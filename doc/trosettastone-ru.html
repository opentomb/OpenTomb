<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.9" />
<title>Устройство Tomb Raider (TRosettaStone)</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}
.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #808080 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0040D0 } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */


@media screen {
  body {
    max-width: 50em; /* approximately 80 characters wide */
    margin-left: 16em;
  }

  #toc {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 13em;
    padding: 0.5em;
    padding-bottom: 1.5em;
    margin: 0;
    overflow: auto;
    border-right: 3px solid #f8f8f8;
    background-color: white;
  }

  #toc .toclevel1 {
    margin-top: 0.5em;
  }

  #toc .toclevel2 {
    margin-top: 0.25em;
    display: list-item;
    color: #aaaaaa;
  }

  #toctitle {
    margin-top: 0.5em;
  }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
<script type="text/javascript">
/*<![CDATA[*/
/*
LaTeXMathML.js
==============

This file, in this form, is due to Douglas Woodall, June 2006.
It contains JavaScript functions to convert (most simple) LaTeX
math notation to Presentation MathML.  It was obtained by
downloading the file ASCIIMathML.js from
	http://www1.chapman.edu/~jipsen/mathml/asciimathdownload/
and modifying it so that it carries out ONLY those conversions
that would be carried out in LaTeX.  A description of the original
file, with examples, can be found at
	www1.chapman.edu/~jipsen/mathml/asciimath.html
	ASCIIMathML: Math on the web for everyone

Here is the header notice from the original file:

ASCIIMathML.js
==============
This file contains JavaScript functions to convert ASCII math notation
to Presentation MathML. The conversion is done while the (X)HTML page
loads, and should work with Firefox/Mozilla/Netscape 7+ and Internet
Explorer 6+MathPlayer (http://www.dessci.com/en/products/mathplayer/).
Just add the next line to your (X)HTML page with this file in the same folder:
This is a convenient and inexpensive solution for authoring MathML.

Version 1.4.7 Dec 15, 2005, (c) Peter Jipsen http://www.chapman.edu/~jipsen
Latest version at http://www.chapman.edu/~jipsen/mathml/ASCIIMathML.js
For changes see http://www.chapman.edu/~jipsen/mathml/asciimathchanges.txt
If you use it on a webpage, please send the URL to jipsen@chapman.edu

This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 2 of the License, or (at
your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
General Public License (at http://www.gnu.org/copyleft/gpl.html)
for more details.

LaTeXMathML.js (ctd)
==============

The instructions for use are the same as for the original
ASCIIMathML.js, except that of course the line you add to your
file should be
Or use absolute path names if the file is not in the same folder
as your (X)HTML page.
*/

var checkForMathML = true;   // check if browser can display MathML
var notifyIfNoMathML = true; // display note if no MathML capability
var alertIfNoMathML = false;  // show alert box if no MathML capability
// was "red":
var mathcolor = "";	     // change it to "" (to inherit) or any other color
// was "serif":
var mathfontfamily = "";      // change to "" to inherit (works in IE)
                              // or another family (e.g. "arial")
var showasciiformulaonhover = true; // helps students learn ASCIIMath
/*
// Commented out by DRW -- not now used -- see DELIMITERS (twice) near the end
var displaystyle = false;     // puts limits above and below large operators
var decimalsign = ".";        // change to "," if you like, beware of `(1,2)`!
var AMdelimiter1 = "`", AMescape1 = "\\\\`"; // can use other characters
var AMdelimiter2 = "$", AMescape2 = "\\\\\\$", AMdelimiter2regexp = "\\$";
var doubleblankmathdelimiter = false; // if true,  x+1  is equal to `x+1`
                                      // for IE this works only in <!--   -->
//var separatetokens;// has been removed (email me if this is a problem)
*/
var isIE = document.createElementNS==null;

if (document.getElementById==null)
  alert("This webpage requires a recent browser such as\
\nMozilla/Netscape 7+ or Internet Explorer 6+MathPlayer")

// all further global variables start with "AM"

function AMcreateElementXHTML(t) {
  if (isIE) return document.createElement(t);
  else return document.createElementNS("http://www.w3.org/1999/xhtml",t);
}

function AMnoMathMLNote() {
  var nd = AMcreateElementXHTML("h3");
  nd.setAttribute("align","center")
  nd.appendChild(AMcreateElementXHTML("p"));
  nd.appendChild(document.createTextNode("To view the "));
  var an = AMcreateElementXHTML("a");
  an.appendChild(document.createTextNode("LaTeXMathML"));
  an.setAttribute("href","http://www.maths.nott.ac.uk/personal/drw/lm.html");
  nd.appendChild(an);
  nd.appendChild(document.createTextNode(" notation use Internet Explorer 6+"));
  an = AMcreateElementXHTML("a");
  an.appendChild(document.createTextNode("MathPlayer"));
  an.setAttribute("href","http://www.dessci.com/en/products/mathplayer/download.htm");
  nd.appendChild(an);
  nd.appendChild(document.createTextNode(" or Netscape/Mozilla/Firefox"));
  nd.appendChild(AMcreateElementXHTML("p"));
  return nd;
}

function AMisMathMLavailable() {
  if (navigator.appName.slice(0,8)=="Netscape")
    if (navigator.appVersion.slice(0,1)>="5") return null;
    else return AMnoMathMLNote();
  else if (navigator.appName.slice(0,9)=="Microsoft")
    try {
        var ActiveX = new ActiveXObject("MathPlayer.Factory.1");
        return null;
    } catch (e) {
        return AMnoMathMLNote();
    }
  else return AMnoMathMLNote();
}

// character lists for Mozilla/Netscape fonts
var AMcal = [0xEF35,0x212C,0xEF36,0xEF37,0x2130,0x2131,0xEF38,0x210B,0x2110,0xEF39,0xEF3A,0x2112,0x2133,0xEF3B,0xEF3C,0xEF3D,0xEF3E,0x211B,0xEF3F,0xEF40,0xEF41,0xEF42,0xEF43,0xEF44,0xEF45,0xEF46];
var AMfrk = [0xEF5D,0xEF5E,0x212D,0xEF5F,0xEF60,0xEF61,0xEF62,0x210C,0x2111,0xEF63,0xEF64,0xEF65,0xEF66,0xEF67,0xEF68,0xEF69,0xEF6A,0x211C,0xEF6B,0xEF6C,0xEF6D,0xEF6E,0xEF6F,0xEF70,0xEF71,0x2128];
var AMbbb = [0xEF8C,0xEF8D,0x2102,0xEF8E,0xEF8F,0xEF90,0xEF91,0x210D,0xEF92,0xEF93,0xEF94,0xEF95,0xEF96,0x2115,0xEF97,0x2119,0x211A,0x211D,0xEF98,0xEF99,0xEF9A,0xEF9B,0xEF9C,0xEF9D,0xEF9E,0x2124];

var CONST = 0, UNARY = 1, BINARY = 2, INFIX = 3, LEFTBRACKET = 4,
    RIGHTBRACKET = 5, SPACE = 6, UNDEROVER = 7, DEFINITION = 8,
    TEXT = 9, BIG = 10, LONG = 11, STRETCHY = 12, MATRIX = 13; // token types

var AMsqrt = {input:"\\sqrt",	tag:"msqrt", output:"sqrt",	ttype:UNARY},
  AMroot = {input:"\\root",	tag:"mroot", output:"root",	ttype:BINARY},
  AMfrac = {input:"\\frac",	tag:"mfrac", output:"/",	ttype:BINARY},
  AMover = {input:"\\stackrel", tag:"mover", output:"stackrel", ttype:BINARY},
  AMatop = {input:"\\atop",	tag:"mfrac", output:"",		ttype:INFIX},
  AMchoose = {input:"\\choose", tag:"mfrac", output:"",		ttype:INFIX},
  AMsub  = {input:"_",		tag:"msub",  output:"_",	ttype:INFIX},
  AMsup  = {input:"^",		tag:"msup",  output:"^",	ttype:INFIX},
  AMtext = {input:"\\mathrm",	tag:"mtext", output:"text",	ttype:TEXT},
  AMmbox = {input:"\\mbox",	tag:"mtext", output:"mbox",	ttype:TEXT};

// Commented out by DRW to prevent 1/2 turning into a 2-line fraction
// AMdiv   = {input:"/",	 tag:"mfrac", output:"/",    ttype:INFIX},
// Commented out by DRW so that " prints literally in equations
// AMquote = {input:"\"",	 tag:"mtext", output:"mbox", ttype:TEXT};

var AMsymbols = [
//Greek letters
{input:"\\alpha",	tag:"mi", output:"\u03B1", ttype:CONST},
{input:"\\beta",	tag:"mi", output:"\u03B2", ttype:CONST},
{input:"\\gamma",	tag:"mi", output:"\u03B3", ttype:CONST},
{input:"\\delta",	tag:"mi", output:"\u03B4", ttype:CONST},
{input:"\\epsilon",	tag:"mi", output:"\u03B5", ttype:CONST},
{input:"\\varepsilon",  tag:"mi", output:"\u025B", ttype:CONST},
{input:"\\zeta",	tag:"mi", output:"\u03B6", ttype:CONST},
{input:"\\eta",		tag:"mi", output:"\u03B7", ttype:CONST},
{input:"\\theta",	tag:"mi", output:"\u03B8", ttype:CONST},
{input:"\\vartheta",	tag:"mi", output:"\u03D1", ttype:CONST},
{input:"\\iota",	tag:"mi", output:"\u03B9", ttype:CONST},
{input:"\\kappa",	tag:"mi", output:"\u03BA", ttype:CONST},
{input:"\\lambda",	tag:"mi", output:"\u03BB", ttype:CONST},
{input:"\\mu",		tag:"mi", output:"\u03BC", ttype:CONST},
{input:"\\nu",		tag:"mi", output:"\u03BD", ttype:CONST},
{input:"\\xi",		tag:"mi", output:"\u03BE", ttype:CONST},
{input:"\\pi",		tag:"mi", output:"\u03C0", ttype:CONST},
{input:"\\varpi",	tag:"mi", output:"\u03D6", ttype:CONST},
{input:"\\rho",		tag:"mi", output:"\u03C1", ttype:CONST},
{input:"\\varrho",	tag:"mi", output:"\u03F1", ttype:CONST},
{input:"\\varsigma",	tag:"mi", output:"\u03C2", ttype:CONST},
{input:"\\sigma",	tag:"mi", output:"\u03C3", ttype:CONST},
{input:"\\tau",		tag:"mi", output:"\u03C4", ttype:CONST},
{input:"\\upsilon",	tag:"mi", output:"\u03C5", ttype:CONST},
{input:"\\phi",		tag:"mi", output:"\u03C6", ttype:CONST},
{input:"\\varphi",	tag:"mi", output:"\u03D5", ttype:CONST},
{input:"\\chi",		tag:"mi", output:"\u03C7", ttype:CONST},
{input:"\\psi",		tag:"mi", output:"\u03C8", ttype:CONST},
{input:"\\omega",	tag:"mi", output:"\u03C9", ttype:CONST},
{input:"\\Gamma",	tag:"mo", output:"\u0393", ttype:CONST},
{input:"\\Delta",	tag:"mo", output:"\u0394", ttype:CONST},
{input:"\\Theta",	tag:"mo", output:"\u0398", ttype:CONST},
{input:"\\Lambda",	tag:"mo", output:"\u039B", ttype:CONST},
{input:"\\Xi",		tag:"mo", output:"\u039E", ttype:CONST},
{input:"\\Pi",		tag:"mo", output:"\u03A0", ttype:CONST},
{input:"\\Sigma",	tag:"mo", output:"\u03A3", ttype:CONST},
{input:"\\Upsilon",	tag:"mo", output:"\u03A5", ttype:CONST},
{input:"\\Phi",		tag:"mo", output:"\u03A6", ttype:CONST},
{input:"\\Psi",		tag:"mo", output:"\u03A8", ttype:CONST},
{input:"\\Omega",	tag:"mo", output:"\u03A9", ttype:CONST},

//fractions
{input:"\\frac12",	tag:"mo", output:"\u00BD", ttype:CONST},
{input:"\\frac14",	tag:"mo", output:"\u00BC", ttype:CONST},
{input:"\\frac34",	tag:"mo", output:"\u00BE", ttype:CONST},
{input:"\\frac13",	tag:"mo", output:"\u2153", ttype:CONST},
{input:"\\frac23",	tag:"mo", output:"\u2154", ttype:CONST},
{input:"\\frac15",	tag:"mo", output:"\u2155", ttype:CONST},
{input:"\\frac25",	tag:"mo", output:"\u2156", ttype:CONST},
{input:"\\frac35",	tag:"mo", output:"\u2157", ttype:CONST},
{input:"\\frac45",	tag:"mo", output:"\u2158", ttype:CONST},
{input:"\\frac16",	tag:"mo", output:"\u2159", ttype:CONST},
{input:"\\frac56",	tag:"mo", output:"\u215A", ttype:CONST},
{input:"\\frac18",	tag:"mo", output:"\u215B", ttype:CONST},
{input:"\\frac38",	tag:"mo", output:"\u215C", ttype:CONST},
{input:"\\frac58",	tag:"mo", output:"\u215D", ttype:CONST},
{input:"\\frac78",	tag:"mo", output:"\u215E", ttype:CONST},

//binary operation symbols
{input:"\\pm",		tag:"mo", output:"\u00B1", ttype:CONST},
{input:"\\mp",		tag:"mo", output:"\u2213", ttype:CONST},
{input:"\\triangleleft",tag:"mo", output:"\u22B2", ttype:CONST},
{input:"\\triangleright",tag:"mo",output:"\u22B3", ttype:CONST},
{input:"\\cdot",	tag:"mo", output:"\u22C5", ttype:CONST},
{input:"\\star",	tag:"mo", output:"\u22C6", ttype:CONST},
{input:"\\ast",		tag:"mo", output:"\u002A", ttype:CONST},
{input:"\\times",	tag:"mo", output:"\u00D7", ttype:CONST},
{input:"\\div",		tag:"mo", output:"\u00F7", ttype:CONST},
{input:"\\circ",	tag:"mo", output:"\u2218", ttype:CONST},
//{input:"\\bullet",	  tag:"mo", output:"\u2219", ttype:CONST},
{input:"\\bullet",	tag:"mo", output:"\u2022", ttype:CONST},
{input:"\\oplus",	tag:"mo", output:"\u2295", ttype:CONST},
{input:"\\ominus",	tag:"mo", output:"\u2296", ttype:CONST},
{input:"\\otimes",	tag:"mo", output:"\u2297", ttype:CONST},
{input:"\\bigcirc",	tag:"mo", output:"\u25CB", ttype:CONST},
{input:"\\oslash",	tag:"mo", output:"\u2298", ttype:CONST},
{input:"\\odot",	tag:"mo", output:"\u2299", ttype:CONST},
{input:"\\land",	tag:"mo", output:"\u2227", ttype:CONST},
{input:"\\wedge",	tag:"mo", output:"\u2227", ttype:CONST},
{input:"\\lor",		tag:"mo", output:"\u2228", ttype:CONST},
{input:"\\vee",		tag:"mo", output:"\u2228", ttype:CONST},
{input:"\\cap",		tag:"mo", output:"\u2229", ttype:CONST},
{input:"\\cup",		tag:"mo", output:"\u222A", ttype:CONST},
{input:"\\sqcap",	tag:"mo", output:"\u2293", ttype:CONST},
{input:"\\sqcup",	tag:"mo", output:"\u2294", ttype:CONST},
{input:"\\uplus",	tag:"mo", output:"\u228E", ttype:CONST},
{input:"\\amalg",	tag:"mo", output:"\u2210", ttype:CONST},
{input:"\\bigtriangleup",tag:"mo",output:"\u25B3", ttype:CONST},
{input:"\\bigtriangledown",tag:"mo",output:"\u25BD", ttype:CONST},
{input:"\\dag",		tag:"mo", output:"\u2020", ttype:CONST},
{input:"\\dagger",	tag:"mo", output:"\u2020", ttype:CONST},
{input:"\\ddag",	tag:"mo", output:"\u2021", ttype:CONST},
{input:"\\ddagger",	tag:"mo", output:"\u2021", ttype:CONST},
{input:"\\lhd",		tag:"mo", output:"\u22B2", ttype:CONST},
{input:"\\rhd",		tag:"mo", output:"\u22B3", ttype:CONST},
{input:"\\unlhd",	tag:"mo", output:"\u22B4", ttype:CONST},
{input:"\\unrhd",	tag:"mo", output:"\u22B5", ttype:CONST},


//BIG Operators
{input:"\\sum",		tag:"mo", output:"\u2211", ttype:UNDEROVER},
{input:"\\prod",	tag:"mo", output:"\u220F", ttype:UNDEROVER},
{input:"\\bigcap",	tag:"mo", output:"\u22C2", ttype:UNDEROVER},
{input:"\\bigcup",	tag:"mo", output:"\u22C3", ttype:UNDEROVER},
{input:"\\bigwedge",	tag:"mo", output:"\u22C0", ttype:UNDEROVER},
{input:"\\bigvee",	tag:"mo", output:"\u22C1", ttype:UNDEROVER},
{input:"\\bigsqcap",	tag:"mo", output:"\u2A05", ttype:UNDEROVER},
{input:"\\bigsqcup",	tag:"mo", output:"\u2A06", ttype:UNDEROVER},
{input:"\\coprod",	tag:"mo", output:"\u2210", ttype:UNDEROVER},
{input:"\\bigoplus",	tag:"mo", output:"\u2A01", ttype:UNDEROVER},
{input:"\\bigotimes",	tag:"mo", output:"\u2A02", ttype:UNDEROVER},
{input:"\\bigodot",	tag:"mo", output:"\u2A00", ttype:UNDEROVER},
{input:"\\biguplus",	tag:"mo", output:"\u2A04", ttype:UNDEROVER},
{input:"\\int",		tag:"mo", output:"\u222B", ttype:CONST},
{input:"\\oint",	tag:"mo", output:"\u222E", ttype:CONST},

//binary relation symbols
{input:":=",		tag:"mo", output:":=",	   ttype:CONST},
{input:"\\lt",		tag:"mo", output:"<",	   ttype:CONST},
{input:"\\gt",		tag:"mo", output:">",	   ttype:CONST},
{input:"\\ne",		tag:"mo", output:"\u2260", ttype:CONST},
{input:"\\neq",		tag:"mo", output:"\u2260", ttype:CONST},
{input:"\\le",		tag:"mo", output:"\u2264", ttype:CONST},
{input:"\\leq",		tag:"mo", output:"\u2264", ttype:CONST},
{input:"\\leqslant",	tag:"mo", output:"\u2264", ttype:CONST},
{input:"\\ge",		tag:"mo", output:"\u2265", ttype:CONST},
{input:"\\geq",		tag:"mo", output:"\u2265", ttype:CONST},
{input:"\\geqslant",	tag:"mo", output:"\u2265", ttype:CONST},
{input:"\\equiv",	tag:"mo", output:"\u2261", ttype:CONST},
{input:"\\ll",		tag:"mo", output:"\u226A", ttype:CONST},
{input:"\\gg",		tag:"mo", output:"\u226B", ttype:CONST},
{input:"\\doteq",	tag:"mo", output:"\u2250", ttype:CONST},
{input:"\\prec",	tag:"mo", output:"\u227A", ttype:CONST},
{input:"\\succ",	tag:"mo", output:"\u227B", ttype:CONST},
{input:"\\preceq",	tag:"mo", output:"\u227C", ttype:CONST},
{input:"\\succeq",	tag:"mo", output:"\u227D", ttype:CONST},
{input:"\\subset",	tag:"mo", output:"\u2282", ttype:CONST},
{input:"\\supset",	tag:"mo", output:"\u2283", ttype:CONST},
{input:"\\subseteq",	tag:"mo", output:"\u2286", ttype:CONST},
{input:"\\supseteq",	tag:"mo", output:"\u2287", ttype:CONST},
{input:"\\sqsubset",	tag:"mo", output:"\u228F", ttype:CONST},
{input:"\\sqsupset",	tag:"mo", output:"\u2290", ttype:CONST},
{input:"\\sqsubseteq",  tag:"mo", output:"\u2291", ttype:CONST},
{input:"\\sqsupseteq",  tag:"mo", output:"\u2292", ttype:CONST},
{input:"\\sim",		tag:"mo", output:"\u223C", ttype:CONST},
{input:"\\simeq",	tag:"mo", output:"\u2243", ttype:CONST},
{input:"\\approx",	tag:"mo", output:"\u2248", ttype:CONST},
{input:"\\cong",	tag:"mo", output:"\u2245", ttype:CONST},
{input:"\\Join",	tag:"mo", output:"\u22C8", ttype:CONST},
{input:"\\bowtie",	tag:"mo", output:"\u22C8", ttype:CONST},
{input:"\\in",		tag:"mo", output:"\u2208", ttype:CONST},
{input:"\\ni",		tag:"mo", output:"\u220B", ttype:CONST},
{input:"\\owns",	tag:"mo", output:"\u220B", ttype:CONST},
{input:"\\propto",	tag:"mo", output:"\u221D", ttype:CONST},
{input:"\\vdash",	tag:"mo", output:"\u22A2", ttype:CONST},
{input:"\\dashv",	tag:"mo", output:"\u22A3", ttype:CONST},
{input:"\\models",	tag:"mo", output:"\u22A8", ttype:CONST},
{input:"\\perp",	tag:"mo", output:"\u22A5", ttype:CONST},
{input:"\\smile",	tag:"mo", output:"\u2323", ttype:CONST},
{input:"\\frown",	tag:"mo", output:"\u2322", ttype:CONST},
{input:"\\asymp",	tag:"mo", output:"\u224D", ttype:CONST},
{input:"\\notin",	tag:"mo", output:"\u2209", ttype:CONST},

//matrices
{input:"\\begin{eqnarray}",	output:"X",	ttype:MATRIX, invisible:true},
{input:"\\begin{array}",	output:"X",	ttype:MATRIX, invisible:true},
{input:"\\\\",			output:"}&{",	ttype:DEFINITION},
{input:"\\end{eqnarray}",	output:"}}",	ttype:DEFINITION},
{input:"\\end{array}",		output:"}}",	ttype:DEFINITION},

//grouping and literal brackets -- ieval is for IE
{input:"\\big",	   tag:"mo", output:"X", atval:"1.2", ieval:"2.2", ttype:BIG},
{input:"\\Big",	   tag:"mo", output:"X", atval:"1.6", ieval:"2.6", ttype:BIG},
{input:"\\bigg",   tag:"mo", output:"X", atval:"2.2", ieval:"3.2", ttype:BIG},
{input:"\\Bigg",   tag:"mo", output:"X", atval:"2.9", ieval:"3.9", ttype:BIG},
{input:"\\left",   tag:"mo", output:"X", ttype:LEFTBRACKET},
{input:"\\right",  tag:"mo", output:"X", ttype:RIGHTBRACKET},
{input:"{",	   output:"{", ttype:LEFTBRACKET,  invisible:true},
{input:"}",	   output:"}", ttype:RIGHTBRACKET, invisible:true},

{input:"(",	   tag:"mo", output:"(",      atval:"1", ttype:STRETCHY},
{input:"[",	   tag:"mo", output:"[",      atval:"1", ttype:STRETCHY},
{input:"\\lbrack", tag:"mo", output:"[",      atval:"1", ttype:STRETCHY},
{input:"\\{",	   tag:"mo", output:"{",      atval:"1", ttype:STRETCHY},
{input:"\\lbrace", tag:"mo", output:"{",      atval:"1", ttype:STRETCHY},
{input:"\\langle", tag:"mo", output:"\u2329", atval:"1", ttype:STRETCHY},
{input:"\\lfloor", tag:"mo", output:"\u230A", atval:"1", ttype:STRETCHY},
{input:"\\lceil",  tag:"mo", output:"\u2308", atval:"1", ttype:STRETCHY},

// rtag:"mi" causes space to be inserted before a following sin, cos, etc.
// (see function AMparseExpr() )
{input:")",	  tag:"mo",output:")",	    rtag:"mi",atval:"1",ttype:STRETCHY},
{input:"]",	  tag:"mo",output:"]",	    rtag:"mi",atval:"1",ttype:STRETCHY},
{input:"\\rbrack",tag:"mo",output:"]",	    rtag:"mi",atval:"1",ttype:STRETCHY},
{input:"\\}",	  tag:"mo",output:"}",	    rtag:"mi",atval:"1",ttype:STRETCHY},
{input:"\\rbrace",tag:"mo",output:"}",	    rtag:"mi",atval:"1",ttype:STRETCHY},
{input:"\\rangle",tag:"mo",output:"\u232A", rtag:"mi",atval:"1",ttype:STRETCHY},
{input:"\\rfloor",tag:"mo",output:"\u230B", rtag:"mi",atval:"1",ttype:STRETCHY},
{input:"\\rceil", tag:"mo",output:"\u2309", rtag:"mi",atval:"1",ttype:STRETCHY},

// "|", "\\|", "\\vert" and "\\Vert" modified later: lspace = rspace = 0em
{input:"|",		tag:"mo", output:"\u2223", atval:"1", ttype:STRETCHY},
{input:"\\|",		tag:"mo", output:"\u2225", atval:"1", ttype:STRETCHY},
{input:"\\vert",	tag:"mo", output:"\u2223", atval:"1", ttype:STRETCHY},
{input:"\\Vert",	tag:"mo", output:"\u2225", atval:"1", ttype:STRETCHY},
{input:"\\mid",		tag:"mo", output:"\u2223", atval:"1", ttype:STRETCHY},
{input:"\\parallel",	tag:"mo", output:"\u2225", atval:"1", ttype:STRETCHY},
{input:"/",		tag:"mo", output:"/",	atval:"1.01", ttype:STRETCHY},
{input:"\\backslash",	tag:"mo", output:"\u2216", atval:"1", ttype:STRETCHY},
{input:"\\setminus",	tag:"mo", output:"\\",	   ttype:CONST},

//miscellaneous symbols
{input:"\\!",	  tag:"mspace", atname:"width", atval:"-0.167em", ttype:SPACE},
{input:"\\,",	  tag:"mspace", atname:"width", atval:"0.167em", ttype:SPACE},
{input:"\\>",	  tag:"mspace", atname:"width", atval:"0.222em", ttype:SPACE},
{input:"\\:",	  tag:"mspace", atname:"width", atval:"0.222em", ttype:SPACE},
{input:"\\;",	  tag:"mspace", atname:"width", atval:"0.278em", ttype:SPACE},
{input:"~",	  tag:"mspace", atname:"width", atval:"0.333em", ttype:SPACE},
{input:"\\quad",  tag:"mspace", atname:"width", atval:"1em", ttype:SPACE},
{input:"\\qquad", tag:"mspace", atname:"width", atval:"2em", ttype:SPACE},
//{input:"{}",		  tag:"mo", output:"\u200B", ttype:CONST}, // zero-width
{input:"\\prime",	tag:"mo", output:"\u2032", ttype:CONST},
{input:"'",		tag:"mo", output:"\u02B9", ttype:CONST},
{input:"''",		tag:"mo", output:"\u02BA", ttype:CONST},
{input:"'''",		tag:"mo", output:"\u2034", ttype:CONST},
{input:"''''",		tag:"mo", output:"\u2057", ttype:CONST},
{input:"\\ldots",	tag:"mo", output:"\u2026", ttype:CONST},
{input:"\\cdots",	tag:"mo", output:"\u22EF", ttype:CONST},
{input:"\\vdots",	tag:"mo", output:"\u22EE", ttype:CONST},
{input:"\\ddots",	tag:"mo", output:"\u22F1", ttype:CONST},
{input:"\\forall",	tag:"mo", output:"\u2200", ttype:CONST},
{input:"\\exists",	tag:"mo", output:"\u2203", ttype:CONST},
{input:"\\Re",		tag:"mo", output:"\u211C", ttype:CONST},
{input:"\\Im",		tag:"mo", output:"\u2111", ttype:CONST},
{input:"\\aleph",	tag:"mo", output:"\u2135", ttype:CONST},
{input:"\\hbar",	tag:"mo", output:"\u210F", ttype:CONST},
{input:"\\ell",		tag:"mo", output:"\u2113", ttype:CONST},
{input:"\\wp",		tag:"mo", output:"\u2118", ttype:CONST},
{input:"\\emptyset",	tag:"mo", output:"\u2205", ttype:CONST},
{input:"\\infty",	tag:"mo", output:"\u221E", ttype:CONST},
{input:"\\surd",	tag:"mo", output:"\\sqrt{}", ttype:DEFINITION},
{input:"\\partial",	tag:"mo", output:"\u2202", ttype:CONST},
{input:"\\nabla",	tag:"mo", output:"\u2207", ttype:CONST},
{input:"\\triangle",	tag:"mo", output:"\u25B3", ttype:CONST},
{input:"\\therefore",	tag:"mo", output:"\u2234", ttype:CONST},
{input:"\\angle",	tag:"mo", output:"\u2220", ttype:CONST},
//{input:"\\\\ ",	  tag:"mo", output:"\u00A0", ttype:CONST},
{input:"\\diamond",	tag:"mo", output:"\u22C4", ttype:CONST},
//{input:"\\Diamond",	  tag:"mo", output:"\u25CA", ttype:CONST},
{input:"\\Diamond",	tag:"mo", output:"\u25C7", ttype:CONST},
{input:"\\neg",		tag:"mo", output:"\u00AC", ttype:CONST},
{input:"\\lnot",	tag:"mo", output:"\u00AC", ttype:CONST},
{input:"\\bot",		tag:"mo", output:"\u22A5", ttype:CONST},
{input:"\\top",		tag:"mo", output:"\u22A4", ttype:CONST},
{input:"\\square",	tag:"mo", output:"\u25AB", ttype:CONST},
{input:"\\Box",		tag:"mo", output:"\u25A1", ttype:CONST},
{input:"\\wr",		tag:"mo", output:"\u2240", ttype:CONST},

//standard functions
//Note UNDEROVER *must* have tag:"mo" to work properly
{input:"\\arccos", tag:"mi", output:"arccos", ttype:UNARY, func:true},
{input:"\\arcsin", tag:"mi", output:"arcsin", ttype:UNARY, func:true},
{input:"\\arctan", tag:"mi", output:"arctan", ttype:UNARY, func:true},
{input:"\\arg",	   tag:"mi", output:"arg",    ttype:UNARY, func:true},
{input:"\\cos",	   tag:"mi", output:"cos",    ttype:UNARY, func:true},
{input:"\\cosh",   tag:"mi", output:"cosh",   ttype:UNARY, func:true},
{input:"\\cot",	   tag:"mi", output:"cot",    ttype:UNARY, func:true},
{input:"\\coth",   tag:"mi", output:"coth",   ttype:UNARY, func:true},
{input:"\\csc",	   tag:"mi", output:"csc",    ttype:UNARY, func:true},
{input:"\\deg",	   tag:"mi", output:"deg",    ttype:UNARY, func:true},
{input:"\\det",	   tag:"mi", output:"det",    ttype:UNARY, func:true},
{input:"\\dim",	   tag:"mi", output:"dim",    ttype:UNARY, func:true}, //CONST?
{input:"\\exp",	   tag:"mi", output:"exp",    ttype:UNARY, func:true},
{input:"\\gcd",	   tag:"mi", output:"gcd",    ttype:UNARY, func:true}, //CONST?
{input:"\\hom",	   tag:"mi", output:"hom",    ttype:UNARY, func:true},
{input:"\\inf",	      tag:"mo", output:"inf",	 ttype:UNDEROVER},
{input:"\\ker",	   tag:"mi", output:"ker",    ttype:UNARY, func:true},
{input:"\\lg",	   tag:"mi", output:"lg",     ttype:UNARY, func:true},
{input:"\\lim",	      tag:"mo", output:"lim",	 ttype:UNDEROVER},
{input:"\\liminf",    tag:"mo", output:"liminf", ttype:UNDEROVER},
{input:"\\limsup",    tag:"mo", output:"limsup", ttype:UNDEROVER},
{input:"\\ln",	   tag:"mi", output:"ln",     ttype:UNARY, func:true},
{input:"\\log",	   tag:"mi", output:"log",    ttype:UNARY, func:true},
{input:"\\max",	      tag:"mo", output:"max",	 ttype:UNDEROVER},
{input:"\\min",	      tag:"mo", output:"min",	 ttype:UNDEROVER},
{input:"\\Pr",	   tag:"mi", output:"Pr",     ttype:UNARY, func:true},
{input:"\\sec",	   tag:"mi", output:"sec",    ttype:UNARY, func:true},
{input:"\\sin",	   tag:"mi", output:"sin",    ttype:UNARY, func:true},
{input:"\\sinh",   tag:"mi", output:"sinh",   ttype:UNARY, func:true},
{input:"\\sup",	      tag:"mo", output:"sup",	 ttype:UNDEROVER},
{input:"\\tan",	   tag:"mi", output:"tan",    ttype:UNARY, func:true},
{input:"\\tanh",   tag:"mi", output:"tanh",   ttype:UNARY, func:true},

//arrows
{input:"\\gets",		tag:"mo", output:"\u2190", ttype:CONST},
{input:"\\leftarrow",		tag:"mo", output:"\u2190", ttype:CONST},
{input:"\\to",			tag:"mo", output:"\u2192", ttype:CONST},
{input:"\\rightarrow",		tag:"mo", output:"\u2192", ttype:CONST},
{input:"\\leftrightarrow",	tag:"mo", output:"\u2194", ttype:CONST},
{input:"\\uparrow",		tag:"mo", output:"\u2191", ttype:CONST},
{input:"\\downarrow",		tag:"mo", output:"\u2193", ttype:CONST},
{input:"\\updownarrow",		tag:"mo", output:"\u2195", ttype:CONST},
{input:"\\Leftarrow",		tag:"mo", output:"\u21D0", ttype:CONST},
{input:"\\Rightarrow",		tag:"mo", output:"\u21D2", ttype:CONST},
{input:"\\Leftrightarrow",	tag:"mo", output:"\u21D4", ttype:CONST},
{input:"\\iff", tag:"mo", output:"~\\Longleftrightarrow~", ttype:DEFINITION},
{input:"\\Uparrow",		tag:"mo", output:"\u21D1", ttype:CONST},
{input:"\\Downarrow",		tag:"mo", output:"\u21D3", ttype:CONST},
{input:"\\Updownarrow",		tag:"mo", output:"\u21D5", ttype:CONST},
{input:"\\mapsto",		tag:"mo", output:"\u21A6", ttype:CONST},
{input:"\\longleftarrow",	tag:"mo", output:"\u2190", ttype:LONG},
{input:"\\longrightarrow",	tag:"mo", output:"\u2192", ttype:LONG},
{input:"\\longleftrightarrow",	tag:"mo", output:"\u2194", ttype:LONG},
{input:"\\Longleftarrow",	tag:"mo", output:"\u21D0", ttype:LONG},
{input:"\\Longrightarrow",	tag:"mo", output:"\u21D2", ttype:LONG},
{input:"\\Longleftrightarrow",  tag:"mo", output:"\u21D4", ttype:LONG},
{input:"\\longmapsto",		tag:"mo", output:"\u21A6", ttype:CONST},
							// disaster if LONG

//commands with argument
AMsqrt, AMroot, AMfrac, AMover, AMsub, AMsup, AMtext, AMmbox, AMatop, AMchoose,
//AMdiv, AMquote,

//diacritical marks
{input:"\\acute",	tag:"mover",  output:"\u00B4", ttype:UNARY, acc:true},
//{input:"\\acute",	  tag:"mover",  output:"\u0317", ttype:UNARY, acc:true},
//{input:"\\acute",	  tag:"mover",  output:"\u0301", ttype:UNARY, acc:true},
//{input:"\\grave",	  tag:"mover",  output:"\u0300", ttype:UNARY, acc:true},
//{input:"\\grave",	  tag:"mover",  output:"\u0316", ttype:UNARY, acc:true},
{input:"\\grave",	tag:"mover",  output:"\u0060", ttype:UNARY, acc:true},
{input:"\\breve",	tag:"mover",  output:"\u02D8", ttype:UNARY, acc:true},
{input:"\\check",	tag:"mover",  output:"\u02C7", ttype:UNARY, acc:true},
{input:"\\dot",		tag:"mover",  output:".",      ttype:UNARY, acc:true},
{input:"\\ddot",	tag:"mover",  output:"..",     ttype:UNARY, acc:true},
//{input:"\\ddot",	  tag:"mover",  output:"\u00A8", ttype:UNARY, acc:true},
{input:"\\mathring",	tag:"mover",  output:"\u00B0", ttype:UNARY, acc:true},
{input:"\\vec",		tag:"mover",  output:"\u20D7", ttype:UNARY, acc:true},
{input:"\\overrightarrow",tag:"mover",output:"\u20D7", ttype:UNARY, acc:true},
{input:"\\overleftarrow",tag:"mover", output:"\u20D6", ttype:UNARY, acc:true},
{input:"\\hat",		tag:"mover",  output:"\u005E", ttype:UNARY, acc:true},
{input:"\\widehat",	tag:"mover",  output:"\u0302", ttype:UNARY, acc:true},
{input:"\\tilde",	tag:"mover",  output:"~",      ttype:UNARY, acc:true},
//{input:"\\tilde",	  tag:"mover",  output:"\u0303", ttype:UNARY, acc:true},
{input:"\\widetilde",	tag:"mover",  output:"\u02DC", ttype:UNARY, acc:true},
{input:"\\bar",		tag:"mover",  output:"\u203E", ttype:UNARY, acc:true},
{input:"\\overbrace",	tag:"mover",  output:"\u23B4", ttype:UNARY, acc:true},
{input:"\\overline",	tag:"mover",  output:"\u00AF", ttype:UNARY, acc:true},
{input:"\\underbrace",  tag:"munder", output:"\u23B5", ttype:UNARY, acc:true},
{input:"\\underline",	tag:"munder", output:"\u00AF", ttype:UNARY, acc:true},
//{input:"underline",	tag:"munder", output:"\u0332", ttype:UNARY, acc:true},

//typestyles and fonts
{input:"\\displaystyle",tag:"mstyle",atname:"displaystyle",atval:"true", ttype:UNARY},
{input:"\\textstyle",tag:"mstyle",atname:"displaystyle",atval:"false", ttype:UNARY},
{input:"\\scriptstyle",tag:"mstyle",atname:"scriptlevel",atval:"1", ttype:UNARY},
{input:"\\scriptscriptstyle",tag:"mstyle",atname:"scriptlevel",atval:"2", ttype:UNARY},
{input:"\\textrm", tag:"mstyle", output:"\\mathrm", ttype: DEFINITION},
{input:"\\mathbf", tag:"mstyle", atname:"mathvariant", atval:"bold", ttype:UNARY},
{input:"\\textbf", tag:"mstyle", atname:"mathvariant", atval:"bold", ttype:UNARY},
{input:"\\mathit", tag:"mstyle", atname:"mathvariant", atval:"italic", ttype:UNARY},
{input:"\\textit", tag:"mstyle", atname:"mathvariant", atval:"italic", ttype:UNARY},
{input:"\\mathtt", tag:"mstyle", atname:"mathvariant", atval:"monospace", ttype:UNARY},
{input:"\\texttt", tag:"mstyle", atname:"mathvariant", atval:"monospace", ttype:UNARY},
{input:"\\mathsf", tag:"mstyle", atname:"mathvariant", atval:"sans-serif", ttype:UNARY},
{input:"\\mathbb", tag:"mstyle", atname:"mathvariant", atval:"double-struck", ttype:UNARY, codes:AMbbb},
{input:"\\mathcal",tag:"mstyle", atname:"mathvariant", atval:"script", ttype:UNARY, codes:AMcal},
{input:"\\mathfrak",tag:"mstyle",atname:"mathvariant", atval:"fraktur",ttype:UNARY, codes:AMfrk}
];

function compareNames(s1,s2) {
  if (s1.input > s2.input) return 1
  else return -1;
}

var AMnames = []; //list of input symbols

function AMinitSymbols() {
  AMsymbols.sort(compareNames);
  for (i=0; i<AMsymbols.length; i++) AMnames[i] = AMsymbols[i].input;
}

var AMmathml = "http://www.w3.org/1998/Math/MathML";

function AMcreateElementMathML(t) {
  if (isIE) return document.createElement("m:"+t);
  else return document.createElementNS(AMmathml,t);
}

function AMcreateMmlNode(t,frag) {
//  var node = AMcreateElementMathML(name);
  if (isIE) var node = document.createElement("m:"+t);
  else var node = document.createElementNS(AMmathml,t);
  node.appendChild(frag);
  return node;
}

function newcommand(oldstr,newstr) {
  AMsymbols = AMsymbols.concat([{input:oldstr, tag:"mo", output:newstr,
                                 ttype:DEFINITION}]);
}

function AMremoveCharsAndBlanks(str,n) {
//remove n characters and any following blanks
  var st;
  st = str.slice(n);
  for (var i=0; i<st.length && st.charCodeAt(i)<=32; i=i+1);
  return st.slice(i);
}

function AMposition(arr, str, n) {
// return position >=n where str appears or would be inserted
// assumes arr is sorted
  if (n==0) {
    var h,m;
    n = -1;
    h = arr.length;
    while (n+1<h) {
      m = (n+h) >> 1;
      if (arr[m]<str) n = m; else h = m;
    }
    return h;
  } else
    for (var i=n; i<arr.length && arr[i]<str; i++);
  return i; // i=arr.length || arr[i]>=str
}

function AMgetSymbol(str) {
//return maximal initial substring of str that appears in names
//return null if there is none
  var k = 0; //new pos
  var j = 0; //old pos
  var mk; //match pos
  var st;
  var tagst;
  var match = "";
  var more = true;
  for (var i=1; i<=str.length && more; i++) {
    st = str.slice(0,i); //initial substring of length i
    j = k;
    k = AMposition(AMnames, st, j);
    if (k<AMnames.length && str.slice(0,AMnames[k].length)==AMnames[k]){
      match = AMnames[k];
      mk = k;
      i = match.length;
    }
    more = k<AMnames.length && str.slice(0,AMnames[k].length)>=AMnames[k];
  }
  AMpreviousSymbol=AMcurrentSymbol;
  if (match!=""){
    AMcurrentSymbol=AMsymbols[mk].ttype;
    return AMsymbols[mk];
  }
  AMcurrentSymbol=CONST;
  k = 1;
  st = str.slice(0,1); //take 1 character
  if ("0"<=st && st<="9") tagst = "mn";
  else tagst = (("A">st || st>"Z") && ("a">st || st>"z")?"mo":"mi");
/*
// Commented out by DRW (not fully understood, but probably to do with
// use of "/" as an INFIX version of "\\frac", which we don't want):
//}
//if (st=="-" && AMpreviousSymbol==INFIX) {
//  AMcurrentSymbol = INFIX;  //trick "/" into recognizing "-" on second parse
//  return {input:st, tag:tagst, output:st, ttype:UNARY, func:true};
//}
*/
  return {input:st, tag:tagst, output:st, ttype:CONST};
}


/*Parsing ASCII math expressions with the following grammar
v ::= [A-Za-z] | greek letters | numbers | other constant symbols
u ::= sqrt | text | bb | other unary symbols for font commands
b ::= frac | root | stackrel	binary symbols
l ::= { | \left			left brackets
r ::= } | \right		right brackets
S ::= v | lEr | uS | bSS	Simple expression
I ::= S_S | S^S | S_S^S | S	Intermediate expression
E ::= IE | I/I			Expression
Each terminal symbol is translated into a corresponding mathml node.*/

var AMpreviousSymbol,AMcurrentSymbol;

function AMparseSexpr(str) { //parses str and returns [node,tailstr,(node)tag]
  var symbol, node, result, result2, i, st,// rightvert = false,
    newFrag = document.createDocumentFragment();
  str = AMremoveCharsAndBlanks(str,0);
  symbol = AMgetSymbol(str);             //either a token or a bracket or empty
  if (symbol == null || symbol.ttype == RIGHTBRACKET)
    return [null,str,null];
  if (symbol.ttype == DEFINITION) {
    str = symbol.output+AMremoveCharsAndBlanks(str,symbol.input.length);
    symbol = AMgetSymbol(str);
    if (symbol == null || symbol.ttype == RIGHTBRACKET)
      return [null,str,null];
  }
  str = AMremoveCharsAndBlanks(str,symbol.input.length);
  switch (symbol.ttype) {
  case SPACE:
    node = AMcreateElementMathML(symbol.tag);
    node.setAttribute(symbol.atname,symbol.atval);
    return [node,str,symbol.tag];
  case UNDEROVER:
    if (isIE) {
      if (symbol.input.substr(0,4) == "\\big") {   // botch for missing symbols
	str = "\\"+symbol.input.substr(4)+str;	   // make \bigcup = \cup etc.
	symbol = AMgetSymbol(str);
	symbol.ttype = UNDEROVER;
	str = AMremoveCharsAndBlanks(str,symbol.input.length);
      }
    }
    return [AMcreateMmlNode(symbol.tag,
			document.createTextNode(symbol.output)),str,symbol.tag];
  case CONST:
    var output = symbol.output;
    if (isIE) {
      if (symbol.input == "'")
	output = "\u2032";
      else if (symbol.input == "''")
	output = "\u2033";
      else if (symbol.input == "'''")
	output = "\u2033\u2032";
      else if (symbol.input == "''''")
	output = "\u2033\u2033";
      else if (symbol.input == "\\square")
	output = "\u25A1";	// same as \Box
      else if (symbol.input.substr(0,5) == "\\frac") {
						// botch for missing fractions
	var denom = symbol.input.substr(6,1);
	if (denom == "5" || denom == "6") {
	  str = symbol.input.replace(/\\frac/,"\\frac ")+str;
	  return [node,str,symbol.tag];
	}
      }
    }
    node = AMcreateMmlNode(symbol.tag,document.createTextNode(output));
    return [node,str,symbol.tag];
  case LONG:  // added by DRW
    node = AMcreateMmlNode(symbol.tag,document.createTextNode(symbol.output));
    node.setAttribute("minsize","1.5");
    node.setAttribute("maxsize","1.5");
    node = AMcreateMmlNode("mover",node);
    node.appendChild(AMcreateElementMathML("mspace"));
    return [node,str,symbol.tag];
  case STRETCHY:  // added by DRW
    if (isIE && symbol.input == "\\backslash")
	symbol.output = "\\";	// doesn't expand, but then nor does "\u2216"
    node = AMcreateMmlNode(symbol.tag,document.createTextNode(symbol.output));
    if (symbol.input == "|" || symbol.input == "\\vert" ||
	symbol.input == "\\|" || symbol.input == "\\Vert") {
	  node.setAttribute("lspace","0em");
	  node.setAttribute("rspace","0em");
    }
    node.setAttribute("maxsize",symbol.atval);  // don't allow to stretch here
    if (symbol.rtag != null)
      return [node,str,symbol.rtag];
    else
      return [node,str,symbol.tag];
  case BIG:  // added by DRW
    var atval = symbol.atval;
    if (isIE)
      atval = symbol.ieval;
    symbol = AMgetSymbol(str);
    if (symbol == null)
	return [null,str,null];
    str = AMremoveCharsAndBlanks(str,symbol.input.length);
    node = AMcreateMmlNode(symbol.tag,document.createTextNode(symbol.output));
    if (isIE) {		// to get brackets to expand
      var space = AMcreateElementMathML("mspace");
      space.setAttribute("height",atval+"ex");
      node = AMcreateMmlNode("mrow",node);
      node.appendChild(space);
    } else {		// ignored in IE
      node.setAttribute("minsize",atval);
      node.setAttribute("maxsize",atval);
    }
    return [node,str,symbol.tag];
  case LEFTBRACKET:   //read (expr+)
    if (symbol.input == "\\left") { // left what?
      symbol = AMgetSymbol(str);
      if (symbol != null) {
	if (symbol.input == ".")
	  symbol.invisible = true;
	str = AMremoveCharsAndBlanks(str,symbol.input.length);
      }
    }
    result = AMparseExpr(str,true,false);
    if (symbol==null ||
	(typeof symbol.invisible == "boolean" && symbol.invisible))
      node = AMcreateMmlNode("mrow",result[0]);
    else {
      node = AMcreateMmlNode("mo",document.createTextNode(symbol.output));
      node = AMcreateMmlNode("mrow",node);
      node.appendChild(result[0]);
    }
    return [node,result[1],result[2]];
  case MATRIX:	 //read (expr+)
    if (symbol.input == "\\begin{array}") {
      var mask = "";
      symbol = AMgetSymbol(str);
      str = AMremoveCharsAndBlanks(str,0);
      if (symbol == null)
	mask = "l";
      else {
	str = AMremoveCharsAndBlanks(str,symbol.input.length);
	if (symbol.input != "{")
	  mask = "l";
	else do {
	  symbol = AMgetSymbol(str);
	  if (symbol != null) {
	    str = AMremoveCharsAndBlanks(str,symbol.input.length);
	    if (symbol.input != "}")
	      mask = mask+symbol.input;
	  }
	} while (symbol != null && symbol.input != "" && symbol.input != "}");
      }
      result = AMparseExpr("{"+str,true,true);
//    if (result[0]==null) return [AMcreateMmlNode("mo",
//			   document.createTextNode(symbol.input)),str];
      node = AMcreateMmlNode("mtable",result[0]);
      mask = mask.replace(/l/g,"left ");
      mask = mask.replace(/r/g,"right ");
      mask = mask.replace(/c/g,"center ");
      node.setAttribute("columnalign",mask);
      node.setAttribute("displaystyle","false");
      if (isIE)
	return [node,result[1],null];
// trying to get a *little* bit of space around the array
// (IE already includes it)
      var lspace = AMcreateElementMathML("mspace");
      lspace.setAttribute("width","0.167em");
      var rspace = AMcreateElementMathML("mspace");
      rspace.setAttribute("width","0.167em");
      var node1 = AMcreateMmlNode("mrow",lspace);
      node1.appendChild(node);
      node1.appendChild(rspace);
      return [node1,result[1],null];
    } else {	// eqnarray
      result = AMparseExpr("{"+str,true,true);
      node = AMcreateMmlNode("mtable",result[0]);
      if (isIE)
	node.setAttribute("columnspacing","0.25em"); // best in practice?
      else
	node.setAttribute("columnspacing","0.167em"); // correct (but ignored?)
      node.setAttribute("columnalign","right center left");
      node.setAttribute("displaystyle","true");
      node = AMcreateMmlNode("mrow",node);
      return [node,result[1],null];
    }
  case TEXT:
      if (str.charAt(0)=="{") i=str.indexOf("}");
      else i = 0;
      if (i==-1)
		 i = str.length;
      st = str.slice(1,i);
      if (st.charAt(0) == " ") {
	node = AMcreateElementMathML("mspace");
	node.setAttribute("width","0.33em");	// was 1ex
	newFrag.appendChild(node);
      }
      newFrag.appendChild(
        AMcreateMmlNode(symbol.tag,document.createTextNode(st)));
      if (st.charAt(st.length-1) == " ") {
	node = AMcreateElementMathML("mspace");
	node.setAttribute("width","0.33em");	// was 1ex
	newFrag.appendChild(node);
      }
      str = AMremoveCharsAndBlanks(str,i+1);
      return [AMcreateMmlNode("mrow",newFrag),str,null];
  case UNARY:
      result = AMparseSexpr(str);
      if (result[0]==null) return [AMcreateMmlNode(symbol.tag,
                             document.createTextNode(symbol.output)),str];
      if (typeof symbol.func == "boolean" && symbol.func) { // functions hack
	st = str.charAt(0);
//	if (st=="^" || st=="_" || st=="/" || st=="|" || st==",") {
	if (st=="^" || st=="_" || st==",") {
	  return [AMcreateMmlNode(symbol.tag,
		    document.createTextNode(symbol.output)),str,symbol.tag];
        } else {
	  node = AMcreateMmlNode("mrow",
	   AMcreateMmlNode(symbol.tag,document.createTextNode(symbol.output)));
	  if (isIE) {
	    var space = AMcreateElementMathML("mspace");
	    space.setAttribute("width","0.167em");
	    node.appendChild(space);
	  }
	  node.appendChild(result[0]);
	  return [node,result[1],symbol.tag];
        }
      }
      if (symbol.input == "\\sqrt") {		// sqrt
	if (isIE) {	// set minsize, for \surd
	  var space = AMcreateElementMathML("mspace");
	  space.setAttribute("height","1.2ex");
	  space.setAttribute("width","0em");	// probably no effect
	  node = AMcreateMmlNode(symbol.tag,result[0])
//	  node.setAttribute("minsize","1");	// ignored
//	  node = AMcreateMmlNode("mrow",node);  // hopefully unnecessary
	  node.appendChild(space);
	  return [node,result[1],symbol.tag];
	} else
	  return [AMcreateMmlNode(symbol.tag,result[0]),result[1],symbol.tag];
      } else if (typeof symbol.acc == "boolean" && symbol.acc) {   // accent
        node = AMcreateMmlNode(symbol.tag,result[0]);
	var output = symbol.output;
	if (isIE) {
		if (symbol.input == "\\hat")
			output = "\u0302";
		else if (symbol.input == "\\widehat")
			output = "\u005E";
		else if (symbol.input == "\\bar")
			output = "\u00AF";
		else if (symbol.input == "\\grave")
			output = "\u0300";
		else if (symbol.input == "\\tilde")
			output = "\u0303";
	}
	var node1 = AMcreateMmlNode("mo",document.createTextNode(output));
	if (symbol.input == "\\vec" || symbol.input == "\\check")
						// don't allow to stretch
	    node1.setAttribute("maxsize","1.2");
		 // why doesn't "1" work?  \vec nearly disappears in firefox
	if (isIE && symbol.input == "\\bar")
	    node1.setAttribute("maxsize","0.5");
	if (symbol.input == "\\underbrace" || symbol.input == "\\underline")
	  node1.setAttribute("accentunder","true");
	else
	  node1.setAttribute("accent","true");
	node.appendChild(node1);
	if (symbol.input == "\\overbrace" || symbol.input == "\\underbrace")
	  node.ttype = UNDEROVER;
	return [node,result[1],symbol.tag];
      } else {			      // font change or displaystyle command
        if (!isIE && typeof symbol.codes != "undefined") {
          for (i=0; i<result[0].childNodes.length; i++)
            if (result[0].childNodes[i].nodeName=="mi" || result[0].nodeName=="mi") {
              st = (result[0].nodeName=="mi"?result[0].firstChild.nodeValue:
                              result[0].childNodes[i].firstChild.nodeValue);
              var newst = [];
              for (var j=0; j<st.length; j++)
                if (st.charCodeAt(j)>64 && st.charCodeAt(j)<91) newst = newst +
                  String.fromCharCode(symbol.codes[st.charCodeAt(j)-65]);
                else newst = newst + st.charAt(j);
              if (result[0].nodeName=="mi")
                result[0]=AMcreateElementMathML("mo").
                          appendChild(document.createTextNode(newst));
              else result[0].replaceChild(AMcreateElementMathML("mo").
          appendChild(document.createTextNode(newst)),result[0].childNodes[i]);
            }
        }
        node = AMcreateMmlNode(symbol.tag,result[0]);
        node.setAttribute(symbol.atname,symbol.atval);
	if (symbol.input == "\\scriptstyle" ||
	    symbol.input == "\\scriptscriptstyle")
		node.setAttribute("displaystyle","false");
	return [node,result[1],symbol.tag];
      }
  case BINARY:
    result = AMparseSexpr(str);
    if (result[0]==null) return [AMcreateMmlNode("mo",
			   document.createTextNode(symbol.input)),str,null];
    result2 = AMparseSexpr(result[1]);
    if (result2[0]==null) return [AMcreateMmlNode("mo",
			   document.createTextNode(symbol.input)),str,null];
    if (symbol.input=="\\root" || symbol.input=="\\stackrel")
      newFrag.appendChild(result2[0]);
    newFrag.appendChild(result[0]);
    if (symbol.input=="\\frac") newFrag.appendChild(result2[0]);
    return [AMcreateMmlNode(symbol.tag,newFrag),result2[1],symbol.tag];
  case INFIX:
    str = AMremoveCharsAndBlanks(str,symbol.input.length);
    return [AMcreateMmlNode("mo",document.createTextNode(symbol.output)),
	str,symbol.tag];
  default:
    return [AMcreateMmlNode(symbol.tag,        //its a constant
	document.createTextNode(symbol.output)),str,symbol.tag];
  }
}

function AMparseIexpr(str) {
  var symbol, sym1, sym2, node, result, tag, underover;
  str = AMremoveCharsAndBlanks(str,0);
  sym1 = AMgetSymbol(str);
  result = AMparseSexpr(str);
  node = result[0];
  str = result[1];
  tag = result[2];
  symbol = AMgetSymbol(str);
  if (symbol.ttype == INFIX) {
    str = AMremoveCharsAndBlanks(str,symbol.input.length);
    result = AMparseSexpr(str);
    if (result[0] == null) // show box in place of missing argument
      result[0] = AMcreateMmlNode("mo",document.createTextNode("\u25A1"));
    str = result[1];
    tag = result[2];
    if (symbol.input == "_" || symbol.input == "^") {
      sym2 = AMgetSymbol(str);
      tag = null;	// no space between x^2 and a following sin, cos, etc.
// This is for \underbrace and \overbrace
      underover = ((sym1.ttype == UNDEROVER) || (node.ttype == UNDEROVER));
//    underover = (sym1.ttype == UNDEROVER);
      if (symbol.input == "_" && sym2.input == "^") {
        str = AMremoveCharsAndBlanks(str,sym2.input.length);
        var res2 = AMparseSexpr(str);
	str = res2[1];
	tag = res2[2];  // leave space between x_1^2 and a following sin etc.
        node = AMcreateMmlNode((underover?"munderover":"msubsup"),node);
        node.appendChild(result[0]);
        node.appendChild(res2[0]);
      } else if (symbol.input == "_") {
	node = AMcreateMmlNode((underover?"munder":"msub"),node);
        node.appendChild(result[0]);
      } else {
	node = AMcreateMmlNode((underover?"mover":"msup"),node);
        node.appendChild(result[0]);
      }
      node = AMcreateMmlNode("mrow",node); // so sum does not stretch
    } else {
      node = AMcreateMmlNode(symbol.tag,node);
      if (symbol.input == "\\atop" || symbol.input == "\\choose")
	node.setAttribute("linethickness","0ex");
      node.appendChild(result[0]);
      if (symbol.input == "\\choose")
	node = AMcreateMmlNode("mfenced",node);
    }
  }
  return [node,str,tag];
}

function AMparseExpr(str,rightbracket,matrix) {
  var symbol, node, result, i, tag,
  newFrag = document.createDocumentFragment();
  do {
    str = AMremoveCharsAndBlanks(str,0);
    result = AMparseIexpr(str);
    node = result[0];
    str = result[1];
    tag = result[2];
    symbol = AMgetSymbol(str);
    if (node!=undefined) {
      if ((tag == "mn" || tag == "mi") && symbol!=null &&
	typeof symbol.func == "boolean" && symbol.func) {
			// Add space before \sin in 2\sin x or x\sin x
	  var space = AMcreateElementMathML("mspace");
	  space.setAttribute("width","0.167em");
	  node = AMcreateMmlNode("mrow",node);
	  node.appendChild(space);
      }
      newFrag.appendChild(node);
    }
  } while ((symbol.ttype != RIGHTBRACKET)
        && symbol!=null && symbol.output!="");
  tag = null;
  if (symbol.ttype == RIGHTBRACKET) {
    if (symbol.input == "\\right") { // right what?
      str = AMremoveCharsAndBlanks(str,symbol.input.length);
      symbol = AMgetSymbol(str);
      if (symbol != null && symbol.input == ".")
	symbol.invisible = true;
      if (symbol != null)
	tag = symbol.rtag;
    }
    if (symbol!=null)
      str = AMremoveCharsAndBlanks(str,symbol.input.length); // ready to return
    var len = newFrag.childNodes.length;
    if (matrix &&
      len>0 && newFrag.childNodes[len-1].nodeName == "mrow" && len>1 &&
      newFrag.childNodes[len-2].nodeName == "mo" &&
      newFrag.childNodes[len-2].firstChild.nodeValue == "&") { //matrix
	var pos = []; // positions of ampersands
        var m = newFrag.childNodes.length;
        for (i=0; matrix && i<m; i=i+2) {
          pos[i] = [];
          node = newFrag.childNodes[i];
	  for (var j=0; j<node.childNodes.length; j++)
	    if (node.childNodes[j].firstChild.nodeValue=="&")
	      pos[i][pos[i].length]=j;
        }
	var row, frag, n, k, table = document.createDocumentFragment();
	for (i=0; i<m; i=i+2) {
	  row = document.createDocumentFragment();
	  frag = document.createDocumentFragment();
	  node = newFrag.firstChild; // <mrow> -&-&...&-&- </mrow>
	  n = node.childNodes.length;
	  k = 0;
	  for (j=0; j<n; j++) {
	    if (typeof pos[i][k] != "undefined" && j==pos[i][k]){
	      node.removeChild(node.firstChild); //remove &
	      row.appendChild(AMcreateMmlNode("mtd",frag));
	      k++;
	    } else frag.appendChild(node.firstChild);
	  }
	  row.appendChild(AMcreateMmlNode("mtd",frag));
	  if (newFrag.childNodes.length>2) {
	    newFrag.removeChild(newFrag.firstChild); //remove <mrow> </mrow>
	    newFrag.removeChild(newFrag.firstChild); //remove <mo>&</mo>
	  }
	  table.appendChild(AMcreateMmlNode("mtr",row));
	}
	return [table,str];
    }
    if (typeof symbol.invisible != "boolean" || !symbol.invisible) {
      node = AMcreateMmlNode("mo",document.createTextNode(symbol.output));
      newFrag.appendChild(node);
    }
  }
  return [newFrag,str,tag];
}

function AMparseMath(str) {
  var result, node = AMcreateElementMathML("mstyle");
  if (mathcolor != "") node.setAttribute("mathcolor",mathcolor);
  if (mathfontfamily != "") node.setAttribute("fontfamily",mathfontfamily);
  node.appendChild(AMparseExpr(str.replace(/^\s+/g,""),false,false)[0]);
  node = AMcreateMmlNode("math",node);
  if (showasciiformulaonhover)                      //fixed by djhsu so newline
    node.setAttribute("title",str.replace(/\s+/g," "));//does not show in Gecko
  if (mathfontfamily != "" && (isIE || mathfontfamily != "serif")) {
    var fnode = AMcreateElementXHTML("font");
    fnode.setAttribute("face",mathfontfamily);
    fnode.appendChild(node);
    return fnode;
  }
  return node;
}

function AMstrarr2docFrag(arr, linebreaks) {
  var newFrag=document.createDocumentFragment();
  var expr = false;
  for (var i=0; i<arr.length; i++) {
    if (expr) newFrag.appendChild(AMparseMath(arr[i]));
    else {
      var arri = (linebreaks ? arr[i].split("\n\n") : [arr[i]]);
      newFrag.appendChild(AMcreateElementXHTML("span").
      appendChild(document.createTextNode(arri[0])));
      for (var j=1; j<arri.length; j++) {
        newFrag.appendChild(AMcreateElementXHTML("p"));
        newFrag.appendChild(AMcreateElementXHTML("span").
        appendChild(document.createTextNode(arri[j])));
      }
    }
    expr = !expr;
  }
  return newFrag;
}

function AMprocessNodeR(n, linebreaks) {
  var mtch, str, arr, frg, i;
  if (n.childNodes.length == 0) {
   if ((n.nodeType!=8 || linebreaks) &&
    n.parentNode.nodeName!="form" && n.parentNode.nodeName!="FORM" &&
    n.parentNode.nodeName!="textarea" && n.parentNode.nodeName!="TEXTAREA" &&
    n.parentNode.nodeName!="pre" && n.parentNode.nodeName!="PRE") {
    str = n.nodeValue;
    if (!(str == null)) {
      str = str.replace(/\r\n\r\n/g,"\n\n");
      str = str.replace(/\x20+/g," ");
      str = str.replace(/\s*\r\n/g," ");
// DELIMITERS:
      mtch = (str.indexOf("\$")==-1 ? false : true);
      str = str.replace(/([^\\])\$/g,"$1 \$");
      str = str.replace(/^\$/," \$");	// in case \$ at start of string
      arr = str.split(" \$");
      for (i=0; i<arr.length; i++)
	arr[i]=arr[i].replace(/\\\$/g,"\$");
      if (arr.length>1 || mtch) {
        if (checkForMathML) {
          checkForMathML = false;
          var nd = AMisMathMLavailable();
          AMnoMathML = nd != null;
          if (AMnoMathML && notifyIfNoMathML)
            if (alertIfNoMathML)
              alert("To view the ASCIIMathML notation use Internet Explorer 6 +\nMathPlayer (free from www.dessci.com)\n\
                or Firefox/Mozilla/Netscape");
            else AMbody.insertBefore(nd,AMbody.childNodes[0]);
        }
        if (!AMnoMathML) {
          frg = AMstrarr2docFrag(arr,n.nodeType==8);
          var len = frg.childNodes.length;
          n.parentNode.replaceChild(frg,n);
          return len-1;
        } else return 0;
      }
    }
   } else return 0;
  } else if (n.nodeName!="math") {
    for (i=0; i<n.childNodes.length; i++)
      i += AMprocessNodeR(n.childNodes[i], linebreaks);
  }
  return 0;
}

function AMprocessNode(n, linebreaks, spanclassAM) {
  var frag,st;
  if (spanclassAM!=null) {
    frag = document.getElementsByTagName("span")
    for (var i=0;i<frag.length;i++)
      if (frag[i].className == "AM")
        AMprocessNodeR(frag[i],linebreaks);
  } else {
    try {
      st = n.innerHTML;
    } catch(err) {}
// DELIMITERS:
    if (st==null || st.indexOf("\$")!=-1)
      AMprocessNodeR(n,linebreaks);
  }
  if (isIE) { //needed to match size and font of formula to surrounding text
    frag = document.getElementsByTagName('math');
    for (var i=0;i<frag.length;i++) frag[i].update()
  }
}

var AMbody;
var AMnoMathML = false, AMtranslated = false;

function translate(spanclassAM) {
  if (!AMtranslated) { // run this only once
    AMtranslated = true;
    AMinitSymbols();
    AMbody = document.getElementsByTagName("body")[0];
    AMprocessNode(AMbody, false, spanclassAM);
  }
}

if (isIE) { // avoid adding MathPlayer info explicitly to each webpage
  document.write("<object id=\"mathplayer\"\
  classid=\"clsid:32F66A20-7614-11D4-BD11-00104BD3F987\"></object>");
  document.write("<?import namespace=\"m\" implementation=\"#mathplayer\"?>");
}

// GO1.1 Generic onload by Brothercake
// http://www.brothercake.com/
//onload function (replaces the onload="translate()" in the <body> tag)
function generic()
{
  translate();
};
//setup onload function
if(typeof window.addEventListener != 'undefined')
{
  //.. gecko, safari, konqueror and standard
  window.addEventListener('load', generic, false);
}
else if(typeof document.addEventListener != 'undefined')
{
  //.. opera 7
  document.addEventListener('load', generic, false);
}
else if(typeof window.attachEvent != 'undefined')
{
  //.. win/ie
  window.attachEvent('onload', generic);
}
//** remove this condition to degrade older browsers
else
{
  //.. mac/ie5 and anything else that gets this far
  //if there's an existing onload function
  if(typeof window.onload == 'function')
  {
    //store it
    var existing = onload;
    //add new onload handler
    window.onload = function()
    {
      //call existing onload function
      existing();
      //call generic onload function
      generic();
    };
  }
  else
  {
    //setup onload function
    window.onload = generic;
  }
}
/*]]>*/
</script>
</head>
<body class="book">
<div id="header">
<h1>Устройство Tomb Raider (TRosettaStone)</h1>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="tableblock">
<table rules="none"
width="100%"
frame="void"
cellspacing="0" cellpadding="4">
<col width="99%" />
<col width="1%" />
<tbody>
<tr>
<td align="left" valign="middle"><div><div class="paragraph"><p><strong>Версия документа: 3.00 (последний раз отредактировано: 2015-08-17)</strong></p></div>
<div class="paragraph"><p>Включает в себя информацию об Tomb Raider <code>.PHD/.TUB</code>, Tomb Raider II-III <code>.TR2</code>, Tomb Raider IV <code>.TR4</code> файлах и Tomb Raider Chronicles (V) <code>.TRC</code> файлах, если таковая информация имеется.</p></div>
<div class="paragraph"><p>Также включает в себя информацию о <code>TOMBPC.DAT</code> скриптах, <code>CDAUDIO.WAD</code> и <code>CUTSEQ.PAK</code> файлах.</p></div></div></td>
<td align="right" valign="middle"><div><div class="paragraph"><p><span class="image">
<img src="images/logo/trosej-mid.png" alt="logo/trosej-mid.png" />
</span></p></div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_введение">1. Введение</h2>
<div class="sectionbody">
<div class="paragraph"><p>До сих пор сообщество Tomb Raider, главным образом программисты и энтузиасты моддеры, ссылались на документ под названием <em>TRosettaStone</em>, который не обновлялся с 1999 года, и его пересмотренный вариант (мы назвали его <em>TRosettaStone 2</em>), который был выполнен E. Поповым (E. Popov) в 2000 или 2001 году. Оба этих документа, помогавших в свое время, страдали от многих ошибок и неточностей.</p></div>
<div class="paragraph"><p>Многие люди нашли эти ошибки и неточности, но никто из них не переделал существующей документации, сохраняя все свои знания только в своей голове. Общеизвестно, что оригиналу не хватает некоторой информации то здесь, то там, и что-то неправильно описано&#8201;&#8212;&#8201;но это нигде не упоминается (за исключением некоторых потерянных сообщений на форумах). Так что, когда новичок начинает программировать, он должен наступить на те же грабли, что и все остальные.</p></div>
<div class="quoteblock">
<div class="content">&#8220;Такого быть не должно.&#8221;</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>Цель <em>TRosettaStone 3</em> заключается в замене оригинального документа и служить в качестве всеобъемлющего источника информации для тех, кто готов участвовать в разработке программного обеспечения для Tomb Raider. Мы будем использовать оригинальную TRosettaStone в качестве основы, в значительной степени заимствования из переиздания Е. Попова. Кроме того, этот документ будет широко заимствовать информацию из руководства пользователей TREP, инструкции, NGLE и информацию с кучи тем форумов и сообщений, касающихся внутренней структуры движка игры.</p></div>
<div class="paragraph"><p>Тем не менее, в то время как оригинальный TRosettaStone и обновление Попова были направлены в первую очередь на изучение уже существующих игровых активов, такие как уровни, звуковые файлы, скрипты и т.д., этот документ создается в общем и в качестве эталона для программистов, создающих повторно игровые движки с открытым исходным кодом. Из-за этого мы иногда будем исследовать не только форматы файлов игры, но и внутреннюю логику игры, процедуры и другие связанные аспекты. Этот документ будет обновляться синхронно с развитием <em>OpenTomb</em>, одним из таких повторных проектов, который получил много отзывов от сообщества.</p></div>
<div class="sect2">
<h3 id="_описание">1.1. Описание</h3>
<div class="paragraph"><p>Этот документ содержит подробные описания форматов файлов данных оригинальной Tomb Raider. Предполагается, что читатель имеет знания и опыт программирования на C или C++ и имеет, по меньшей мере, общее знакомство с графическим программированием. Этот документ является автономным; все гиперссылки ссылаются только на документ.</p></div>
<div class="paragraph"><p>Вся информация в этом документе, была получена самостоятельно, без помощи или оказания поддержки любого из Core Design или Eidos. Таким образом, в этом документе информация может содержать ошибки или упущения, а многие структуры и имена переменных были выведены из интерпретации данных (и, следовательно, может ввести в заблуждение или совершенно неправильно быть истолковано). Тем не менее, мы вновь используем определенные имена переменных и функций отличных от оригинальной отладочной сборки Tomb Raider и таблицы символов из просочившейся Tomb Raider Chronicles PSX SDK.</p></div>
<div class="paragraph"><p>Вся информация в этом документе была проверена и, следовательно, правдоподобна, но также может быть неверно истолкована. Вся информация в настоящем документе, предоставляется как есть&#8201;&#8212;&#8201;вы получаете ровно столько, сколько платите, получаете свободно. Это свободный проект, который намерен документировать форматы файлов Tomb Raider.</p></div>
</div>
<div class="sect2">
<h3 id="_условности">1.2. Условности</h3>
<div class="paragraph"><p>Вообще, версии игры используют сокращения:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>TR1</strong> сокращение для Tomb Raider и Tomb Raider: Unfinished Business
</p>
</li>
<li>
<p>
<strong>TR2</strong> сокращение для Tomb Raider II и Tomb Raider: The Golden Mask
</p>
</li>
<li>
<p>
<strong>TR3</strong> сокращение для Tomb Raider III и Tomb Raider: The Lost Artifact
</p>
</li>
<li>
<p>
<strong>TR4</strong> сокращение для Tomb Raider: The Last Revelation
</p>
</li>
<li>
<p>
<strong>TR5</strong> сокращение для Tomb Raider: Chronicles
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>Форматы уровня <strong>TR4</strong> относятся не только к оригинальной игре, но и к <em>пользовательским уровням</em> собранными фанатами с помощью <em>Tomb Raider Level Editor</em> (<code>winroomedit.exe</code>) версии <code>.49</code>, используемого для работы с TR4-специфичными файлами уровней. Эта версия редактора единственный редактор официально выпущенный Eidos / Core, наряду с TR5.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Когда мы приводим некоторую зависимую от версий информацию о некоторых структурах или методах, эта информация будет помечена специальными изображениями, обозначающими версию игры этими картинками: <span class="image">
<img src="images/icons/tr1.png" alt="TR1 only" width="16" height="17" title="TR1 only" />
</span> для TR1, <span class="image">
<img src="images/icons/tr2.png" alt="TR2 only" width="16" height="17" title="TR2 only" />
</span> для TR2, <span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span> для TR3, <span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span> для TR4, и <span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> для TR5. Версия-зависимая информация будет продолжена до следующего параграфа или списка записи, пока не указано иное.</p></div>
<div class="paragraph"><p>Кроме того, если внешние программы и утилиты участвуют, вот сокращения для них:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>TRLE</strong> сокращение для Tomb Raider Level Editor&#8201;&#8212;&#8201;официальная утилита Core Design для изменения уровней.
</p>
</li>
<li>
<p>
<strong>NGLE</strong> сокращение для TRLE версии, которая была неофициально исправлена и в настоящее время широко используется для редактирования уровней сообществом.
</p>
</li>
<li>
<p>
<strong>Dxtre3d</strong> сокращение для так называемого <em>неофициального</em> редактора уровней созданного Felix aka <em>Turbo Pascal</em>.
</p>
</li>
<li>
<p>
<strong>TREP</strong> сокращение для бинарного патчера который используется для изменения <em>движка TR4</em> в <em>редактор уровней</em> (в связке с TR5) для включения некоторых улучшений от сообщества.
</p>
</li>
<li>
<p>
<strong>TRNG</strong> еще один патчер для тех же целей, что и  TREP, впрочем, несовместимый с ним. TRNG предоставляет более дополнительные возможности и улучшения для <em>движка TR4</em>.
</p>
</li>
<li>
<p>
<strong>FLEP</strong> сокращение для аналогичного патчера из <em>TREP</em>, который используется для того же <em>движка TR4</em>, предварительно модифицированного до <em>TRNG</em>.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_пока_не_известно">1.3. Пока не известно</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Структура освещения комнат из TR4 требует дополнительного пояснения.
</p>
</li>
<li>
<p>
То же самое для структуры освещения комнаты в TR5.
</p>
</li>
<li>
<p>
Точное значение понятия "слой комнаты" в TR5.
</p>
</li>
<li>
<p>
Уточнить значение для <em>4-го бита</em> в структуре <a href="#tr2_room_vertex">[tr2_room_vertex]</a>.
</p>
</li>
<li>
<p>
Уточнить назначение поля <code>Normal</code> в структуре <a href="#tr5_room_vertex">[tr5_room_vertex]</a>, и действительно ли поле <code>Attributes</code> было удалено.
</p>
</li>
<li>
<p>
Вся структура <code>tr5_room</code> нуждается в детальном анализе из за всех лишних <em>Unknown</em> полей.
</p>
</li>
<li>
<p>
Уточнить значения теней, влияющих на их радиус.
</p>
</li>
<li>
<p>
Определить назначение поля &#8220;flag/zone&#8221; в структуре <code>tr_camera</code>.
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_авторские_права">1.4. Авторские права</h3>
<div class="paragraph"><p>Tomb Raider, Tomb Raider Gold, Unfinished Business, Tomb Raider II, Tomb Raider III, Tomb Raider: The Last Revelation, Tomb Raider Chronicles, Лара Крофт, и
все изображения и данные внутри файлов игры и игрового движка являются Авторским правом © Square Enix.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_fundamentals">2. The Fundamentals</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_file_types">2.1. File Types</h3>
<div class="paragraph"><p>Tomb Raider is driven by various sets of files&#8201;&#8212;&#8201;level files, script files, FMVs, audio tracks and sound files. In TR4 and TR5, there is also specific file
type which contains cutscene data&#8201;&#8212;&#8201;<em>cutseq pack</em>.</p></div>
<div class="sect3">
<h4 id="_the_script_files">2.1.1. The Script Files</h4>
<div class="paragraph"><p>The script file structure differs from version to version.</p></div>
<div class="paragraph"><p>In TR1, all script info was embedded into executable file (<code>TOMB.EXE</code>), and thus is <em>hardcoded</em>. TR2 and TR3 had unified <code>TOMBPC.DAT</code> file, which contains all the
text strings describing the various elements in the game (e.g. the game engine knows about &#8220;Key 1&#8221;; it looks in <code>TOMBPC.DAT</code> to determine the name to be
displayed in Lara&#8217;s inventory, such as &#8220;Rusty Key&#8221; or &#8220;Taste rostige&#8221; or &#8220;Cle Rouillee&#8221;), the level and cut-scene filenames (e.g. <code>WALL.TR2</code>,
<code>CUT3.TR2</code>), the order in which they are to be played, and various per-level and per-game configuration options (e.g. what weapons and objects Lara starts the
level with, whether or not the &#8220;cheat&#8221; codes work, etc.).</p></div>
<div class="paragraph"><p>TR4 and TR5 introduced a new script format, where the actual script defining the gameflow was separated from text strings used in game&#8201;&#8212;&#8201;hence, both TR4 and
TR5 have two <code>.DAT</code> files&#8201;&#8212;&#8201;<code>SCRIPT.DAT</code> and <code>LANGUAGE.DAT</code>, where <code>LANGUAGE</code> differs depending on regional origin of the game&#8201;&#8212;&#8201;<code>US.DAT</code>, <code>FRENCH.DAT</code>,
<code>JAPANESE.DAT</code>, and so on.</p></div>
</div>
<div class="sect3">
<h4 id="_the_level_files">2.1.2. The Level Files</h4>
<div class="paragraph"><p>The level files, <code>{level-name}.PHD/TUB/TR2/TR4/TRC</code>, contain everything about the level, including the geographical geometry, the geometry (meshes) of all
animate and inanimate objects in the level, all the textures and colour data, all animation data, index information (and, in TR1, TR4 and TR5&#8201;&#8212;&#8201;also the
<em>actual sound sample data</em>) for all sounds, accessibility maps&#8201;&#8212;&#8201;everything necessary to run the game. For whatever reason, Core has included everything in one
file instead of breaking it up into logical groupings; this means that every level contains all the meshes, textures, sound information, and animation data for
Lara and all of her weapons. There are a fair number of other redundancies, too.</p></div>
<div class="paragraph"><p>Since TR4, the level file is divided into <em>several chunks</em>, each of them being compressed with <em>zlib</em>. Usually, each chunk of compressed data is preceded by two
32-bit unsigned integers defining the <em>uncompressed size</em> of the chunk and the <em>compressed size</em> of the chunk. Therefore, the engine allocates an empty buffer
equal to the <em>uncompressed size</em> of a specific chunk, and another buffer equal to the <em>compressed size</em>. The compressed data is loaded directly within it based
on the <em>compressed size</em>. The compressed data is then decompressed into the result buffer and the buffer containing the compressed data is destroyed.</p></div>
<div class="paragraph"><p>It&#8217;s good to note the origins of level file extension. While it is obvious that TR2/TR4/TRC extensions specify abbreviations of the game name. <code>.PHD</code> is
actually the initials of the <em>Lead Programmer</em> for Tomb Raider 1: <em>Paul Howard Douglas</em>. Looks like this programmer contributed a lot of the code during early
development stages of Tomb Raider. This is suggested because the <em>phd</em> initials also became a prefix for several helper functions in the original source code,
for instance: <code>phd_sin</code>, <code>phd_cos</code> etc. Most likely, he was also responsible for developing the level file structure for Tomb Raider.</p></div>
</div>
<div class="sect3">
<h4 id="_fmvs_full_motion_videos">2.1.3. FMVs (Full Motion Videos)</h4>
<div class="paragraph"><p>TR1-3 shared the same proprietary Eidos codec for videos, called <em>Escape</em>. The extension for such files is <code>.RPL</code>, that&#8217;s why they occasionally (and
mistakingly) called Replay codec. Signature feature of RPL videos is that they are always interlaced with black stripes; most likely, this was used to conserve
disk space (however, <em>PlayStation</em> videos were in <code>.STR</code> format, which is basic MPEG compression, and they had no interlacing&#8201;&#8212;&#8201;but suffered from blocking
issues). In TR1 and TR2, framerate was limited to 15 FPS, while in TR3 it was doubled to 30 FPS.</p></div>
<div class="paragraph"><p>For a long time, Escape codec was largely unexplored and barely reverse-engineered; there was only an abandoned open source <em>Mplayer</em> implementation for some
Escape codec versions, but recent <em>ffmpeg</em> revisions feature fully functional decoder for Escape videos.</p></div>
<div class="paragraph"><p>Since TR4, all FMVs are in <em>Bink Video</em> format, which is much more common and easy to rip, convert and explore.</p></div>
</div>
<div class="sect3">
<h4 id="_sound_files_8201_8212_8201_audio_tracks">2.1.4. Sound Files&#8201;&#8212;&#8201;Audio Tracks</h4>
<div class="paragraph"><p>These are long sound files which occasionally play either on some in-game events (e.g. approaching certain important checkpoint in game, like big hall with
ladder and two wolves in &#8220;Caves&#8221;&#8201;&#8212;&#8201;it triggers danger music theme) or in looped manner as background ambience. Audio tracks are stored differently across TR
game versions&#8201;&#8212;&#8201;<em>CD-Audio</em> in TR1-TR2, single merged file <code>CDAUDIO.WAD</code> in TR3, and separate audio files in TR4 and TR5.</p></div>
</div>
<div class="sect3">
<h4 id="_sound_files_8201_8212_8201_samples">2.1.5. Sound Files&#8201;&#8212;&#8201;Samples</h4>
<div class="paragraph"><p>TR2 and TR3 also featured external sound sample files, which allowed to share samples between all level files. This sound file is called <code>MAIN.SFX</code>, and usually
placed in <code>DATA</code> subfolder. Hence, engine loads sound samples not from level files (as it&#8217;s done in TR1, TR4 and TR5&#8201;&#8212;&#8201;see above), but rather from this
<code>MAIN.SFX</code> file.</p></div>
</div>
<div class="sect3">
<h4 id="_cut_sequence_packs">2.1.6. Cut Sequence Packs</h4>
<div class="paragraph"><p>TR4 and TR5 featured special data type containing all the necessary information to play <em>in-game cutscenes</em>. While in earlier games such info was embedded into
the level file itself, and generally, cutscenes themselves were separate level files (easily distinguished by their filenames, e.g. <code>CUT1.TR2</code> etc.), TR4
changed this approach, and cutscenes could be loaded and played right inside level files at runtime.</p></div>
<div class="paragraph"><p>The data for such cutscene setup was packed into single file titled <code>CUTSEQ.PAK</code> in TR4 or <code>CUTSEQ.BIN</code> in TR5. There will be a special section describing whole
cutseq file format.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_basic_data_types">2.2. Basic Data Types</h3>
<div class="paragraph"><p>For the purposes of further discussion, the following are assumed:</p></div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="70%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="83%" />
<tbody>
<tr>
<td align="right" valign="top"><p class="table"><code>int8_t</code></p></td>
<td align="left" valign="top"><p class="table">specifies an 8-bit signed integer (range -128..127)</p></td>
</tr>
<tr>
<td align="right" valign="top"><p class="table"><code>uint8_t</code></p></td>
<td align="left" valign="top"><p class="table">specifies an 8-bit unsigned integer (range 0..255)</p></td>
</tr>
<tr>
<td align="right" valign="top"><p class="table"><code>int16_t</code></p></td>
<td align="left" valign="top"><p class="table">specifies a 16-bit signed integer (range -32768..32767)</p></td>
</tr>
<tr>
<td align="right" valign="top"><p class="table"><code>uint16_t</code></p></td>
<td align="left" valign="top"><p class="table">specifies a 16-bit unsigned integer (range 0..65535)</p></td>
</tr>
<tr>
<td align="right" valign="top"><p class="table"><code>int32_t</code></p></td>
<td align="left" valign="top"><p class="table">specifies a 32-bit signed integer (range -2147483648..2147483647)</p></td>
</tr>
<tr>
<td align="right" valign="top"><p class="table"><code>uint32_t</code></p></td>
<td align="left" valign="top"><p class="table">specifies a 32-bit unsigned integer (range 0..4294967295)</p></td>
</tr>
<tr>
<td align="right" valign="top"><p class="table"><code>float</code></p></td>
<td align="left" valign="top"><p class="table">specifies a 32-bit IEEE-754 floating-point number</p></td>
</tr>
<tr>
<td align="right" valign="top"><p class="table"><code>fixed</code></p></td>
<td align="left" valign="top"><p class="table">specifies a 32-bit non-trivial 16.16 fixed point value&#8201;&#8212;&#8201;see further</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>All multi-byte integers (<code>{u}int16_t</code>, <code>{u}int32_t</code>) are stored in little-endian (Intel-x86, etc.) format, with the least significant byte stored first and the
most significant byte stored last. When using this data in platforms with big-endian (PowerPC, etc.) number format, be sure to reverse the order of bytes.</p></div>
<div class="sect3">
<h4 id="_16_16_fixed_point_data_type">2.2.1. 16.16 Fixed Point Data Type</h4>
<div class="paragraph"><p>This very specific 32-bit data type mimics floating-point behaviour, <em>while remaining integer</em>. It is done by splitting floating-point value into whole and
fractional parts, and keeping each part as <code>int16_t</code> and <code>uint16_t</code> correspondingly. Whole part is kept as it is, while fractional part is multiplied by 65536,
and then kept as unsigned integer. So, the formula to calculate floating-point from mixed float is:</p></div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="100%"
frame="void"
cellspacing="0" cellpadding="4">
<col width="100%" />
<tbody>
<tr>
<td align="center" valign="top"><p class="table">$F_{real} = P_{whole} + ( P_{frac} \div 65536 )$</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>&#8230;where $P_{whole}$ is whole part of mixed float (signed), and $P_{frac}$ is fractional part of mixed float (unsigned).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>The reason why such complicated setup was invented is to avoid using floating-point numbers. In 90% of all cases, Tomb Raider engines use integer numbers, even
for geometry calculations and animation interpolations. The root of this setup lies in multi-platform nature of the code, which was simultaneously written for
PC and PlayStation. While PCs had enough computational power to deal with floats at that time, PlayStation relied only on integers.</p></div>
<div class="paragraph"><p>However, some internal variables and constants (like drawing distance, fog distance constants and some light properties) are PC-specific and stored in floating
point numbers. Also, last game in series, TR5, extensively used floating-point numbers for certain data types&#8201;&#8212;&#8201;like colours, vertices and coordinates.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_data_alignment">2.2.2. Data Alignment</h4>
<div class="paragraph"><p>Data alignment is something one has to be careful about. When some entity gets an address that is a multiple of $n$, it is said to be
$n$-byte aligned. The reason it is important here is that some systems prefer multibyte alignment for multibyte quantities, and compilers for such
systems may pad the data to get the &#8220;correct&#8221; alignments, thus making the in-memory structures out of sync with their file counterparts. However, a compiler
may be commanded to use a lower level of alignment, one that will not cause padding. And for TR&#8217;s data structures, 2-byte alignment should be successful in
nearly all cases, with exceptions noted below.</p></div>
<div class="paragraph"><p>To set single-byte alignment in any recent compiler, use the following compiler directive:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">#pragma pack(push, 1)</span>
</pre></div></div></div>
<div class="paragraph"><p>To return to the project&#8217;s default alignment, use the following directive:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">#pragma pack(pop)</span>
</pre></div></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_basic_terms">2.3. Basic Terms</h3>
<div class="sect3">
<h4 id="_coordinates">2.3.1. Coordinates</h4>
<div class="paragraph"><p>The world coordinate system is oriented with the $X-Z$ plane horizontal and $Y$ vertical, with $-Y$ being &#8220;up&#8221; (e.g.
decreasing $Y$ values indicate increasing altitude). The world coordinate system is specified using <code>int32_t</code> values; however, the geography is
limited to the $+X$/$+Z$ quadrant for reasons that are explained below. Mesh coordinates are relative and are specified using <code>int16_t</code>.</p></div>
<div class="paragraph"><p>There are some additional coordinate values used, such as &#8220;the number of 1024-unit blocks between points A and B&#8221;;  these are simply scaled versions of more
conventional coordinates.</p></div>
</div>
<div class="sect3">
<h4 id="_colours">2.3.2. Colours</h4>
<div class="paragraph"><p>All colours in TR are specified either explicitly (using either the <a href="#tr_colour">[tr_colour]</a> structure, described below, 16-bit structures or 32-bit structures) or
implicitly, by indexing one of the palettes. However, it is only applicable to TR1-3&#8201;&#8212;&#8201;there is no palette in TR4 and TR5.</p></div>
<div class="paragraph"><p>In TR1-3, mesh surfaces could be either <em>coloured</em> or <em>textured</em>. <em>Coloured</em> surfaces are &#8220;painted&#8221; with a single colour that is either specified explicitly
or using an index into the palette.</p></div>
<div class="paragraph"><p>Beginning from TR4, coloured faces feature was removed, so each face must have a texture attached to it.</p></div>
</div>
<div class="sect3">
<h4 id="_textures">2.3.3. Textures</h4>
<div class="paragraph"><p><em>Textured</em> surfaces map textures (bitmapped images) from the texture tiles (textiles) to each point on the mesh surface.  This is done using conventional UV
mapping, which is specified in &#8220;Object Textures&#8221; below; each object texture specifies a mapping from a set of vertices to locations in the textile, and these
texture vertices are associated with position vertices specified here. Each textile is a 256x256 pixels wide area.</p></div>
<div class="paragraph"><p>The 16-bit textile array, which contains <a href="#tr_textile16">[tr_textile16]</a> structures, specifies colours using 16-bit ARGB, where the highest bit (<code>0x8000</code>) is a crude alpha
channel (really just simple transparency&#8201;&#8212;&#8201;<em>0 = transparent</em>, <em>1 = opaque</em>).  The next 5 bits (<code>0x7C00</code>) specify the red channel, the next 5 bits (<code>0x03E0</code>)
specify the green channel, and the last 5 bits (<code>0x001F</code>) specify the blue channel, each on a scale from 0..31.</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr1.png" alt="TR1 only" width="16" height="17" title="TR1 only" />
</span><span class="image">
<img src="images/icons/tr2.png" alt="TR2 only" width="16" height="17" title="TR2 only" />
</span><span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span> If, for some reason, 16-bit textures are turned off, all colours and textures use an 8-bit palette that is stored in the level file.  This
palette consists of a 256-element array of <a href="#tr_colour">[tr_colour]</a> structures, each designating some colour;  textures and other elements that need to reference a colour
specify an index (0..255) into the <code>Palette[]</code> array.  There is also a 16-bit palette, which is used for identifying colours of solid polygons.  The 16-bit
palette contains up to 256 four-byte entries;  the first three bytes are a <a href="#tr_colour">[tr_colour]</a>, while the last byte is ignored (set to 0).</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> The 32-bit textile array, which contains <a href="#tr4_textile32">[tr4_textile32]</a> structures, specifies colours using 32-bit ARGB, where the highest byte (A) is unused. The next bytes specify (in this order) the red / green / blue channels. The 16-bit and 32-bit textile arrays depict the same graphics data, but of course the 32-bit array has a better colour resolution. It&#8217;s the one used if you select a 32-bit A8R8G8B8 texture format in the setup menu from TR4 and TR5.</p></div>
</div>
<div class="sect3">
<h4 id="_meshes_and_sprites">2.3.4. Meshes and Sprites</h4>
<div class="paragraph"><p>There are two basic types of &#8220;visible objects&#8221; in TR2&#8201;&#8212;&#8201;meshes and sprites.</p></div>
<div class="paragraph"><p><em>Meshes</em> are collections of textured or coloured polygons that are assembled to form a three-dimensional object (such as a tree, a tiger, or Lara herself). The
&#8220;rooms&#8221; themselves are also composed of meshes. Mesh objects may contain more than one mesh; though these meshes are moved relative to each other, each mesh
is rigid.</p></div>
<div class="paragraph"><p><em>Sprites</em> are two-dimensional images that are inserted into three-dimensional space, such as the &#8220;secret&#8221; dragons, ammunition, medi-packs, etc. There are also
animated sprite sequences, such as the fire at the end of &#8220;The Great Wall.&#8221; Core had presumably used this method to reduce CPU utilization on the PlayStation
and/or the earlier PCs. Sprites become less and less abundant; TR2 has very few scenery sprites, and TR3&#8217;s pickups are models instead of sprites.</p></div>
</div>
<div class="sect3">
<h4 id="_entities">2.3.5. Entities</h4>
<div class="paragraph"><p>Each Tomb Raider game has an internal hardcoded set of <em>entity types</em>, each of them linked to specific <em>model</em> (hence, <em>entity type</em> and <em>model</em> can be considered equal). Entity is an individual object with its own specific
function and purpose. Almost every &#8220;moving&#8221; or &#8220;acting&#8221; thing you see is an entity&#8201;&#8212;&#8201;like enemies, doors, pick-up items, and even Lara herself.</p></div>
<div class="paragraph"><p>A level can contain numerous instances of the same entity type, e.g. ten crocodiles, five similar doors and switches, and so on.</p></div>
<div class="paragraph"><p>Entities are referenced in one of two ways&#8201;&#8212;&#8201;as an offset into an array (e.g. <code>Entities[i]</code>) or internally, using an unique index . In the latter case, the related array (<code>Entities[]</code>) is searched until a matching index is found. Each entity also refers to its <code>entity type</code> by <code>TypeID</code> to select behaviour and model to draw. In this case, <code>Models[]</code> array is searched for matching <code>TypeID</code> until one found.</p></div>
</div>
<div class="sect3">
<h4 id="_animations">2.3.6. Animations</h4>
<div class="paragraph"><p>There are three basic types of animations in TR, two corresponding with textures&#8201;&#8212;&#8201;sprite animations and animated textures&#8201;&#8212;&#8201;and one corresponding directly
with meshes.</p></div>
<div class="sect4">
<h5 id="_sprite_animations">Sprite Animations</h5>
<div class="paragraph"><p>Sprite animation (sprite sequences) consists simply of a series of sprites that are to be displayed one after another, e.g. grenade explosions. Sprite
animations were quite common in earlier games (TR1 and TR2), while in TR3 onwards there are almost no sprite animations&#8201;&#8212;&#8201;only notable example is fire particle
sprites and water splash effect.</p></div>
</div>
<div class="sect4">
<h5 id="_animated_textures">Animated Textures</h5>
<div class="paragraph"><p>These are either a list of textures cycled through in endless loop, or (in TR4-5) a single texture with shifting coordinates, creating an illusion of
&#8220;rolling&#8221; image.</p></div>
</div>
<div class="sect4">
<h5 id="_mesh_animations">Mesh Animations</h5>
<div class="paragraph"><p>Mesh animations are much more complex than sprite and texture animations, and done by what is essentially a skeletal-modeling scheme. These involve some arrays
(Frames[] and MeshTree[]) of offsets and rotations for each element of a composite mesh. Frames are then grouped into an array (Animations[]) that describes
discrete &#8220;movements&#8221;, e.g. Lara taking a step or a tiger striking with its paw. The animations are “sewn together” by a state change array and an animation
dispatch array, which, together with state information about the character, ensure that the animation is fluid (e.g. if Lara is running and the player releases
the RUN key, she will stop; depending upon which of her feet was down at the time, either her left or right foot will strike the floor as part of the &#8220;stop&#8221;
animation. The correct animation (left foot stop vs. right foot stop) is selected using these structures and the state information).</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_lighting">2.3.7. Lighting</h4>
<div class="paragraph"><p>There are two main types of lighting in Tomb Raider, <em>constant</em> and <em>vertex</em>. Constant lighting means that all parts of an object have the same illumination,
while in vertex lighting, each polygon vertex has its own light value, and the illumination of the polygon interiors is interpolated from the vertex values.</p></div>
<div class="paragraph"><p>Furthermore, lighting can be either internal or external. Internal lighting is specified in an object’s data, external lighting is calculated using the room’s
light sources (ambient light, point light sources, spotlights (TR4-5), dynamic lights).</p></div>
<div class="paragraph"><p>When available, external lighting also uses the vertex normals to calculate the incoming light at each vertex. Light intensities are described either with a
single value or with a 16 bits color value (you can see it more like a &#8220;color filter&#8221;), depending mainly on the TR version.</p></div>
<div class="paragraph"><p>Light intensities are described with a single value in TR1 and a pair of values in TR2 and TR3; the paired values are almost always equal, and the pairing may
reflect some feature that was only imperfectly implemented, such as off/on or minimum/maximum values. In TR1 and TR2, the light values go from 0 (maximum light)
to 8192 (minimum light), while in TR3, the light values go from 0 (minimum light) to 32767 (maximum light).</p></div>
</div>
<div class="sect3">
<h4 id="_sound_samples">2.3.8. Sound Samples</h4>
<div class="paragraph"><p>There are two ways for sound samples to play.</p></div>
<div class="paragraph"><p>First one is basically sound emitter sitting at a static global position in level, and continuously emitting specified sound (such as waterfalls&#8201;&#8212;&#8201;these are in
<code>SoundSources[]</code>). Second one is triggered sounds&#8201;&#8212;&#8201;these are sounds played when some event happens, such as at certain animation frames (footsteps and other
Lara sounds), when doors open and close, and when weapons are fired.</p></div>
<div class="paragraph"><p>Either way, each played sound is referred to using a three-layer indexing scheme, to provide a maximum amount of abstraction. An internal sound index references
<code>SoundMap[]</code>, which points to a <code>SoundDetails[]</code> record, which in turn points to a <code>SampleIndices[]</code> entry, which in turn points to a sound sample.
<code>SoundDetails[]</code>, contains such features as sound intensity, how many sound samples to choose from, among others. The sound samples themselves are in Microsoft
WAVE format, and, as already mentioned, they are embedded either in the data files (TR1, TR4 and TR5) or in a separate file (<code>MAIN.SFX</code>) in TR2 and TR3.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_basic_data_structures">2.4. Basic Data Structures</h3>
<div class="paragraph"><p>Much of the .TR2 file is comprised of structures based on a few fundamental data structures, described below.</p></div>
<div class="sect3">
<h4 id="_colour_structures">2.4.1. Colour Structures</h4>
<div class="paragraph"><p>This is how most colours are specified.</p></div>
<div class="listingblock">
<a id="tr_colour"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_colour</span>   <span class="c1">// 3 bytes</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">Red</span><span class="p">;</span>        <span class="c1">// Red component (0 -- darkest, 255 -- brightest)</span>
    <span class="kt">uint8_t</span> <span class="n">Green</span><span class="p">;</span>      <span class="c1">// Green component (0 -- darkest, 255 -- brightest)</span>
    <span class="kt">uint8_t</span> <span class="n">Blue</span><span class="p">;</span>       <span class="c1">// Blue component (0 -- darkest, 255 -- brightest)</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>(Some compilers will pad this structure to make 4 bytes; one must either read and write 3 bytes explicitly, or else use a simple array of
bytes instead of this structure.)</p></div>
<div class="paragraph"><p>And as mentioned earlier, the 16-bit palette uses a similar structure:</p></div>
<div class="listingblock">
<a id="tr_colour4"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_colour4</span>  <span class="c1">// 4 bytes</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">Red</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">Green</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">Blue</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">Unused</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>In TR5, there is new additional colour type composed of floating-point numbers. This type is primarily used in light structures.</p></div>
<div class="listingblock">
<a id="tr5_colour"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr5_colour</span>  <span class="c1">// 4 bytes</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">Red</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">Green</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">Blue</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">Unused</span><span class="p">;</span>   <span class="c1">// Usually filler value = 0xCDCDCDCD</span>
<span class="p">};</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_vertex_structures">2.4.2. Vertex Structures</h4>
<div class="paragraph"><p>This is how vertices are specified, using relative coordinates.  They are generally formed into lists, such that other entities (such as
quads or triangles) can refer to them by simply using their index in the list.</p></div>
<div class="listingblock">
<a id="tr_vertex"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_vertex</span>   <span class="c1">// 6 bytes</span>
<span class="p">{</span>
    <span class="kt">int16_t</span> <span class="n">x</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">y</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">z</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>As with colours, TR5 introduced additional vertex type comprised of floating-point numbers:</p></div>
<div class="listingblock">
<a id="tr5_vertex"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr5_vertex</span>   <span class="c1">// 12 bytes</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">x</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">y</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">z</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_rectangular_quad_face_definition">2.4.3. Rectangular (Quad) Face Definition</h4>
<div class="paragraph"><p>Four vertices (the values are indices into the appropriate vertex list) and a texture (an index into the object-texture list) or colour (index into 8-bit
palette or 16-bit palette).  If the rectangle is a coloured polygon (not textured), the .Texture element contains two indices: the low byte (<code>Texture &amp; 0xFF</code>)
is an index into the 256-colour palette, while the high byte (<code>Texture &gt;&gt; 8</code>) is in index into the 16-bit palette, when present. A textured rectangle will have
its vertices mapped onto all 4 vertices of an object texture, in appropriate correspondence.</p></div>
<div class="listingblock">
<a id="tr_face4"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_face4</span>    <span class="c1">// 12 bytes</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">Vertices</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="kt">uint16_t</span> <span class="n">Texture</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>Texture</code> field can have the bit 15 set: when it is, the face is <em>double-sided</em> (i.e. visible from both sides).</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr1.png" alt="TR1 only" width="16" height="17" title="TR1 only" />
</span><span class="image">
<img src="images/icons/tr2.png" alt="TR2 only" width="16" height="17" title="TR2 only" />
</span><span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span> If the rectangle is a coloured polygon (not textured), the .Texture element contains two indices: the low byte (<code>Texture &amp; 0xFF</code>) is an index
into the 256-colour palette, while the high byte (<code>Texture &gt;&gt; 8</code>) is in index into the 16-bit palette, when present.</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> TR4 and later introduced an extended version <em>only used for meshes</em>, not for triangles and quads making rooms:</p></div>
<div class="listingblock">
<a id="tr4_mesh_face4"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr4_mesh_face4</span>    <span class="c1">// 12 bytes</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">Vertices</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="kt">uint16_t</span> <span class="n">Texture</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">Effects</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>The only difference is the extra field <code>Effects</code>. It has this layout:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Bit 0:</em> if set, face has <em>additive alpha blending</em> (same meaning that when the <code>Attribute</code> field of <a href="#tr_object_texture">[tr_object_texture]</a> is 2, but this flag overrides it).
</p>
</li>
</ul></div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="80%"
frame="void"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/illustrations/face_blend.jpg" alt="illustrations/face_blend.jpg" title="Bit 0 set" />
</span></p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/illustrations/face_noblend.jpg" alt="illustrations/face_noblend.jpg" title="Bit 0 not set" />
</span></p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table"><em>Bit 0 set, blending enabled</em></p></td>
<td align="center" valign="top"><p class="table"><em>Bit 0 not set, blending disabled</em></p></td>
</tr>
</tbody>
</table>
</div>
<div class="ulist"><ul>
<li>
<p>
<em>Bits 1..7:</em> strength of <em>environment mapping</em> effect (so-called &#8220;shiny effect&#8221; in TRLE community). Environment map is derived from special pre-rendered
   texture. The bigger the value is, the more visible the effect is.
</p>
</li>
</ul></div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="40%"
frame="void"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/illustrations/shine-on.jpg" alt="illustrations/shine-on.jpg" title="Bit 0 set" />
</span></p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/illustrations/shine-off.jpg" alt="illustrations/shine-off.jpg" title="Bit 0 not set" />
</span></p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table"><em>Shiny effect at max</em></p></td>
<td align="center" valign="top"><p class="table"><em>No shiny effect</em></p></td>
</tr>
</tbody>
</table>
</div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Note that only externally lit meshes can use environment mapping in original engines. If you use it with internally lit meshes, you will crash the game.
</p>
</li>
<li>
<p>
TR4 engine doesn&#8217;t support environmental map for Lara&#8217;s joints. It simply wasn&#8217;t implemented, so if you apply effect to Lara joints, game will crash. For TR5,
   a special object called <em>Lara&#8217;s catsuit</em> was developed to support environmental map on transformed meshes.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_triangular_face_definition">2.4.4. Triangular Face Definition</h4>
<div class="paragraph"><p>These structures has the same layout than the quad face definitions, except a textured triangle will have its vertices mapped <em>onto the first 3 vertices of an
object texture, in appropriate correspondence</em>. Moreover, a triangle has only 3 vertices, not 4.</p></div>
<div class="listingblock">
<a id="tr_face3"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_face3</span>    <span class="c1">// 8 bytes</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">Vertices</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="kt">uint16_t</span> <span class="n">Texture</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">[[</span><span class="n">tr4_mesh_face3</span><span class="p">]]</span>
<span class="k">struct</span> <span class="n">tr4_mesh_face3</span>    <span class="c1">// 10 bytes</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">Vertices</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="kt">uint16_t</span> <span class="n">Texture</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">Effects</span><span class="p">;</span>    <span class="c1">// TR4-5 ONLY: alpha blending and environment mapping strength</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>All the info about <code>Texture</code> and <code>Effects</code> fields is also similar to same info from <a href="#tr_face4">[tr_face4]</a> and <a href="#tr4_mesh_face4">[tr4_mesh_face4]</a> respectively.</p></div>
</div>
<div class="sect3">
<h4 id="_8_bit_texture_tile">2.4.5. 8-bit Texture Tile</h4>
<div class="paragraph"><p>Each <code>uint8_t</code> represents a pixel whose colour is in the 8-bit palette.</p></div>
<div class="listingblock">
<a id="tr_textile8"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_textile8</span>    <span class="c1">// 65536 bytes</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">Tile</span><span class="p">[</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">256</span><span class="p">];</span>
<span class="p">};</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_16_bit_texture_tile">2.4.6. 16-bit Texture Tile</h4>
<div class="paragraph"><p>Each <code>uint16_t</code> represents a pixel whose colour is of the form ARGB, MSB-to-LSB:</p></div>
<div class="paragraph"><p>1-bit transparency (<code>0</code> = transparent, <code>1</code> = opaque) (<code>0x8000</code>) <br />
5-bit red channel (<code>0x7C00</code>) <br />
5-bit green channel (<code>0x03E0</code>) <br />
5-bit blue channel (<code>0x001F</code>)</p></div>
<div class="listingblock">
<a id="tr_textile16"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_textile16</span>    <span class="c1">// 131072 bytes</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">Tile</span><span class="p">[</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">256</span><span class="p">];</span>
<span class="p">};</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_32_bit_texture_tile">2.4.7. 32-bit Texture Tile</h4>
<div class="paragraph"><p>Each <code>uint32_t</code> represents a pixel whose colour is of the form ARGB, (A = most significant byte), each component being one byte.</p></div>
<div class="listingblock">
<a id="tr4_textile32"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr4_textile32</span>    <span class="c1">// 262144 bytes</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">Tile</span><span class="p">[</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">256</span><span class="p">];</span>
<span class="p">};</span>
</pre></div></div></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_room_geometry">3. Room Geometry</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_overview">3.1. Overview</h3>
<div class="paragraph"><p>A <em>room</em> in TR2 is simply a rectangular three-dimensional area. A room may be &#8220;indoors&#8221; or &#8220;outdoors,&#8221; may or may not be enclosed, may be
accessible or inaccessible to Lara, may or may not contain doors or objects.</p></div>
<div class="paragraph"><p>All rooms have &#8220;portals,&#8221; called &#8220;doors&#8221; in some documentation, which are pathways to adjacent rooms. There are two kinds of portals&#8201;&#8212;&#8201;visibility portals
and collisional portals. Visibility portals are for determining how much of a room (if any) is visible from another room, while collisional portals are for
enabling an object to travel from one room to another.</p></div>
<div class="paragraph"><p>The visibility portals are most likely for doing &#8220;portal rendering&#8221;, which is a visibility-calculation scheme that goes as follows: the viewpoint is a member
of some room, which is then listed as visible from it. This room&#8217;s portals are checked for visibility from that viewpoint, and visible portals have their
opposite-side rooms marked as visible. These rooms are then checked for portals that are visible from the viewpoint through the viewpoint&#8217;s room&#8217;s portals, and
visible ones have their opposite-side rooms marked as visible. This operation is repeated, with viewing through intermediate portals, until all visible portals
have been found. The result is a tree of rooms, starting from the viewpoint&#8217;s room; only those rooms and their contents need to be rendered.</p></div>
<div class="paragraph"><p>It is clear that both visibility and collision calculations require that objects have room memberships given for them, and indeed we shall find that most map
objects have room memberships.</p></div>
<div class="paragraph"><p>Rooms may overlap; as we shall see, this is involved in how horizontal collisional portals are implemented. However, different rooms may overlap without either
being directly accessible from the other; there are several inadvertent examples of such &#8220;5D space&#8221; in the Tomb Raider series. The only possibly deliberate
example I know of is the flying saucer in &#8220;Area 51&#8221; in TR3, whose interior is bigger than its exterior.</p></div>
<div class="paragraph"><p>A room can have an &#8220;alternate room&#8221; specified for it; that means that that room can be replaced by that alternate as the game is running. This trick is used
to produce such tricks as empty rooms vs. rooms full of water, scenery rearrangements (for example, the dynamited house in &#8220;Bartoli&#8217;s Hideout&#8221; in TR2), and so
forth. An empty room is first created, and then a full room is created at its location from a copy of it. The empty room then has that full room set as its
alternate, and when that room is made to alternate, one sees a full room rather than an empty one.</p></div>
<div class="paragraph"><p>The rooms are stored sequentially in an array, and &#8220;Room Numbers&#8221; are simply indices into this array (e.g. &#8220;Room Number 5&#8221; is simply <code>Rooms[5]</code>; the first
room is <code>Rooms[0]</code>).</p></div>
<div class="paragraph"><p>Rooms are divided into <em>sectors</em> (or <em>squares</em>), which are 1024x1024 unit squares that form a grid on the $X-Z$ plane. Sectors are the defining area
for floor/ceiling heights and triggers (e.g. a tiger appears and attacks when Lara steps on a given square); the various attributes of each sector are stored in
the Sector Data (described in this section) and the <a href="#FloorData">[FloorData]</a>.  As an aside, Sectors correspond to the &#8220;squares,&#8221; easily visible in all of the Tomb Raider
games, that experienced players count when gauging jumps;  they also account for some of the game&#8217;s less-appealing graphic artifacts. Careful tiling and texture
construction can make these &#8220;squares&#8221; almost invisible.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>Each room has two types of surface geometry&#8201;&#8212;&#8201;<em>rendered</em> and <em>collisional</em>. The former are what is <em>seen</em>, while the latter control how objects <em>collide</em> and
<em>interact</em> with the world. Furthermore, these two types are specified separately in the room data&#8201;&#8212;&#8201;each type is <em>completely independent of other</em>, i. e.
collisional geometry shouldn&#8217;t exactly match visible room geometry.</p></div>
<div class="paragraph"><p>While this distinctive feature was never used in originals (collisional room &#8220;meshes&#8221; fully resembled visible room &#8220;meshes&#8221;), it is now extensively used by
level editing community with the help of a program called <em>meta2tr</em>. This utility allows level builder to replace visible geometry generated by <em>TRLE</em> with any
custom geometry, usually modelled in <em>Metasequoia</em> 3D editor (hence the name of <em>meta2tr</em> utility).</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Rooms are defined with a complex structure, which is described below &#8220;inside-out,&#8221; meaning that the smaller component structures are described first, followed
by the larger structures that are built using the smaller structures.</p></div>
</div>
<div class="sect2">
<h3 id="_room_structures">3.2. Room Structures</h3>
<div class="sect3">
<h4 id="_room_header">3.2.1. Room header</h4>
<div class="paragraph"><p>$X / Z$ indicate the base position of the room mesh in world coordinates ($Y$ is always zero-relative)</p></div>
<div class="listingblock">
<a id="tr_room_info"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_room_info</span>    <span class="c1">// 16 bytes</span>
<span class="p">{</span>
    <span class="kt">int32_t</span> <span class="n">x</span><span class="p">;</span>             <span class="c1">// X-offset of room (world coordinates)</span>
    <span class="kt">int32_t</span> <span class="n">z</span><span class="p">;</span>             <span class="c1">// Z-offset of room (world coordinates)</span>
    <span class="kt">int32_t</span> <span class="n">yBottom</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">yTop</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>yBottom</code> is actually largest value, but indicates <em>lowest</em> point in the room.
<code>yTop</code> is actually smallest value, but indicates <em>highest</em> point in the room.</p></div>
<div class="paragraph"><p>TR5 uses an extended version of this structure:</p></div>
<div class="listingblock">
<a id="tr5_room_info"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr5_room_info</span>    <span class="c1">// 20 bytes</span>
<span class="p">{</span>
    <span class="kt">int32_t</span> <span class="n">x</span><span class="p">;</span>             <span class="c1">// X-offset of room (world coordinates)</span>
    <span class="kt">int32_t</span> <span class="n">y</span><span class="p">;</span>             <span class="c1">// Y-offset of room (world coordinates) - only in TR5</span>
    <span class="kt">int32_t</span> <span class="n">z</span><span class="p">;</span>             <span class="c1">// Z-offset of room (world coordinates)</span>
    <span class="kt">int32_t</span> <span class="n">yBottom</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">yTop</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>The additional <code>y</code> value is usually 0.</p></div>
</div>
<div class="sect3">
<h4 id="_portal_structure">3.2.2. Portal Structure</h4>
<div class="paragraph"><p>These portals, sometimes called &#8220;doors&#8221;, define the view from a room into another room. This can be through a &#8220;real&#8221; door, a window, or even some open area
that makes the rooms look like one big room. Note that &#8220;rooms&#8221; here are really just areas; they aren&#8217;t necessarily enclosed.  The portal structure below
defines <em>only visibility portals</em>, not an actual door model, texture, or action (if any).  And if the portal is not properly oriented, the camera cannot
&#8220;see&#8221; through it.</p></div>
<div class="listingblock">
<a id="tr_room_portal"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_room_portal</span>  <span class="c1">// 32 bytes</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span>  <span class="n">AdjoiningRoom</span><span class="p">;</span> <span class="c1">// Which room this portal leads to</span>
    <span class="n">tr_vertex</span> <span class="n">Normal</span><span class="p">;</span>
    <span class="n">tr_vertex</span> <span class="n">Vertices</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>Normal</code> field tells which way the portal faces (the normal points <em>away</em> from the adjacent room; to be seen through, it must point <em>toward</em> the viewpoint).</p></div>
<div class="paragraph"><p><code>Vertices</code> are the corners of this portal (the right-hand rule applies with respect to the normal). If the right-hand-rule is not followed, the portal will
contain visual artifacts instead of a viewport to <code>AdjoiningRoom</code>.</p></div>
</div>
<div class="sect3">
<h4 id="_room_sector_structure">3.2.3. Room Sector Structure</h4>
<div class="paragraph"><p>All the geometry specified here is <em>collisional geometry</em>.</p></div>
<div class="listingblock">
<a id="tr_room_sector"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_room_sector</span> <span class="c1">// 8 bytes</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">FDindex</span><span class="p">;</span>    <span class="c1">// Index into FloorData[]</span>
    <span class="kt">uint16_t</span> <span class="n">BoxIndex</span><span class="p">;</span>   <span class="c1">// Index into Boxes[] (-1 if none)</span>
    <span class="kt">uint8_t</span>  <span class="n">RoomBelow</span><span class="p">;</span>  <span class="c1">// 255 is none</span>
    <span class="kt">int8_t</span>   <span class="n">Floor</span><span class="p">;</span>      <span class="c1">// Absolute height of floor</span>
    <span class="kt">uint8_t</span>  <span class="n">RoomAbove</span><span class="p">;</span>  <span class="c1">// 255 if none</span>
    <span class="kt">int8_t</span>   <span class="n">Ceiling</span><span class="p">;</span>    <span class="c1">// Absolute height of ceiling</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>Floor</code> and <code>Ceiling</code> are signed numbers of 256 units of height (relative to 0)&#8201;&#8212;&#8201;e.g. Floor <code>0x04</code> corresponds to $Y = 1024$ in world coordinates.
Therefore, 256 units is a <em>minimum vertical stride of collisional geometry</em>. However, this rule could be broken by specific entities, which Lara can stand on.
But <em>horizontal</em> sector dimensions, which, as mentioned earlier, are 1024 x 1024 (in world coordinates), could not. Therefore, minimal horizontal platform
dimensions, on which Lara can stand and grab, are 1024 x 1024 as well.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">This implies that, while $X$ and $Z$ can be quite large, $Y$ is constrained to -32768..32512.</td>
</tr></table>
</div>
<div class="paragraph"><p><code>Floor</code> and <code>Ceiling</code> value of <code>0x81</code> is a magic number used to indicate impenetrable walls around the sector. <code>Floor</code> values are used by the game engine to
determine what objects Lara can traverse and how. Relative steps of 1 (-256) can be walked up; steps of 2..7 (-512..-1792) can/must be jumped up; steps larger
than 7 (-2048..-32768) cannot be jumped up (too tall).</p></div>
<div class="paragraph"><p><code>RoomAbove</code> and <code>RoomBelow</code> values indicate what neighboring rooms are in these directions&#8201;&#8212;&#8201;the number of the room below this one and the number of the room
above this one. If <code>RoomAbove</code> is not <em>none</em>, then the ceiling is a <em>collisional portal</em> to that room, while if <code>RoomBelow</code> is not <em>none</em>, then the floor is a
<em>collisional portal</em> to that room.</p></div>
<div class="paragraph"><p>Also, <code>RoomBelow</code> value is extensively used by engine to determine actual sector data and triggers in so-called <em>stacked room setups</em>, when one room is placed
above another through collisional portal. The thing is, engine uses sector data and triggers <em>only for the lowest sector</em> of the stacked room setup, so it
recursively scans for a lowest room to determine which sector to use.</p></div>
<div class="paragraph"><p><code>FDindex</code> is a pointer to specific entry in <a href="#FloorData">[FloorData]</a> array, which keeps all the information about sector flags, triggers and other parameters. While it is
implied that one <code>FDindex</code> entry may be shared between several sectors, it is usually not the case with original Tomb Raider levels built with <em>TRLE</em>. However,
<em>Dxtre3d</em> takes advantage of this feature and may optimize similar sectors to share same FDindex pointer.</p></div>
<div class="paragraph"><p><code>BoxIndex</code> is a pointer to special <a href="#Boxes">[Boxes]</a> array entry, which is basically a subset of sectors with same height configuration. It is primarily used for AI
pathfinding (see the <a href="#non-player-character-behaviour">Non-player character behaviour</a> chapter for more details).</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> In these games, <code>BoxIndex</code> field is more complicated, and actually contains <em>two packed values</em>. Bits 4..14 contain the <em>actual box index</em>, and
bits 0..3 contain <em>material index</em>, which is used to produce specific footstep sound, when Lara is walking or running in this sector. On PlayStation game
versions, this index was also used to determine if footprint textures should be applied to this particular place.</p></div>
<div class="paragraph"><p>Majority of <em>material index</em> values are the same across game versions, but some of them exist only in particular game. Here is the description:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>0</strong>&#8201;&#8212;&#8201;Mud
</p>
</li>
<li>
<p>
<strong>1</strong>&#8201;&#8212;&#8201;Snow (TR3 and TR5 only)
</p>
</li>
<li>
<p>
<strong>2</strong>&#8201;&#8212;&#8201;Sand
</p>
</li>
<li>
<p>
<strong>3</strong>&#8201;&#8212;&#8201;Gravel
</p>
</li>
<li>
<p>
<strong>4</strong>&#8201;&#8212;&#8201;Ice (TR3 and TR5 only)
</p>
</li>
<li>
<p>
<strong>5</strong>&#8201;&#8212;&#8201;Water <em>(unused, as water footstep is only activated in water rooms)</em>
</p>
</li>
<li>
<p>
<strong>6</strong>&#8201;&#8212;&#8201;Stone <em>(unused, as it is default footstep sound)</em>
</p>
</li>
<li>
<p>
<strong>7</strong>&#8201;&#8212;&#8201;Wood
</p>
</li>
<li>
<p>
<strong>8</strong>&#8201;&#8212;&#8201;Metal
</p>
</li>
<li>
<p>
<strong>9</strong>&#8201;&#8212;&#8201;Marble (TR4 only)
</p>
</li>
<li>
<p>
<strong>10</strong>&#8201;&#8212;&#8201;Grass <em>(same sound effect as sand)</em>
</p>
</li>
<li>
<p>
<strong>11</strong>&#8201;&#8212;&#8201;Concrete <em>(same sound effect as stone, hence unused)</em>
</p>
</li>
<li>
<p>
<strong>12</strong>&#8201;&#8212;&#8201;Old wood <em>(same sound effect as wood)</em>
</p>
</li>
<li>
<p>
<strong>13</strong>&#8201;&#8212;&#8201;Old metal <em>(same sound effect as metal)</em>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Mud, snow, sand, grass and maybe some other materials produce footprints in PlayStation version.</p></div>
<div class="paragraph"><p>Furthermore, in TR3-5, <em>actual box index</em> may contain special value 2047, which is most likely indicates that this sector is a slope on which Lara can slide
(and, therefore, possibly impassable by most NPCs).</p></div>
</div>
<div class="sect3">
<h4 id="_room_light_structure">3.2.4. Room Light Structure</h4>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">TR engines always used static room lights only for processing lighting on entities (such as Lara, enemies, doors, and others). This is called <em>external
lighting</em>. For room meshes, they used so-called internal, or <em>pre-baked</em> lighting, which is done on level building stage: lights are calculated and applied to
room faces via vertex colours. There is no way to change room lighting when the level is compiled&#8201;&#8212;&#8201;meaning, any changes in light positions, intensities and
colour won&#8217;t affect room faces.</td>
</tr></table>
</div>
<div class="paragraph"><p>There are four different types of room light structures. First one is used in TR1-2, second is used in TR3, third is used in TR4, and fourth is used in TR5.
Here is the description of each:</p></div>
<div class="sect4">
<h5 id="_tr1_room_lighting">TR1 Room Lighting</h5>
<div class="listingblock">
<a id="tr_room_light"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_room_light</span>   <span class="c1">// 18 bytes</span>
<span class="p">{</span>
     <span class="kt">int32_t</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>       <span class="c1">// Position of light, in world coordinates</span>
    <span class="kt">uint16_t</span> <span class="n">Intensity1</span><span class="p">;</span>    <span class="c1">// Light intensity</span>
    <span class="kt">uint32_t</span> <span class="n">Fade1</span><span class="p">;</span>         <span class="c1">// Falloff value</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>X/Y/Z</code> are in world coordinates. <code>Intensity1/Intensity2</code> are almost always equal. This lighting only affects <em>externally-lit</em> objects. Tomb Raider 1 has only
the first of the paired <code>Intensity</code> and <code>Fade</code> values.</p></div>
<div class="paragraph"><p><code>Intensity1</code> ranges from 0 (dark) to 0x1FFF (bright). However, some rooms occasionally have some lights with intensity greater than 0x1FFF (for example, look at
room #9, 2nd light in <code>level1.phd</code>). <code>Fade1</code> is the maximum distance the light shines on, and ranges from 0 to 0x7FFF.</p></div>
</div>
<div class="sect4">
<h5 id="_tr2_room_lighting">TR2 Room Lighting</h5>
<div class="paragraph"><p>TR2 uses an extended version of TR1 light structure:</p></div>
<div class="listingblock">
<a id="tr2_room_light"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr2_room_light</span>   <span class="c1">// 24 bytes</span>
<span class="p">{</span>
     <span class="kt">int32_t</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>       <span class="c1">// Position of light, in world coordinates</span>
    <span class="kt">uint16_t</span> <span class="n">Intensity1</span><span class="p">;</span>    <span class="c1">// Light intensity</span>
    <span class="kt">uint16_t</span> <span class="n">Intensity2</span><span class="p">;</span>    <span class="c1">// Only in TR2</span>
    <span class="kt">uint32_t</span> <span class="n">Fade1</span><span class="p">;</span>         <span class="c1">// Falloff value</span>
    <span class="kt">uint32_t</span> <span class="n">Fade2</span><span class="p">;</span>         <span class="c1">// Only in TR2</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>Intensity2</code> and <code>Fade2</code> values are seemingly not used. <code>Intensity1</code> can go very well beyond 0x1FFF, right to 0x7FFF (ultra bright light). Above 0x7FFF, it is
always black, so the number is pseudo-signed (negative values are always treated as zero).</p></div>
</div>
<div class="sect4">
<h5 id="_tr3_room_lighting">TR3 Room Lighting</h5>
<div class="listingblock">
<a id="tr3_room_light"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr3_room_light</span>   <span class="c1">// 24 bytes</span>
<span class="p">{</span>
        <span class="kt">int32_t</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>       <span class="c1">// Position of light, in world coordinates</span>
     <span class="n">tr_colour4</span> <span class="n">Colour</span><span class="p">;</span>        <span class="c1">// Colour of the light</span>
       <span class="kt">uint32_t</span> <span class="n">Intensity</span><span class="p">;</span>
       <span class="kt">uint32_t</span> <span class="n">Fade</span><span class="p">;</span>          <span class="c1">// Falloff value</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>Intensity</code> is the power of the light and ranges mainly from 0 (low power) to 0x1FFF (high power). Though, values greater than 0x1FFF do exist and their
meanings are unknown. <code>Fade</code> is the distance max the light can shine on. Range is mainly from 0 to 0x7FFF, but negative values do exist and their meanings are
unknown.</p></div>
</div>
<div class="sect4">
<h5 id="_tr4_room_lighting">TR4 Room Lighting</h5>
<div class="listingblock">
<a id="tr4_room_light"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr4_room_light</span>   <span class="c1">// 46 bytes</span>
<span class="p">{</span>
        <span class="kt">int32_t</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>       <span class="c1">// Position of light, in world coordinates</span>
      <span class="n">tr_colour</span> <span class="n">Colour</span><span class="p">;</span>        <span class="c1">// Colour of the light</span>

        <span class="kt">uint8_t</span> <span class="n">LightType</span><span class="p">;</span>
        <span class="kt">uint8_t</span> <span class="n">Unknown</span><span class="p">;</span>       <span class="c1">// Always 0xFF?</span>
        <span class="kt">uint8_t</span> <span class="n">Intensity</span><span class="p">;</span>

          <span class="kt">float</span> <span class="n">In</span><span class="p">;</span>            <span class="c1">// Also called hotspot in TRLE manual</span>
          <span class="kt">float</span> <span class="n">Out</span><span class="p">;</span>           <span class="c1">// Also called falloff in TRLE manual</span>
          <span class="kt">float</span> <span class="n">Length</span><span class="p">;</span>
          <span class="kt">float</span> <span class="n">CutOff</span><span class="p">;</span>

          <span class="kt">float</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">;</span>    <span class="c1">// Direction - used only by sun and spot lights</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>LightType</code> is somewhat similar to D3D light type, but there are some differences.</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>0</strong>&#8201;&#8212;&#8201;Sun
</p>
</li>
<li>
<p>
<strong>1</strong>&#8201;&#8212;&#8201;Light
</p>
</li>
<li>
<p>
<strong>2</strong>&#8201;&#8212;&#8201;Spot
</p>
</li>
<li>
<p>
<strong>3</strong>&#8201;&#8212;&#8201;Shadow
</p>
</li>
<li>
<p>
<strong>4</strong>&#8201;&#8212;&#8201;Fog bulb
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p><em>Fog bulb</em> is a special case of room light, which actually don&#8217;t work as usual light. It serves as a point in space, where a kind of <em>volumetric fog</em> effect is
generated. It works only if user has enabled corresponding option in game setup.</p></div>
<div class="paragraph"><p>Fog bulbs don&#8217;t use <code>Colour</code> field to define its colour. However, <code>Red</code> field of a <code>Colour</code> structure is used to define fog density. Colour itself can be only
changed with special <em>flipeffect #28</em> trigger function, which takes a value from the <em>timer field</em> of the trigger to index into hardcoded RGB table of
pre-defined colours. The table consists of 28 RGB values:</p></div>
</td>
</tr></table>
</div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="4%" />
<col width="20%" />
<col width="4%" />
<col width="20%" />
<col width="4%" />
<col width="20%" />
<col width="4%" />
<col width="20%" />
<tbody>
<tr>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/00.png" alt="fe-palette/00.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code> 0</code> = 0,0,0</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/07.png" alt="fe-palette/07.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code> 7</code> = 0,64,192</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/14.png" alt="fe-palette/14.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code>14</code> = 111,255,223</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/21.png" alt="fe-palette/21.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code>21</code> = 0,30,16</p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/01.png" alt="fe-palette/01.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code> 1</code> = 245,200,60</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/08.png" alt="fe-palette/08.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code> 8</code> = 0,128,0</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/15.png" alt="fe-palette/15.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code>15</code> = 244,216,152</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/22.png" alt="fe-palette/22.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code>22</code> = 250,222,167</p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/02.png" alt="fe-palette/02.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code> 2</code> = 120,196,112</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/09.png" alt="fe-palette/09.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code> 9</code> = 150,172,157</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/16.png" alt="fe-palette/16.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code>16</code> = 248,192,60</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/23.png" alt="fe-palette/23.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code>23</code> = 218,175,117</p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/03.png" alt="fe-palette/03.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code> 3</code> = 202,204,230</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/10.png" alt="fe-palette/10.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code>10</code> = 128,128,128</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/17.png" alt="fe-palette/17.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code>17</code> = 252,0,0</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/24.png" alt="fe-palette/24.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code>24</code> = 225,191,78</p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/04.png" alt="fe-palette/04.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code> 4</code> = 128,64,0</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/11.png" alt="fe-palette/11.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code>11</code> = 204,163,123</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/18.png" alt="fe-palette/18.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code>18</code> = 198,95,87</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/25.png" alt="fe-palette/25.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code>25</code> = 77,140,141</p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/05.png" alt="fe-palette/05.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code> 5</code> = 64,64,64</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/12.png" alt="fe-palette/12.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code>12</code> = 177,162,140</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/19.png" alt="fe-palette/19.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code>19</code> = 226,151,118</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/26.png" alt="fe-palette/26.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code>26</code> = 4,181,154</p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/06.png" alt="fe-palette/06.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code> 6</code> = 243,232,236</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/13.png" alt="fe-palette/13.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code>13</code> = 0,223,191</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/20.png" alt="fe-palette/20.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code>20</code> = 248,235,206</p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/fe-palette/27.png" alt="fe-palette/27.png" width="16" height="16" />
</span></p></td>
<td align="left" valign="top"><p class="table"><code>27</code> = 255,174,0</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_tr5_room_lighting">TR5 Room Lighting</h5>
<div class="listingblock">
<a id="tr5_room_light"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr5_room_light</span>   <span class="c1">// 88 bytes</span>
<span class="p">{</span>
        <span class="kt">float</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>       <span class="c1">// Position of light, in world coordinates</span>
        <span class="kt">float</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>       <span class="c1">// Colour of the light</span>

       <span class="kt">uint32_t</span> <span class="n">Separator</span>    <span class="c1">// Dummy value = 0xCDCDCDCD</span>

        <span class="kt">float</span> <span class="n">In</span><span class="p">;</span>            <span class="c1">// Cosine of the IN value for light / size of IN value</span>
        <span class="kt">float</span> <span class="n">Out</span><span class="p">;</span>           <span class="c1">// Cosine of the OUT value for light / size of OUT value</span>
        <span class="kt">float</span> <span class="n">RadIn</span><span class="p">;</span>         <span class="c1">// (IN radians) * 2</span>
        <span class="kt">float</span> <span class="n">RadOut</span><span class="p">;</span>        <span class="c1">// (OUT radians) * 2</span>
        <span class="kt">float</span> <span class="n">Range</span><span class="p">;</span>         <span class="c1">// Range of light</span>

        <span class="kt">float</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">;</span>    <span class="c1">// Direction - used only by sun and spot lights</span>
      <span class="kt">int32_t</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span><span class="p">;</span>    <span class="c1">// Same as position, only in integer.</span>
      <span class="kt">int32_t</span> <span class="n">dx2</span><span class="p">,</span> <span class="n">dy2</span><span class="p">,</span> <span class="n">dz2</span><span class="p">;</span> <span class="c1">// Same as direction, only in integer.</span>

      <span class="kt">uint8_t</span> <span class="n">LightType</span><span class="p">;</span>

      <span class="kt">uint8_t</span> <span class="n">Filler</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>     <span class="c1">// Dummy values = 3 x 0xCD</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>x,y,z</code> values shouldn&#8217;t be used by sun type light, but sun seems to have a large <code>x</code> value (9 million, give or take), a zero <code>y</code> value, and a small <code>z</code> value
(4..20) in the original TR5 levels.</p></div>
<div class="paragraph"><p><code>In</code> and <code>Out</code> values aren&#8217;t used by <em>sun</em> type. For the <em>spot</em> type, these are the <em>hotspot</em> and <em>falloff angle</em> cosines. For the <em>light</em> and <em>shadow</em> types,
these are the TR units for the <em>hotspot / falloff</em> (1024 = 1 sector).</p></div>
<div class="paragraph"><p><code>RadIn</code>, <code>RadOut</code> and <code>Range</code> are only used by the <em>spot</em> light type.</p></div>
<div class="paragraph"><p><code>dx</code>, <code>dy</code> and <code>dz</code> values are used only by the <em>sun</em> and <em>spot</em> type lights. They describe the directional vector of the light. This can be obtained by:</p></div>
<div class="ulist"><ul>
<li>
<p>
if both <code>x</code> and <code>y</code> $\mathnormal{LightDirectionVectorX} = \cos(X) * \sin(Y)$
</p>
</li>
<li>
<p>
$\mathnormal{LightDirectionVectorY} = \sin(X)$
</p>
</li>
<li>
<p>
$\mathnormal{LightDirectionVectorZ} = \cos(X) * \cos(Y)$
</p>
</li>
</ul></div>
<div class="paragraph"><p><code>x2</code>, <code>y2</code>, <code>z2</code>, <code>dx2</code>, <code>dy2</code> and <code>dz2</code> values repeat previous corresponding information in long data types instead of floats.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_room_vertex_structure">3.2.5. Room Vertex Structure</h4>
<div class="paragraph"><p>This defines the vertices within a room. As mentioned above, room lighting is internal vertex lighting, except for necessarily external sources like flares,
flame emitters and gunflashes. Room ambient lights and point sources are ignored.</p></div>
<div class="paragraph"><p>As TR3 introduced colored lighting, room vertex structure drastically changed. It changed once again in TR5, when floating-point numbers were introduced. So
we&#8217;ll define vertex structure for TR1-2, TR3-4 and TR5 independently.</p></div>
<div class="sect4">
<h5 id="_tr1_2_room_vertex_structure">TR1-2 Room Vertex Structure</h5>
<div class="listingblock">
<a id="tr_room_vertex"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_room_vertex</span>  <span class="c1">// 8 bytes</span>
<span class="p">{</span>
     <span class="n">tr_vertex</span> <span class="n">Vertex</span><span class="p">;</span>
       <span class="kt">int16_t</span> <span class="n">Lighting</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>Vertex</code> is the coordinates of the vertex, relative to <a href="#tr_room_info">[tr_room_info]</a> <code>x</code> and <code>z</code> values.</p></div>
<div class="paragraph"><p><code>Lighting</code> ranges from 0 (bright) to 0x1FFF (dark). This value is ignored by TR2, and <code>Lighting2</code> is used instead with the same brightness range.</p></div>
<div class="paragraph"><p>TR2 uses an extended version of the structure:</p></div>
<div class="listingblock">
<a id="tr2_room_vertex"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr2_room_vertex</span>  <span class="c1">// 12 bytes</span>
<span class="p">{</span>
     <span class="n">tr_vertex</span> <span class="n">Vertex</span><span class="p">;</span>
       <span class="kt">int16_t</span> <span class="n">Lighting</span><span class="p">;</span>
      <span class="kt">uint16_t</span> <span class="n">Attributes</span><span class="p">;</span> <span class="c1">// A set of flags for special rendering effects</span>
       <span class="kt">int16_t</span> <span class="n">Lighting2</span><span class="p">;</span>  <span class="c1">// Almost always equal to Lighting1</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>Attributes</code> field is a <em>set of flags</em>, and their meaning is:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Bits 0..4</em> are only used together in combination with the <code>LightMode</code> field of the <a href="#tr_room">[tr_room]</a> structure. See below.
</p>
</li>
<li>
<p>
<em>Bit 15:</em> When used in room filled with water, don&#8217;t move the vertices of the room when viewed from above (normally, when viewed from above, the vertices of a
  room filled with water moves to <em>simulate</em> the refraction of lights in water). Note that when viewed from inside the room filled with water, the vertices of the
  other rooms outside still moves.
</p>
</li>
</ul></div>
<div class="paragraph"><p><code>Lighting</code> field is ignored by TR2, and <code>Lighting2</code> is used instead with the same brightness range&#8201;&#8212;&#8201;from 0 (bright) to 0x1FFF (dark).</p></div>
</div>
<div class="sect4">
<h5 id="_tr3_4_room_vertex_structure">TR3-4 Room Vertex Structure</h5>
<div class="listingblock">
<a id="tr3_room_vertex"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr3_room_vertex</span>  <span class="c1">// 12 bytes</span>
<span class="p">{</span>
     <span class="n">tr_vertex</span> <span class="n">Vertex</span><span class="p">;</span>
       <span class="kt">int16_t</span> <span class="n">Lighting</span><span class="p">;</span>   <span class="c1">// Value is ignored!</span>
      <span class="kt">uint16_t</span> <span class="n">Attributes</span><span class="p">;</span> <span class="c1">// A set of flags for special rendering effects</span>
      <span class="kt">uint16_t</span> <span class="n">Colour</span><span class="p">;</span>     <span class="c1">// 15-bit colour</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>Lighting</code> value is ignored by the engine, as now each vertex has its own defined 15-bit colour (see below).</p></div>
<div class="paragraph"><p><code>Attributes</code> bit flags were extended. Here is the list:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Bit 13:</em> Water / quicksand surface &#8220;wave&#8221; movement. Brightness is also shifting, if this flag is set (but it&#8217;s not the same type as with <em>Bit 14</em>, it&#8217;s much
  less noticeable).
</p>
</li>
<li>
<p>
<em>Bit 14:</em> Simulates caustics by constantly shifting vertex colour brightness. Used mainly in underwater rooms, but can be used in rooms without water. In TR2,
  there was a similar effect, but it was assigned for all vertices in any water room.
</p>
</li>
<li>
<p>
<em>Bit 15:</em> Same &#8220;wave&#8221; effect as with <em>Bit 13</em>, but without light effect (?).
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">The amplitude of the &#8220;wave&#8221; effect depends on <code>WaterScheme</code> value specified in room structure.</td>
</tr></table>
</div>
<div class="paragraph"><p><code>Colour</code> value specifies vertex colour in 15-bit format (each colour occupies 5 bits). Therefore, each colour value&#8217;s maximum is <em>31</em>. You can use this code to
get each colour:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Red:</em> <code>((Colour &amp; 0x7C00) &gt;&gt; 10)</code>
</p>
</li>
<li>
<p>
<em>Green:</em> <code>((Colour &amp; 0x03E0) &gt;&gt; 5)</code>
</p>
</li>
<li>
<p>
<em>Blue:</em> <code>(Colour &amp; 0x001F)</code>
</p>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="_tr5_room_vertex_structure">TR5 Room Vertex Structure</h5>
<div class="paragraph"><p>In TR5, room vertex structure was almost completely changed. Coordinates were converted to floats, and normal was added:</p></div>
<div class="listingblock">
<a id="tr5_room_vertex"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr5_room_vertex</span>  <span class="c1">// 28 bytes</span>
<span class="p">{</span>
    <span class="n">tr5_vertex</span> <span class="n">Vertex</span><span class="p">;</span>     <span class="c1">// Vertex is now floating-point</span>
    <span class="n">tr5_vertex</span> <span class="n">Normal</span><span class="p">;</span>
      <span class="kt">uint32_t</span> <span class="n">Colour</span><span class="p">;</span>     <span class="c1">// 32-bit colour</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>There is no more <code>Attributes</code> field in room vertex structure for TR5.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_room_sprite_structure">3.2.6. Room Sprite Structure</h4>
<div class="listingblock">
<a id="tr_room_sprite"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_room_sprite</span>  <span class="c1">// 4 bytes</span>
<span class="p">{</span>
    <span class="kt">int16_t</span> <span class="n">Vertex</span><span class="p">;</span>       <span class="c1">// Offset into vertex list</span>
    <span class="kt">int16_t</span> <span class="n">Texture</span><span class="p">;</span>      <span class="c1">// Offset into sprite texture list</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>Vertex</code> indicates an index into room vertex list (<code>Room.Vertices[room_sprite.Vertex]</code>), which acts as a point in space where to display a sprite.</p></div>
<div class="paragraph"><p><code>Texture</code> is an index into the sprite texture list.</p></div>
</div>
<div class="sect3">
<h4 id="_room_data_structure">3.2.7. Room Data Structure</h4>
<div class="paragraph"><p>This is the whole geometry of the &#8220;room,&#8221; including walls, floors, ceilings, and other embedded landscape. It <em>does not</em> include objects that Lara can
interact with (keyholes, moveable blocks, moveable doors, etc.), neither does it include <em>static meshes</em> (mentioned below in the next section).</p></div>
<div class="paragraph"><p>The surfaces specified here are rendered surfaces.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/caution.png" alt="Caution" />
</td>
<td class="content">This is not a &#8220;real&#8221; C/C++ structure, in that the arrays are sized by the <code>NumXXX</code> elements that precede them. Also <a href="#tr_room_vertex">[tr_room_vertex]</a> could be
replaced by any other version-specific room vertex type (<code>tr3_room_vertex</code>, etc.).</td>
</tr></table>
</div>
<div class="listingblock">
<a id="tr_room_data"></a>
<div class="content"><div class="highlight"><pre><span class="k">virtual</span> <span class="k">struct</span> <span class="n">tr_room_data</span>    <span class="c1">// (variable length)</span>
<span class="p">{</span>
    <span class="kt">int16_t</span> <span class="n">NumVertices</span><span class="p">;</span>                   <span class="c1">// Number of vertices in the following list</span>
    <span class="n">tr2_room_vertex</span> <span class="n">Vertices</span><span class="p">[</span><span class="n">NumVertices</span><span class="p">];</span> <span class="c1">// List of vertices (relative coordinates)</span>

    <span class="kt">int16_t</span> <span class="n">NumRectangles</span><span class="p">;</span>                 <span class="c1">// Number of textured rectangles</span>
    <span class="n">tr_face4</span> <span class="n">Rectangles</span><span class="p">[</span><span class="n">NumRectangles</span><span class="p">];</span>   <span class="c1">// List of textured rectangles</span>

    <span class="kt">int16_t</span> <span class="n">NumTriangles</span><span class="p">;</span>                  <span class="c1">// Number of textured triangles</span>
    <span class="n">tr_face3</span> <span class="n">Triangles</span><span class="p">[</span><span class="n">NumTriangles</span><span class="p">];</span>     <span class="c1">// List of textured triangles</span>

    <span class="kt">int16_t</span> <span class="n">NumSprites</span><span class="p">;</span>                    <span class="c1">// Number of sprites</span>
    <span class="n">tr2_room_sprite</span> <span class="n">Sprites</span><span class="p">[</span><span class="n">NumSprites</span><span class="p">];</span>   <span class="c1">// List of sprites</span>
<span class="p">};</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_room_static_mesh_structure">3.2.8. Room Static Mesh Structure</h4>
<div class="paragraph"><p>Positions and IDs of static meshes (e.g. skeletons, spiderwebs, furniture, trees). This is comparable to the <a href="#tr2_item">[tr2_item]</a> structure, except that static meshes
have no animations and are confined to a single room.</p></div>
<div class="sect4">
<h5 id="_tr1_room_static_mesh_structure">TR1 Room Static Mesh Structure</h5>
<div class="listingblock">
<a id="tr_room_staticmesh"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_room_staticmesh</span>  <span class="c1">// 18 bytes</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>    <span class="c1">// Absolute position in world coordinates</span>
    <span class="kt">uint16_t</span> <span class="n">Rotation</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">Intensity1</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">MeshID</span><span class="p">;</span>     <span class="c1">// Which StaticMesh item to draw</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>Intensity1</code> ranges from 0 (bright) to 0x1FFF (dark).</p></div>
<div class="paragraph"><p>In <code>Rotation</code> field, high two bits (<code>0xC000</code>) indicate steps of 90 degrees (e.g. (Rotation &gt;&gt; 14) * 90). However, when parsing this value, no extra bitshifting
is needed, as you can simply interpret it using this formula:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">float</span> <span class="n">Real_Rotation</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">Rotation</span> <span class="o">/</span> <span class="mf">16384.0f</span> <span class="o">*</span> <span class="o">-</span><span class="mi">90</span><span class="p">;</span>
</pre></div></div></div>
</div>
<div class="sect4">
<h5 id="_tr2_room_static_mesh_structure">TR2 Room Static Mesh Structure</h5>
<div class="paragraph"><p>TR2 again uses an extended version:</p></div>
<div class="listingblock">
<a id="tr2_room_staticmesh"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr2_room_staticmesh</span>  <span class="c1">// 20 bytes</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>    <span class="c1">// Absolute position in world coordinates</span>
    <span class="kt">uint16_t</span> <span class="n">Rotation</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">Intensity1</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">Intensity2</span><span class="p">;</span> <span class="c1">// Absent in TR1</span>
    <span class="kt">uint16_t</span> <span class="n">MeshID</span><span class="p">;</span>     <span class="c1">// Which StaticMesh item to draw</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>Intensity2</code> is seemingly not used, as changing this value does nothing.</p></div>
</div>
<div class="sect4">
<h5 id="_tr3_5_room_static_mesh_structure">TR3-5 Room Static Mesh Structure</h5>
<div class="listingblock">
<a id="tr3_room_staticmesh"></a>
<div class="content"><div class="highlight"><pre><span class="k">virtual</span> <span class="k">struct</span> <span class="n">tr3_room_staticmesh</span>  <span class="c1">// 20 bytes</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>    <span class="c1">// Absolute position in world coordinates</span>
    <span class="kt">uint16_t</span> <span class="n">Rotation</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">Colour</span><span class="p">;</span>     <span class="c1">// 15-bit colour</span>
    <span class="kt">uint16_t</span> <span class="n">Unused</span><span class="p">;</span>     <span class="c1">// Not used!</span>
    <span class="kt">uint16_t</span> <span class="n">MeshID</span><span class="p">;</span>     <span class="c1">// Which StaticMesh item to draw</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>Colour</code> value specifies vertex colour in 15-bit format (each colour occupies 5 bits): 0x0[red]RRRRR[green]GGGGG[blue]BBBBB. Therefore, each colour value&#8217;s
maximum is <em>31</em>. You can use this code to get each colour:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Red:</em> <code>((Colour &amp; 0x7C00) &gt;&gt; 10)</code>
</p>
</li>
<li>
<p>
<em>Green:</em> <code>((Colour &amp; 0x03E0) &gt;&gt; 5)</code>
</p>
</li>
<li>
<p>
<em>Blue:</em> <code>(Colour &amp; 0x001F)</code>
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tr5_room_structure_changes">3.3. TR5 Room Structure Changes</h3>
<div class="paragraph"><p>In TR5 the room format was drastically changed. The room itself is made up of <em>sections</em>. These sections encompass a 3x3 sector grid (actually 3069x3069
pixels). Historically, these sections are referred as <em>layers</em>, however, more proper name for them is <em>volumes</em>. Layers are organized in a quadtree-like
structure, and their purpose was presumably optimizing rendering by some kind of space partitioning and culling invisible volumes.</p></div>
<div class="paragraph"><p>Another thing to note is that some <em>rooms</em> in TR5 do not actually contain visible mesh data. If concerned, we will refer to these rooms as <em>null rooms</em>.</p></div>
<div class="sect3">
<h4 id="_tr5_room_layer_structure">3.3.1. TR5 Room Layer Structure</h4>
<div class="listingblock">
<a id="tr5_room_layer"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr5_room_layer</span>   <span class="c1">// 56 bytes</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">NumLayerVertices</span><span class="p">;</span>   <span class="c1">// Number of vertices in this layer (4 bytes)</span>
    <span class="kt">uint16_t</span> <span class="n">UnknownL1</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">NumLayerRectangles</span><span class="p">;</span> <span class="c1">// Number of rectangles in this layer (2 bytes)</span>
    <span class="kt">uint16_t</span> <span class="n">NumLayerTriangles</span><span class="p">;</span>  <span class="c1">// Number of triangles in this layer (2 bytes)</span>
    <span class="kt">uint16_t</span> <span class="n">UnknownL2</span><span class="p">;</span>

    <span class="kt">uint16_t</span> <span class="n">Filler</span><span class="p">;</span>             <span class="c1">// Always 0</span>
    <span class="kt">uint16_t</span> <span class="n">Filler2</span><span class="p">;</span>            <span class="c1">// Always 0</span>

    <span class="c1">// The following 6 floats define the bounding box for the layer</span>

    <span class="kt">float</span>    <span class="n">LayerBoundingBoxX1</span><span class="p">;</span>
    <span class="kt">float</span>    <span class="n">LayerBoundingBoxY1</span><span class="p">;</span>
    <span class="kt">float</span>    <span class="n">LayerBoundingBoxZ1</span><span class="p">;</span>
    <span class="kt">float</span>    <span class="n">LayerBoundingBoxX2</span><span class="p">;</span>
    <span class="kt">float</span>    <span class="n">LayerBoundingBoxY2</span><span class="p">;</span>
    <span class="kt">float</span>    <span class="n">LayerBoundingBoxZ2</span><span class="p">;</span>

    <span class="kt">uint32_t</span> <span class="n">Filler3</span><span class="p">;</span>     <span class="c1">// Always 0 (4 bytes)</span>
    <span class="kt">uint32_t</span> <span class="n">UnknownL6</span><span class="p">;</span>   <span class="c1">// Unknown</span>
    <span class="kt">uint32_t</span> <span class="n">UnknownL7</span><span class="p">;</span>   <span class="c1">// Unknown</span>
    <span class="kt">uint32_t</span> <span class="n">UnknownL8</span><span class="p">;</span>   <span class="c1">// Always the same throughout the level.</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p><code>UnknownL2</code> appears to be the number of double sided textures in this layer, however is sometimes 1 off (2 bytes).</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_the_whole_room_structure">3.4. The Whole Room Structure</h3>
<div class="paragraph"><p>Here&#8217;s where all the room data come together.</p></div>
<div class="paragraph"><p>Room structure differs drastically across different game versions (especially in TR5). For this reason, we will define each version of Room structure
independently, to avoid confusion. Also, version-specific fields will be described in each version&#8217;s section in a &#8220;backwards-compatible&#8221; manner, while common
fields with version-specific variations, such as <code>Flags</code>, will be described afterwards in separate section.</p></div>
<div class="paragraph"><p><em>These are not &#8220;real&#8221; C/C++ structures, in that the arrays are sized by the <code>NumXXX</code> elements that precede them.</em></p></div>
<div class="sect3">
<h4 id="_tr1_room_structure">3.4.1. TR1 Room Structure</h4>
<div class="paragraph"><p>As it&#8217;s stored in the file, the <a href="#tr_room_info">[tr_room_info]</a> structure comes first, followed by a <code>uint32_t NumDataWords</code>, which specifies the number of 16-bit words to
follow.  Those data words must be parsed in order to interpret and construct the variable-length arrays of vertices, meshes, doors, and sectors. Such setup is
also applicable to all variations of room structures, <em>except</em> <code>tr5_room</code>, which will be described independently.</p></div>
<div class="listingblock">
<a id="tr_room"></a>
<div class="content"><div class="highlight"><pre><span class="k">virtual</span> <span class="k">struct</span> <span class="n">tr_room</span>  <span class="c1">// (variable length)</span>
<span class="p">{</span>
    <span class="n">tr_room_info</span> <span class="n">info</span><span class="p">;</span>           <span class="c1">// Where the room exists, in world coordinates</span>

    <span class="kt">uint32_t</span> <span class="n">NumDataWords</span><span class="p">;</span>       <span class="c1">// Number of data words (uint16_t&#39;s)</span>
    <span class="kt">uint16_t</span> <span class="n">Data</span><span class="p">[</span><span class="n">NumDataWords</span><span class="p">];</span> <span class="c1">// The raw data from which the rest of this is derived</span>

    <span class="n">tr_room_data</span> <span class="n">RoomData</span><span class="p">;</span>       <span class="c1">// The room mesh</span>

    <span class="kt">uint16_t</span> <span class="n">NumPortals</span><span class="p">;</span>                 <span class="c1">// Number of visibility portals to other rooms</span>
    <span class="n">tr_room_portal</span> <span class="n">Portals</span><span class="p">[</span><span class="n">NumPortals</span><span class="p">];</span>  <span class="c1">// List of visibility portals</span>

    <span class="kt">uint16_t</span> <span class="n">NumZsectors</span><span class="p">;</span>                                  <span class="c1">// ``Width&#39;&#39; of sector list</span>
    <span class="kt">uint16_t</span> <span class="n">NumXsectors</span><span class="p">;</span>                                  <span class="c1">// ``Height&#39;&#39; of sector list</span>
    <span class="n">tr_room_sector</span> <span class="n">SectorList</span><span class="p">[</span><span class="n">NumXsectors</span> <span class="o">*</span> <span class="n">NumZsectors</span><span class="p">];</span>  <span class="c1">// List of sectors in this room</span>

    <span class="kt">int16_t</span> <span class="n">AmbientIntensity</span><span class="p">;</span>

    <span class="kt">uint16_t</span> <span class="n">NumLights</span><span class="p">;</span>                 <span class="c1">// Number of lights in this room</span>
    <span class="n">tr_room_light</span> <span class="n">Lights</span><span class="p">[</span><span class="n">NumLights</span><span class="p">];</span>    <span class="c1">// List of lights</span>

    <span class="kt">uint16_t</span> <span class="n">NumStaticMeshes</span><span class="p">;</span>                            <span class="c1">// Number of static meshes</span>
    <span class="n">tr2_room_staticmesh</span> <span class="n">StaticMeshes</span><span class="p">[</span><span class="n">NumStaticMeshes</span><span class="p">];</span>   <span class="c1">// List of static meshes</span>

    <span class="kt">int16_t</span> <span class="n">AlternateRoom</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">Flags</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>AmbientIntensity</code> is a brightness value which affects only <em>externally-lit</em> objects. It ranges from 0 (bright) to 0x1FFF (dark).</p></div>
<div class="paragraph"><p><code>AlternateRoom</code> (or, as it is called in TRLE terms, <em>flipped room</em>) is the number of the room that this room can <em>flip</em> with. In the terms of the gameplay,
<em>flipped</em> room is a state change of the same room&#8201;&#8212;&#8201;for example, empty or flooded with water, filled with sand or debris. Alternate room usually has the same
boundaries as original room, but altered geometry and/or texturing. Detailed description of <em>alternate rooms</em> will be provided in a separate section.</p></div>
</div>
<div class="sect3">
<h4 id="_tr2_room_structure">3.4.2. TR2 Room Structure</h4>
<div class="listingblock">
<a id="tr2_room"></a>
<div class="content"><div class="highlight"><pre><span class="k">virtual</span> <span class="k">struct</span> <span class="n">tr2_room</span>  <span class="c1">// (variable length)</span>
<span class="p">{</span>
    <span class="n">tr_room_info</span> <span class="n">info</span><span class="p">;</span>           <span class="c1">// Where the room exists, in world coordinates</span>

    <span class="kt">uint32_t</span> <span class="n">NumDataWords</span><span class="p">;</span>       <span class="c1">// Number of data words (uint16_t&#39;s)</span>
    <span class="kt">uint16_t</span> <span class="n">Data</span><span class="p">[</span><span class="n">NumDataWords</span><span class="p">];</span> <span class="c1">// The raw data from which the rest of this is derived</span>

    <span class="n">tr_room_data</span> <span class="n">RoomData</span><span class="p">;</span>       <span class="c1">// The room mesh</span>

    <span class="kt">uint16_t</span> <span class="n">NumPortals</span><span class="p">;</span>                 <span class="c1">// Number of visibility portals to other rooms</span>
    <span class="n">tr_room_portal</span> <span class="n">Portals</span><span class="p">[</span><span class="n">NumPortals</span><span class="p">];</span>  <span class="c1">// List of visibility portals</span>

    <span class="kt">uint16_t</span> <span class="n">NumZsectors</span><span class="p">;</span>                                  <span class="c1">// ``Width&#39;&#39; of sector list</span>
    <span class="kt">uint16_t</span> <span class="n">NumXsectors</span><span class="p">;</span>                                  <span class="c1">// ``Height&#39;&#39; of sector list</span>
    <span class="n">tr_room_sector</span> <span class="n">SectorList</span><span class="p">[</span><span class="n">NumXsectors</span> <span class="o">*</span> <span class="n">NumZsectors</span><span class="p">];</span>  <span class="c1">// List of sectors in this room</span>

    <span class="kt">int16_t</span> <span class="n">AmbientIntensity</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">AmbientIntensity2</span><span class="p">;</span>  <span class="c1">// Usually the same as AmbientIntensity</span>
    <span class="kt">int16_t</span> <span class="n">LightMode</span><span class="p">;</span>

    <span class="kt">uint16_t</span> <span class="n">NumLights</span><span class="p">;</span>                 <span class="c1">// Number of point lights in this room</span>
    <span class="n">tr_room_light</span> <span class="n">Lights</span><span class="p">[</span><span class="n">NumLights</span><span class="p">];</span>    <span class="c1">// List of point lights</span>

    <span class="kt">uint16_t</span> <span class="n">NumStaticMeshes</span><span class="p">;</span>                            <span class="c1">// Number of static meshes</span>
    <span class="n">tr_room_staticmesh</span> <span class="n">StaticMeshes</span><span class="p">[</span><span class="n">NumStaticMeshes</span><span class="p">];</span>   <span class="c1">// List of static meshes</span>

    <span class="kt">int16_t</span> <span class="n">AlternateRoom</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">Flags</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>AmbientIntensity2</code> value is usually equal to <code>AmbientIntensity</code> value. Seems it&#8217;s not used.</p></div>
<div class="paragraph"><p><code>LightMode</code> specifies lighting mode special effect, which is applied to all room vertices in conjunction with 5 lowest bits of <code>Attributes</code> field belonging to
<a href="#tr_room_vertex">[tr_room_vertex]</a> structure. Here we will refer these 5 bits value to as <code>effect_value</code>:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>0</strong>&#8201;&#8212;&#8201;Normal lighting mode, no special effects.
</p>
</li>
<li>
<p>
<strong>2</strong>&#8201;&#8212;&#8201;If <code>effect_value</code> is in 1-15 range, then vertex lighting is cyclically fading to more bright value. The lower the value is, the deeper the fade to full
  vertex lighting is. If <code>effect_value</code> is in 17-30 range (<em>not</em> 31!), then vertex lighting is cyclically fading to more dark value. The higher the value is, the
  deeper the fade to black is. If <code>effect_value</code> is 16 or 0, no effect is produced. So practically, <code>effect_value</code> serves as a multiplier to overall effect
  brightness.
</p>
</li>
<li>
<p>
<strong>1</strong>&#8201;&#8212;&#8201;Produces flickering effect, with <code>effect_value</code> acting the same way&#8201;&#8212;&#8201;as intensity multiplier.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_tr3_room_structure">3.4.3. TR3 Room Structure</h4>
<div class="listingblock">
<a id="tr3_room"></a>
<div class="content"><div class="highlight"><pre><span class="k">virtual</span> <span class="k">struct</span> <span class="n">tr3_room</span>  <span class="c1">// (variable length)</span>
<span class="p">{</span>
    <span class="n">tr_room_info</span> <span class="n">info</span><span class="p">;</span>           <span class="c1">// Where the room exists, in world coordinates</span>

    <span class="kt">uint32_t</span> <span class="n">NumDataWords</span><span class="p">;</span>       <span class="c1">// Number of data words (uint16_t&#39;s)</span>
    <span class="kt">uint16_t</span> <span class="n">Data</span><span class="p">[</span><span class="n">NumDataWords</span><span class="p">];</span> <span class="c1">// The raw data from which the rest of this is derived</span>

    <span class="n">tr_room_data</span> <span class="n">RoomData</span><span class="p">;</span>       <span class="c1">// The room mesh</span>

    <span class="kt">uint16_t</span> <span class="n">NumPortals</span><span class="p">;</span>                 <span class="c1">// Number of visibility portals to other rooms</span>
    <span class="n">tr_room_portal</span> <span class="n">Portals</span><span class="p">[</span><span class="n">NumPortals</span><span class="p">];</span>  <span class="c1">// List of visibility portals</span>

    <span class="kt">uint16_t</span> <span class="n">NumZsectors</span><span class="p">;</span>                                  <span class="c1">// ``Width&#39;&#39; of sector list</span>
    <span class="kt">uint16_t</span> <span class="n">NumXsectors</span><span class="p">;</span>                                  <span class="c1">// ``Height&#39;&#39; of sector list</span>
    <span class="n">tr_room_sector</span> <span class="n">SectorList</span><span class="p">[</span><span class="n">NumXsectors</span> <span class="o">*</span> <span class="n">NumZsectors</span><span class="p">];</span>  <span class="c1">// List of sectors in this room</span>

    <span class="kt">int16_t</span> <span class="n">AmbientIntensity1</span><span class="p">;</span>  <span class="c1">// This and the next one only affect externally-lit objects</span>
    <span class="kt">int16_t</span> <span class="n">AmbientIntensity2</span><span class="p">;</span>  <span class="c1">// Usually the same as AmbientIntensity1</span>

    <span class="kt">uint16_t</span> <span class="n">NumLights</span><span class="p">;</span>                 <span class="c1">// Number of point lights in this room</span>
    <span class="n">tr3_room_light</span> <span class="n">Lights</span><span class="p">[</span><span class="n">NumLights</span><span class="p">];</span>   <span class="c1">// List of point lights</span>

    <span class="kt">uint16_t</span> <span class="n">NumStaticMeshes</span><span class="p">;</span>                            <span class="c1">// Number of static meshes</span>
    <span class="n">tr_room_staticmesh</span> <span class="n">StaticMeshes</span><span class="p">[</span><span class="n">NumStaticMeshes</span><span class="p">];</span>    <span class="c1">// List of static meshes</span>

    <span class="kt">int16_t</span> <span class="n">AlternateRoom</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">Flags</span><span class="p">;</span>

    <span class="kt">uint8_t</span> <span class="n">WaterScheme</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">ReverbInfo</span><span class="p">;</span>

    <span class="kt">uint8_t</span> <span class="n">Filler</span><span class="p">;</span>  <span class="c1">// Unused.</span>
<span class="p">};</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_tr4_room_structure">3.4.4. TR4 Room Structure</h4>
<div class="listingblock">
<a id="tr4_room"></a>
<div class="content"><div class="highlight"><pre><span class="k">virtual</span> <span class="k">struct</span> <span class="n">tr4_room</span>  <span class="c1">// (variable length)</span>
<span class="p">{</span>
    <span class="n">tr_room_info</span> <span class="n">info</span><span class="p">;</span>           <span class="c1">// Where the room exists, in world coordinates</span>

    <span class="kt">uint32_t</span> <span class="n">NumDataWords</span><span class="p">;</span>       <span class="c1">// Number of data words (uint16_t&#39;s)</span>
    <span class="kt">uint16_t</span> <span class="n">Data</span><span class="p">[</span><span class="n">NumDataWords</span><span class="p">];</span> <span class="c1">// The raw data from which the rest of this is derived</span>

    <span class="n">tr_room_data</span> <span class="n">RoomData</span><span class="p">;</span>       <span class="c1">// The room mesh</span>

    <span class="kt">uint16_t</span> <span class="n">NumPortals</span><span class="p">;</span>                 <span class="c1">// Number of visibility portals to other rooms</span>
    <span class="n">tr_room_portal</span> <span class="n">Portals</span><span class="p">[</span><span class="n">NumPortals</span><span class="p">];</span>  <span class="c1">// List of visibility portals</span>

    <span class="kt">uint16_t</span> <span class="n">NumZsectors</span><span class="p">;</span>                                  <span class="c1">// ``Width&#39;&#39; of sector list</span>
    <span class="kt">uint16_t</span> <span class="n">NumXsectors</span><span class="p">;</span>                                  <span class="c1">// ``Height&#39;&#39; of sector list</span>
    <span class="n">tr2_room_sector</span> <span class="n">SectorList</span><span class="p">[</span><span class="n">NumXsectors</span> <span class="o">*</span> <span class="n">NumZsectors</span><span class="p">];</span> <span class="c1">// List of sectors in this room</span>

    <span class="kt">uint32_t</span> <span class="n">RoomColour</span><span class="p">;</span>        <span class="c1">// In ARGB format!</span>

    <span class="kt">int16_t</span> <span class="n">AmbientIntensity1</span><span class="p">;</span>  <span class="c1">// This and the next one only affect externally-lit objects</span>
    <span class="kt">int16_t</span> <span class="n">AmbientIntensity2</span><span class="p">;</span>  <span class="c1">// Usually the same as AmbientIntensity1</span>

    <span class="kt">uint16_t</span> <span class="n">NumLights</span><span class="p">;</span>                 <span class="c1">// Number of point lights in this room</span>
    <span class="n">tr4_room_light</span> <span class="n">Lights</span><span class="p">[</span><span class="n">NumLights</span><span class="p">];</span>   <span class="c1">// List of point lights</span>

    <span class="kt">uint16_t</span> <span class="n">NumStaticMeshes</span><span class="p">;</span>                           <span class="c1">// Number of static meshes</span>
    <span class="n">tr_room_staticmesh</span> <span class="n">StaticMeshes</span><span class="p">[</span><span class="n">NumStaticMeshes</span><span class="p">];</span>   <span class="c1">// List of static meshes</span>

    <span class="kt">int16_t</span> <span class="n">AlternateRoom</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">Flags</span><span class="p">;</span>

    <span class="kt">uint8_t</span> <span class="n">WaterScheme</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">ReverbInfo</span><span class="p">;</span>

    <span class="kt">uint8_t</span> <span class="n">AlternateGroup</span><span class="p">;</span>  <span class="c1">// Replaces Filler from TR3</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>RoomColour</code> replaces <code>AmbientIntensity</code> and <code>AmbientIntensity2</code> values from <code>tr2_room</code> structure. Note it&#8217;s <em>not in <code>tr_colour4</code> format</em>, because colour order
is reversed. It should be treated as ARGB, where A is unused.</p></div>
<div class="paragraph"><p><code>AlternateGroup</code> was introduced in TR4 to solve long-existing engine limitation, which flipped <em>all alternate rooms at once</em> (see <em>flipmap</em> trigger function
description in <a href="#trigger-functions">Trigger Functions</a> section). Since TR4, engine only flips rooms which have similar index in room&#8217;s <code>AlternateGroup</code> field
and trigger operand.</p></div>
</div>
<div class="sect3">
<h4 id="_tr5_room_structure">3.4.5. TR5 Room Structure</h4>
<div class="paragraph"><p>As it was mentioned before, TR5 room structure was almost completely changed, when compared to previous versions. For example, TR5 completely throws out a
concept of <code>tr_room_data</code> structure, shuffles numerous values and structures in almost chaotic manner, and introduces a bunch of completely new parameters
(mostly to deal with <em>layers</em>). Also, there is vast amount of <em>fillers</em> and <em>separators</em>, which contain no specific data.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">The one possible reason for such ridiculous structure change is an attempt to <em>crypt file format</em>, so it won&#8217;t be accessed by unofficial level editing
tools, which received major development by that time. Another possible reason is whole TR5 development process was rushed, as the team developed <em>Tomb Raider:
Angel of Darkness</em> at the very same time.</td>
</tr></table>
</div>
<div class="listingblock">
<a id="tr5_room"></a>
<div class="content"><div class="highlight"><pre><span class="k">virtual</span> <span class="k">struct</span> <span class="n">tr5_room</span> <span class="c1">// (variable length)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">XELA</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>           <span class="c1">// So-called &quot;XELA landmark&quot;</span>

    <span class="kt">uint32_t</span> <span class="n">RoomDataSize</span><span class="p">;</span>

    <span class="kt">uint32_t</span> <span class="n">Seperator</span><span class="p">;</span>     <span class="c1">// 0xCDCDCDCD (4 bytes)</span>

    <span class="kt">uint32_t</span> <span class="n">EndSDOffset</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">StartSDOffset</span><span class="p">;</span>

    <span class="kt">uint32_t</span> <span class="n">Separator</span><span class="p">;</span>     <span class="c1">// Either 0 or 0xCDCDCDCD</span>

    <span class="kt">uint32_t</span> <span class="n">EndPortalOffset</span><span class="p">;</span>

    <span class="n">tr_room_info</span> <span class="n">info</span><span class="p">;</span>

    <span class="kt">uint16_t</span> <span class="n">NumZSectors</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">NumXSectors</span><span class="p">;</span>

    <span class="kt">uint32_t</span> <span class="n">RoomColour</span><span class="p">;</span>   <span class="c1">// In ARGB format!</span>

    <span class="kt">uint16_t</span> <span class="n">NumLights</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">NumStaticMeshes</span><span class="p">;</span>

    <span class="kt">uint8_t</span>  <span class="n">ReverbInfo</span><span class="p">;</span>
    <span class="kt">uint8_t</span>  <span class="n">AlternateGroup</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">WaterScheme</span><span class="p">;</span>

    <span class="kt">uint32_t</span> <span class="n">Filler</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>    <span class="c1">// Both always 0x00007FFF</span>
    <span class="kt">uint32_t</span> <span class="n">Separator</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="c1">// Both always 0xCDCDCDCD</span>
    <span class="kt">uint32_t</span> <span class="n">Filler</span><span class="p">;</span>       <span class="c1">// Always 0xFFFFFFFF</span>

    <span class="kt">uint16_t</span> <span class="n">AlternateRoom</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">Flags</span><span class="p">;</span>

    <span class="kt">uint32_t</span> <span class="n">Unknown1</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">Unknown2</span><span class="p">;</span>     <span class="c1">// Always 0</span>
    <span class="kt">uint32_t</span> <span class="n">Unknown3</span><span class="p">;</span>     <span class="c1">// Always 0</span>

    <span class="kt">uint32_t</span> <span class="n">Separator</span><span class="p">;</span>    <span class="c1">// 0xCDCDCDCD</span>

    <span class="kt">uint16_t</span> <span class="n">Unknown4</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">Unknown5</span><span class="p">;</span>

    <span class="kt">float</span> <span class="n">RoomX</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">RoomY</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">RoomZ</span><span class="p">;</span>

    <span class="kt">uint32_t</span> <span class="n">Separator</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// Always 0xCDCDCDCD</span>
    <span class="kt">uint32_t</span> <span class="n">Separator</span><span class="p">;</span>    <span class="c1">// 0 for normal rooms and 0xCDCDCDCD for null rooms</span>
    <span class="kt">uint32_t</span> <span class="n">Separator</span><span class="p">;</span>    <span class="c1">// Always 0xCDCDCDCD</span>

    <span class="kt">uint32_t</span> <span class="n">NumRoomTriangles</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">NumRoomRectangles</span><span class="p">;</span>

    <span class="kt">uint32_t</span> <span class="n">Separator</span><span class="p">;</span>     <span class="c1">// Always 0</span>

    <span class="kt">uint32_t</span> <span class="n">LightDataSize</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">NumLights2</span><span class="p">;</span>    <span class="c1">// Always same as NumLights</span>

    <span class="kt">uint32_t</span> <span class="n">Unknown6</span><span class="p">;</span>

    <span class="kt">int32_t</span> <span class="n">RoomYTop</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">RoomYBottom</span><span class="p">;</span>

    <span class="kt">uint32_t</span> <span class="n">NumLayers</span><span class="p">;</span>

    <span class="kt">uint32_t</span> <span class="n">LayerOffset</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">VerticesOffset</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">PolyOffset</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">PolyOffset2</span><span class="p">;</span>   <span class="c1">// Same as PolyOffset</span>

    <span class="kt">uint32_t</span> <span class="n">NumVertices</span><span class="p">;</span>

    <span class="kt">uint32_t</span> <span class="n">Separator</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>  <span class="c1">// Always 0xCDCDCDCD</span>

    <span class="n">tr5_room_light</span> <span class="n">Lights</span><span class="p">[</span><span class="n">NumLights</span><span class="p">];</span>    <span class="c1">// Data for the lights (88 bytes * NumRoomLights)</span>
    <span class="n">tr2_room_sector</span> <span class="n">SectorList</span><span class="p">[</span><span class="n">NumXSectors</span> <span class="o">*</span> <span class="n">NumZSectors</span><span class="p">];</span> <span class="c1">// List of sectors in this room</span>

    <span class="kt">uint16_t</span> <span class="n">NumPortals</span><span class="p">;</span>                 <span class="c1">// Number of visibility portals to other rooms</span>
    <span class="n">tr_room_portal</span> <span class="n">Portals</span><span class="p">[</span><span class="n">NumPortals</span><span class="p">];</span>  <span class="c1">// List of visibility portals</span>

    <span class="kt">uint16_t</span> <span class="n">Separator</span><span class="p">;</span>  <span class="c1">// Always 0xCDCD</span>

    <span class="n">tr3_room_staticmesh</span> <span class="n">StaticMeshes</span><span class="p">[</span><span class="n">NumStaticMeshes</span><span class="p">];</span>   <span class="c1">// List of static meshes</span>

    <span class="n">tr5_room_layer</span><span class="p">[</span><span class="n">NumLayers</span><span class="p">];</span> <span class="c1">// Data for the room layers (volumes) (56 bytes * NumLayers)</span>

    <span class="kt">uint8_t</span> <span class="n">Faces</span><span class="p">[(</span><span class="n">NumRoomRectangles</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tr_face4</span><span class="p">)</span> <span class="o">+</span> <span class="n">NumRoomTriangles</span> <span class="o">*</span> <span class="p">(</span><span class="n">tr_face3</span><span class="p">)];</span>

    <span class="n">tr5_room_vertex</span> <span class="n">Vertices</span><span class="p">[</span><span class="n">NumVertices</span><span class="p">];</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p><code>XELA</code> landmark seemingly serves as a header for room structure. It is clear that <em>XELA</em> is a reversed <em>ALEX</em>, which is most likely the name of TR5 programmer,
<em>Alex Davis</em>. It probably indicates that Alex Davis is responsible for changes in room structures.</p></div>
<div class="paragraph"><p><code>RoomDataSize</code> is a handy value determining the size of the following data. You can use this value to quickly <em>parse thru</em> to the next room.</p></div>
<div class="paragraph"><p><code>EndSDOffset</code>: usually this number <code>+216</code> will give you the offset from the start of the room data to the end of the <code>SectorData</code> section. However, it is known
that this uint32_t could be equal to <code>0xFFFFFFFF</code>, so to calculate the end of <code>SectorData</code>, it is better to use the following value <code>StartSDOffset + 216 +
((NumXSectors * NumZSectors)*8)</code>, if you need to obtain this information.</p></div>
<div class="paragraph"><p><code>StartSDOffset</code>: This number <code>+216</code> will give you the offset from the start of the room to the start of the <code>SectorData</code> section.</p></div>
<div class="paragraph"><p><code>EndPortalOffset</code>: this number <code>+216</code> will give you the offset from the start of the room to the end of the portal data.</p></div>
<div class="paragraph"><p><code>RoomX</code>, <code>RoomY</code> and <code>RoomZ</code> values are positions of room in world coordinates. <strong>NOTE:</strong> If room is <em>null room</em>, then each of these values will be <code>0xCDCDCDCD</code>.</p></div>
<div class="paragraph"><p><code>NumRoomTriangles</code> and <code>NumRoomRectangles</code> are respectively the numbers of triangular and rectangular faces in a given room. <strong>NOTE:</strong> If room is <em>null room</em>,
each of these values will be <code>0xCDCDCDCD</code>.</p></div>
<div class="paragraph"><p><code>LightDataSize</code> is the size of the light data in bytes (<em>not</em> in <code>tr5_room_light</code> units).</p></div>
<div class="paragraph"><p><code>Unknown6</code> could probably be a copy of <code>ReverbInfo</code> (see further), as its value usually ranges from 0 to 3.</p></div>
<div class="paragraph"><p><code>RoomYTop</code> and <code>RoomYBottom</code> are equal to <code>yTop</code> and <code>yBottom</code> values in <a href="#tr_room_info">[tr_room_info]</a> structure. If room is a <em>null room</em>, both of these values are
<code>0xCDCDCDCD</code>.</p></div>
<div class="paragraph"><p><code>NumLayers</code> is a number of layers (volumes) in this room.</p></div>
<div class="paragraph"><p><code>LayerOffset</code>: this number <code>+216</code> will give you an offset from the start of the room data to the start of the layer data.</p></div>
<div class="paragraph"><p><code>VerticesOffset</code>: this number <code>+216</code> will give you an offset from the start of the room data to the start of the verex data.</p></div>
<div class="paragraph"><p><code>PolyOffset</code>: this number <code>+216</code> will give you an offset from the start of the room data to the start of the rectangle/triangle data.</p></div>
<div class="paragraph"><p><code>VerticesSize</code> is the size of vertex data block in bytes. Therefore, it <em>must</em> be a multiple of <code>tr5_room_vertex</code> size, else it means the block size is wrong.</p></div>
<div class="paragraph"><p><code>Faces</code> is a sequential data array for the room polygons (both <code>tr_face4</code> and <code>tr_face3</code>),</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content"><code>Faces</code> array is strictly linked with <code>NumLayers</code> value. The data is sequentially structured for each layer&#8201;&#8212;&#8201;at first it lists first layer&#8217;s rectangles
then triangles, followed by the second layer&#8217;s rectangles and triangles, and so on, until all layers are done.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_common_fields_of_a_room_structure">3.4.6. Common Fields of a Room Structure</h4>
<div class="paragraph"><p><code>Flags</code> is an array of various flag bits, which meaning is as follows:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>Bit 0</strong>&#8201;&#8212;&#8201;Room is filled with water.
</p>
</li>
<li>
<p>
<strong>Bit 3</strong>&#8201;&#8212;&#8201;<span class="image">
<img src="images/icons/tr2.png" alt="TR2 only" width="16" height="17" title="TR2 only" />
</span><span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Set if the <em>skybox</em> can be seen from this room. Used to speed things up: if no rendered room has this bit set, then the sky can
  never been seen, so it is not rendered. Else, if at least one visible room has this bit set, then the sky must be drawn because it is (could be) visible.
</p>
</li>
<li>
<p>
<strong>Bit 5</strong>&#8201;&#8212;&#8201;<span class="image">
<img src="images/icons/tr2.png" alt="TR2 only" width="16" height="17" title="TR2 only" />
</span><span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Lara&#8217;s ponytail gets blown by the wind. Beginning with TR3, some particle types are also be blown, if they end up in such room
  (particle type is specified by certain particle flag).
</p>
</li>
<li>
<p>
<strong>Bit 6</strong>&#8201;&#8212;&#8201;<span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Unknown. A lot of rooms have this bit set but it seems it does nothing&#8230;
</p>
</li>
<li>
<p>
<strong>Bit 7</strong>&#8201;&#8212;&#8201;<span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Different meaning in TR3 and TR4/5. In TR3, it means that room is filled with quicksand, while in TR4/5 it presumably blocks <em>global
  lens flare</em> from appearing in that room (in TRLE, checkbox which sets this flag is named <em>NL</em>).
</p>
</li>
<li>
<p>
<strong>Bit 8</strong>&#8201;&#8212;&#8201;<span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Creates <em>caustics effect</em> similar to that used in water rooms. TRLE sets this bit when the M option is used (in the same time, the
  degree of fading intensity typed by the user is put in the <code>water_scheme</code> byte).
</p>
</li>
<li>
<p>
<strong>Bit 9</strong>&#8201;&#8212;&#8201;<span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> The room has some <em>water reflectivity</em>. TRLE sets this bit when the R (<em>reflectivity</em>) option is used (in the same time, the amount
  of reflectivity typed by the user + 5 is put in the <code>water_scheme</code> byte). When the flag is set for normal room and there is water room below it, game engine
  creates &#8220;reflection effect&#8221; above the water surface&#8201;&#8212;&#8201;effectively it means that all the vertices at the bottom of the room receive caustics effect described
  well above.
</p>
</li>
<li>
<p>
<strong>Bit 11</strong>&#8201;&#8212;&#8201;<span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Not found in any original TR levels, but when the <em>D</em> flag is set in the TRLE, this bit is set. Was re-used in NGLE as a flag specifying
  <em>Damage room</em>.
</p>
</li>
<li>
<p>
<strong>Bit 12</strong>&#8201;&#8212;&#8201;<span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Not found in any original TR levels, but when the <em>P</em> flag is set in the TRLE, this bit is set. Was also re-used in NGLE as a flag
  specifying <em>Poisonous room</em>.
</p>
</li>
</ul></div>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> <code>WaterScheme</code> is used for different purposes. If room is a water room, then it specifies underwater caustics patterns. If it is set for normal
room <em>placed above the water room</em>, then it controls <em>wave strength</em> effect applied to the faces adjoining water room. Maximum value in both cases is 15.</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> <code>ReverbInfo</code> defines <em>room reverberation type</em>. It affects sound postprocessing, if listener position belongs to that room. This feature was
present <em>only in PlayStation versions</em> of the game, but not on PC. Nevertheless, the info is preserved in PC level files. Here are the types of reverberation:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>0</strong>&#8201;&#8212;&#8201;Outside. No (or barely heard) reverberation.
</p>
</li>
<li>
<p>
<strong>1</strong>&#8201;&#8212;&#8201;Small room. Little reverberation.
</p>
</li>
<li>
<p>
<strong>2</strong>&#8201;&#8212;&#8201;Medium room.
</p>
</li>
<li>
<p>
<strong>3</strong>&#8201;&#8212;&#8201;Large room.
</p>
</li>
<li>
<p>
<strong>4</strong>&#8201;&#8212;&#8201;Pipe. Highest reverberation level. Almost never used.
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="FloorData">4. FloorData</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_overview_2">4.1. Overview</h3>
<div class="paragraph"><p>The <em>FloorData</em> is the key part of the level structure, which defines almost everything related to &#8220;physical&#8221; world &#8201;&#8212;&#8201;geometry, interaction and response of
a level. While <em>room geometry</em> (see above) may be considered as a &#8220;face&#8221; of the level, <em>FloorData</em> is its &#8220;heart&#8221; and &#8220;brain&#8221;.</p></div>
<div class="paragraph"><p>Distinctive feature of the FloorData is its <em>serialized nature</em>. While in room geometry you can easily jump through structures using data sizes and pointers to
get the needed part, <em>FloorData</em> require sequential parsing, one unit by one.</p></div>
</div>
<div class="sect2">
<h3 id="_the_concept">4.2. The Concept</h3>
<div class="paragraph"><p>The <em>FloorData</em> defines special sector attributes such as individual floor and ceiling <em>corner heights</em> (slopes), <em>collisional</em> portals to other rooms,
<em>climbability</em> of walls, and, most important of all, <em>the various types of triggering</em>. Each room sector (see <a href="#tr_room_sector">[tr_room_sector]</a> structure) points to the
FloorData using <code>FDIndex</code> variable. It is referenced as an array of <em>16-bit unsigned integers</em> (<code>uint16</code>s).</p></div>
<div class="paragraph"><p>Therefore, the <em>current <code>tr_room_sector</code> offset</em> (not yet the FloorData pointer itself!) is calculated using this formula:</p></div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="100%"
frame="void"
cellspacing="0" cellpadding="4">
<col width="100%" />
<tbody>
<tr>
<td align="center" valign="top"><div><div class="paragraph"><p>$S_{Offset} = (((X_{current} - X_{room}) / 1024) \times n_{Zsectors}) + ((Z_{current} - Z_{room}) / 1024)$</p></div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>&#8230;where $X_{current}$ and $Z_{current}$ are current player positions, $X_{room}$ and $Z_{room}$ are
corresponding <code>tr_room_info.x</code> and <code>tr_room_info.z</code> fields, and $n_{Zsectors}$ is <code>tr_room.NumZsectors</code> value.</p></div>
<div class="paragraph"><p>Then, the <em>current FloorData pointer</em> is derived from calculated <code>tr_room_sector</code> structure&#8217;s <code>FDIndex</code> field. In other words, <code>FDindex</code> is an offset into the
<code>FloorData[]</code> array.</p></div>
<div class="paragraph"><p>As mentioned above, The FloorData consists of solely <code>uint16_t</code> entries without general structure&#8201;&#8212;&#8201;the way engine treats specific entry depends on the
sequence order and type of previously parsed entries. While it&#8217;s a bit difficult to understand it at first, you should get used to it. Main thing to remember is
the FloorData should be read sequentially.</p></div>
</div>
<div class="sect2">
<h3 id="_understanding_the_setup">4.3. Understanding The Setup</h3>
<div class="paragraph"><p><em>First order</em> of FloorData entries has a common &#8220;bitwise&#8221; structure, which we will call <code>FDSetup</code>. The structure could be divided into three fields:</p></div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="50%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="center" valign="top"><p class="table"><code>Function</code></p></td>
<td align="center" valign="top"><p class="table">bits 0..4 (<code>0x001F</code>)</p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table"><code>SubFunction</code></p></td>
<td align="center" valign="top"><p class="table">bits 8..14 (<code>0x7F00</code>)</p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table"><code>EndData</code></p></td>
<td align="center" valign="top"><p class="table">bit 15 (<code>0x8000</code>)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><code>Function</code> defines the type of action that must be done with current FloorData entry, and <code>SubFunction</code> is usually used in that action&#8217;s conditions and case
switches (if there are any). If there are no any special conditions for a given <code>Function</code>, then <code>SubFunction</code> <em>is not used</em>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/tip.png" alt="Tip" />
</td>
<td class="content">When parsing <code>FDSetup</code> for TR3, use only the lower 5 bits (0..4) to find the <code>Function</code> value, because some of TR3 <em>triangulation functions</em> use the upper
3 bits of the lower byte for other purpose. However, this will also work correctly in TR1 and TR2.</td>
</tr></table>
</div>
<div class="paragraph"><p>If <code>EndData</code> is set, there should be no more <em>similar</em> FloorData entries (after the current one) in the <code>FloorData[]</code> array&#8201;&#8212;&#8201;so further parsing must be
stopped.  Otherwise, the following <code>uint16_t</code> should be interpreted after the current one in the same manner.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">Even if <code>EndData</code> is set, it doesn&#8217;t specifically mean that there are no more <code>uint16_t</code> following the current one at all. As we will see, some FloorData
functions and subfunctions require to parse additional entries with their own rules. In programming terms, <code>EndData</code> just indicates that parsing loop must be
broken&#8201;&#8212;&#8201;however, there may be following code which reads additional entries.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">While <code>FloorData</code> index 0 means the sector does not use floordata, there is still a &#8220;dummy&#8221; entry for index 0. This dummy entry doesn&#8217;t contain any
useful information.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">Several of the functions indicate adjustments to the sector&#8217;s <em>corner heights</em>. The corners will be denoted as <code>00</code>, <code>01</code>, <code>10</code>, and <code>11</code>, where the first
digit is the corner&#8217;s X coordinate and the second digit is the corner&#8217;s Z coordinate, with both given as multiples of 1024.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_floordata_functions">4.4. FloorData Functions</h3>
<div class="sect3">
<h4 id="_function_code_0x01_code_8201_8212_8201_portal_sector">4.4.1. Function <code>0x01</code>&#8201;&#8212;&#8201;Portal Sector</h4>
<div class="paragraph"><p><em>SubFunction is not used</em></p></div>
<div class="paragraph"><p>The <em>next</em> <code>FloorData</code> entry is the number of the room that this sector is a collisional portal to. An entity that arrives in a sector with this function
present will gets its room membership changed to provided room number, without any change in position.</p></div>
<div class="paragraph"><p>To understand what exactly happens when room membership is changed, you must understand how collisional portals work in Tomb Raider&#8217;s 4D space. When two rooms
are connected with portal, it means that they also <em>overlap</em> within a distance of two sectors (because these sectors contain portal in each of the connected
rooms). This way, when room is changed, it remains unnoticed by the player, cause portal sectors are interconnected:</p></div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="70%"
frame="void"
cellspacing="0" cellpadding="4">
<col width="100%" />
<tbody>
<tr>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/illustrations/doors.png" alt="illustrations/doors.png" title="Floor sector triangulation types" />
</span></p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table"><em>Collisional portal layout. Blue sectors are walls around each room. Green sector is Room 2&#8217;s collisional portal to Room 1, and dark blue sector is Room 1&#8217;s
  collisional portal to Room 2</em></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_function_code_0x02_code_8201_8212_8201_floor_slant">4.4.2. Function <code>0x02</code>&#8201;&#8212;&#8201;Floor Slant</h4>
<div class="paragraph"><p><em>SubFunction is not used</em></p></div>
<div class="paragraph"><p>The next <code>FloorData</code> entry contains two <code>uint8_t</code> <em>slant values</em> for the <em>floor</em> of this sector. Slant values are specified in increments of 256 units
(so-called <em>clicks</em> in TRLE terms). The high byte is the <em>Z slope</em>, while the low byte is the <em>X slope</em>. If the X slope is greater than zero, then its value is
added to the floor heights of corners <code>00</code> and <code>01</code>. If it is less than zero, then its value is subtracted from the floor heights of corners <code>10</code> and <code>11</code>. If
the Z slope is greater than zero, then its value is added to the floor heights of corners <code>00</code> and <code>10</code>. If it is less than zero, then its value is subtracted
from the floor heights of corners <code>01</code> and <code>11</code>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">This function is never combined with <em>triangulation</em> functions present in TR3 onwards (see further).</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_function_code_0x03_code_8201_8212_8201_ceiling_slant">4.4.3. Function <code>0x03</code>&#8201;&#8212;&#8201;Ceiling Slant</h4>
<div class="paragraph"><p><em>SubFunction is not used</em></p></div>
<div class="paragraph"><p>The next <code>FloorData</code> entry contains two <code>uint8_t</code> <em>slant values</em> for the <em>ceiling</em> of this sector. Slant values are specified in increments of 256 units. The
high byte is the <em>Z slope</em>, while the low byte is the <em>X slope</em>. If the X slope is greater than zero, then its value is subtracted from the ceiling heights of
corners <code>10</code> and <code>11</code>. If it is less than zero, then its value is added to the ceiling heights of corners <code>00</code> and <code>01</code>. If the Z slope is greater than zero,
then its value is subtracted from the ceiling heights of corners <code>00</code> and <code>10</code>. If it is less than zero, then its value is added to the ceiling heights of
corners <code>01</code> and <code>11</code>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">This function is never combined with <em>triangulation</em> functions present in TR3 onwards (see further).</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_function_code_0x04_code_8201_8212_8201_trigger">4.4.4. Function <code>0x04</code>&#8201;&#8212;&#8201;Trigger</h4>
<div class="paragraph"><p>The <code>uint16_t</code> immediately following current entry is called <code>TriggerSetup</code>, and contains general trigger properties stored in a &#8220;bitwise&#8221; manner:</p></div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="30%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="33%" />
<col width="66%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><code>Timer</code></p></td>
<td align="left" valign="top"><p class="table">bits 0..7 (<code>0x00FF</code>)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>OneShot</code></p></td>
<td align="left" valign="top"><p class="table">bit 8 (<code>0x0100</code>)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>Mask</code></p></td>
<td align="left" valign="top"><p class="table">bits 9..13 (<code>0x3E00</code>)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><code>Timer</code> is a value generally used for making <em>timed triggers</em> of certain entities&#8201;&#8212;&#8201;for example, the door which opens only for a few seconds and then closes,
or a fire which extinguishes and then burns again. In such case, engine <em>copies timer value in corresponding field of each triggered entity</em>. Then each entity&#8217;s
timer begins to count time back, and when it reaches zero, entity deactivates.</p></div>
<div class="paragraph"><p>However, it&#8217;s not the only purpose of <code>Timer</code> field. As trigger may not specifically activate entities but do some other actions, <code>Timer</code> field may be re-used
as a general-purpose numerical field to specify particular trigger behaviour. We will mention it separately for such trigger actions.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">Since TR4, <code>Timer</code> field became <em>signed</em>, i.e. it may contain <em>negative values</em>. Effectively, it means that entities activated with such trigger won&#8217;t be
immediately activated and then deactivated after given amount of time, but <em>wait for a given time before being activated</em>. Most prominent example is timed spike
pit in the beginning of &#8220;Burial Chambers&#8221;.</td>
</tr></table>
</div>
<div class="paragraph"><p><code>Mask</code>: The five bits at <code>0x3E00</code> are the so-called <em>Trigger Mask</em>. The purpose of trigger mask is to create puzzle set-ups which require a combination of
activated triggers to achieve certain result. A good example of trigger mask use is the multiple-switch room of &#8220;Palace Midas&#8221; in TR1.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>Each entity in Tomb Raider has a similar field in its structure called <em>activation mask</em>. Activation of entity happens <em>only when all bits of activation mask
are set</em>. Trigger action which activates an entity makes either bitwise <code>XOR</code> operation (for <em>switch</em> trigger types&#8201;&#8212;&#8201;namely, <em>switch</em> and <em>heavy switch</em>&#8201;&#8212;&#8201;see further) or bitwise <code>OR</code> operation on <em>activation mask</em> using <em>trigger mask</em>. Trigger action purposed for deactivation (namely, <em>antitrigger</em>, <em>antipad</em> and
<em>heavy antitrigger</em> types) don&#8217;t take its trigger mask into consideration, and instead just reset target entity&#8217;s activation mask to zero.</p></div>
<div class="paragraph"><p>Whenever entity&#8217;s activation mask is changed to anything but 0x1F (all bits set), entity is <em>automatically deactivated</em>, excluding the cases when <code>OneShot</code> flag
was previously set for a given entity&#8201;&#8212;&#8201;see further.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p><code>OneShot</code> flag is used <em>only</em> for activation of entities (it is also copied to entity&#8217;s own flag field with same name), and indicates that <em>after activation,
entity state is locked</em>. It means that even if entity&#8217;s own activation mask is unset (as with <em>switch</em> trigger type&#8201;&#8212;&#8201;see further), entity will remain
activated. However, it doesn&#8217;t mean that entity couldn&#8217;t be deactivated at all&#8201;&#8212;&#8201;because <em>antitrigger</em> trigger type ignores and resets this flag.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">All other trigger actions, except activation of entities, are <em>performed continuously</em>. It&#8217;s not obvious, because engine uses various workarounds for
specific trigger actions to prevent &#8220;repeated&#8221; execution, like playing same soundtracks over and over again. Such workarounds will be specifically mentioned.</td>
</tr></table>
</div>
<div class="paragraph"><p><em>Trigger types</em> and <em>trigger actions</em> will be described separately right after listing all FloorData functions.</p></div>
</div>
<div class="sect3">
<h4 id="_function_code_0x05_code_8201_8212_8201_kill_lara">4.4.5. Function <code>0x05</code>&#8201;&#8212;&#8201;Kill Lara</h4>
<div class="paragraph"><p><em>SubFunction not used</em></p></div>
<div class="paragraph"><p>Instantly kills Lara. Usually she is simply set on fire, however, there is one special case in TR3. If current level index is 7 (&#8220;Madubu Gorge&#8221;), then instead
of catching fire, Lara will play drowning animation.</p></div>
</div>
<div class="sect3">
<h4 id="_function_code_0x06_code_8201_8212_8201_climbable_walls">4.4.6. Function <code>0x06</code>&#8201;&#8212;&#8201;Climbable Walls</h4>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr2.png" alt="TR2 only" width="16" height="17" title="TR2 only" />
</span><span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> The <code>SubFunction</code> indicates climbability of walls; its value is the bitwise <code>OR</code> of the values associated with all the climbable-wall
directions (<code>0x01</code> = +Z, <code>0x02</code> = +X, <code>0x04</code> = -Z, <code>0x08</code> = -X), e.g. SubFunction <code>0x09</code> indicates that the walls on both the +Z and -X sides of this sector are
climbable.</p></div>
</div>
<div class="sect3">
<h4 id="_functions_code_0x07_code_to_code_0x12_code_8201_8212_8201_triangulation">4.4.7. Functions <code>0x07</code> to <code>0x12</code>&#8201;&#8212;&#8201;Triangulation</h4>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Beginning with TR3, geometry layout of each sector was significantly changed. Engine introduced <em>triangles</em> as a minimal collisional unit,
compared with <em>rectangles only</em> in TR1 and TR2. This advantage allowed to create much more organic and natural terrain (albeit still limited by minimal sector
width and depth of 1024 units), but also complicated things a lot, introducing the whole new set of different FloorData collisional functions.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content"><em>Triangulation</em> functions are never combined with <em>slant</em> functions present in TR1 and TR2. Each sector has either <em>slant</em> or <em>triangulation</em> function
assigned to it, and <em>never both of them</em>. If there ever will be a paradoxical case of combination, most likely, only <em>older</em> function (i.e. <em>slant</em>) will be
considered for collision calculation.</td>
</tr></table>
</div>
<div class="paragraph"><p>Similarly to <em>slant</em> functions, <em>triangulation</em> functions define the floor and ceiling corner heights, but besides, they also specify <em>dividing up the floors
and ceilings into triangles along either of the two diagonals</em>. Also, one of the triangles may be a collisional portal to the room above (if in the ceiling) or
to the room below (if in the floor).</p></div>
<div class="paragraph"><p>Each triangulation function <code>uint16_t</code> must be parsed differently, not like ordinary <code>FDSetup</code> entry:</p></div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="40%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="33%" />
<col width="66%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table">Function</p></td>
<td align="left" valign="top"><p class="table">Bits 0..4 (<code>0x001F</code>)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">$H_{\triangle1}$</p></td>
<td align="left" valign="top"><p class="table">Bits 5..9 (<code>0x03E0</code>)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">$H_{\triangle2}$</p></td>
<td align="left" valign="top"><p class="table">Bits 10..14 (<code>0x7C00</code>)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">EndData</p></td>
<td align="left" valign="top"><p class="table">Bit 15 (<code>0x8000</code>)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>$H_{\triangle1}$ and $H_{\triangle2}$ are signed values, and replace <code>FDSetup</code>'s <code>SubFunction</code> field.</p></div>
<div class="paragraph"><p>Own triangulation function&#8217;s <code>uint16_t</code> is followed by <em>one extra</em> <code>uint16_t</code> to be parsed as follows:</p></div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="40%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="33%" />
<col width="66%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table">$\DeltaC_{10}$</p></td>
<td align="left" valign="top"><p class="table">Bits 0..3 (<code>0x000F</code>)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">$\DeltaC_{00}$</p></td>
<td align="left" valign="top"><p class="table">Bits 4..7 (<code>0x00F0</code>)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">$\DeltaC_{01}$</p></td>
<td align="left" valign="top"><p class="table">Bits 8..11 (<code>0x0F00</code>)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">$\DeltaC_{11}$</p></td>
<td align="left" valign="top"><p class="table">Bits 12..15 (<code>0xF000</code>)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>All four values here are unsigned.</p></div>
<div class="sect4">
<h5 id="_the_triangulation_formula">The Triangulation Formula</h5>
<div class="paragraph"><p>The idea behind this set up is dividing each sector rectangle into <em>two independent triangles</em>, and adjust each triangle height by combination of <em>corner</em> and
<em>triangle</em> heights.  To get each triangle&#8217;s individual corner height, you should use this formula:</p></div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="100%"
frame="void"
cellspacing="0" cellpadding="4">
<col width="100%" />
<tbody>
<tr>
<td align="center" valign="top"><div><div class="paragraph"><p>$H_{\angle} = H_{floor} + (\max(\DeltaC_{10}, \DeltaC_{00}, \DeltaC_{01}, \DeltaC_{11}) - \DeltaC_{n} \times 1024 )$</p></div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>&#8230;where $H_{\angle}$ is <em>absolute floor height</em> specified in <code>tr_room_sector</code>'s <code>Floor</code> field, and $\DeltaC_{n}$ is triangle&#8217;s
individual corner height.</p></div>
<div class="paragraph"><p>While four corner height values are shared by both triangles, <em>triangle height values specify additional overall height of individual triangle</em>. Therefore,
sector corner heights may or may not be shared between two triangles:</p></div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="80%"
frame="void"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/illustrations/tri-notshared.png" alt="illustrations/tri-notshared.png" title="Corner heights are not shared" />
</span></p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/illustrations/tri-shared.png" alt="illustrations/tri-shared.png" title="Corner heights are shared" />
</span></p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table"><em>Corner heights are not shared</em></p></td>
<td align="center" valign="top"><p class="table"><em>Corner heights are shared</em></p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>The way engine interprets <em>triangle height values</em> $H_{\triangle1}$ and $H_{\triangle2}$ is not exactly known&#8201;&#8212;&#8201;however, <em>meta2tr</em>
understands them and uses them to create so-called <em>diagonal steps</em>, example of which is pictured on the left side. There is no case of diagonal steps in
original games, but they may exist in levels edited with <em>meta2tr</em>.</p></div>
<div class="paragraph"><p>Overall, there are 12 different triangulation functions, which can be divided into two pairs of groups&#8201;&#8212;&#8201;one pair of groups is for floor, and another pair is
for ceiling. Each pair is categorized by <em>split direction</em>, and each group is categorized if it&#8217;s floor or ceiling. In each group, there are three functions&#8201;&#8212;&#8201;first function denotes that <em>both</em> triangles in sector are solid, second and third functions denote that <em>one of triangles is a collisional vertical portal</em>.
When function denotes a vertical portal, target room of a portal is taken from <code>tr_room_sector</code> structure&#8201;&#8212;&#8201;<code>RoomBelow</code> for floor functions, and <code>RoomAbove</code>
for ceiling functions.</p></div>
<div class="paragraph"><p>Here is an example illustration depicting sectors with all possible floor triangulation functions. Ceiling triangulation happens in similar manner.</p></div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="100%"
frame="void"
cellspacing="0" cellpadding="4">
<col width="100%" />
<tbody>
<tr>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/illustrations/tri-types.png" alt="illustrations/tri-types.png" title="Floor sector triangulation types" />
</span></p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table"><em>Floor sector triangulation types.</em>
  <em>Black triangles depict vertical collisional portal to different room.</em></p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><code>X</code> axis in world coordinates also may be considered <em>north</em> for more simple reference (because you can always check compass direction in actual game engines,
at least in TR1 and TR4).</p></div>
</div>
<div class="sect4">
<h5 id="_functions_code_0x07_code_code_0x0b_code_code_0x0c_code">Functions <code>0x07</code>, <code>0x0B</code>, <code>0x0C</code></h5>
<div class="paragraph"><p>These functions define <em>floor</em> triangles split in the <em>northwest-southeast</em> direction.</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>0x07</code>&#8201;&#8212;&#8201;Both triangles are solid.
</p>
</li>
<li>
<p>
<code>0x0B</code>&#8201;&#8212;&#8201;Triangle pointing its right angle to the <em>southwest</em> is a <em>collisional portal</em>.
</p>
</li>
<li>
<p>
<code>0x0C</code>&#8201;&#8212;&#8201;Triangle pointing its right angle to the <em>northeast</em> is a <em>collisional portal</em>.
</p>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="_functions_code_0x08_code_code_0x0d_code_code_0x0e_code">Functions <code>0x08</code>, <code>0x0D</code>, <code>0x0E</code></h5>
<div class="paragraph"><p>These functions define <em>floor</em> triangles split in the <em>northeast-southwest</em> direction.</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>0x08</code>&#8201;&#8212;&#8201;Both triangles are solid.
</p>
</li>
<li>
<p>
<code>0x0D</code>&#8201;&#8212;&#8201;Triangle pointing its right angle to the <em>southwest</em> is a <em>collisional portal</em>.
</p>
</li>
<li>
<p>
<code>0x0E</code>&#8201;&#8212;&#8201;Triangle pointing its right angle to the <em>northwest</em> is a <em>collisional portal</em>.
</p>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="_functions_code_0x09_code_code_0x0f_code_code_0x10_code">Functions <code>0x09</code>, <code>0x0F</code>, <code>0x10</code></h5>
<div class="paragraph"><p>These functions define <em>ceiling</em> triangles split in the <em>northwest</em> direction.</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>0x09</code>&#8201;&#8212;&#8201;Both triangles are solid.
</p>
</li>
<li>
<p>
<code>0x0F</code>&#8201;&#8212;&#8201;Triangle pointing its right angle to the <em>southwest</em> is a <em>collisional portal</em>.
</p>
</li>
<li>
<p>
<code>0x10</code>&#8201;&#8212;&#8201;Triangle pointing its right angle to the <em>northeast</em> is a <em>collisional portal</em>.
</p>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="_functions_code_0x0a_code_code_0x11_code_code_0x12_code">Functions <code>0x0A</code>, <code>0x11</code>, <code>0x12</code></h5>
<div class="paragraph"><p>These functions define <em>ceiling</em> triangles split in the <em>northeast</em> direction.</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>0x0A</code>&#8201;&#8212;&#8201;Both triangles are solid.
</p>
</li>
<li>
<p>
<code>0x11</code>&#8201;&#8212;&#8201;Triangle pointing its right angle to the <em>northwest</em> is a <em>collisional portal</em>.
</p>
</li>
<li>
<p>
<code>0x12</code>&#8201;&#8212;&#8201;Triangle pointing its right angle to the <em>southeast</em> is a <em>collisional portal</em>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect3">
<h4 id="_function_code_0x13_code_8201_8212_8201_monkeyswing_only_in_tr3_5">4.4.8. Function <code>0x13</code>&#8201;&#8212;&#8201;Monkeyswing (only in TR3-5)</h4>
<div class="paragraph"><p><em>SubFunction is not used</em></p></div>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Sets monkey-swingability of the ceiling in specified sector.</p></div>
</div>
<div class="sect3">
<h4 id="_function_code_0x14_code">4.4.9. Function <code>0x14</code></h4>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> This function has a different meaning in TR3 and TR4/5.</p></div>
<div class="ulist"><ul>
<li>
<p>
In TR3, if Lara approaches sector with this FloorData function inside <em>minecart</em> vehicle, it will turn <em>left</em> 90 degrees, with a circle radius around 4
  sectors (4096 units in world coordinates).
</p>
</li>
<li>
<p>
In TR4 and TR5, this function is used together with special entity called <em>Trigger Triggerer</em>. The purpose of this entity is to perform <em>deferred triggering</em>.
  That is, if <em>trigger</em> FloorData function is placed in the same sector with function <code>0x14</code>, trigger won&#8217;t be activated until there&#8217;s an activated <em>Trigger
  Triggerer</em> object in the same sector. This allows to create setups where player can cross trigger sector without activating it, until some other event occurs
  later in level.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_function_code_0x15_code">4.4.10. Function <code>0x15</code></h4>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span> This function has a different meaning in TR3 and TR4.</p></div>
<div class="ulist"><ul>
<li>
<p>
In TR3, if Lara approaches sector with this FloorData function inside <em>minecart</em> vehicle, it will turn <em>right</em> 90 degrees, with a circle radius around 4
  sectors (4096 units in world coordinates).
</p>
</li>
<li>
<p>
In TR4, this function is used together with special entity called <em>Mapper</em>. If <em>Mechanical Beetle</em> is placed in sector with function <code>0x15</code> and inactive
  <em>Mapper</em> entity, it rotates in the same direction <em>Mapper</em> is pointing to, activates it, and then rolls forward, until next sector with function 0x14 is
  reached. Then it waits until Lara picks it up.
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">If Lara places beetle at the very same sector where beetle was already used, it will shake and explode. It happens because beetle checks if <em>Mapper</em>
entity is active or not, and if it was already activated, it explodes instead of rolling.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_trigger_types">4.5. Trigger types</h3>
<div class="paragraph"><p>A <em>trigger type</em> specifies the condition of a given <em>trigger function</em> to be activated. Condition may be a type of activator (Lara or some other entity), a
specific state of activator, specific trigger action (activate or deactivate), and so on.</p></div>
<div class="paragraph"><p>Trigger type <em>is placed in <code>SubFunction</code> field</em> of <code>FDSetup</code> structure, so we will refer to trigger types as <em>SubFunctions</em>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">Trigger type names are directly borrowed from TRLE.</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_subfunction_code_0x00_code_8201_8212_8201_trigger">4.5.1. SubFunction <code>0x00</code>&#8201;&#8212;&#8201;Trigger</h4>
<div class="paragraph"><p>Activated by Lara whenever she enters a given sector&#8201;&#8212;&#8201;either steps, climbs, jumps over it, and so on.</p></div>
</div>
<div class="sect3">
<h4 id="_subfunction_code_0x01_code_8201_8212_8201_pad">4.5.2. SubFunction <code>0x01</code>&#8201;&#8212;&#8201;Pad</h4>
<div class="paragraph"><p>Activated by Lara <em>only</em> if she steps or lands on a given sector.</p></div>
</div>
<div class="sect3">
<h4 id="_subfunction_code_0x02_code_8201_8212_8201_switch">4.5.3. SubFunction <code>0x02</code>&#8201;&#8212;&#8201;Switch</h4>
<div class="paragraph"><p>This particular type of trigger takes first <code>ActionList</code> entry&#8217;s <code>Parameter</code> field <em>as a reference to specific switch entity in level</em>. It activates <em>every time
the switch state is changed</em>. For <em>Object</em> trigger actions, <em>activation</em> means <em>performing <code>XOR</code> operation</em> on these object&#8217;s (entities) activation masks. (See
next section for description of <em>Object</em> trigger action and <code>Parameter</code> field.)</p></div>
<div class="paragraph"><p>Please note that this trigger type (as well as <em>any other trigger types</em>) always perform all trigger actions except <em>Object</em> in the same manner! Meaning, if
there is a <em>Camera</em> or <em>Effect</em> trigger action, it will be performed every time the switch is flipped on or off.</p></div>
</div>
<div class="sect3">
<h4 id="_subfunction_code_0x03_code_8201_8212_8201_key">4.5.4. SubFunction <code>0x03</code>&#8201;&#8212;&#8201;Key</h4>
<div class="paragraph"><p>Similar to previous trigger type, it works only if there is a <em>keyhole entity</em> listed in the first <code>ActionList</code> entry&#8217;s <code>Parameter</code> field. It activates only if
a key was inserted into that particular keyhole.</p></div>
</div>
<div class="sect3">
<h4 id="_subfunction_code_0x04_code_8201_8212_8201_pickup">4.5.5. SubFunction <code>0x04</code>&#8201;&#8212;&#8201;Pickup</h4>
<div class="paragraph"><p>As above, this type of trigger works only if there is a <em>pick-up entity</em> listed in the first <code>ActionList</code> entry&#8217;s <code>Parameter</code> field. It activates only if this
item was picked up by Lara.</p></div>
</div>
<div class="sect3">
<h4 id="_subfunction_code_0x05_code_8201_8212_8201_heavytrigger">4.5.6. SubFunction <code>0x05</code>&#8201;&#8212;&#8201;Heavytrigger</h4>
<div class="paragraph"><p>Activated by <em>specific entity type</em> (activator) wherever it enters a specified sector. Entity types which are able to activate <em>heavytriggers</em> are hardcoded,
and usually include <em>NPCs (enemies), rolling balls and pushable objects</em>. Since TR4, heavytriggers may also be activated by destroying <em>shatter static mesh</em>
which is placed in a given sector.</p></div>
<div class="paragraph"><p>Note that heavytrigger <em>does not perform deactivation action</em>, if activator leaves trigger sector.</p></div>
</div>
<div class="sect3">
<h4 id="_subfunction_code_0x06_code_8201_8212_8201_antipad">4.5.7. SubFunction <code>0x06</code>&#8201;&#8212;&#8201;Antipad</h4>
<div class="paragraph"><p>Same as <em>Pad</em>&#8201;&#8212;&#8201;activates only if Lara has landed or stepped onto a given sector. The difference is, <em>Antipad</em> performs <em>deactivation</em> for each case of
<em>Object</em> trigger action. What <em>deactivation</em> specifically means is it resets entity activation mask to zero (trigger mask is ignored), thus flipping entity
activation procedure.</p></div>
<div class="paragraph"><p>As it was mentioned for <em>Switch</em> trigger type, any other trigger actions beside <em>Object</em> will perform exactly in the same manner as with normal trigger types.
So you shouldn&#8217;t expect soundtrack to stop, if you have placed <em>PlayTrack</em> trigger action for antipad.</p></div>
</div>
<div class="sect3">
<h4 id="_subfunction_code_0x07_code_8201_8212_8201_combat">4.5.8. SubFunction <code>0x07</code>&#8201;&#8212;&#8201;Combat</h4>
<div class="paragraph"><p>Activated by Lara whenever she enters a given sector <em>with her weapons drawn</em>. This trigger type was (presumably) never used in original games.</p></div>
</div>
<div class="sect3">
<h4 id="_subfunction_code_0x08_code_8201_8212_8201_dummy">4.5.9. SubFunction <code>0x08</code>&#8201;&#8212;&#8201;Dummy</h4>
<div class="paragraph"><p>This type doesn&#8217;t perform <em>any trigger action</em> listed for it except <em>Object</em> type&#8201;&#8212;&#8201;for these trigger actions, it <em>applies standable collision for Lara on a
given entities</em>, if such entities are in this trigger sector. For particular entity types, it works even if entity is deactivated (e.g. collapsing floor), but
for other types it works only if entity was activated (e.g. trapdoors). Selected behaviour is most likely hardcoded.</p></div>
<div class="paragraph"><p>It&#8217;s worth noting that <em>any</em> trigger type will apply standable collision on such entity types, if they are in the same sector. It&#8217;s not a bug, rather a way TR
engines process FloorData.</p></div>
</div>
<div class="sect3">
<h4 id="_subfunction_code_0x09_code_8201_8212_8201_antitrigger">4.5.10. SubFunction <code>0x09</code>&#8201;&#8212;&#8201;Antitrigger</h4>
<div class="paragraph"><p>Same as <em>Trigger</em>, but performs <em>deactivation</em> for each case of <em>Object</em> trigger action.</p></div>
</div>
<div class="sect3">
<h4 id="_subfunction_code_0x0a_code_8201_8212_8201_heavy_switch">4.5.11. SubFunction <code>0x0A</code>&#8201;&#8212;&#8201;Heavy switch</h4>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Don&#8217;t be fooled by the name of this trigger type. It is not literally a <em>switch</em>, as only similarity between it <em>switch</em> type is XOR operation with
activation mask. In fact, this trigger performs action when <em>specific entity type</em> (activator) enters a given trigger sector, but <em>only if trigger mask is equal
to activator&#8217;s activation mask</em>.</p></div>
<div class="paragraph"><p>The best example of heavy switch setup is <em>Planetarium</em> in &#8220;The Lost Library&#8221;. Trigger mask is only applied to raising block if pushable in trigger sector has
a similar activation mask.</p></div>
</div>
<div class="sect3">
<h4 id="_subfunction_code_0x0b_code_8201_8212_8201_heavy_antitrigger">4.5.12. SubFunction <code>0x0B</code>&#8201;&#8212;&#8201;Heavy antitrigger</h4>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Same as <em>Antitrigger</em>, but performs <em>deactivation</em> for each case of <em>Object</em> trigger action.</p></div>
</div>
<div class="sect3">
<h4 id="_subfunction_code_0x0c_code_8201_8212_8201_monkey">4.5.13. SubFunction <code>0x0C</code>&#8201;&#8212;&#8201;Monkey</h4>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Activated by Lara whenever she enters a given sector <em>in monkeyswing state</em>. Best example is locust swarm attacking Lara when she monkeyswings across
the street in &#8220;Trenches&#8221;.</p></div>
</div>
<div class="sect3">
<h4 id="_subfunction_code_0x0d_code_8201_8212_8201_skeleton">4.5.14. SubFunction <code>0x0D</code>&#8201;&#8212;&#8201;Skeleton</h4>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> This trigger type temporarily replaces Lara model with a combination of models #25 (Lara skeleton), #26 (see-through body) and #27 (see-through joints).
See-through body and joints are applied on top of the skeleton model with additive blending.</p></div>
</div>
<div class="sect3">
<h4 id="_subfunction_code_0x0e_code_8201_8212_8201_tightrope">4.5.15. SubFunction <code>0x0E</code>&#8201;&#8212;&#8201;Tightrope</h4>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Activated by Lara whenever she enters a given sector <em>walking on a tightrope</em>.</p></div>
</div>
<div class="sect3">
<h4 id="_subfunction_code_0x0f_code_8201_8212_8201_crawl">4.5.16. SubFunction <code>0x0F</code>&#8201;&#8212;&#8201;Crawl</h4>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Activated by Lara whenever she enters a given sector <em>crawling or crouching</em>.</p></div>
</div>
<div class="sect3">
<h4 id="_subfunction_code_0x10_code_8201_8212_8201_climb">4.5.17. SubFunction <code>0x10</code>&#8201;&#8212;&#8201;Climb</h4>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Activated by Lara whenever she enters a given sector <em>climbing on a wall</em>.</p></div>
<div class="paragraph"><p>This concludes the description of <em>Trigger</em> FloorData function <em>trigger types</em>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_trigger_actions">4.6. Trigger actions</h3>
<div class="paragraph"><p>Trigger function references an additional list of FloorData entries called <code>ActionList</code>, which is a &#8220;chain&#8221; of entries that immediately follows <code>TriggerSetup</code>
entry. As you maybe already guessed, the <code>ActionList</code> contains the list of actions to be performed for a specified trigger.</p></div>
<div class="paragraph"><p><code>ActionList</code> entry format is:</p></div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="50%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="25%" />
<col width="75%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><code>Parameter</code></p></td>
<td align="left" valign="top"><p class="table">bits 0..9 (<code>0x03FF</code>) <em>-- Used bytes may vary</em></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>TrigAction</code></p></td>
<td align="left" valign="top"><p class="table">bits 10..14 (<code>0x7C00</code>)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>ContBit</code></p></td>
<td align="left" valign="top"><p class="table">bit 15 (<code>0x8000</code>)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><code>TrigAction</code> is a type of action to be performed. These will be listed seperately.</p></div>
<div class="paragraph"><p><code>Parameter</code> is used with certain trigger actions which need a certain numerical argument provided to them.</p></div>
<div class="paragraph"><p><code>ContBit</code> flag meaning is similar to <code>EndData</code> flag described for <code>FDSetup</code> structure. It indicates if there is another <code>ActionList</code> entry after current one. If
<code>ContBit</code> is not set, it means we have reached the end of <code>ActionList</code>, and there&#8217;s nothing more to do for a given trigger.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">If <code>ActionList</code>'s parent trigger type is either <em>Switch</em> or <em>Key</em>, first entry of <code>ActionList</code> is used to get reference entity (switch or keyhole) index.
Hence, it is ignored here, as by the time engine reaches <code>ActionList</code> offset, its first entry is already parsed by preceding code.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content"><code>ContBit</code> flag is <em>not the same</em> as <code>EndData</code> flag! When writing a parser, do not overwrite one with another.</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_trigaction_code_0x00_code_8201_8212_8201_object">4.6.1. TrigAction <code>0x00</code>&#8201;&#8212;&#8201;Object</h4>
<div class="paragraph"><p>Activate or deactivate entity (object) with index specified in <code>Parameter</code>.</p></div>
</div>
<div class="sect3">
<h4 id="_trigaction_code_0x01_code_8201_8212_8201_camera">4.6.2. TrigAction <code>0x01</code>&#8201;&#8212;&#8201;Camera</h4>
<div class="paragraph"><p>Switches to camera. <code>Parameter</code> (bits 0..6 used) serves as index into <code>Cameras[]</code> array.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">Camera trigger action <em>uses one extra <code>uint16_t</code> entry</em> after its own entry! Its format is:</td>
</tr></table>
</div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="30%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="33%" />
<col width="66%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><code>Timer</code></p></td>
<td align="left" valign="top"><p class="table">bits 0..7 (<code>0x00FF</code>)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>Once</code></p></td>
<td align="left" valign="top"><p class="table">bit 8 (<code>0x0100</code>)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>Zoom</code></p></td>
<td align="left" valign="top"><p class="table">bit 12 (<code>0x1000</code>) <em>-- only in TR1-2</em></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>ContBit</code></p></td>
<td align="left" valign="top"><p class="table">bit 15 (<code>0x8000</code>)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><code>Timer</code> is a number of seconds to wait before automatically switching back to the normal camera. If 0, it never switches back to normal camera, as long as
trigger is active.</p></div>
<div class="paragraph"><p><code>Once</code>: If set, only switch to camera once; otherwise, switch to camera every time trigger is active.</p></div>
<div class="paragraph"><p><code>Zoom</code>: Camera smoothly zooms in when activated. Zoom amount is hardcoded.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content"><code>ContBit</code> flag <em>overwrites</em> the same flag from the preceding <code>ActionList</code> entry.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_trigaction_code_0x02_code_8201_8212_8201_underwater_current">4.6.3. TrigAction <code>0x02</code>&#8201;&#8212;&#8201;Underwater Current</h4>
<div class="paragraph"><p>Continuously moves Lara to specifed <em>sink</em>. <code>Parameter</code> serves as index into <code>Cameras[]</code> array. If sink is placed lower than current sector absolute floor
height or upper than current sector absolute ceiling height, $Y$ coordinate will be ignored when dragging Lara to sink. Since TR3, sink also
prevents Lara from surfacing the water.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">While it may look like <code>Cameras[]</code> array was mentioned here by mistake, it is not. TR engines <em>share the same structure for both cameras and sinks</em>. The
way engine treats it in either case will be discussed in corresponding section.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_trigaction_code_0x03_code_flip_map">4.6.4. TrigAction <code>0x03</code>: Flip Map</h4>
<div class="paragraph"><p><em>FlipMap</em> is an internal engine array of <code>uint8_t</code>s which is used to determine if alternate rooms should be turned on or off (in TRLE terms, <em>flipped</em>). It uses
<em>trigger mask</em> in the same manner as for <em>Object</em> activation and deactivation, but in this case, alternate rooms are activated if given <code>FlipMap</code> entry mask is
set (<code>0x1F</code>), and deactivated, if <code>FlipMap</code> entry is not set (not <code>0x1F</code>).</p></div>
<div class="paragraph"><p>This trigger action at first applies <em>trigger mask</em> to a given <code>FlipMap</code> entry using <code>OR</code> bitwise operation and then immediately checks if it&#8217;s already set or
not. If FlipMap entry is set, then it immediately switches rooms to alternate mode.</p></div>
<div class="paragraph"><p><code>Parameter</code> defines which <code>FlipMap</code> entry engine should refer to decide should it switch alternate rooms on or off. The size of <code>FlipMap</code> array is around 10
(judging by the number of unused <code>FLIP_MAPn</code> <em>effect</em> entries), but in original levels, number usually never tops 2 or 3.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">From TR1 to TR3, <code>FlipMap</code> array was merely used as a &#8220;hint table&#8221; to tell the engine if it should flip <em>all rooms at once</em>. That is, to check and apply
another FlipMap entry, alternate rooms should have been reverted to previous state before&#8201;&#8212;&#8201;that&#8217;s the purpose of next two listed trigger actions. However, in
TR4 algorithm was changed&#8201;&#8212;&#8201;each &#8220;flippable&#8221; room now bears additional parameter called &#8220;alternate group&#8221;, which strictly tells an engine to flip it <em>only
when room alternate group is equal to FlipMap <code>Parameter</code> value</em>. This change in algorithm made next two trigger actions unnecessary in TR4-5 (however, they are
still available).</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_trigaction_code_0x04_code_8201_8212_8201_flip_on">4.6.5. TrigAction <code>0x04</code>&#8201;&#8212;&#8201; Flip On</h4>
<div class="paragraph"><p>Tries to turn alternate rooms <em>on</em>, judging on current value of a given <code>FlipMap</code> entry (entry index is specified by <code>Parameter</code>). If corresponding FlipMap is
not set (i.e. the value is not <code>0x1F</code>), rooms won&#8217;t be flipped. <code>Parameter</code> defines a <code>FlipMap</code> entry to work with.</p></div>
</div>
<div class="sect3">
<h4 id="_trigaction_code_0x05_code_8201_8212_8201_flip_off">4.6.6. TrigAction <code>0x05</code>:&#8201;&#8212;&#8201;Flip Off</h4>
<div class="paragraph"><p>Tries to turn alternate rooms <em>off</em>, judging on current value of a given <code>FlipMap</code> entry (entry index is specified by <code>Parameter</code>). If corresponding FlipMap is
not set (i.e. the value is not <code>0x1F</code>), rooms won&#8217;t be flipped. <code>Parameter</code> defines a <code>FlipMap</code> entry to work with.</p></div>
</div>
<div class="sect3">
<h4 id="_trigaction_code_0x06_code_8201_8212_8201_look_at_item">4.6.7. TrigAction <code>0x06</code>&#8201;&#8212;&#8201;Look at Item</h4>
<div class="paragraph"><p>Specifies an entity which current camera should look at. If current camera is &#8220;ordinary&#8221; one following Lara, then it will also rotate Lara model in a target
direction, creating an illusion of Lara looking at it. If current camera is changed to &#8220;triggered&#8221; one (by trigger action <code>0x01</code>&#8201;&#8212;&#8201;see above), then this
camera&#8217;s orientation will be changed to a given entity. Note that if such camera change is desired, this action should come first, not the <strong>Camera</strong> one.</p></div>
<div class="paragraph"><p><code>Parameter</code> specifies an entity index to look at.</p></div>
</div>
<div class="sect3">
<h4 id="_trigaction_code_0x07_code_8201_8212_8201_end_level">4.6.8. TrigAction <code>0x07</code>&#8201;&#8212;&#8201; End Level</h4>
<div class="paragraph"><p>Immediately loads next level. In TR1-3 and TR5, <code>Parameter</code> field is not used, i.e. engine just loads next level specified in script. In TR4, so called &#8220;hub
system&#8221; was implemented, which allows Lara to jump between levels back and forth. For this reason, <em>End Level</em> trigger action must also explicitly specify
level index to jump.</p></div>
</div>
<div class="sect3">
<h4 id="_trigaction_code_0x08_code_8201_8212_8201_play_soundtrack">4.6.9. TrigAction <code>0x08</code>&#8201;&#8212;&#8201;Play Soundtrack</h4>
<div class="paragraph"><p>Triggers a playback of a soundtrack specified in <code>Parameter</code> field. Type of soundtrack (<em>looped</em> or <em>one-shot</em>) is hardcoded and assigned automatically.</p></div>
<div class="paragraph"><p>This trigger action makes use of <em>trigger mask</em> <strong>and</strong> <em>one-shot trigger flag</em> to mark if this track was already played with a given <em>trigger mask</em> or not in a
special internal <em>soundtrack map</em>. That is, if it is called with <em>trigger mask</em> set to, say, <code>0x01</code>, then all further calls from triggers with same <em>trigger
mask</em> will be ignored. However, if same track playback is called with <em>trigger mask</em> value of <code>0x02</code>, it will play again, as it&#8217;s another byte in <em>trigger
mask</em>. Effectively, it allows to play specified track <em>six times</em> (five bits of <em>activation mask</em> plus one bit of <em>one-shot flag</em>). Comparison is done via
bitwise <code>AND</code> operation, so if playback is called with <em>trigger mask + one-shot</em> value of <code>(0x1F + 0x20 = 0x3F)</code>, then any other playback call to that track
will be blocked.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>In TR1, soundtrack playback is more complicated. For some reason, in PC version programmers completely disabled playback for majority of soundtracks, leaving
only five or six most significant ones to play (like title theme or cutscene audio). <em>Looped</em> soundtracks were also completely ignored&#8201;&#8212;&#8201;instead, background
ambience is explicitly specified by script entry, rather than trigger action (that&#8217;s the reason why PC version has four different ambience types when compared
to PSX version).</p></div>
<div class="paragraph"><p>To overcome this issue and enable complete soundtrack functionality, several patches were created by the community. However, PC version is missing <em>soundtrack
map</em> structure, which potentially produces bugs when single track could be played independently by both triggers in the same level, although mostly this bug
comes unnoticed, as majority of TR1 soundtracks are engaged only once in a level.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_trigaction_code_0x09_code_8201_8212_8201_effect">4.6.10. TrigAction <code>0x09</code>&#8201;&#8212;&#8201;Effect</h4>
<div class="paragraph"><p><em>Effect</em> (or <em>flipeffect</em> in TRLE terms) does not necessarily mean &#8220;special effect&#8221; or so. By the name of &#8220;effect&#8221; comes <em>any non-trivial or special trigger action which should be
seperately defined</em>. This workaround was implemented because TR engines lack any scripting language to program arbitrary trigger, so you can consider an
<em>effect</em> as a call to some &#8220;pre-compiled&#8221; scripted function.</p></div>
<div class="paragraph"><p>For example, in TR2 &#8220;Lara&#8217;s Home&#8221;, there is a need to control assault course timer, like restarting it while reaching start point or stopping it when Lara is off the course. This task is accomplished via several different effects.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">The list of <em>effects</em> differs across game versions. These will be listed in a separate section noting changes from version to version.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_trigaction_code_0x0a_code_8201_8212_8201_secret_found">4.6.11. TrigAction <code>0x0A</code>&#8201;&#8212;&#8201;Secret Found</h4>
<div class="paragraph"><p>Plays &#8220;secret&#8221; soundtrack theme and marks a secret number specified in <code>Parameter</code> field as found. For finding each secret, another <code>Parameter</code> value must be
specified, or else secret won&#8217;t be counted as found.</p></div>
</div>
<div class="sect3">
<h4 id="_trigaction_code_0x0b_code_8201_8212_8201_clear_bodies">4.6.12. TrigAction <code>0x0B</code>&#8201;&#8212;&#8201;Clear bodies</h4>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr1.png" alt="TR1 only" width="16" height="17" title="TR1 only" />
</span><span class="image">
<img src="images/icons/tr2.png" alt="TR2 only" width="16" height="17" title="TR2 only" />
</span><span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span> Removes dead bodies of enemies from a level to conserve memory usage. This action has effect only on entities which had <em>clear body</em> flag
specified in their parameters (see further). <code>Parameter</code> field is unused.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">This trigger action caused significant confusion in TRLE community. In level editor, action is called <em>BODYBAG</em>, and makes no visible effect in game, so
various speculations were made regarding action&#8217;s true purpose. Some people thought it is used to attach a backpack to Lara in &#8220;Angkor Wat&#8221; cutscene, another
people thought it is used for lipsync or dragging SAS troop body in &#8220;City of the Dead&#8221;. All this speculation was proven wrong.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_trigaction_code_0x0c_code_8201_8212_8201_flyby">4.6.13. TrigAction <code>0x0C</code>&#8201;&#8212;&#8201;Flyby</h4>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Engages a <em>flyby camera sequence</em> specified in <code>Parameter</code> field. The feature was added in TR4 and enables to play cinematographic interludes with
camera continuously &#8220;flying&#8221; from one point to another. Such <em>sequences</em>, their <em>points</em>, properties and order are defined in a level editor, and engine moves
camera across them using <em>spline function</em>.</p></div>
<div class="paragraph"><p><code>uint16_t</code> immediately following flyby&#8217;s own entry contains <em>one-shot flag</em> at <code>0x0100</code>. If this flag is not set, flyby will infinitely loop. As with <em>Camera</em> TrigAction, flag at <code>0x8000</code> is a continuation bit, which overrides previous entry&#8217;s continuation bit.</p></div>
</div>
<div class="sect3">
<h4 id="_trigaction_code_0x0d_code_8201_8212_8201_cutscene">4.6.14. TrigAction <code>0x0D</code>&#8201;&#8212;&#8201;Cutscene</h4>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Engages a cutscene pre-defined in script file. <code>Parameter</code> is taken as cutscene ID. In turn, script file refers to <code>CUTSEQ.PAK</code> (TR4) or <code>CUTSEQ.BIN</code>
(TR5) file to get all the data for a cutscene, such as <em>actor positions and animations</em>, <em>camera movement</em>, <em>soundtrack</em> and many more. There will be a special
section describing particular <code>CUTSEQ.PAK</code> file format.</p></div>
<div class="paragraph"><p>This concludes the description of <em>Trigger</em> FloorData function <em>action types</em>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_meshes_and_models">5. Meshes and Models</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_overview_3">5.1. Overview</h3>
<div class="paragraph"><p>Nearly all of the non-geographic visual elements in TR (as well as a few parts of the landscape) consist of as meshes.  A <em>mesh</em> is simply a list of vertices
and how they&#8217;re arranged.  The mesh structure includes a list of vertices as relative coordinates (which allows meshes to easily be placed anywhere in the world
geometry), a list of normals (to indicate which side of each face is visible), and lists of Rectangles and Triangles, both textured and coloured.  The elements
of each <a href="#tr_face4">[tr_face4]</a> or <a href="#tr_face3">[tr_face3]</a> (or same version-specific) structure (Rectangles and Triangles) contain an offset into the <code>Vertices[]</code> array for the mesh.
Other arrays (<code>Entities[]</code>, <code>StaticMeshes[]</code>) do not reference the array <code>Meshes[]</code> directly, but instead reference the array <code>MeshPointers[]</code>, which points to
locations inside of <code>Meshes[]</code>, inside of which the meshes are stored in packed fashion.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/tip.png" alt="Tip" />
</td>
<td class="content">
<div class="paragraph"><p>Pointer indexing system allows engine to share same mesh for numerous different models, and also easily implement a feature called <em>meshswap</em>&#8201;&#8212;&#8201;used when a
puzzle is inserted into a hole, when Lara draws pistols, and so on.</p></div>
<div class="paragraph"><p>While it may be not obvious, but every time you see mesh look is changed, it means that <em>meshswap</em> happened. There was never any other way to modify mesh looks
in classic TRs.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_meshes">5.2. Meshes</h3>
<div class="paragraph"><p>The sign of the number of normals specifies which sort of lighting to use. If the sign is positive, then external vertex lighting is used, with the lighting
calculated from the room&#8217;s ambient and point-source lighting values. The latter appears to use a simple Lambert law for directionality: intensity is
proportional to $\max(\langle (\mathrm{normal direction}), (\mathrm{direction to source}) \rangle, 0)$. If the sign is negative, then internal
vertex lighting is used, using the data included with the mesh.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">This is not a &#8220;real&#8221; C/C++ structure, in that the arrays are sized by the <code>NumXXX</code> elements that precede them.</td>
</tr></table>
</div>
<div class="listingblock">
<a id="tr_mesh"></a>
<div class="content"><div class="highlight"><pre><span class="k">virtual</span> <span class="k">struct</span> <span class="n">tr_mesh</span>
<span class="p">{</span>
    <span class="n">tr_vertex</span> <span class="n">Centre</span><span class="p">;</span>
      <span class="kt">int32_t</span> <span class="n">CollRadius</span><span class="p">;</span>

      <span class="kt">int16_t</span> <span class="n">NumVertices</span><span class="p">;</span>           <span class="c1">// Number of vertices in this mesh</span>
    <span class="n">tr_vertex</span> <span class="n">Vertices</span><span class="p">[</span><span class="n">NumVertices</span><span class="p">];</span> <span class="c1">// List of vertices (relative coordinates)</span>

      <span class="kt">int16_t</span> <span class="n">NumNormals</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="n">NumNormals</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">tr_vertex</span> <span class="n">Normals</span><span class="p">[</span><span class="n">NumNormals</span><span class="p">];</span>
  <span class="k">else</span>
      <span class="kt">int16_t</span> <span class="n">Lights</span><span class="p">[</span><span class="n">abs</span><span class="p">(</span><span class="n">NumNormals</span><span class="p">)];</span>

     <span class="kt">int16_t</span> <span class="n">NumTexturedRectangles</span><span class="p">;</span> <span class="c1">// number of textured rectangles in this mesh</span>
    <span class="n">tr_face4</span> <span class="n">TexturedRectangles</span><span class="p">[</span><span class="n">NumTexturedRectangles</span><span class="p">];</span> <span class="c1">// list of textured rectangles</span>

     <span class="kt">int16_t</span> <span class="n">NumTexturedTriangles</span><span class="p">;</span>  <span class="c1">// number of textured triangles in this mesh</span>
    <span class="n">tr_face3</span> <span class="n">TexturedTriangles</span><span class="p">[</span><span class="n">NumTexturedTriangles</span><span class="p">];</span> <span class="c1">// list of textured triangles</span>

     <span class="kt">int16_t</span> <span class="n">NumColouredRectangles</span><span class="p">;</span> <span class="c1">// number of coloured rectangles in this mesh</span>
    <span class="n">tr_face4</span> <span class="n">ColouredRectangles</span><span class="p">[</span><span class="n">NumColouredRectangles</span><span class="p">];</span> <span class="c1">// list of coloured rectangles</span>

     <span class="kt">int16_t</span> <span class="n">NumColouredTriangles</span><span class="p">;</span> <span class="c1">// number of coloured triangles in this mesh</span>
    <span class="n">tr_face3</span> <span class="n">ColouredTriangles</span><span class="p">[</span><span class="n">NumColouredTriangles</span><span class="p">];</span> <span class="c1">// list of coloured triangles</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>Centre</code> is usually close to the mesh&#8217;s centroid, and appears to be the center of a sphere used for certain kinds of collision testing.</p></div>
<div class="paragraph"><p><code>CollRadius</code> appears to be the radius of that aforementioned collisional sphere.</p></div>
<div class="paragraph"><p><code>NumNormals</code>: If positive, it is a number of normals in this mesh. If negative, it is a number of vertex lighting elements (<code>abs</code> value).</p></div>
<div class="paragraph"><p>Depending on a value of <code>NumNormals</code>, next data block is interpreted either as <code>Normals[]</code> array (in <code>tr_vertex</code> format) or <code>Lights</code> array (just standard
<code>int16_t</code> values).</p></div>
<div class="paragraph"><p><code>NumTexturedTriangles</code> and <code>NumTexturedRectangles</code> are respectively the number of triangular and rectangular faces in this mesh. Corresponding
<code>TexturedTriangles</code> and <code>TexturedRectangles</code> array contain textured triangles and rectangles themselves.</p></div>
<div class="paragraph"><p><code>NumColoredTriangles</code> and <code>NumColoredRectangles</code> are respectively the number of triangular and rectangular faces in this mesh. Corresponding <code>ColoredTriangles</code>
and <code>ColoredRectangles</code> array contain colored triangles and rectangles themselves.</p></div>
<div class="paragraph"><p>As coloured faces feature was removed since TR4, <code>tr_mesh</code> structure was changed, and contain no data for coloured faces anymore:</p></div>
<div class="listingblock">
<a id="tr4_mesh"></a>
<div class="content"><div class="highlight"><pre><span class="k">virtual</span> <span class="k">struct</span> <span class="n">tr4_mesh</span>
<span class="p">{</span>
    <span class="n">tr_vertex</span> <span class="n">Centre</span><span class="p">;</span>
      <span class="kt">int32_t</span> <span class="n">CollRadius</span><span class="p">;</span>

      <span class="kt">int16_t</span> <span class="n">NumVertices</span><span class="p">;</span>           <span class="c1">// Number of vertices in this mesh</span>
    <span class="n">tr_vertex</span> <span class="n">Vertices</span><span class="p">[</span><span class="n">NumVertices</span><span class="p">];</span> <span class="c1">// List of vertices (relative coordinates)</span>

      <span class="kt">int16_t</span> <span class="n">NumNormals</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="n">NumNormals</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">tr_vertex</span> <span class="n">Normals</span><span class="p">[</span><span class="n">NumNormals</span><span class="p">];</span>
  <span class="k">else</span>
      <span class="kt">int16_t</span> <span class="n">Lights</span><span class="p">[</span><span class="n">abs</span><span class="p">(</span><span class="n">NumNormals</span><span class="p">)];</span>

     <span class="kt">int16_t</span> <span class="n">NumTexturedRectangles</span><span class="p">;</span> <span class="c1">// number of textured rectangles in this mesh</span>
    <span class="n">tr_face4</span> <span class="n">TexturedRectangles</span><span class="p">[</span><span class="n">NumTexturedRectangles</span><span class="p">];</span> <span class="c1">// list of textured rectangles</span>

     <span class="kt">int16_t</span> <span class="n">NumTexturedTriangles</span><span class="p">;</span>  <span class="c1">// number of textured triangles in this mesh</span>
    <span class="n">tr_face3</span> <span class="n">TexturedTriangles</span><span class="p">[</span><span class="n">NumTexturedTriangles</span><span class="p">];</span> <span class="c1">// list of textured triangles</span>
<span class="p">};</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_static_meshes">5.3. Static Meshes</h3>
<div class="paragraph"><p>As the name tells, static meshes are meshes that don&#8217;t move (e.g. skeletons lying on the floor, spiderwebs, trees, statues, etc.) Usually it implies that static
mesh is completely non-interactive, i.e. all it does is sitting there in place serving as an ornament.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content"><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Since TR4, certain static meshes became <em>destroyable</em> (either by shooting or exploding them), and even gained ability to activate <em>heavy
triggers</em>. Such static meshes are called <em>shatters</em>. Engine tells shatter statics from ordinary ones judging by their IDs, i.e. shatter static mesh must be in a
specific slot. This behaviour is hardcoded.</td>
</tr></table>
</div>
<div class="paragraph"><p>StaticMeshes have two <em>bounding boxes</em>. First one serves as visibililty box, and other is the collisional box. The former is being used for visibility testing,
and the latter is used for collision testing.</p></div>
<div class="listingblock">
<a id="tr_staticmesh"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_staticmesh</span>   <span class="c1">// 32 bytes</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span>   <span class="n">ID</span><span class="p">;</span>   <span class="c1">// Static Mesh Identifier</span>
    <span class="kt">uint16_t</span>   <span class="n">Mesh</span><span class="p">;</span> <span class="c1">// Mesh (offset into MeshPointers[])</span>
    <span class="n">tr2_vertex</span> <span class="n">VisibilityBox</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="n">tr2_vertex</span> <span class="n">CollisionBox</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="kt">uint16_t</span>   <span class="n">Flags</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>For <code>VisibilityBox</code> and <code>CollisionBox</code>, dimensions are specified using two vectors, first being the <code>bounding box minimum</code>, and second being the <code>bounding box
maximum</code>.</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr1.png" alt="TR1 only" width="16" height="17" title="TR1 only" />
</span><span class="image">
<img src="images/icons/tr2.png" alt="TR2 only" width="16" height="17" title="TR2 only" />
</span> <code>Flags</code> value is usually 2, and is 3 for static meshes <em>without collision</em>, like plants and lying skeletons. Since TR3, value is ignored, and
no-collision mode is obtained using degenerate collision box (with all-zero or all-one coordinates).</p></div>
</div>
<div class="sect2">
<h3 id="_models">5.4. Models</h3>
<div class="paragraph"><p>This defines a list of contiguous meshes that comprise one object, which is called a <em>model</em>. This structure also points to the hierarchy and offsets of the
meshes (<code>MeshTree</code>), and also to the animations used (<code>Animation</code>); these will be described in detail below. If the Animation index is -1, that means that there
are no predefined animations, and entity&#8217;s movement is all generated by the engine; an example is Lara&#8217;s ponytail or rolling balls from TR4 and TR5.</p></div>
<div class="paragraph"><p>Some entities are really stationary, such as locks and the skybox, and some are not rendered at all, such as &#8220;camera target&#8221; points to aim the camera at,
flame emitters, AI objects and other service entities. Such invisible models are frequently called <em>nullmeshes</em>, because usually they have no valid mesh
index specified for them.</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr1.png" alt="TR1 only" width="16" height="17" title="TR1 only" />
</span><span class="image">
<img src="images/icons/tr2.png" alt="TR2 only" width="16" height="17" title="TR2 only" />
</span> Sometimes, model may refer to sprite or sprite sequence to draw itself (for example, pick-up items and flame emitters). In this case, model is replaced with sprite in run-time. This behaviour is hardcoded for specific model IDs.</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Sometimes, model may have <em>two different versions</em> defined in level files&#8201;&#8212;&#8201;one is normal, and another is low-detailed one, with the latter used when camera position gets too far from them. These are called <em>MIP models</em>, and mostly exist for NPCs (enemies). Usually, their type IDs are one off their normal counterparts (for example, skeleton type ID in TR4 is <em>35</em>, and its MIP variation is <em>36</em>).</p></div>
<div class="listingblock">
<a id="tr_model"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_model</span>  <span class="c1">// 18 bytes</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">ID</span><span class="p">;</span>           <span class="c1">// Type Identifier (matched in Entities[])</span>
    <span class="kt">uint16_t</span> <span class="n">NumMeshes</span><span class="p">;</span>    <span class="c1">// Number of meshes in this object</span>
    <span class="kt">uint16_t</span> <span class="n">StartingMesh</span><span class="p">;</span> <span class="c1">// Stating mesh (offset into MeshPointers[])</span>
    <span class="kt">uint32_t</span> <span class="n">MeshTree</span><span class="p">;</span>     <span class="c1">// Offset into MeshTree[]</span>
    <span class="kt">uint32_t</span> <span class="n">FrameOffset</span><span class="p">;</span>  <span class="c1">// Byte offset into Frames[] (divide by 2 for Frames[i])</span>
    <span class="kt">uint16_t</span> <span class="n">Animation</span><span class="p">;</span>    <span class="c1">// Offset into Animations[]</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> There is an extra <code>uint16_t</code> at the end of <code>tr_model</code> structure, which is always <code>0xFFEF</code> and used for alignment. Consider it while parsing.</p></div>
</div>
<div class="sect2">
<h3 id="_entities_2">5.5. Entities</h3>
<div class="paragraph"><p>Entities are the actual instances of entity types, consisting either of <em>models</em> or <em>sprites</em> (with the latter existing in TR1-2 only). For an entity to appear in a level, it must be
referenced in the <code>Models[]</code> array. Multiple instances of the same model are possible (e.g. two identical tigers in different rooms are represented using two
entries in <code>Entities[]</code>, one for each).</p></div>
<div class="paragraph"><p>Entity structure has gone through different variations across game versions, so we&#8217;ll list them all.</p></div>
<div class="sect3">
<h4 id="_tr1_entity_structure">5.5.1. TR1 Entity Structure</h4>
<div class="listingblock">
<a id="tr_entity"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_entity</span>
<span class="p">{</span>
    <span class="kt">int16_t</span> <span class="n">TypeID</span><span class="p">;</span>     <span class="c1">// Entity type ID (matched in Models[])</span>
    <span class="kt">int16_t</span> <span class="n">Room</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">x</span><span class="p">;</span>          <span class="c1">// Item position in world coordinates</span>
    <span class="kt">int32_t</span> <span class="n">y</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">z</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">Angle</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">Intensity1</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">Flags</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_tr2_3_entity_structure">5.5.2. TR2-3 Entity Structure</h4>
<div class="listingblock">
<a id="tr2_entity"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr2_entity</span>
<span class="p">{</span>
    <span class="kt">int16_t</span> <span class="n">TypeID</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">Room</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">x</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">y</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">z</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">Angle</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">Intensity1</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">Intensity2</span><span class="p">;</span> <span class="c1">// Like Intensity1, and almost always with the same value.</span>
    <span class="kt">uint16_t</span> <span class="n">Flags</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_tr4_5_entity_structure">5.5.3. TR4-5 Entity Structure</h4>
<div class="listingblock">
<a id="tr4_entity"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr4_entity</span>
<span class="p">{</span>
    <span class="kt">int16_t</span> <span class="n">TypeID</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">Room</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">x</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">y</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">z</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">Angle</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">Intensity1</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">OCB</span><span class="p">;</span>        <span class="c1">// Replaces Intensity2, see further for explanations.</span>
    <span class="kt">uint16_t</span> <span class="n">Flags</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>TypeID</code> is used to assign appropriate action for this entity and/or locate the appropriate sprite sequence or model to draw. If <code>TypeID</code> is zero, it means it&#8217;s playable character (i.e. Lara).</p></div>
<div class="paragraph"><p><code>Room</code> is a room ID to which this particular entity belongs to. If <em>room</em> value was modified incorrectly, entity will glitch and, most likely, won&#8217;t appear in
engine. That is, you can&#8217;t change entity position without complementary edit or <code>Room</code> field.</p></div>
<div class="paragraph"><p><code>Angle</code> is an <em>Euler Yaw angle</em> (i.e. &#8220;horizontal&#8221; rotation) stored in a special manner. To convert it to ordinary degrees, use this formula:</p></div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="100%"
frame="void"
cellspacing="0" cellpadding="4">
<col width="100%" />
<tbody>
<tr>
<td align="center" valign="top"><p class="table">$\angle^\circ = (Angle \div 16384) \times -90$</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr1.png" alt="TR1 only" width="16" height="17" title="TR1 only" />
</span> <code>Intensity2</code> field is missing in this game version, so the structure size is 2 bytes less.</p></div>
<div class="paragraph"><p><code>Intensity1</code>: If not -1, it is a value of constant lighting. -1 means &#8220;use mesh lighting&#8221;.</p></div>
<div class="paragraph"><p><code>Flags</code> value contain packed list of several parameters:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>Bit 7</strong> (<code>0x0080</code>)&#8201;&#8212;&#8201;<span class="image">
<img src="images/icons/tr1.png" alt="TR1 only" width="16" height="17" title="TR1 only" />
</span><span class="image">
<img src="images/icons/tr2.png" alt="TR2 only" width="16" height="17" title="TR2 only" />
</span><span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span> <em>Clear Body</em> flag. It is used together with <em>Clear Bodies</em> trigger action to remove the body of dead enemy from the
  level to conserve resources.
</p>
</li>
<li>
<p>
<strong>Bit 8</strong> (<code>0x0100</code>)&#8201;&#8212;&#8201;<em>Invisible</em> flag. If entity has this flag set, it will be invisible on start-up. However, it only works for specific types of entities.
  It is primarily used with pick-ups or other entities which should appear at certain point only after activation, but are visible by default.
</p>
</li>
<li>
<p>
<strong>Bits 9..13</strong> (<code>0x3E00</code>)&#8201;&#8212;&#8201;<em>Activation Mask</em> for this entity. As you already learned in <em>Trigger Actions</em> chapter, entity is only activated when <em>activation
  mask is all set</em> (i.e. all 5 bits are set, and value is <code>0x1F</code>). However, activation mask doesn&#8217;t strictly required to be set by trigger&#8201;&#8212;&#8201;level editor
  allows to <em>pre-define</em> activation mask, so entity will bear specific activation mask layout on level start-up.
</p>
</li>
</ul></div>
<div class="paragraph"><p>If activation mask was pre-set to <code>0x1F</code> (all set), entity will activate <em>immediately after level loading</em>, and engine will also <em>reset activation mask to zero</em>
and <em>mark entity as inactive</em>, effectively swapping &#8220;inactive&#8221; state with &#8220;active&#8221;. That is, when player will activate such pre-activated entity with a
trigger, it will actually &#8220;deactivate&#8221;, et cetera. Most prominent example of this behaviour is pre-opened grated door in Tomb of Qualopec.</p></div>
</div>
<div class="sect3">
<h4 id="object-code-bit">5.5.4. Object Code Bit</h4>
<div class="paragraph"><p>In TR4 and TR5, <code>Intensity2</code> field was replaced with completely new one, called <em>Object Code Bit</em> (or <code>OCB</code>). OCB allows to alter entity behaviour based on its value, thus providing very basic &#8220;script-like&#8221; functionality. For example, flame emitter entities have a case switch for OCB value, and each valid OCB value produces different result&#8201;&#8212;&#8201;flame emttier acts either as a static flame, as a directional flame, as a lightning, and so on.</p></div>
<div class="paragraph"><p>More detailed description of OCB is provided in <a href="#non-player-character-behaviour">this section</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_sprites">5.6. Sprites</h3>
<div class="paragraph"><p>These are &#8220;billboard&#8221; objects that are always rendered perpendicular to the view direction. These are used for text and explosion effects and similar things;
they are also used for some scenery objects and pickup items, though this use gets less as one goes from TR1 to TR3. The various &#8220;Sides&#8221; below are the
positions of the sprite sides relative to the sprite&#8217;s overall position, measured in TR&#8217;s world-coordinate units.</p></div>
<div class="listingblock">
<a id="tr_sprite_texture"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_sprite_texture</span>   <span class="c1">// 16 bytes</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">Tile</span><span class="p">;</span>
     <span class="kt">uint8_t</span> <span class="n">x</span><span class="p">;</span>
     <span class="kt">uint8_t</span> <span class="n">y</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">Width</span><span class="p">;</span>        <span class="c1">// (ActualWidth  * 256) + 255</span>
    <span class="kt">uint16_t</span> <span class="n">Height</span><span class="p">;</span>       <span class="c1">// (ActualHeight * 256) + 255</span>
     <span class="kt">int16_t</span> <span class="n">LeftSide</span><span class="p">;</span>
     <span class="kt">int16_t</span> <span class="n">TopSide</span><span class="p">;</span>
     <span class="kt">int16_t</span> <span class="n">RightSide</span><span class="p">;</span>
     <span class="kt">int16_t</span> <span class="n">BottomSide</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> <code>x</code> and <code>y</code> values <em>are not used</em> in this version. Additionally, formula for <code>Width</code> and <code>Height</code> is changed: now it&#8217;s <code>(ActualWidth - 1) * 256</code> and <code>(ActualHeight - 1) * 256</code> respectively.</p></div>
</div>
<div class="sect2">
<h3 id="_sprite_sequences">5.7. Sprite Sequences</h3>
<div class="paragraph"><p>These are collections of sprites that are referred to as a group. The members of this group can be cycled through (animated sprites such as flames, blood splats or explosions) or selected
in other ways (text). Some sequences have only one member; this is done so as to access all the sprites in the same way.</p></div>
<div class="listingblock">
<a id="tr_sprite_sequence"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_sprite_sequence</span>  <span class="c1">// 8 bytes</span>
<span class="p">{</span>
    <span class="kt">int32_t</span> <span class="n">SpriteID</span><span class="p">;</span>       <span class="c1">// Sprite identifier</span>
    <span class="kt">int16_t</span> <span class="n">NegativeLength</span><span class="p">;</span> <span class="c1">// Negative of ``how many sprites are in this sequence&#39;&#39;</span>
    <span class="kt">int16_t</span> <span class="n">Offset</span><span class="p">;</span>         <span class="c1">// Where (in sprite texture list) this sequence starts</span>
<span class="p">};</span>
</pre></div></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mesh_construction_and_animation">6. Mesh Construction and Animation</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_overview_4">6.1. Overview</h3>
<div class="paragraph"><p>The animated mesh objects in the Tomb Raider series are sets of meshes that are moved relative to each other, as defined by <code>Entities[]</code> entries. Each entry
describes which meshes to be used (a contiguous set of them referred to in <code>MeshPointers[]</code>), what hierarchy and relative offsets they have (contents of
<code>MeshTree[]</code> pointed to), and what animations are to be used (contents of <code>Animations[]</code> pointed to).</p></div>
<div class="paragraph"><p>The hierarchy used is a branching one, with the meshes being at the nodes, and with the first mesh being the root node. The <code>MeshTree[]</code> values are applied to each of the child meshes in sequence; they are sets of four <code>int32_t</code>s, the first being a hierarchy operator,
and the remaining three being the coordinates in the parent mesh&#8217;s system. A hierarchy example is that for the Lara meshes:</p></div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="70%"
frame="void"
cellspacing="0" cellpadding="4">
<col width="100%" />
<tbody>
<tr>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/illustrations/meshtree.png" alt="illustrations/meshtree.png" width="450" height="446" title="Lara&#8217;s MeshTree" />
</span></p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table"><em>Top-down hierarchy of Lara&#8217;s MeshTree. Hips is a root mesh. Ponytail is not listed, as it is a separate object.</em></p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>This is implemented by using a stack of meshes and &#8220;push&#8221; and &#8220;pop&#8221; operations in <code>MeshTree[]</code>. Normally, each mesh&#8217;s parent is the previous mesh in series.
But such meshes can be &#8220;remembered&#8221; by adding them to a stack of meshes with a &#8220;push&#8221; operation. This remembered mesh can then be used as the parent mesh
with a &#8220;pop&#8221; operation. It is not clear what the maximum stack depth is; most TR mesh stacks do not extend beyond 2 or 3 meshes.</p></div>
<div class="paragraph"><p>The animations for each mesh object are selected with some ingenious techniques. Which animations to use are not hardcoded; instead, each entity has some states
it can be in, and these states are used to select which animation. For example, locks have only one state (they just sit there), doors have two states (open and
closed), and Lara has numerous states, such as standing, walking, running, jumping, falling, being hurt, dying, etc. Each animation has a state ID, which can be
used to select it; however, state transitions might seem to require a large number of intermediate states (opening, closing, starting to jump, landing, etc.).
The alternative used in the Tomb Raider engine is for each animation to have bridge animations to other states' animations, which are selected using the ID of
which state to change to. These bridge animations then lead to the animation with the appropriate state. Thus, a closed door will run a looped closed-door
animation as long as its state stays &#8220;closed&#8221;, but when its state becomes &#8220;open&#8221;, it will change to an opening-door bridge animation, which will end in a
looped open-door animation. Likewise, closing a door will make it use a closing-door bridge animation. Some bridge animations are chosen with a finer grain of
selectivity, however, such as using one for left foot forward and one for right foot forward.</p></div>
<div class="paragraph"><p>Thus, each animation references a set of <code>StateChange</code> structures, each one of which references an <code>AnimDispatch</code> structure (called a &#8220;range&#8221; in some
documentation). Each <code>StateChange</code> structure contains a new state and which <code>AnimDispatch</code> structures to use. When an entity goes into a new state, the
<code>StateChange</code> structures are scanned for that state&#8217;s ID, and if one matches, then that <code>StateChange</code>'s <code>AnimDispatch</code> es are then scanned for a range of frames
that contains the ID of the current frame. If such an <code>AnimDispatch</code> is found, the animation and the frame are changed to those listed in it.</p></div>
<div class="paragraph"><p>The ultimate unit of animation is, of course, the frame, and each frame consists of a bounding box, the offset of the root mesh, and rotation angles for all the
meshes with respect to their parent meshes. The root mesh is also rotated, but relative to the object&#8217;s overall coordinates. All rotations are performed around
the meshes' origins, and are in order Y, X, Z (yaw, pitch, roll). The reason for the root mesh&#8217;s displacement is because entities traveling on solid surfaces
are likely tracked by having their locations be at ground level, and Lara&#8217;s hips, for example, are well above the ground. Finally, some of the angles are not
specified explicitly, when they are not, they are zero.</p></div>
<div class="paragraph"><p>Frames are referenced in two ways, either by an offset into the <code>Frames[]</code> array that contains them, or by frame index. The values of the latter appear to be
unique to each kind of entity, but not between entities; the first frame for each kind is numbered 0. This is likely a convenience when constructing the
animations, since the list of animation frames for each entity can be constructed separately. However, using these indices is fairly simple. Each Animation
structure has a first-frame index; this index is subtracted from the index of the desired frame in order to find out its index relative to the animation&#8217;s first
frame.</p></div>
<div class="paragraph"><p>There are also some special <em>AnimCommands</em> for doing various additional things. Some of them are for moving entities in absolute coordinates, for example to
position Lara at climb location, or specifying jump momentum. Some others define actions per frame, like playing sounds, emitting bubbles, and so forth.</p></div>
<div class="paragraph"><p>Finally, some entities appear to have incomplete set of animations; their complete animations are &#8220;borrowed&#8221; from similar entities. Such setup is mostly used
in TR2&#8217;s Venice levels&#8201;&#8212;&#8201;some of Venice goons them have a full set of animations, while some others have only the standing animation. The ones with only the
standing animation borrow their other animations from the fully-animated ones.</p></div>
</div>
<div class="sect2">
<h3 id="_data_structures">6.2. Data Structures</h3>
<div class="sect3">
<h4 id="_mesh_tree_structure">6.2.1. Mesh Tree Structure</h4>
<div class="listingblock">
<a id="tr_meshtree_node"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_meshtree_node</span> <span class="c1">// 4 bytes</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">Flags</span><span class="p">;</span>
     <span class="kt">int32_t</span> <span class="n">Offset_X</span><span class="p">;</span>
     <span class="kt">int32_t</span> <span class="n">Offset_Y</span><span class="p">;</span>
     <span class="kt">int32_t</span> <span class="n">Offset_Z</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>MeshTree[]</code> array consists of meshtree nodes.</p></div>
<div class="paragraph"><p>In &#8216;Flags` field, two bytes are used:
* Bit 0 (<code>0x0001</code>) indicates <em>``take the top mesh off of the mesh stack and use as the parent mesh&#8217;' when set</em>, otherwise <em><code>&#8216;use the previous mesh as the parent mesh&#8217;'</em>.
* Bit 1 (</code>0x0002`) indicates &#8220;put the parent mesh on the mesh stack&#8221;.</p></div>
<div class="paragraph"><p>When both bits are set, the <em>Bit 0</em> operation is always done before the <em>Bit 1</em> operation. In effect, <em>read the stack but do not change it</em>.</p></div>
<div class="paragraph"><p><code>Offset_X</code>, <code>Offset_Y</code> and <code>Offset_Z</code> are offsets of the mesh&#8217;s origin from the parent mesh&#8217;s origin.</p></div>
</div>
<div class="sect3">
<h4 id="_tr1_3_animation_structure">6.2.2. TR1-3 Animation Structure</h4>
<div class="paragraph"><p>This describes each individual animation. These may be looped by specifying the next animation to be itself. In TR2 and TR3, one must be careful when parsing
frames using the FrameSize value as the size of each frame, since an animation&#8217;s frame range may extend into the next animation&#8217;s frame range, and that may have
a different FrameSize value.</p></div>
<div class="listingblock">
<a id="tr_animation"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_animation</span> <span class="c1">// 32 bytes</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span>  <span class="n">FrameOffset</span><span class="p">;</span> <span class="c1">// Byte offset into Frames[] (divide by 2 for Frames[i])</span>
     <span class="kt">uint8_t</span>  <span class="n">FrameRate</span><span class="p">;</span>   <span class="c1">// Engine ticks per frame</span>
     <span class="kt">uint8_t</span>  <span class="n">FrameSize</span><span class="p">;</span>   <span class="c1">// Number of int16_t&#39;s in Frames[] used by this animation</span>

    <span class="kt">uint16_t</span>  <span class="n">State_ID</span><span class="p">;</span>

       <span class="n">fixed</span>  <span class="n">Speed</span><span class="p">;</span>
       <span class="n">fixed</span>  <span class="n">Accel</span><span class="p">;</span>

    <span class="kt">uint16_t</span>  <span class="n">FrameStart</span><span class="p">;</span>  <span class="c1">// First frame in this animation</span>
    <span class="kt">uint16_t</span>  <span class="n">FrameEnd</span><span class="p">;</span>    <span class="c1">// Last frame in this animation</span>
    <span class="kt">uint16_t</span>  <span class="n">NextAnimation</span><span class="p">;</span>
    <span class="kt">uint16_t</span>  <span class="n">NextFrame</span><span class="p">;</span>

    <span class="kt">uint16_t</span>  <span class="n">NumStateChanges</span><span class="p">;</span>
    <span class="kt">uint16_t</span>  <span class="n">StateChangeOffset</span><span class="p">;</span> <span class="c1">// Offset into StateChanges[]</span>

    <span class="kt">uint16_t</span>  <span class="n">NumAnimCommands</span><span class="p">;</span>   <span class="c1">// How many of them to use.</span>
    <span class="kt">uint16_t</span>  <span class="n">AnimCommand</span><span class="p">;</span>       <span class="c1">// Offset into AnimCommand[]</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>FrameOffset</code> is a byte offset into Frames[] (divide by 2 for Frames[i]).</p></div>
<div class="paragraph"><p><code>FrameRate</code> is a multiplier value which defines how many <em>game frames</em> will be spent for each actual animation frame. For example, if value is 1, then each
animation frame belongs to single game frame. If value is 2, then each animation frame belongs to two game frames, and so on. In latter case, animation frames
will be interpolated between game frames using <em>slerp</em> function.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>Actual game frame rate is always locked to 30 FPS. All engine internal counters, including animation frame counters, are also using 30 FPS timebase.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p><code>State_ID</code> identifies current state type to be used with this animation. Engine uses current <code>State_ID</code> not only to solve state changes, but also to define
current Lara behaviour&#8201;&#8212;&#8201;like collisional routines to be used, controls to be checked, health/air/sprint points to be drained, and so on.</p></div>
<div class="paragraph"><p><code>Speed</code> and <code>Accel</code> values are used to set a specific momentum to a given entity. That is, entity will be accelerated with <code>Accel</code> value, until <code>Speed</code> value is
reached. If <code>Accel</code> is negative, speed will be decreased to fit <code>Speed</code> value. The direction in which entity is moved using speed value is hardcoded, and mostly
is forward.</p></div>
<div class="paragraph"><p><code>NextAnimation</code> defines which animation should be played after current one is finished. When current animation ends, engine will switch it to <code>NextAnimation</code>,
not regarding current <code>State_ID</code> value. If <code>NextAnimation</code> value is the same as animation number itself, it means animation will be looped until loop is broken
by state change.</p></div>
<div class="paragraph"><p><code>NextFrame</code> specifies the frame number to be used when switching to next animation. That is, if <code>NextFrame</code> is 5 and <code>NextAnimation</code> is 20, it basically means
that at the end of current animation engine will switch right to frame 5 of animation 20. If animation is looped, <code>NextFrame</code> defines to which frame animation
should be rewound. It allows to &#8220;eat up&#8221; certain start-up frames of some animations and re-use them as looped.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/tip.png" alt="Tip" />
</td>
<td class="content">To get number of frames for current animation, use this formula: <code>NumFrames = (FrameEnd - FrameStart) + 1</code>.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_tr4_5_animation_structure">6.2.3. TR4-5 Animation Structure</h4>
<div class="paragraph"><p>For TR4 and TR5, extended version of <code>tr_animation</code> is used:</p></div>
<div class="listingblock">
<a id="tr4_animation"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr4_animation</span> <span class="c1">// 40 bytes</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span>  <span class="n">FrameOffset</span><span class="p">;</span>
     <span class="kt">uint8_t</span>  <span class="n">FrameRate</span><span class="p">;</span>
     <span class="kt">uint8_t</span>  <span class="n">FrameSize</span><span class="p">;</span>

    <span class="kt">uint16_t</span>  <span class="n">State_ID</span><span class="p">;</span>

       <span class="n">fixed</span>  <span class="n">Speed</span><span class="p">;</span>
       <span class="n">fixed</span>  <span class="n">Accel</span><span class="p">;</span>
       <span class="n">fixed</span>  <span class="n">SpeedLateral</span><span class="p">;</span> <span class="c1">// New field</span>
       <span class="n">fixed</span>  <span class="n">AccelLateral</span><span class="p">;</span> <span class="c1">// New field</span>

    <span class="kt">uint16_t</span>  <span class="n">FrameStart</span><span class="p">;</span>
    <span class="kt">uint16_t</span>  <span class="n">FrameEnd</span><span class="p">;</span>
    <span class="kt">uint16_t</span>  <span class="n">NextAnimation</span><span class="p">;</span>
    <span class="kt">uint16_t</span>  <span class="n">NextFrame</span><span class="p">;</span>

    <span class="kt">uint16_t</span>  <span class="n">NumStateChanges</span><span class="p">;</span>
    <span class="kt">uint16_t</span>  <span class="n">StateChangeOffset</span><span class="p">;</span>

    <span class="kt">uint16_t</span>  <span class="n">NumAnimCommands</span><span class="p">;</span>
    <span class="kt">uint16_t</span>  <span class="n">AnimCommand</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span> <span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> In addition to <code>Speed</code> and <code>Accel</code> values, TR4 introduced <code>LateralSpeed</code> and <code>LateralAccel</code> values, which are used to move entity to the sides,
rather than forward or backward. However, these values are only used for <em>any entity but Lara</em>&#8201;&#8212;&#8201;engine ignores them in such case.</p></div>
<div class="paragraph"><p>Lateral speed and acceleration primarily used for &#8220;start-up&#8221; animations of NPCs&#8201;&#8212;&#8201;for example, armed baddies in TR4 can roll or jump aside.</p></div>
</div>
<div class="sect3">
<h4 id="_state_change_structure">6.2.4. State Change Structure</h4>
<div class="paragraph"><p>Each state change entry contains the state to change to and which animation dispatches to use; there may be more than one, with each separate one covering a
different range of frames.</p></div>
<div class="listingblock">
<a id="tr_state_change"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_state_change</span> <span class="c1">// 6 bytes</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">StateID</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">NumAnimDispatches</span><span class="p">;</span> <span class="c1">// number of ranges (seems to always be 1..5)</span>
    <span class="kt">uint16_t</span> <span class="n">AnimDispatch</span><span class="p">;</span>      <span class="c1">// Offset into AnimDispatches[]</span>
<span class="p">};</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_animation_dispatch_structure">6.2.5. Animation Dispatch Structure</h4>
<div class="paragraph"><p>This specifies the next animation and frame to use; these are associated with some range of frames. This makes possible such specificity as one animation for
left foot forward and another animation for right foot forward.</p></div>
<div class="listingblock">
<a id="tr_anim_dispatch"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_anim_dispatch</span>    <span class="c1">// 8 bytes</span>
<span class="p">{</span>
    <span class="kt">int16_t</span> <span class="n">Low</span><span class="p">;</span>           <span class="c1">// Lowest frame that uses this range</span>
    <span class="kt">int16_t</span> <span class="n">High</span><span class="p">;</span>          <span class="c1">// Highest frame that uses this range</span>
    <span class="kt">int16_t</span> <span class="n">NextAnimation</span><span class="p">;</span> <span class="c1">// Animation to dispatch to</span>
    <span class="kt">int16_t</span> <span class="n">NextFrame</span><span class="p">;</span>     <span class="c1">// Frame offset to dispatch to</span>
<span class="p">};</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_animcommand_structure">6.2.6. AnimCommand Structure</h4>
<div class="paragraph"><p>These are various commands associated with each animation. They are varying numbers of <code>int16_t</code>s packed into an array. As the <em>FloorData</em>, AnimCommands must be
parsed sequentially, one by one.</p></div>
<div class="paragraph"><p>The first AnimCommand entry is the <em>type</em>, which also determines how many <code>int16_t</code> arguments (operands) follow it (i.e. how many <code>int16_t</code> values must be
parsed after current one without switching to next AnimCommand). For a given animation, AnimCommands are parsed until <code>NumAnimCommands</code> value is reached.</p></div>
<div class="paragraph"><p>Some of commands refer to the whole animation (jump speed, position change and empty hands commands), while others of them are associated with specific frames (sound, bubbles, etc.).</p></div>
<div class="listingblock">
<a id="tr_anim_command"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_anim_command</span> <span class="c1">// 2 bytes</span>
<span class="p">{</span>
    <span class="kt">int16_t</span> <span class="n">Value</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>Here are all the <code>AnimCommand</code> types and their arguments.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<strong>Set Position</strong> (3 arguments). Sets relative entity position (x, y, z); found in grab and block-move animations.
</p>
</li>
<li>
<p>
<strong>Jump Distance</strong> (2 arguments). Vertical and horizontal speed for jumping.
</p>
</li>
<li>
<p>
<strong>Empty Hands</strong> (No arguments). This command is performed in the end of animation of Lara pulling a switch, inserting a key, grabbing a pushable block, and
  so on. It is needed because engine &#8220;locks&#8221; Lara&#8217;s ability to draw weapons or ignite a flare when such action is performed, and only way to unlock it is to
  call this command.
</p>
</li>
<li>
<p>
<strong>Kill</strong> (No arguments). Kill entity. This effectively disables entity and removes it from the world.
</p>
</li>
<li>
<p>
<strong>Play Sound</strong> (2 arguments). The first argument is a frame number, and the second one is the ID of the sound to play at that frame (internal sound index).
</p>
<div class="openblock">
<div class="content">
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr2.png" alt="TR2 only" width="16" height="17" title="TR2 only" />
</span><span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Besides Sound ID, second argument may contain two &#8220;packed&#8221; bit flags. Their meanings are:</p></div>
</div></div>
<div class="ulist"><ul>
<li>
<p>
<code>0x4000</code>&#8201;&#8212;&#8201;play this sound when on dry land (example: footsteps)
</p>
</li>
<li>
<p>
<code>0x8000</code>&#8201;&#8212;&#8201;play this sound when in water (example: running through shallow water)
</p>
</li>
</ul></div>
</li>
<li>
<p>
<strong>Effect</strong> (2 operands). The first one is a frame number, and the second one is effect number. Note that <em>effect</em> here is the very same kind of effect used
  in <em>trigger action</em> with the same name. Effect meaning will be listed separately.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_frame_structure">6.2.7. Frame Structure</h4>
<div class="paragraph"><p>Frames indicate how composite meshes are positioned and rotated. They work in conjunction with Animations[] and MeshTree[]. A given frame has the following
format:</p></div>
<div class="listingblock">
<a id="tr_anim_frame"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_anim_frame</span>    <span class="c1">// Variable size</span>
<span class="p">{</span>
     <span class="kt">int16_t</span> <span class="n">BB1x</span><span class="p">,</span> <span class="n">BB1y</span><span class="p">,</span> <span class="n">BB1z</span><span class="p">;</span> <span class="c1">// Bounding box (low)</span>
     <span class="kt">int16_t</span> <span class="n">BB2x</span><span class="p">,</span> <span class="n">BB2y</span><span class="p">,</span> <span class="n">BB2z</span><span class="p">;</span> <span class="c1">// Bounding box (high)</span>
     <span class="kt">int16_t</span> <span class="n">OffsetX</span><span class="p">,</span> <span class="n">OffsetY</span><span class="p">,</span> <span class="n">OffsetZ</span><span class="p">;</span> <span class="c1">// Starting offset for this model</span>
     <span class="kt">int16_t</span> <span class="n">NumValues</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">AngleSets</span><span class="p">[];</span>   <span class="c1">// Variable size</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p><code>NumValues</code>: <span class="image">
<img src="images/icons/tr1.png" alt="TR1 only" width="16" height="17" title="TR1 only" />
</span> Number of angle sets to follow; these start with the first mesh, and meshes without angles get zero angles. <span class="image">
<img src="images/icons/tr2.png" alt="TR2 only" width="16" height="17" title="TR2 only" />
</span><span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> NumValues is implicitly NumMeshes (from model).</p></div>
<div class="paragraph"><p><code>AngleSets</code> are sets of rotation angles for all the meshes with respect to their parent meshes. In TR2/3, an angle set can specify either one or three axes of
rotation.</p></div>
<div class="paragraph"><p>If either of the high two bits (<code>0xC000</code>) of the first angle <code>uint16_t</code> are set, it&#8217;s one axis: only one <code>uint16_t</code>, low 10 bits (<code>0x03FF</code>), scale is <code>0x0100</code>&#8201;&#8212;&#8201;90 degrees; the high two bits are interpreted as follows: <code>0x4000</code>&#8201;&#8212;&#8201;X only, <code>0x8000</code>&#8201;&#8212;&#8201;Y only, <code>0xC000</code>&#8201;&#8212;&#8201;Z only.</p></div>
<div class="paragraph"><p>If neither of the high bits are set, it&#8217;s a three-axis rotation. The next 10 bits (<code>0x3FF0</code>) are the X rotation, the next 10 (including the following
<code>uint16_t</code>) (<code>0x000F</code>, <code>0xFC00</code>) are the Y rotation, the next 10 (<code>0x03FF</code>) are the Z rotation, same scale as before (<code>0x0100</code>&#8201;&#8212;&#8201;90 degrees).</p></div>
<div class="paragraph"><p>Rotations are performed in Y, X, Z order.</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr1.png" alt="TR1 only" width="16" height="17" title="TR1 only" />
</span> All angle sets are two words and interpreted like the two-word sets in TR2/3, <em>except</em> that the word order is reversed.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="non-player-character-behaviour">7. Non-Player Character Behaviour</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_overview_5">7.1. Overview</h3>
<div class="paragraph"><p>All the Tomb Raider game physics and entity behaviour is hardcoded, with each type ID being associated with some specific sort of behaviour (as Lara,
as a boat, as a tiger, as a door, as a boulder, as a lock, etc.). That is, each model refer two internal engine routines&#8201;&#8212;&#8201;<em>collisional</em> one and <em>control</em> one. For static entities (like flame emitters), <em>collisional</em> routine may contain no functional code, while <em>control</em> routine is present. On contrary, &#8220;decorative&#8221; entities (usually called <em>animatings</em> in TRLE) may lack <em>control</em> code, while retaining <em>collisional</em> code.</p></div>
<div class="paragraph"><p>Several entity types may share the same collisional and/or control routines&#8201;&#8212;&#8201;for example, there is one generic collisional routine for almost all enemies, another generic routine for doors, and another one for <em>standable</em> entities, like bridge or platform objects.</p></div>
<div class="paragraph"><p>Lara is unique player character, so she has a large set of both <em>control</em> and <em>collisional</em> routines, which are switched depending on her current <em>state</em>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>In original Tomb Raider source code, notation for collisional and state routines follows two different schemes. For Lara, collisional and control routines are called <code>lara_col_STATE</code> and <code>lara_as_STATE</code>, where <code>STATE</code> is the name of the state, like <em>walk, run, reach</em>, and so on.</p></div>
<div class="paragraph"><p>For other entity types, there is more generic scheme: collisional routines are called <code>NAMECollision</code>, where <code>NAME</code> is entity type name, like <em>CreatureCollision</em>, and control routines are called <code>NAMEControl</code>, where <code>NAME</code> is entity type name. E.g., bear will have a pair of routines linked to it, named <em>CreatureCollision</em> and <em>BearControl</em>.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_entity_scripting">7.2. Entity Scripting</h3>
<div class="paragraph"><p>Despite the existence of <em>script files</em>, here is no any scripting for entity behaviour, like in most contemporary games. This hardcoding makes it difficult to port the earlier Tomb Raider
scenarios to the engines of the later games, which could be desirable with their improved hardware support. While textures, models, and animations
can be ported, behaviour cannot be.</p></div>
<div class="paragraph"><p>However, there is a small change in TR4 and TR5 which indicates that specific entity behaviour can be altered&#8201;&#8212;&#8201;it&#8217;s called <em>OCB</em>. It was briefly described in <a href="#object-code-bit">this section</a>. OCB is a special value defined for each entity instance, based on which entity can switch the way it acts (most prominent examples are flame emitters, which change their size and emit direction based on OCB, and teeth spikes, which change their orientation in space).</p></div>
<div class="paragraph"><p>Sometimes OCB is interpreted as a &#8220;packed&#8221; field with several values incorporated&#8201;&#8212;&#8201;like teeth spike OCB contain information about their horizontal and vertical orientation, and also about their &#8220;physical&#8221; behaviour (stick out constantly, pop-retract in looped manner, or pop-retract just once).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/tip.png" alt="Tip" />
</td>
<td class="content">
<div class="paragraph"><p>For list of valid entity OCBs in TR4, you may refer to TRLE User&#8217;s Manual, although it was written in a big rush, and thus it lacks many existing OCBs for many entities. There are also fan-made OCB lists which are much more comprehensive.</p></div>
<div class="paragraph"><p>As for TR5, no proper OCB list exists for its entity types, so it may be considered a big unknown.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>However, OCB can&#8217;t be seriously called &#8220;scripting&#8221;, as it also operates with pre-defined hardcoded behaviour.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>Recent patches for TR4 game engine (used to play custom levels), like <em>TREP</em> and <em>TRNG</em>, feature some kind of basic scripting functionality. However, there&#8217;s still no sign of <em>real scripting language</em> in them, and such scripting is basically specifying pre-defined variables to alter entity behaviour, just like OCB does.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_pathfinding">7.3. Pathfinding</h3>
<div class="paragraph"><p>Despite the lack of scripting, the Tomb Raider series does have navigation hints for the Non-Player Characters; those entities that move freely across the maps under the
command of the game AI. NPCs find their way in a level by checking &#8220;FloorData&#8221; collisional functions in the same way Lara does, and also with the help of special data structures which are used for proper pathfinding.</p></div>
<div class="sect3">
<h4 id="_data_structures_2">7.3.1. Data Structures</h4>
<div class="paragraph"><p>TR engines use three different structures to assist pathfinding. These are <em>boxes, overlaps, and zones</em>. Most sectors point to some <em>box</em>, the main exceptions being horizontal-portal sectors.
Several neighbour sectors may point to the same box. A box is a horizontal rectangle, with corners and height specified; each box also has a pointer into the
list of <em>overlaps</em>. Each segment in that list is the list of accessible neighbouring boxes for some box; the NPCs apparently select from this list to decide where
to go next.</p></div>
<div class="paragraph"><p>This selection is done with the help of the <em>zones</em>. These structures of 6 (TR1) or 10 (TR2-TR5) <code>int16_t</code>s that act as zone IDs;
their overall indexing is the same as the boxes, meaning that each box will have an associated set of zone IDs. An NPC will select one of this set to use, and
will prefer to go only into the overlaps-list boxes that have the same zone value as the box it is currently in. For example, one can create guard paths by making
chains of zone-ID-sharing boxes, with their overlaps pointing to the next boxes in those chains.</p></div>
<div class="sect4">
<h5 id="Boxes">Boxes</h5>
<div class="paragraph"><p>There are two variations of box structure&#8201;&#8212;&#8201;one for TR1 and another for TR2 and any other game version.</p></div>
<div class="listingblock">
<a id="tr_box"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_box</span>   <span class="c1">// 20 bytes</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">Zmin</span><span class="p">;</span>          <span class="c1">// Horizontal dimensions in global units</span>
    <span class="kt">uint32_t</span> <span class="n">Zmax</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">Xmin</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">Xmax</span><span class="p">;</span>
     <span class="kt">int16_t</span> <span class="n">TrueFloor</span><span class="p">;</span>     <span class="c1">// Height value in global units</span>
     <span class="kt">int16_t</span> <span class="n">OverlapIndex</span><span class="p">;</span>  <span class="c1">// Index into Overlaps[].</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="listingblock">
<a id="tr2_box"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr2_box</span>   <span class="c1">// 8 bytes</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">Zmin</span><span class="p">;</span>          <span class="c1">// Horizontal dimensions in sectors</span>
    <span class="kt">uint8_t</span> <span class="n">Zmax</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">Xmin</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">Xmax</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">TrueFloor</span><span class="p">;</span>     <span class="c1">// Height value in global units</span>
    <span class="kt">int16_t</span> <span class="n">OverlapIndex</span><span class="p">;</span>  <span class="c1">// Index into Overlaps[].</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>In <code>OverlapIndex</code>, the high bit is sometimes set; this occurs in front of swinging doors and the like.</p></div>
</div>
<div class="sect4">
<h5 id="_overlaps">Overlaps</h5>
<div class="paragraph"><p>This is a set of lists of neighbouring boxes for each box, each member being a <code>uint16_t</code>. NPCs apparently
use this list to decide where to go next.</p></div>
<div class="paragraph"><p>Overlaps must be parsed in serial manner, as with <em>FloorData</em> functions: the highest bit (<code>0x8000</code>) being set marks the end of each list.</p></div>
</div>
<div class="sect4">
<h5 id="_zones">Zones</h5>
<div class="paragraph"><p>This is a set of <code>int16_t</code>s, 6 for TR1 and 10 for TR2-5. NPCs prefer to travel to a box with the same zone ID as the one they are currently at.
Which of these zone IDs it uses depends on the kind of the NPC and its current state. The first half of the Zones structure is for the <em>normal</em> room state,
and the second half is for the <em>alternate</em> (flipped) room state. TR1 has 2 sets of ground zones and 1 set of fly zones:</p></div>
<div class="listingblock">
<a id="tr_zone"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_zone</span>   <span class="c1">// 12 bytes</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">GroundZone1_Normal</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">GroundZone2_Normal</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">FlyZone_Normal</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">GroundZone1_Alternate</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">GroundZone2_Alternate</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">FlyZone_Alternate</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>TR2-5 have similar breakdowns, though they have 4 ground zones:</p></div>
<div class="listingblock">
<a id="tr2_zone"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr2_zone</span>   <span class="c1">// 20 bytes</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">GroundZone1_Normal</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">GroundZone2_Normal</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">GroundZone3_Normal</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">GroundZone4_Normal</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">FlyZone_Normal</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">GroundZone1_Alternate</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">GroundZone2_Alternate</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">GroundZone3_Alternate</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">GroundZone4_Alternate</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">FlyZone_Alternate</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>The ground zones are for NPCs that travel on the ground, while the fly zones are for flying or swimming NPCs.</p></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ai_objects">7.4. AI Objects</h3>
<div class="paragraph"><p>Since TR3, in addition to pathfinding data structures, there are now special <em>AI objects</em>, which are used in a waypoint-like manner, defining specific action, like wandering between two points, guarding specific point or running to specific place in case Lara is around. For example, MP Guards in TR3&#8217;s &#8220;Area 51&#8221; may patrol specific area when they are limited by special <em>AI_PATROL</em> object.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>Not every NPC is &#8220;taught&#8221; to work with AI objects&#8201;&#8212;&#8201;usually, only &#8220;smart&#8221; human enemies or friends can take advantage of them. Analyzing level files with utilities like <em>FexInspect</em> may help understanding particular AI object setup and learn which NPCs can actually work with them.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Specific set of AI objects and their respective entity type IDs are different across game versions, but types themselves largely remained unchanged from TR3 to TR5. Here are they:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>AI_GUARD</strong>&#8201;&#8212;&#8201;Makes the enemy stay on his current position and turn his head, looking left and right, with a 180 degree field of view&#8201;&#8212;&#8201;so his &#8220;viewing cone&#8221; is continuously changed, based on current look direction. When Lara gets into his &#8220;viewing cone&#8221;, default entity behaviour is engaged&#8201;&#8212;&#8201;for example, MP guards will chase Lara and try to beat her.
</p>
</li>
<li>
<p>
<strong>AI_AMBUSH</strong>&#8201;&#8212;&#8201;Makes the enemy run to a designated square by dropping an AI_AMBUSH object on the same sector with him, and another AI_AMBUSH on the sector where he should run to. He will do that only if he spots Lara (hence the name). After reaching second AI_AMBUSH point, enemy will switch to default behaviour. Best example is MP Guard in &#8220;Area 51&#8221; who locks out first secret, if you won&#8217;t manage to kill him in time after he noticed you.
</p>
</li>
<li>
<p>
<strong>AI_PATROL1</strong> and <strong>AI_PATROL2</strong>&#8201;&#8212;&#8201;Makes the enemy patrol specific path between AI_PATROL1 and AI_PATROL2 locations. To make it work, AI_PATROL1 object must be in the same sector with enemy, and AI_PATROL2 must be in the point to which enemy must go. After reaching AI_PATROL2 point, enemy will return to AI_PATROL1 point, and vice versa. It&#8217;s also possible to specify another &#8220;starting point&#8221; for enemy by dropping extra AI_PATROL1 object&#8201;&#8212;&#8201;then enemy will go to this secondary AI_PATROL1 object just after activation. If enemy spots Lara, he will switch to default behaviour.
</p>
</li>
<li>
<p>
<strong>AI_MODIFY</strong>&#8201;&#8212;&#8201;When placed in the same sector with <em>AI_GUARD</em>, it makes the enemy look straight ahead, instead of turning his head left and right.
</p>
</li>
<li>
<p>
<strong>AI_FOLLOW</strong>&#8201;&#8212;&#8201;Used primarily with friendly NPCs, and makes them wait for Lara and then &#8220;lead&#8221; her to specific point. For such behaviour, one AI_FOLLOW object must be placed in the same sector as NPC, and second AI_FOLLOW object must be placed on target point. If Lara shoots NPC affected with AI_FOLLOW behaviour, he will abandon it and become hostile.
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>If there is a HEAVYTRIGGER under an AI_AMBUSH or AI_PATROL object, the enemy will activate it only when he gets there.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> TR4 introduced two additional AI objects, <strong>AI_X1</strong> and <strong>AI_X2</strong>. For example, these are used with SAS Guards in <em>Cairo</em> story arc. When AI_X1 object is placed in the same sector with SAS Guard, he will prefer to shoot grenades instead of bullets. If another SAS Guard with AI_X2 is activated nearby, then first one will stop shooting grenades, and second one will shoot them instead.</p></div>
<div class="sect3">
<h4 id="_ai_object_ids">7.4.1. AI Object IDs</h4>
<div class="paragraph"><p>Here are all AI Object type IDs in each TR version which has them:</p></div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="40%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="40%" />
<col width="20%" />
<col width="20%" />
<col width="20%" />
<thead>
<tr>
<th align="left" valign="top">            </th>
<th align="center" valign="top"> TR3 </th>
<th align="center" valign="top"> TR4 </th>
<th align="center" valign="top"> TR5</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">AI_GUARD</p></td>
<td align="center" valign="top"><p class="table"><code>74</code></p></td>
<td align="center" valign="top"><p class="table"><code>398</code></p></td>
<td align="center" valign="top"><p class="table"><code>378</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">AI_AMBUSH</p></td>
<td align="center" valign="top"><p class="table"><code>75</code></p></td>
<td align="center" valign="top"><p class="table"><code>399</code></p></td>
<td align="center" valign="top"><p class="table"><code>379</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">AI_PATROL1</p></td>
<td align="center" valign="top"><p class="table"><code>76</code></p></td>
<td align="center" valign="top"><p class="table"><code>400</code></p></td>
<td align="center" valign="top"><p class="table"><code>380</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">AI_PATROL2</p></td>
<td align="center" valign="top"><p class="table"><code>79</code></p></td>
<td align="center" valign="top"><p class="table"><code>403</code></p></td>
<td align="center" valign="top"><p class="table"><code>383</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">AI_MODIFY</p></td>
<td align="center" valign="top"><p class="table"><code>77</code></p></td>
<td align="center" valign="top"><p class="table"><code>401</code></p></td>
<td align="center" valign="top"><p class="table"><code>381</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">AI_FOLLOW</p></td>
<td align="center" valign="top"><p class="table"><code>78</code></p></td>
<td align="center" valign="top"><p class="table"><code>402</code></p></td>
<td align="center" valign="top"><p class="table"><code>382</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">AI_X1</p></td>
<td align="center" valign="top"><p class="table"><code></code></p></td>
<td align="center" valign="top"><p class="table"><code>404</code></p></td>
<td align="center" valign="top"><p class="table"><code>384</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">AI_X2</p></td>
<td align="center" valign="top"><p class="table"><code></code></p></td>
<td align="center" valign="top"><p class="table"><code>405</code></p></td>
<td align="center" valign="top"><p class="table"><code>385</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_ai_data_block_in_tr4_5">7.4.2. AI Data Block in TR4-5</h4>
<div class="paragraph"><p>Beginning with TR4, AI objects are <em>not kept along with other entities</em>. Instead, they have their own structure, which is basically simplified <a href="#tr4_entity">[tr4_entity]</a> structure, and moved to separate data block. This seems reasonable, as the only purpose of AI objects is to serve as &#8220;waypoints&#8221;, and they have neither <em>collisional</em> nor <em>control</em> code attached to them.</p></div>
<div class="paragraph"><p>The format of AI object structure as follows:</p></div>
<div class="listingblock">
<a id="tr_ai_object"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr4_ai_object</span>   <span class="c1">// 24 bytes</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">TypeID</span>     <span class="c1">// Object type ID (same meaning as with tr4_entity)</span>
    <span class="kt">uint16_t</span> <span class="n">Room</span><span class="p">;</span>      <span class="c1">// Room where AI object is placed</span>
     <span class="kt">int32_t</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>   <span class="c1">// Coordinates</span>
     <span class="kt">int16_t</span> <span class="n">OCB</span><span class="p">;</span>       <span class="c1">// Same meaning as with tr4_entity</span>
    <span class="kt">uint16_t</span> <span class="n">Flags</span><span class="p">;</span>     <span class="c1">// Activation mask, bitwise-shifted left by 1</span>
     <span class="kt">int32_t</span> <span class="n">Angle</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_music_and_sound">8. Music and Sound</h2>
<div class="sectionbody">
<div class="paragraph"><p>As it was described in the beginning, all sound in TR engines can be separated into two distinctive sections&#8201;&#8212;&#8201;<em>audio tracks</em> and <em>sounds</em>.</p></div>
<div class="paragraph"><p>Audio tracks are long separate files which are loaded by streaming, and usually they contain background ambience, music or voiceovers for cutscenes.</p></div>
<div class="paragraph"><p>Sounds are short audio samples, which are frequently played on eventual basis. While engine can usually play one audio track at a time, it can play lots of
sounds in the same time, and also play numerous copies of the same sound (for example, when two similar enemies are roaming around).</p></div>
<div class="sect2">
<h3 id="_audio_tracks">8.1. Audio Tracks</h3>
<div class="paragraph"><p>Audio tracks can be <em>looped</em> or <em>one-shot</em>. Looped tracks are usually contain background ambience (these creepy sounds heard in the beginning of &#8220;Caves&#8221; and so
on), but occasionally they can use music (e. g., &#8220;Jeep theme&#8221; from TR4). One-shot tracks are used for musical pieces which are usually triggered on certain
event, and also for &#8220;voice chatting&#8221; (e. g. approaching the monk from &#8220;Diving Area&#8221; in TR2).</p></div>
<div class="paragraph"><p>As both looped and one-shot tracks use the same audio playing routine, <em>there&#8217;s no chance both looped and one-shot tracks could be played simultaneously.</em>
This is the reason why background ambience stops and restarts every time another (one-shot) track is triggered. However, this limitation was lifted in <em>TREP</em>
and <em>TRNG</em>.</p></div>
<div class="paragraph"><p>The audio tracks are stored in different fashions in the various versions of the TR series:</p></div>
<div class="sect3">
<h4 id="_tr_1_and_tr2">8.1.1. TR 1 and TR2</h4>
<div class="paragraph"><p>TR1 and TR2 used <em>CD-Audio</em> tracks for in-game music, and therefore, they needed auxilary CD-audio fed into the soundcard. That&#8217;s the reason why most
contemporary PCs have issues with audiotrack playback in these games&#8201;&#8212;&#8201;such setup is no longer supported in modern CD/DVD/BD drives, and digital pipeline is not
always giving the same result. Currently, various modernized game repacks (such as <em>Steam</em> or <em>GOG</em> releases) officially features no-CD cracks with embedded
MP3 player, which takes place of deprecated CD-Audio player.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">In the Macintosh versions, the CD audio tracks are separate files in AIFF format.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_tr3">8.1.2. TR3</h4>
<div class="paragraph"><p>In TR3, we have somewhat special audiotrack setup. Audio format was changed to simple <em>WAV (MS-ADPCM codec)</em>, but all tracks were embedded into
<code>CDAUDIO.WAD</code> file, which also contained a header with a list of all tracks and their durations. So, when game requests an audiotrack to play, it takes info on
needed track from <code>CDAUDIO.WAD</code> header, and then goes straight to an offset for this track into it. The format of <code>CDAUDIO.WAD</code> header entry is:</p></div>
<div class="listingblock">
<a id="tr3_cdaudio_entry"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr3_cdaudio_entry</span>    <span class="c1">// 0x10C bytes</span>
<span class="p">{</span>
        <span class="kt">char</span> <span class="n">Name</span><span class="p">[</span><span class="mi">260</span><span class="p">];</span>     <span class="c1">// C string with track name</span>
    <span class="kt">uint32_t</span> <span class="n">WavLength</span><span class="p">;</span>     <span class="c1">// Wave file size</span>
    <span class="kt">uint32_t</span> <span class="n">WavOffset</span><span class="p">;</span>     <span class="c1">// Absolute offset in CDAUDIO.WAD</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>The number of header entries is always 130 (meaning the whole size of header should be <code>0x10C * 130</code>). Header is immediately followed by embedded audio files in <em>WAV</em> format.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">In the Macintosh version of TR3, these tracks are separate files in <em>WAV</em> format. The Macintosh version of TR3 contains an additional file, <code>CDAudio.db</code>, which
contains the names of all the track files as 32-byte zero-padded C strings with no extra contents.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_tr4_and_tr5">8.1.3. TR4 and TR5</h4>
<div class="paragraph"><p>In TR4-5, track format remained the same (MS-ADPCM), but tracks were no longer embedded into <code>CDAUDIO.WAD</code>. Instead, each track was saved as simple <code>.WAV</code> file,
and file names themselves were embedded into executable. Hence, when TR4-5 plays an audiotracks, it refers to internal filename table, and then loads an
audiotrack with corresponding name.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_sounds">8.2. Sounds</h3>
<div class="paragraph"><p>In TR engines, sounds appear in a variety of contexts.</p></div>
<div class="paragraph"><p>They can be either <em>continuous</em> or <em>triggered</em>. Continuous ones are usually produced by <em>sound source</em> object, which make sound in a range around some specific
point (range appears to be hardcoded, and is equal to around 8 sectors). Likewise, triggered ones can be triggered by a variety of events. The triggering can be
hardcoded in the engine (for example, gunshots) or by reaching some animation frame (footsteps, Lara&#8217;s somewhat unladylike sounds). <em>Flipeffects</em> can also be
used to play certain sound sample in specific circumstances, and either called by triggers or from animations.</p></div>
<div class="paragraph"><p>Sounds may be <em>looped</em> or <em>one shot</em>, with looped ones playing until specifically untriggered by some in-game event. For example, Uzi and M16 sounds are looped
and will be played until Lara stops firing these weapons&#8201;&#8212;&#8201;in such case, engine sends a command to stop this particular sound.</p></div>
<div class="paragraph"><p>Sounds are referred to by an <em>internal sound index</em>; this is translated into which sound sample with the help of three layers of indexing, to allow for a
suitable degree of abstraction. Internal sound indices for various sounds are consistent across all the level files in a game; a gunshot or a passport opening
in one level file will have the same internal sound index as in all the others. The highest level of these is the <code>SoundMap[]</code> array, which translates the
internal sound index into an index into <code>SoundDetails[]</code>. Each <code>SoundDetails</code> record contains such details as the sound volume, pitch and volume randomization,
looping configuration, how many samples to select from, and an index into <code>SampleIndices[]</code>. This allows for selecting among multiple samples to produce
variety; that index is the index to the <code>SampleIndices[]</code> value of first of these, with the rest of them being having the next indices in series of that array.
Thus, if the number of samples is 4, then the TR engine looks in <code>SampleIndices[]</code> locations <em>Index</em>, <em>Index+1</em>, <em>Index+2</em>, and <em>Index+3</em>. Finally, the
<code>SampleIndices[]</code> array references some arrays of sound samples.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>Wave format used in TR1/TR2 and TR3/TR4/TR5 is different. While TR1 and TR2 used 8-bit 11 kHz data, TR3 onwards switched to 16-bit 22 kHz data. However,
PlayStation versions of TR1 and TR2 used 16-bit samples as well, which generally made PlayStation version sound quality better, without dithering artifacts.</p></div>
<div class="paragraph"><p>Additionally, TR4 and TR5 introduced usage of <em>MS-ADPCM</em> codec to store sample data, which was compressed and loaded into buffers on level loading. However,
<em>TR4 engine version bundled with TRLE</em> used uncompressed wave data, as in TR1-TR3.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>In TR1, TR4 and TR5 samples themselves are embedded in the level files. In TR1, <code>SampleIndices[]</code> array contains the displacements of each sample in bytes from
the beginning of that embedded block. In TR4 and TR5, way to access sample data was changed&#8201;&#8212;&#8201;each sample data is preceded by <em>uncompressed size</em> and
<em>compressed size</em> <code>uint32_t</code> values, which are used to extract given sample and load it into DirectSound buffer.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>While <em>compressed size</em> defines the whole size of embedded <code>.WAV</code> file, <em>uncompressed size</em> defines the size of raw PCM data size in <em>16-bit, 22050 kHz, mono</em>
format. However, <em>uncompressed size</em> does not necessarily equal to a value derived from <em>compressed size</em> by wave type conversion, because MS-ADPCM codec tends
to leave a bit of silence in the end of the file (which produces audible interruption in looped samples).</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>In TR2 and TR3, these samples are concatenated in the file <code>MAIN.SFX</code> with no additional information; <code>SampleIndices[]</code> contains sequence numbers (0, 1, 2, 3, &#8230;)
in <code>MAIN.SFX</code>. Finally, the samples themselves are all in Microsoft WAVE format.</p></div>
</div>
<div class="sect2">
<h3 id="_sound_data_structures">8.3. Sound Data Structures</h3>
<div class="sect3">
<h4 id="_sound_sources">8.3.1. Sound Sources</h4>
<div class="paragraph"><p>This structure contains the details of continuous-sound sources. Although a SoundSource object has a position, it has no room membership; the sound seems to
propagate omnidirectionally for about 8 horizontal-grid sizes without regard for the presence of walls.</p></div>
<div class="listingblock">
<a id="tr_sound_source"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_sound_source</span>
<span class="p">{</span>
     <span class="kt">int32_t</span> <span class="n">x</span><span class="p">;</span>         <span class="c1">// absolute X position of sound source (world coordinates)</span>
     <span class="kt">int32_t</span> <span class="n">y</span><span class="p">;</span>         <span class="c1">// absolute Y position of sound source (world coordinates)</span>
     <span class="kt">int32_t</span> <span class="n">z</span><span class="p">;</span>         <span class="c1">// absolute Z position of sound source (world coordinates)</span>
    <span class="kt">uint16_t</span> <span class="n">SoundID</span><span class="p">;</span>   <span class="c1">// internal sound index</span>
    <span class="kt">uint16_t</span> <span class="n">Flags</span><span class="p">;</span>     <span class="c1">// 0x40, 0x80, or 0xC0</span>
<span class="p">};</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_sound_map">8.3.2. Sound Map</h4>
<div class="paragraph"><p><code>SoundMap</code> is used for mapping from internal-sound index to <code>SoundDetails</code> index; it is 370 <code>int16_t</code> in TR2 and TR3 and 256 <code>int16_t</code> in TR1. A value of <code>-1
(0xFFFF)</code> indicates &#8220;none&#8221;, meaning the sample is not used in current level.</p></div>
<div class="paragraph"><p>Each <code>SoundDetails</code> entry can be described as such:</p></div>
<div class="listingblock">
<a id="tr_sound_details"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_sound_details</span> <span class="c1">// 8 bytes</span>
<span class="p">{</span>
   <span class="kt">uint16_t</span> <span class="n">Sample</span><span class="p">;</span> <span class="c1">// (index into SampleIndices)</span>
   <span class="kt">uint16_t</span> <span class="n">Volume</span><span class="p">;</span>
   <span class="kt">uint16_t</span> <span class="n">Chance</span><span class="p">;</span> <span class="c1">// If !=0 and ((rand()&amp;0x7fff) &gt; Chance), this sound is not played</span>
   <span class="kt">uint16_t</span> <span class="n">Characteristics</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>Characteristics</code> is a packed field containing various options for this particular sound detail:</p></div>
<div class="ulist"><ul>
<li>
<p>
Bits 0-1: Looping behaviour: either normal playback (value <code>00</code>), <em>one-shot rewound</em> (<code>01</code> in TR1/TR2, <code>10</code> in other games), meaning the sound will be rewound
  if triggered again, or <em>looped</em> (value <code>10</code> in TR1, <code>11</code> in other games), meaning the sound will be looped until strictly stopped by an engine event. Since
  TR3, <em>one-shot wait</em> mode is introduced (value <code>10</code>), meaning the same sound will be ignored until current one stops.
</p>
</li>
<li>
<p>
Bits 2-7: Number of sound samples in this group. If there are more than one samples, then engine will select one to play based on randomizer (for example,
  listen to Lara footstep sounds).
</p>
</li>
<li>
<p>
Bit 12: Meaning unknown. Set when <em>N</em> value is defined in sound script used with TRLE.
</p>
</li>
<li>
<p>
Bit 13: Randomize pitch. When this flag is set, sound pitch will be slightly varied with each playback event.
</p>
</li>
<li>
<p>
Bit 14: Randomize gain. When this flag is set, sound volume (gain) will be slightly varied with each playback event.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In TR3 onwards, <code>tr_sound_details</code> structure was rearranged:</p></div>
<div class="listingblock">
<a id="tr3_sound_details"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr3_sound_details</span>  <span class="c1">// 8 bytes</span>
<span class="p">{</span>
   <span class="kt">uint16_t</span> <span class="n">Sample</span><span class="p">;</span> <span class="c1">// (index into SampleIndices)</span>
    <span class="kt">uint8_t</span> <span class="n">Volume</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">Range</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">Chance</span><span class="p">;</span>
  <span class="kt">uint8_t</span> <span class="n">Pitch</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">Characteristics</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>Range</code> now defines radius (in sectors), on which this sound can be heard. Previously (in TR1 and TR2), each sound had a predefined range about 8 sectors.</p></div>
<div class="paragraph"><p><code>Pitch</code> specifies <em>absolute</em> pitch volume for this sound (may be also varied by bit 13 of <em>Characteristics</em>). Mainly, this value was used to &#8220;speed-up&#8221;
certain samples, thus allowing to keep high-quality samples with lower sample rate, or on contrary, &#8220;slow down&#8221; sample, making it sound longer than its native
sample rate, thus conserving some memory.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_sample_indices">8.4. Sample Indices</h3>
<div class="paragraph"><p>In TR1, this is an offset value array, each offset of which points into the embedded sound-samples block, which follows this array in the level file. In TR2 and TR3, this is a list of
indices into the file &#8216;MAIN.SFX` file; the indices are the index numbers of that file&#8217;s embedded sound samples, rather than the samples&#8217; starting locations. That
file itself is a set of concatenated sound files with no catalogue info present.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>Sample indices are not used in TR4 and TR5, and this data block is missing from level file, replaced by six zero bytes, which finalize <em>zlib compressed level
block</em> followed by embedded sound sample data.</p></div>
</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_miscellany">9. Miscellany</h2>
<div class="sectionbody">
<div class="paragraph"><p>These are various odds and ends that do not fit into the earlier categories.</p></div>
<div class="sect2">
<h3 id="_version">9.1. Version</h3>
<div class="paragraph"><p>Every level file begins with a <code>uint32_t</code> version number.  This seems to be used by the engine to guarantee compatibility between various level editor versions
and the game engine version.  More generally, it can be used to determine what sort of level is being read.</p></div>
<div class="paragraph"><p>Here are the known (observed) values for the version header:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>0x00000020</code>&#8201;&#8212;&#8201;Tomb Raider 1, Gold, Unfinished Business
</p>
</li>
<li>
<p>
<code>0x0000002D</code>&#8201;&#8212;&#8201;Tomb Raider 2
</p>
</li>
<li>
<p>
<code>0xFF080038</code>&#8201;&#8212;&#8201;Tomb Raider 3
</p>
</li>
<li>
<p>
<code>0xFF180038</code>&#8201;&#8212;&#8201;Tomb Raider 3
</p>
</li>
<li>
<p>
<code>0x00345254</code>&#8201;&#8212;&#8201;Tomb Raider 4 and Tomb Raider 5
</p>
</li>
<li>
<p>
<code>0x63345254</code>&#8201;&#8212;&#8201;Tomb Raider 4 (demo versions)
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">Early TR4 demos (e.g. <em>September 15 demo</em>) have whole level file packed into a single zlib chunk. Therefore, there is no header.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">TR5 version header is equal to TR4 version header.  So there is no way to tell TR4 level from TR5 level judging only by this header&#8201;&#8212;&#8201;you need to check
filename extension as well.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">As it was noted, <em>retail</em> version of TR4 expects to load sound samples compressed in MS-ADPCM format, while <em>TRLE</em> version of TR4 loads uncompressed
samples only. There is no way to tell <em>retail</em> version from <em>TRLE</em> version, as their version numbers are equal.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_palette">9.2. Palette</h3>
<div class="paragraph"><p>This consists of 256 <a href="#tr_colour">[tr_colour]</a> structs, one for each palette entry. However, the individual colour values range from 0 to 63; they must be multiplied by 4
to get the correct values.</p></div>
<div class="paragraph"><p>This used for all 8-bit colour, such as 8-bit textures.</p></div>
</div>
<div class="sect2">
<h3 id="_object_textures">9.3. Object Textures</h3>
<div class="paragraph"><p>Object texture (or <em>texture details</em> in TRLE terms) keeps detailed information about each texture independently used in game. While it&#8217;s not texture image
itself (these are kept inside <em>texture tiles</em>), it&#8217;s rather a reference to particular texture tile zone kept with all other necessary information to display
this texture.</p></div>
<div class="sect3">
<h4 id="_object_texture_vertex_structure">9.3.1. Object Texture Vertex Structure</h4>
<div class="paragraph"><p>This sub-structure used by object textures specifies a vertex location in textile coordinates. The Xpixel and Ypixel are the actual coordinates of the vertex&#8217;s pixel.
The Xcoordinate and Ycoordinate values depend on where the other vertices are in the object texture. And if the object texture is used to specify a triangle,
then the fourth vertex&#8217;s values will all be zero.</p></div>
<div class="listingblock">
<a id="tr_object_texture_vert"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_object_texture_vert</span> <span class="c1">// 4 bytes</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">Xcoordinate</span><span class="p">;</span> <span class="c1">// 1 if Xpixel is the low value, 255 if Xpixel is the high value in the object texture</span>
    <span class="kt">uint8_t</span> <span class="n">Xpixel</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">Ycoordinate</span><span class="p">;</span> <span class="c1">// 1 if Ypixel is the low value, 255 if Ypixel is the high value in the object texture</span>
    <span class="kt">uint8_t</span> <span class="n">Ypixel</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_object_texture_structure_tr1_3">9.3.2. Object Texture Structure (TR1-3)</h4>
<div class="paragraph"><p>It&#8217;s object texture structure itself. These, thee contents of <code>ObjectTextures[]</code>, are used for specifying texture mapping for the world geometry and for mesh objects.</p></div>
<div class="listingblock">
<a id="tr_object_texture"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_object_texture</span>  <span class="c1">// 20 bytes</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">Attribute</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">TileAndFlag</span><span class="p">;</span>
    <span class="n">tr_object_texture_vert</span> <span class="n">Vertices</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// The four corners of the texture</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>TileAndFlag</code> is a combined field:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Bits 0..14</em> specify <em>texture tile</em> to use.
</p>
</li>
<li>
<p>
<em>Bit 15</em>: if set, it indicates that texture is used on a triangle face.
</p>
</li>
</ul></div>
<div class="paragraph"><p><code>Attribute</code> specifies transparency mode (i.e. <em>blending mode</em>) used for face with this texture applied. There are several ones available:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>0</strong>&#8201;&#8212;&#8201;Texture is <em>all-opaque</em>, and that transparency information is ignored.
</p>
</li>
<li>
<p>
<strong>1</strong>&#8201;&#8212;&#8201;Texture uses <em>alpha testing</em>, i.e. it may contain opaque and completely transparent regions. In 8-bit colour, index 0 is the transparent colour, while
  in 16-bit colour, the top bit (0x8000) is the alpha channel (1 = opaque, 0 = transparent). In 32-bit textures, transparency is specified by <em>full magenta
  colour value</em> (RGB = 255,0,255)&#8201;&#8212;&#8201;i.e. pixel has to be magenta to be transparent.
</p>
</li>
<li>
<p>
<strong>2</strong>&#8201;&#8212;&#8201;<span class="image">
<img src="images/icons/tr3.png" alt="TR3 only" width="16" height="17" title="TR3 only" />
</span><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Texture uses <em>alpha blending</em> with <em>additive operation</em>. No depth sorting is done on alpha-blended textures.
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>While blending modes 0, 1 and 2 were the only ones directly available for implementation in original level and animation editors, and therefore, only ones which
can be encountered in object textures, there are actually several <em>internal blending modes</em>, which were primarily used for different sprite and particle types.
These will be listed below:</p></div>
</td>
</tr></table>
</div>
<div class="ulist"><ul>
<li>
<p>
<strong>3</strong>&#8201;&#8212;&#8201;Not implemented properly in PC version, but on PlayStation this type produces alpha blending with <em>inversion operation</em>, thus converting all the bright
  zones to dark, and dark zones to bright. This blending mode was used for smooth textured shadows, footprints and black smoke sprites. There is a remnant of
  this blending mode in the form of entity type named <em>smoke emitter black</em>.
</p>
</li>
<li>
<p>
<strong>4</strong>&#8201;&#8212;&#8201;Alpha-tested face <em>without Z testing</em>, i.e. depth information is ignored. Used for GUI elements (such as fonts) and skyboxes.
</p>
</li>
<li>
<p>
<strong>5</strong>&#8201;&#8212;&#8201;Unused. Possibly was used in PlayStation versions.
</p>
</li>
<li>
<p>
<strong>6</strong>&#8201;&#8212;&#8201;Wireframe mode. Used for &#8220;line particles&#8221;, such as gun sparks, water drops and laser beams. Possibly was also used for debug purposes.
</p>
</li>
<li>
<p>
<strong>7</strong>&#8201;&#8212;&#8201;<span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Forced alpha value. It&#8217;s ordinary alpha-tested face, but alpha value for this face is overridden with global variable. Used to &#8220;fade out&#8221;
  specific meshes, like vanishing enemy bodies or Semerkhet ghost in &#8220;Tomb of Semerkhet&#8221; level.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_object_texture_structure_tr4_5">9.3.3. Object Texture Structure (TR4-5)</h4>
<div class="paragraph"><p>The structure introduced many new fields in TR4, partly related to new <em>bump mapping feature</em>.</p></div>
<div class="paragraph"><p>For <em>bump mapping</em>, TR4 used fairly simple approach, which was actually not a true bump mapping, but multitexturing with additive operation. Therefore, bump
maps were not <em>normal maps</em> mainly used for bump-mapping nowadays, but simple monochrome <em>heightmaps</em> automatically generated by level editor. This is a test
screenshot comparison demonstrating same scene with and without bump mapping:</p></div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="70%"
frame="void"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/illustrations/bump-no.jpg" alt="illustrations/bump-no.jpg" title="Without bump mapping" />
</span></p></td>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/illustrations/bump-yes.jpg" alt="illustrations/bump-yes.jpg" title="With bump mapping" />
</span></p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table"><em>Bump mapping turned off</em></p></td>
<td align="center" valign="top"><p class="table"><em>Bump mapping turned on</em></p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>Assignation of bump maps happened inside level editor, where each texture piece could be marked as either <em>level 1</em> or <em>level 2</em> degree of bump map effect. When
level was converted, all texture pieces with bumpmaps were placed into separate texture tiles after all other texture tiles, following by the same amount of
texture tiles with auto-generated bump maps arranged in the same manner as original texture tiles. Number of bumped texture tiles was kept in separate variable
as well (see <a href="#TR4 Level Format">[TR4 Level Format]</a> section).</p></div>
<div class="paragraph"><p>So, when engine rendered a face with texture marked as <em>bumped</em>, it rendered original texture at first, then it jumped to the texture tile <em>plus number of
bumped texture tiles</em>, and rendered one more texture pass on this face using texture from resulting texture tile and the same UV coordinates.</p></div>
<div class="listingblock">
<a id="tr4_object_texture"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr4_object_texture</span> <span class="c1">// 38 bytes</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">Attribute</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">TileAndFlag</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">NewFlags</span><span class="p">;</span>

    <span class="n">tr_object_texture_vert</span> <span class="n">Vertices</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// The four corners of the texture</span>

    <span class="kt">uint32_t</span> <span class="n">OriginalU</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">OriginalV</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">Width</span><span class="p">;</span>     <span class="c1">// Actually width-1</span>
    <span class="kt">uint32_t</span> <span class="n">Height</span><span class="p">;</span>    <span class="c1">// Actually height-1</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>NewFlags</code> is a bit field with flags:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>Bits 0..2</strong>&#8201;&#8212;&#8201;Mapping correction. It seems that these bits change the way the texture is applied.
</p>
</li>
<li>
<p>
<strong>Bits 11..12</strong>&#8201;&#8212;&#8201;Specifies bump mapping level (see above), so can be either <code>00 = 0</code> (no bump mapping), <code>01 = 1</code> (level 1) or <code>10 = 2</code> (level 2).
</p>
</li>
<li>
<p>
<strong>Bit 15</strong>&#8201;&#8212;&#8201;If set, the texture is for a triangle/quad from a room geometry. If not set, the texture is for a static mesh or model.
</p>
</li>
</ul></div>
<div class="paragraph"><p><code>Width</code> and <code>Height</code> are helper values which specify width and height for a given object texture.</p></div>
<div class="paragraph"><p><code>OriginalU</code> and <code>OriginalV</code> are unused values, which seem to identify <em>original UV coordinates</em> of object texture in TRLE texture page listings. These
coordinates are getting messed up when level is compiled, so one shouldn&#8217;t bother about parsing them correctly.</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> There is also null <code>uint16_t</code> filler in the end of each <code>tr4_object_texture</code>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_animated_textures_2">9.4. Animated Textures</h3>
<div class="paragraph"><p>Animated textures describe sets of object textures that are cycled through to produce texture animations; they are a set of int16_t&#8217;s with the following format
(not a &#8220;real&#8221; C/C++ structure):</p></div>
<div class="listingblock">
<a id="animated_textures"></a>
<div class="content"><div class="highlight"><pre><span class="kt">int16_t</span> <span class="n">NumAnimatedTextures</span>

<span class="k">virtual</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="kt">int16_t</span> <span class="n">NumTextureIDs</span><span class="p">;</span> <span class="c1">// Actually, this is the number of texture ID&#39;s - 1.</span>
    <span class="kt">int16_t</span> <span class="n">TextureIDs</span><span class="p">[</span><span class="n">NumTextureIDs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span> <span class="c1">// offsets into ObjectTextures[], in animation order.</span>
<span class="p">}</span> <span class="n">AnimatedTextures</span><span class="p">[</span><span class="n">NumAnimatedTextures</span><span class="p">];</span>
</pre></div></div></div>
<div class="paragraph"><p>If a texture belongs to an animated-texture group, it will automatically be animated by the engine.</p></div>
<div class="paragraph"><p>There are two types of animated textures&#8201;&#8212;&#8201;<em>classic frames</em> and <em>UVRotate</em>:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>Classic frames:</strong> These are ordinary animated textures, and the only type displayed prior to TR4. It is simply a list of textures that are cycled through in
  an endless loop; they are normally used as geographic elements of the levels (e.g. water surface, bubbling lava, Atlantean flesh walls), but practically, Tomb
  Raider engines are capable of applying animated textures to mesh geometry (this feature is primarily used in custom levels). The speed (interval) of animation
  is hardcoded, and varies from version to version. While in TR1-2 textures were animated relatively slowly, in TR3 onwards they were sped up.
</p>
</li>
<li>
<p>
<strong>UV Rotate:</strong> Beginning from TR4, there is a new scheme for animated textures, called <em>UVRotate</em>. According to its name, it continuously shifts vertical
  texture coordinate while preserving texture size, which creates an effect of moving texture. For example, you can see it in action in TR4&#8217;s <code>angkor1.tr4</code>,
  room #76:
</p>
</li>
</ul></div>
<div class="tableblock">
<table rules="all"
style="margin-left:auto; margin-right:auto;"
width="70%"
frame="void"
cellspacing="0" cellpadding="4">
<col width="100%" />
<tbody>
<tr>
<td align="center" valign="top"><p class="table"><span class="image">
<img src="images/illustrations/uvrotate.jpg" alt="illustrations/uvrotate.jpg" title="UVRotate texture animation in action" />
</span></p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table">In foreground, you can see alpha-blended waterfall object animated with UVRotate.
  In background, UVRotate animation is also applied to room mesh.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>UVRotate mode is engaged by specifying <code>UVRotate</code> command in level script entry, which takes rotation speed as an argument. If such command is found (and
argument is not zero&#8201;&#8212;&#8201;for example, <code>UVRotate = 4</code>), engine uses special variable value kept in level file, <code>NumUVRotates</code>, to determine if
animation range belongs to UVRotate mode or classic frames mode. Then, if it belongs to UVRotate mode, each frame of this range is treated as individual
rotating texture.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>There is also special case when UVRotate texture mode is engaged. When a texture is applied to a model with specific ID (so-called <em>waterfall objects</em>), then it
is also considered UVRotate animated texture, even if it doesn&#8217;t belong to animated texture range, <em>but only if it is a texture applied to a first face in the
first mesh of the model</em>. If there are other textures applied to other faces of a waterfall object, they won&#8217;t be considered as UVRotate.</p></div>
<div class="paragraph"><p>The speed of animation for waterfall objects is not affected by <code>UVRotate</code> script command. Instead, it is hardcoded value of 7.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_cameras_and_sinks">9.5. Cameras and Sinks</h3>
<div class="paragraph"><p>This data block serves for two different purposes, albeit keeping the same structure for both. First purpose is to provide positions to switch the camera to
using <em>Camera</em> trigger action, and the second purpose is to <em>move Lara to specified position</em> when she is underwater, and <em>Underwater Current</em> trigger action
was used.</p></div>
<div class="listingblock">
<a id="tr_camera"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_camera</span>
<span class="p">{</span>
    <span class="kt">int32_t</span> <span class="n">x</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">y</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">z</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">Room</span><span class="p">;</span>
   <span class="kt">uint16_t</span> <span class="n">Flag</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>X</code>, <code>Y</code> and <code>Z</code> values are coordinates of a given camera or sink. When used with camera, it is an origin point of a camera. When used with sink, it is a point,
towards which Lara is pushed.</p></div>
<div class="paragraph"><p><code>Room</code> value specifies the room where camera is placed. For <em>sink</em> cases, this value is used to define <em>strength of the current</em> which moves Lara underwater.</p></div>
<div class="paragraph"><p><code>Flag</code> value is unknown for both cameras and sinks. However, there is some info that <code>Flag</code> is re-used for sinks as a <code>Zone[]</code> reference.</p></div>
</div>
<div class="sect2">
<h3 id="_flyby_cameras">9.6. Flyby Cameras</h3>
<div class="paragraph"><p><span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span><span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Flyby cameras are cinematic interludes, in which camera flies from one point to another using spline trajectory. Each point in such sequence is a
<em>single flyby camera</em>, and current camera properties (position, direction, roll, FOV, speed, and some more) are calculated by interpolating corresponding values
from such flyby camera points&#8201;&#8212;&#8201;for example, if <em>camera 0</em> has speed value of 10, and <em>camera 1</em> has speed value of 5, then speed will gradually change from 10
to 5 when moving from one to another.</p></div>
<div class="listingblock">
<a id="tr4_flyby_camera"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr4_flyby_camera</span>  <span class="c1">// 40 bytes</span>
<span class="p">{</span>
    <span class="kt">int32_t</span> <span class="n">x</span><span class="p">;</span>    <span class="c1">// Camera position</span>
    <span class="kt">int32_t</span> <span class="n">y</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">z</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">dx</span><span class="p">;</span>   <span class="c1">// Camera angles</span>
    <span class="kt">int32_t</span> <span class="n">dy</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">dz</span><span class="p">;</span>

    <span class="kt">uint8_t</span> <span class="n">Sequence</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">Index</span><span class="p">;</span>

   <span class="kt">uint16_t</span> <span class="n">FOV</span><span class="p">;</span>
    <span class="kt">int16_t</span> <span class="n">Roll</span><span class="p">;</span>
   <span class="kt">uint16_t</span> <span class="n">Timer</span><span class="p">;</span>
   <span class="kt">uint16_t</span> <span class="n">Speed</span><span class="p">;</span>
   <span class="kt">uint16_t</span> <span class="n">Flags</span><span class="p">;</span>

   <span class="kt">uint32_t</span> <span class="n">Room_ID</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p><code>Sequence</code> is a number of flyby camera &#8220;chain&#8221; this particular camera belongs to. Maximum amount of flyby sequences in single level is 8 (however, this limit
was raised to 64 in <em>TREP</em>).</p></div>
<div class="paragraph"><p><code>Index</code> specifies order of the cameras in this particular sequence. Camera with <code>index</code> 0 will be first one in sequence, <code>index</code> 1 means camera will be second
in sequence, and so on.</p></div>
<div class="paragraph"><p><code>Room_ID</code> should be valid for a given flyby camera, so it will display properly, as well as have the ability to activate <em>heavy triggers</em>.</p></div>
<div class="paragraph"><p><code>FOV</code> changes this particular camera&#8217;s field of view.</p></div>
<div class="paragraph"><p><code>Roll</code> changes roll factor of a particular camera. When this parameter is not zero, camera will rotate either left or right along roll axis, creating so-called
&#8220;dutch angle&#8221;.</p></div>
<div class="paragraph"><p><code>Timer</code> field mainly used to stop camera movement for a given time (in game frames). As this parameter is temporal, it won&#8217;t be interpolated between two cameras.</p></div>
<div class="paragraph"><p><code>Speed</code> specifies movement speed for this particular camera.</p></div>
<div class="paragraph"><p><code>Flags</code> is an array of bit flags specifying different camera options:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>Bit 0</strong>&#8201;&#8212;&#8201;Make a cut to flyby from Lara camera position. Without it, it&#8217;ll pan smoothly.
</p>
</li>
<li>
<p>
<strong>Bit 1</strong>&#8201;&#8212;&#8201;<span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span> Tracks specified entity position (from <code>Entities[]</code> array). <span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Creates a vignette around the picture, giving impression of "subjective" camera.
</p>
</li>
<li>
<p>
<strong>Bit 2</strong>&#8201;&#8212;&#8201;Infinitely loop sequence.
</p>
</li>
<li>
<p>
<strong>Bit 3</strong>&#8201;&#8212;&#8201;<em>Used only with first camera in a sequence:</em> whole sequence is treated merely as a camera &#8220;rails&#8221;, and camera itself focuses on Lara, thus
  creating &#8220;tracking&#8221; camera. Best example is &#8220;tracking&#8221; view in <code>ALEXHUB2.TR4</code>, rooms #23 and #31.
</p>
</li>
<li>
<p>
<strong>Bit 4</strong>&#8201;&#8212;&#8201;<span class="image">
<img src="images/icons/tr4.png" alt="TR4 only" width="16" height="17" title="TR4 only" />
</span> Camera focuses on Lara&#8217;s last head position. <span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> For TR5, this flag is now used to hide Lara for this camera.
</p>
</li>
<li>
<p>
<strong>Bit 5</strong>&#8201;&#8212;&#8201;Camera continuously focuses on Lara&#8217;s head, overriding own angle.
</p>
</li>
<li>
<p>
<strong>Bit 6</strong>&#8201;&#8212;&#8201;<em>Used only with last camera in a sequence:</em> camera smoothly pans back to Lara camera position.
</p>
</li>
<li>
<p>
<strong>Bit 7</strong>&#8201;&#8212;&#8201;When flyby arrives to this position, cuts to specific camera in same sequence. Next camera number is specified in <em>Timer</em> field of this camera.
</p>
</li>
<li>
<p>
<strong>Bit 8</strong>&#8201;&#8212;&#8201;Stops camera movement for a given time (see <em>Timer</em> field).
</p>
</li>
<li>
<p>
<strong>Bit 9</strong>&#8201;&#8212;&#8201;Disables look keypress breakout.
</p>
</li>
<li>
<p>
<strong>Bit 10</strong>&#8201;&#8212;&#8201;Disables all Lara controls <em>for all next camera points</em>. Also engages <em>widescreen bars</em> to create cinematic feel.
</p>
</li>
<li>
<p>
<strong>Bit 11</strong>&#8201;&#8212;&#8201;Overrides <em>Bit 10</em> controls lock, enabling them back. Widescreen bars remain unaffected.
</p>
</li>
<li>
<p>
<strong>Bit 12</strong>&#8201;&#8212;&#8201;<span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Make screen fade-in.
</p>
</li>
<li>
<p>
<strong>Bit 13</strong>&#8201;&#8212;&#8201;<span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> Make screen fade-out.
</p>
</li>
<li>
<p>
<strong>Bit 14</strong>&#8201;&#8212;&#8201;Camera can activate <em>heavy triggers</em>, just like particular kinds of entities (boulders, pushables, etc.). When camera is moving right above heavy trigger sector, it will be activated.
</p>
</li>
<li>
<p>
<strong>Bit 15</strong>&#8201;&#8212;&#8201;<span class="image">
<img src="images/icons/tr5.png" alt="TR5 only" width="16" height="17" title="TR5 only" />
</span> TRLE for TR5 says this flag is used to make camera one-shot, but it&#8217;s not true. Actual one-shot flag is placed in extra <code>uint16_t</code> field at <code>0x0100</code> for flyby camera <em>TrigAction</em>.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_cinematic_frames">9.7. Cinematic Frames</h3>
<div class="paragraph"><p>These are camera positionings for cutscenes. All the entity animations are specified separately, and they are not synced with actual camera positions.</p></div>
<div class="listingblock">
<a id="tr_cinematic_frame"></a>
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr_cinematic_frame</span>
<span class="p">{</span>
    <span class="kt">int16_t</span> <span class="n">rotY</span><span class="p">;</span>    <span class="c1">// rotation about Y axis, +/- 32767 == +/- 180 degrees</span>
    <span class="kt">int16_t</span> <span class="n">rotZ</span><span class="p">;</span>    <span class="c1">// rotation about Z axis, +/- 32767 == +/- 180 degrees</span>
    <span class="kt">int16_t</span> <span class="n">rotZ2</span><span class="p">;</span>   <span class="c1">// seems to work a lot like rotZ;  I haven&#39;t yet been able to</span>
                     <span class="c1">// differentiate them</span>
    <span class="kt">int16_t</span> <span class="n">posZ</span><span class="p">;</span>    <span class="c1">// camera position relative to something (target? Lara? room</span>
                     <span class="c1">// origin?).  pos* are _not_ in world coordinates.</span>
    <span class="kt">int16_t</span> <span class="n">posY</span><span class="p">;</span>    <span class="c1">// camera position relative to something (see posZ)</span>
    <span class="kt">int16_t</span> <span class="n">posX</span><span class="p">;</span>    <span class="c1">// camera position relative to something (see posZ)</span>
    <span class="kt">int16_t</span> <span class="n">unknown</span><span class="p">;</span> <span class="c1">// changing this can cause a runtime error</span>
    <span class="kt">int16_t</span> <span class="n">rotX</span><span class="p">;</span>    <span class="c1">// rotation about X axis, +/- 32767 == +/- 180 degrees</span>
<span class="p">};</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_lightmap">9.8. LightMap</h3>
<div class="paragraph"><p>A 32*256 array of <code>uint8_t</code> which is apparently for applying light to 8-bit colour, in some documentation called <code>ColourMap</code>. The current palette index and
lighting value are used to calcuate an index to this table, which is a table of palette indices.</p></div>
<div class="paragraph"><p>The Tomb Raider series' software rendering, like that of most real-time-3D games, uses 8-bit colour for speed and low bulk; however, there is the serious
problem of how to do lighting with 8-bit colour, because doing it directly is computationally expensive. The usual solution is to arrange the palettes' colours
in ramps, which the engine then follows in the appropriate directions. However, the TR series' palettes generally lack such neat ramps.</p></div>
<div class="paragraph"><p>But the TR series has a more general solution, one that does not require palettes to have colour ramps. It uses precalculated lighting tables, the <code>ColourMap</code>
objects. These contain translations of a colour value and a lighting value, listed by palette index. The translation goes as follows:</p></div>
<div class="paragraph"><p><code>n = ColourMap[256 * k + i];</code></p></div>
<div class="paragraph"><p>where <code>i</code> is the original palette index, <code>k</code> is determined from the lighting value, and <code>n</code> is the new palette index. The lighting index <code>k</code> varies from 0 to
31, and the corresponding lighting value is, <span class="red">for TR1</span>,</p></div>
<div class="paragraph"><p><code>2 - k / 16</code></p></div>
<div class="paragraph"><p>and for TR2 and TR3,</p></div>
<div class="paragraph"><p><code>2 - (k + 1) / 16</code></p></div>
<div class="paragraph"><p>This may be associated with the curious fact of the lighting values in the data files increasing in the &#8220;wrong&#8221; direction in TR1 and TR2, with 0 being full
brightness and greater values being darker.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_level_file_formats">10. Level File Formats</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_the_entire_tr1_level_format">10.1. The Entire TR1 Level Format</h3>
<div class="paragraph"><p>What follows is the physical <code>.PHD</code> file layout, byte for byte.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/caution.png" alt="Caution" />
</td>
<td class="content">This is not a &#8220;real&#8221; C/C++ structure, in that some arrays are variable-length, with the length being defined by another element of the structure.</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">uint32_t</span> <span class="n">Version</span><span class="p">;</span> <span class="c1">// version (4 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumTextiles</span><span class="p">;</span> <span class="c1">// number of texture tiles (4 bytes)</span>
<span class="n">tr2_textile8</span> <span class="n">Textile8</span><span class="p">[</span><span class="n">NumTextiles</span><span class="p">];</span> <span class="c1">// 8-bit (palettized) textiles (NumTextiles * 65536 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">Unused</span><span class="p">;</span> <span class="c1">// 32-bit unused value (4 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">NumRooms</span><span class="p">;</span> <span class="c1">// number of rooms (2 bytes)</span>
<span class="k">virtual</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="n">tr2_room_info</span> <span class="n">RoomInfo</span><span class="p">;</span> <span class="c1">// room header (16 bytes)</span>
    <span class="kt">uint32_t</span> <span class="n">NumData</span><span class="p">;</span> <span class="c1">// number of data uint16_t&#39;s to follow (=RoomData) (4 bytes)</span>
    <span class="k">virtual</span> <span class="k">struct</span>
    <span class="p">{</span>
        <span class="kt">uint16_t</span> <span class="n">NumVertices</span><span class="p">;</span> <span class="c1">// number of vertices to follow (2 bytes)</span>
        <span class="n">tr2_vertex_room</span> <span class="n">Vertices</span><span class="p">[</span><span class="n">NumVertices</span><span class="p">];</span> <span class="c1">// vertex list (NumVertices * 8 bytes [TR1 version])</span>
        <span class="kt">uint16_t</span> <span class="n">NumRectangles</span><span class="p">;</span> <span class="c1">// number of rectangles to follow (2 bytes)</span>
        <span class="n">tr_face4</span> <span class="n">Rectangles</span><span class="p">[</span><span class="n">NumRectangles</span><span class="p">];</span> <span class="c1">// rectangle list (NumRectangles * 10 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">NumTriangles</span><span class="p">;</span> <span class="c1">// number of triangles to follow (2 bytes)</span>
        <span class="n">tr_face3</span> <span class="n">Triangles</span><span class="p">[</span><span class="n">NumTriangles</span><span class="p">];</span> <span class="c1">// triangle list (NumTriangles * 8 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">NumSprites</span><span class="p">;</span> <span class="c1">// number of sprites to follow (2 bytes)</span>
        <span class="n">tr2_room_sprite</span> <span class="n">Sprites</span><span class="p">[</span><span class="n">NumSprites</span><span class="p">];</span> <span class="c1">// room sprite list (NumSprites * 4 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">NumDoors</span><span class="p">;</span> <span class="c1">// number of doors to follow (2 bytes)</span>
        <span class="n">tr2_room_door</span> <span class="n">Doors</span><span class="p">[</span><span class="n">NumDoors</span><span class="p">];</span> <span class="c1">// door list (NumDoors * 32 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">NumZsector</span><span class="p">;</span> <span class="c1">// sector table width (2 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">NumXsector</span><span class="p">;</span> <span class="c1">// sector table height (2 bytes)</span>
        <span class="n">tr2_room_sector</span> <span class="n">SectorData</span><span class="p">[</span><span class="n">NumZsector</span> <span class="o">*</span> <span class="n">NumXsector</span><span class="p">];</span> <span class="c1">// sector table (NumZsector * NumXsector * 8 bytes)</span>
        <span class="kt">int16_t</span> <span class="n">Intensity1</span><span class="p">;</span>
        <span class="kt">uint16_t</span> <span class="n">NumLights</span><span class="p">;</span> <span class="c1">// number of lights to follow (2 bytes)</span>
        <span class="n">tr2_room_light</span> <span class="n">Lights</span><span class="p">[</span><span class="n">NumLights</span><span class="p">];</span> <span class="c1">// light list (NumLights * 18 bytes [TR1 version])</span>
        <span class="kt">uint16_t</span> <span class="n">NumStaticMeshes</span><span class="p">;</span> <span class="c1">// number of static mesh records to follow (2 bytes)</span>
        <span class="n">tr2_room_staticmesh</span> <span class="n">StaticMeshes</span><span class="p">[</span><span class="n">NumStaticMeshes</span><span class="p">];</span> <span class="c1">// static mesh data (NumStaticMeshes * 18 bytes [TR1 version])</span>
        <span class="kt">int16_t</span> <span class="n">AlternateRoom</span><span class="p">;</span> <span class="c1">// (2 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">Flags</span><span class="p">;</span> <span class="c1">// (2 bytes)</span>
    <span class="p">}</span> <span class="n">RoomData</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Rooms</span><span class="p">[</span><span class="n">NumRooms</span><span class="p">];</span>
<span class="kt">uint32_t</span> <span class="n">NumFloorData</span><span class="p">;</span> <span class="c1">// number of floor data uint16_t&#39;s to follow (4 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">FloorData</span><span class="p">[</span><span class="n">NumFloorData</span><span class="p">];</span> <span class="c1">// floor data (NumFloorData * 2 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumMeshData</span><span class="p">;</span> <span class="c1">// number of uint16_t&#39;s of mesh data to follow (=Meshes[]) (4 bytes)</span>
<span class="k">virtual</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="n">tr2_vertex</span> <span class="n">Centre</span><span class="p">;</span> <span class="c1">// relative coordinates of mesh centre (6 bytes)</span>
    <span class="kt">uint8_t</span> <span class="n">Unknown1</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// unknown (4 bytes)</span>
    <span class="kt">int16_t</span> <span class="n">NumVertices</span><span class="p">;</span> <span class="c1">// number of vertices to follow (2 bytes)</span>
    <span class="n">tr2_vertex</span> <span class="n">Vertices</span><span class="p">[</span><span class="n">NumVertices</span><span class="p">];</span> <span class="c1">// list of vertices (NumVertices * 6 bytes)</span>
    <span class="kt">int16_t</span> <span class="n">NumNormals</span><span class="p">;</span> <span class="c1">// number of normals to follow (2 bytes)</span>
    <span class="n">tr2_vertex</span> <span class="n">Normals</span><span class="p">[</span><span class="n">NumNormals</span><span class="p">];</span> <span class="c1">// list of normals (NumNormals * 6 bytes) (becomes Lights if NumNormals &lt; 0; 2 bytes)</span>
    <span class="kt">int16_t</span> <span class="n">NumTexturedRectangles</span><span class="p">;</span> <span class="c1">// number of textured rectangles to follow (2 bytes)</span>
    <span class="n">tr_face4</span> <span class="n">TexturedRectangles</span><span class="p">[</span><span class="n">NumTexturedRectangles</span><span class="p">];</span> <span class="c1">// list of textured rectangles (NumTexturedRectangles * 10 bytes)</span>
    <span class="kt">int16_t</span> <span class="n">NumTexturedTriangles</span><span class="p">;</span> <span class="c1">// number of textured triangles to follow (2 bytes)</span>
    <span class="n">tr_face3</span> <span class="n">TexturedTriangles</span><span class="p">[</span><span class="n">NumTexturedTriangles</span><span class="p">];</span> <span class="c1">// list of textured triangles (NumTexturedTriangles * 8 bytes)</span>
    <span class="kt">int16_t</span> <span class="n">NumColouredRectangles</span><span class="p">;</span> <span class="c1">// number of coloured rectangles to follow (2 bytes)</span>
    <span class="n">tr_face4</span> <span class="n">ColouredRectangles</span><span class="p">[</span><span class="n">NumColouredRectangles</span><span class="p">];</span> <span class="c1">// list of coloured rectangles (NumColouredRectangles * 10 bytes)</span>
    <span class="kt">int16_t</span> <span class="n">NumColouredTriangles</span><span class="p">;</span> <span class="c1">// number of coloured triangles to follow (2 bytes)</span>
    <span class="n">tr_face3</span> <span class="n">ColouredTriangles</span><span class="p">[</span><span class="n">NumColouredTriangles</span><span class="p">];</span> <span class="c1">// list of coloured triangles (NumColouredTriangles * 8 bytes)</span>
<span class="p">}</span> <span class="n">Meshes</span><span class="p">[</span><span class="n">NumMeshPointers</span><span class="p">];</span> <span class="c1">// note that NumMeshPointers comes AFTER Meshes[]</span>
<span class="kt">uint32_t</span> <span class="n">NumMeshPointers</span><span class="p">;</span> <span class="c1">// number of mesh pointers to follow (4 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">MeshPointers</span><span class="p">[</span><span class="n">NumMeshPointers</span><span class="p">];</span> <span class="c1">// mesh pointer list (NumMeshPointers * 4 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumAnimations</span><span class="p">;</span> <span class="c1">// number of animations to follow (4 bytes)</span>
<span class="n">tr2_animation</span> <span class="n">Animations</span><span class="p">[</span><span class="n">NumAnimations</span><span class="p">];</span> <span class="c1">// animation list (NumAnimations * 32 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumStateChanges</span><span class="p">;</span> <span class="c1">// number of state changes to follow (4 bytes)</span>
<span class="n">tr2_state_change</span> <span class="n">StateChanges</span><span class="p">[</span><span class="n">NumStateChanges</span><span class="p">];</span> <span class="c1">// state-change list (NumStructures * 6 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumAnimDispatches</span><span class="p">;</span> <span class="c1">// number of animation dispatches to follow (4 bytes)</span>
<span class="n">tr2_anim_dispatch</span> <span class="n">AnimDispatches</span><span class="p">[</span><span class="n">NumAnimDispatches</span><span class="p">];</span> <span class="c1">// animation-dispatch list list (NumAnimDispatches * 8 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumAnimCommands</span><span class="p">;</span> <span class="c1">// number of animation commands to follow (4 bytes)</span>
<span class="n">tr2_anim_command</span> <span class="n">AnimCommands</span><span class="p">[</span><span class="n">NumAnimCommands</span><span class="p">];</span> <span class="c1">// animation-command list (NumAnimCommands * 2 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumMeshTrees</span><span class="p">;</span> <span class="c1">// number of MeshTrees to follow (4 bytes)</span>
<span class="n">tr2_meshtree</span> <span class="n">MeshTrees</span><span class="p">[</span><span class="n">NumMeshTrees</span><span class="p">];</span> <span class="c1">// MeshTree list (NumMeshTrees * 4 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumFrames</span><span class="p">;</span> <span class="c1">// number of words of frame data to follow (4 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">Frames</span><span class="p">[</span><span class="n">NumFrames</span><span class="p">];</span> <span class="c1">// frame data (NumFrames * 2 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumMoveables</span><span class="p">;</span> <span class="c1">// number of moveables to follow (4 bytes)</span>
<span class="n">tr2_moveable</span> <span class="n">Moveables</span><span class="p">[</span><span class="n">NumMoveables</span><span class="p">];</span> <span class="c1">// moveable list (NumMoveables * 18 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumStaticMeshes</span><span class="p">;</span> <span class="c1">// number of StaticMesh data records to follow (4 bytes)</span>
<span class="n">tr2_staticmesh</span> <span class="n">StaticMeshes</span><span class="p">[</span><span class="n">NumStaticMeshes</span><span class="p">];</span> <span class="c1">// StaticMesh data (NumStaticMesh * 32 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumObjectTextures</span><span class="p">;</span> <span class="c1">// number of object textures to follow (4 bytes) (after AnimatedTextures in TR3)</span>
<span class="n">tr2_object_texture</span> <span class="n">ObjectTextures</span><span class="p">[</span><span class="n">NumObjectTextures</span><span class="p">];</span> <span class="c1">// object texture list (NumObjectTextures * 20 bytes) (after AnimatedTextures in TR3)</span>
<span class="kt">uint32_t</span> <span class="n">NumSpriteTextures</span><span class="p">;</span> <span class="c1">// number of sprite textures to follow (4 bytes)</span>
<span class="n">tr2_sprite_texture</span> <span class="n">SpriteTextures</span><span class="p">[</span><span class="n">NumSpriteTextures</span><span class="p">];</span> <span class="c1">// sprite texture list (NumSpriteTextures * 16 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumSpriteSequences</span><span class="p">;</span> <span class="c1">// number of sprite sequences records to follow (4 bytes)</span>
<span class="n">tr2_sprite_sequence</span> <span class="n">SpriteSequences</span><span class="p">[</span><span class="n">NumSpriteSequences</span><span class="p">];</span> <span class="c1">// sprite sequence data (NumSpriteSequences * 8 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumCameras</span><span class="p">;</span> <span class="c1">// number of camera data records to follow (4 bytes)</span>
<span class="n">tr2_camera</span> <span class="n">Cameras</span><span class="p">[</span><span class="n">NumCameras</span><span class="p">];</span> <span class="c1">// camera data (NumCameras * 16 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumSoundSources</span><span class="p">;</span> <span class="c1">// number of sound source data records to follow (4 bytes)</span>
<span class="n">tr2_sound_source</span> <span class="n">SoundSources</span><span class="p">[</span><span class="n">NumSoundSources</span><span class="p">];</span> <span class="c1">// sound source data (NumSoundSources * 16 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumBoxes</span><span class="p">;</span> <span class="c1">// number of box data records to follow (4 bytes)</span>
<span class="n">tr2_box</span> <span class="n">Boxes</span><span class="p">[</span><span class="n">NumBoxes</span><span class="p">];</span> <span class="c1">// box data (NumBoxes * 20 bytes [TR1 version])</span>
<span class="kt">uint32_t</span> <span class="n">NumOverlaps</span><span class="p">;</span> <span class="c1">// number of overlap records to follow (4 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">Overlaps</span><span class="p">[</span><span class="n">NumOverlaps</span><span class="p">];</span> <span class="c1">// overlap data (NumOverlaps * 2 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">GroundZone</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">NumBoxes</span><span class="p">];</span> <span class="c1">// ground zone data</span>
<span class="kt">uint16_t</span> <span class="n">GroundZone2</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">NumBoxes</span><span class="p">];</span> <span class="c1">// ground zone 2 data</span>
<span class="kt">uint16_t</span> <span class="n">FlyZone</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">NumBoxes</span><span class="p">];</span> <span class="c1">// fly zone data</span>
<span class="kt">uint16_t</span> <span class="n">GroundZoneAlt</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">NumBoxes</span><span class="p">];</span> <span class="c1">// ground zone data (alternate rooms?)</span>
<span class="kt">uint16_t</span> <span class="n">GroundZoneAlt2</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">NumBoxes</span><span class="p">];</span> <span class="c1">// ground zone 2 data (alternate rooms?)</span>
<span class="kt">uint16_t</span> <span class="n">FlyZoneAlt</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">NumBoxes</span><span class="p">];</span> <span class="c1">// fly zone data (alternate rooms?)</span>
<span class="kt">uint32_t</span> <span class="n">NumAnimatedTextures</span><span class="p">;</span> <span class="c1">// number of animated texture records to follow (4 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">AnimatedTextures</span><span class="p">[</span><span class="n">NumAnimatedTextures</span><span class="p">];</span> <span class="c1">// animated texture data (NumAnimatedTextures * 2 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumItems</span><span class="p">;</span> <span class="c1">// number of items to follow (4 bytes)</span>
<span class="n">tr2_item</span> <span class="n">Items</span><span class="p">[</span><span class="n">NumItems</span><span class="p">];</span> <span class="c1">// item list (NumItems * 22 bytes [TR1 version])</span>
<span class="kt">uint8_t</span> <span class="n">LightMap</span><span class="p">[</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">256</span><span class="p">];</span> <span class="c1">// light map (8192 bytes)</span>
<span class="n">tr_colour</span> <span class="n">Palette</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span> <span class="c1">// 8-bit palette (768 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">NumCinematicFrames</span><span class="p">;</span> <span class="c1">// number of cinematic frame records to follow (2 bytes)</span>
<span class="n">tr2_cinematic_frame</span> <span class="n">CinematicFrames</span><span class="p">[</span><span class="n">NumCinematicFrames</span><span class="p">];</span> <span class="c1">// (NumCinematicFrames * 16 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">NumDemoData</span><span class="p">;</span> <span class="c1">// number of demo data records to follow (2 bytes)</span>
<span class="kt">uint8_t</span> <span class="n">DemoData</span><span class="p">[</span><span class="n">NumDemoData</span><span class="p">];</span> <span class="c1">// demo data (NumDemoData bytes)</span>
<span class="kt">int16_t</span> <span class="n">SoundMap</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span> <span class="c1">// sound map (512 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumSoundDetails</span><span class="p">;</span> <span class="c1">// number of sound-detail records to follow (4 bytes)</span>
<span class="n">tr2_sample_info</span> <span class="n">SoundDetails</span><span class="p">[</span><span class="n">NumSoundDetails</span><span class="p">];</span> <span class="c1">// sound-detail list (NumSoundDetails * 8 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumSamples</span> <span class="p">(</span><span class="n">number</span> <span class="n">of</span> <span class="kt">uint8_t</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">in</span> <span class="n">Samples</span><span class="p">)</span>
<span class="kt">uint8_t</span> <span class="n">Samples</span> <span class="p">(</span><span class="n">array</span> <span class="n">of</span> <span class="kt">uint8_t</span><span class="err">&#39;</span><span class="n">s</span> <span class="o">--</span> <span class="n">embedded</span> <span class="n">sound</span> <span class="n">samples</span> <span class="n">in</span> <span class="n">Microsoft</span> <span class="n">WAVE</span> <span class="n">format</span><span class="p">)</span>
<span class="kt">uint32_t</span> <span class="n">NumSampleIndices</span><span class="p">;</span> <span class="c1">// number of sample indices to follow (4 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">SampleIndices</span><span class="p">[</span><span class="n">NumSampleIndices</span><span class="p">];</span> <span class="c1">// sample indices (NumSampleIndices * 4 bytes)</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_the_entire_tr2_level_format">10.2. The Entire TR2 Level Format</h3>
<div class="paragraph"><p>What follows is the physical <code>.TR2</code> file layout, byte for byte.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/caution.png" alt="Caution" />
</td>
<td class="content">This is not a &#8220;real&#8221; C/C++ structure, in that some arrays are variable-length, with the length being defined by another element of the structure.</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">uint32_t</span> <span class="n">Version</span><span class="p">;</span> <span class="c1">// version (4 bytes)</span>
<span class="n">tr_colour</span> <span class="n">Palette</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span> <span class="c1">// 8-bit palette (768 bytes)</span>
<span class="n">tr_colour4</span> <span class="n">Palette16</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span> <span class="c1">//  (1024 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumTextiles</span><span class="p">;</span> <span class="c1">// number of texture tiles (4 bytes)</span>
<span class="n">tr2_textile8</span> <span class="n">Textile8</span><span class="p">[</span><span class="n">NumTextiles</span><span class="p">];</span> <span class="c1">// 8-bit (palettized) textiles (NumTextiles * 65536 bytes)</span>
<span class="n">tr2_textile16</span> <span class="n">Textile16</span><span class="p">[</span><span class="n">NumTextiles</span><span class="p">];</span> <span class="c1">// 16-bit (ARGB) textiles (NumTextiles * 131072 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">Unused</span><span class="p">;</span> <span class="c1">// 32-bit unused value (4 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">NumRooms</span><span class="p">;</span> <span class="c1">// number of rooms (2 bytes)</span>
<span class="k">virtual</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="n">tr2_room_info</span> <span class="n">RoomInfo</span><span class="p">;</span> <span class="c1">// room header (16 bytes)</span>
    <span class="kt">uint32_t</span> <span class="n">NumData</span><span class="p">;</span> <span class="c1">// number of data uint16_t&#39;s to follow (=RoomData) (4 bytes)</span>
    <span class="k">virtual</span> <span class="k">struct</span>
    <span class="p">{</span>
        <span class="kt">uint16_t</span> <span class="n">NumVertices</span><span class="p">;</span> <span class="c1">// number of vertices to follow (2 bytes)</span>
        <span class="n">tr2_vertex_room</span> <span class="n">Vertices</span><span class="p">[</span><span class="n">NumVertices</span><span class="p">];</span> <span class="c1">// vertex list (NumVertices * 12 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">NumRectangles</span><span class="p">;</span> <span class="c1">// number of rectangles to follow (2 bytes)</span>
        <span class="n">tr_face4</span> <span class="n">Rectangles</span><span class="p">[</span><span class="n">NumRectangles</span><span class="p">];</span> <span class="c1">// rectangle list (NumRectangles * 10 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">NumTriangles</span><span class="p">;</span> <span class="c1">// number of triangles to follow (2 bytes)</span>
        <span class="n">tr_face3</span> <span class="n">Triangles</span><span class="p">[</span><span class="n">NumTriangles</span><span class="p">];</span> <span class="c1">// triangle list (NumTriangles * 8 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">NumSprites</span><span class="p">;</span> <span class="c1">// number of sprites to follow (2 bytes)</span>
        <span class="n">tr2_room_sprite</span> <span class="n">Sprites</span><span class="p">[</span><span class="n">NumSprites</span><span class="p">];</span> <span class="c1">// room sprite list (NumSprites * 4 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">NumDoors</span><span class="p">;</span> <span class="c1">// number of doors to follow (2 bytes)</span>
        <span class="n">tr2_room_door</span> <span class="n">Doors</span><span class="p">[</span><span class="n">NumDoors</span><span class="p">];</span> <span class="c1">// door list (NumDoors * 32 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">NumZsector</span><span class="p">;</span> <span class="c1">// sector table width (2 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">NumXsector</span><span class="p">;</span> <span class="c1">// sector table height (2 bytes)</span>
        <span class="n">tr2_room_sector</span> <span class="n">SectorData</span><span class="p">[</span><span class="n">NumZsector</span> <span class="o">*</span> <span class="n">NumXsector</span><span class="p">];</span> <span class="c1">// sector table (NumZsector * NumXsector * 8 bytes)</span>
        <span class="kt">int16_t</span> <span class="n">Intensity1</span><span class="p">;</span>
        <span class="kt">int16_t</span> <span class="n">Intensity2</span><span class="p">;</span>
        <span class="kt">int16_t</span> <span class="n">LightMode</span><span class="p">;</span>
        <span class="kt">uint16_t</span> <span class="n">NumLights</span><span class="p">;</span> <span class="c1">// number of lights to follow (2 bytes)</span>
        <span class="n">tr2_room_light</span> <span class="n">Lights</span><span class="p">[</span><span class="n">NumLights</span><span class="p">];</span> <span class="c1">// light list (NumLights * 24 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">NumStaticMeshes</span><span class="p">;</span> <span class="c1">// number of static mesh records to follow (2 bytes)</span>
        <span class="n">tr2_room_staticmesh</span> <span class="n">StaticMeshes</span><span class="p">[</span><span class="n">NumStaticMeshes</span><span class="p">];</span> <span class="c1">// static mesh data (NumStaticMeshes * 20 bytes)</span>
        <span class="kt">int16_t</span> <span class="n">AlternateRoom</span><span class="p">;</span> <span class="c1">// (2 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">Flags</span><span class="p">;</span> <span class="c1">// (2 bytes)</span>
    <span class="p">}</span> <span class="n">RoomData</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Rooms</span><span class="p">[</span><span class="n">NumRooms</span><span class="p">];</span>
<span class="kt">uint32_t</span> <span class="n">NumFloorData</span><span class="p">;</span> <span class="c1">// number of floor data uint16_t&#39;s to follow (4 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">FloorData</span><span class="p">[</span><span class="n">NumFloorData</span><span class="p">];</span> <span class="c1">// floor data (NumFloorData * 2 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumMeshData</span><span class="p">;</span> <span class="c1">// number of uint16_t&#39;s of mesh data to follow (=Meshes[]) (4 bytes)</span>
<span class="k">virtual</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="n">tr2_vertex</span> <span class="n">Centre</span><span class="p">;</span> <span class="c1">// relative coordinates of mesh centre (6 bytes)</span>
    <span class="kt">uint8_t</span> <span class="n">Unknown1</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// unknown (4 bytes)</span>
    <span class="kt">int16_t</span> <span class="n">NumVertices</span><span class="p">;</span> <span class="c1">// number of vertices to follow (2 bytes)</span>
    <span class="n">tr2_vertex</span> <span class="n">Vertices</span><span class="p">[</span><span class="n">NumVertices</span><span class="p">];</span> <span class="c1">// list of vertices (NumVertices * 6 bytes)</span>
    <span class="kt">int16_t</span> <span class="n">NumNormals</span><span class="p">;</span> <span class="c1">// number of normals to follow (2 bytes)</span>
    <span class="n">tr2_vertex</span> <span class="n">Normals</span><span class="p">[</span><span class="n">NumNormals</span><span class="p">];</span> <span class="c1">// list of normals (NumNormals * 6 bytes) (becomes Lights if NumNormals &lt; 0; 2 bytes)</span>
    <span class="kt">int16_t</span> <span class="n">NumTexturedRectangles</span><span class="p">;</span> <span class="c1">// number of textured rectangles to follow (2 bytes)</span>
    <span class="n">tr_face4</span> <span class="n">TexturedRectangles</span><span class="p">[</span><span class="n">NumTexturedRectangles</span><span class="p">];</span> <span class="c1">// list of textured rectangles (NumTexturedRectangles * 10 bytes)</span>
    <span class="kt">int16_t</span> <span class="n">NumTexturedTriangles</span><span class="p">;</span> <span class="c1">// number of textured triangles to follow (2 bytes)</span>
    <span class="n">tr_face3</span> <span class="n">TexturedTriangles</span><span class="p">[</span><span class="n">NumTexturedTriangles</span><span class="p">];</span> <span class="c1">// list of textured triangles (NumTexturedTriangles * 8 bytes)</span>
    <span class="kt">int16_t</span> <span class="n">NumColouredRectangles</span><span class="p">;</span> <span class="c1">// number of coloured rectangles to follow (2 bytes)</span>
    <span class="n">tr_face4</span> <span class="n">ColouredRectangles</span><span class="p">[</span><span class="n">NumColouredRectangles</span><span class="p">];</span> <span class="c1">// list of coloured rectangles (NumColouredRectangles * 10 bytes)</span>
    <span class="kt">int16_t</span> <span class="n">NumColouredTriangles</span><span class="p">;</span> <span class="c1">// number of coloured triangles to follow (2 bytes)</span>
    <span class="n">tr_face3</span> <span class="n">ColouredTriangles</span><span class="p">[</span><span class="n">NumColouredTriangles</span><span class="p">];</span> <span class="c1">// list of coloured triangles (NumColouredTriangles * 8 bytes)</span>
<span class="p">}</span> <span class="n">Meshes</span><span class="p">[</span><span class="n">NumMeshPointers</span><span class="p">];</span> <span class="c1">// note that NumMeshPointers comes AFTER Meshes[]</span>
<span class="kt">uint32_t</span> <span class="n">NumMeshPointers</span><span class="p">;</span> <span class="c1">// number of mesh pointers to follow (4 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">MeshPointers</span><span class="p">[</span><span class="n">NumMeshPointers</span><span class="p">];</span> <span class="c1">// mesh pointer list (NumMeshPointers * 4 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumAnimations</span><span class="p">;</span> <span class="c1">// number of animations to follow (4 bytes)</span>
<span class="n">tr2_animation</span> <span class="n">Animations</span><span class="p">[</span><span class="n">NumAnimations</span><span class="p">];</span> <span class="c1">// animation list (NumAnimations * 32 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumStateChanges</span><span class="p">;</span> <span class="c1">// number of state changes to follow (4 bytes)</span>
<span class="n">tr2_state_change</span> <span class="n">StateChanges</span><span class="p">[</span><span class="n">NumStateChanges</span><span class="p">];</span> <span class="c1">// state-change list (NumStructures * 6 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumAnimDispatches</span><span class="p">;</span> <span class="c1">// number of animation dispatches to follow (4 bytes)</span>
<span class="n">tr2_anim_dispatch</span> <span class="n">AnimDispatches</span><span class="p">[</span><span class="n">NumAnimDispatches</span><span class="p">];</span> <span class="c1">// animation-dispatch list list (NumAnimDispatches * 8 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumAnimCommands</span><span class="p">;</span> <span class="c1">// number of animation commands to follow (4 bytes)</span>
<span class="n">tr2_anim_command</span> <span class="n">AnimCommands</span><span class="p">[</span><span class="n">NumAnimCommands</span><span class="p">];</span> <span class="c1">// animation-command list (NumAnimCommands * 2 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumMeshTrees</span><span class="p">;</span> <span class="c1">// number of MeshTrees to follow (4 bytes)</span>
<span class="n">tr2_meshtree</span> <span class="n">MeshTrees</span><span class="p">[</span><span class="n">NumMeshTrees</span><span class="p">];</span> <span class="c1">// MeshTree list (NumMeshTrees * 4 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumFrames</span><span class="p">;</span> <span class="c1">// number of words of frame data to follow (4 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">Frames</span><span class="p">[</span><span class="n">NumFrames</span><span class="p">];</span> <span class="c1">// frame data (NumFrames * 2 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumMoveables</span><span class="p">;</span> <span class="c1">// number of moveables to follow (4 bytes)</span>
<span class="n">tr2_moveable</span> <span class="n">Moveables</span><span class="p">[</span><span class="n">NumMoveables</span><span class="p">];</span> <span class="c1">// moveable list (NumMoveables * 18 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumStaticMeshes</span><span class="p">;</span> <span class="c1">// number of StaticMesh data records to follow (4 bytes)</span>
<span class="n">tr2_staticmesh</span> <span class="n">StaticMeshes</span><span class="p">[</span><span class="n">NumStaticMeshes</span><span class="p">];</span> <span class="c1">// StaticMesh data (NumStaticMesh * 32 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumObjectTextures</span><span class="p">;</span> <span class="c1">// number of object textures to follow (4 bytes)</span>
<span class="n">tr2_object_texture</span> <span class="n">ObjectTextures</span><span class="p">[</span><span class="n">NumObjectTextures</span><span class="p">];</span> <span class="c1">// object texture list (NumObjectTextures * 20 bytes) (after AnimatedTextures in TR3)</span>
<span class="kt">uint32_t</span> <span class="n">NumSpriteTextures</span><span class="p">;</span> <span class="c1">// number of sprite textures to follow (4 bytes)</span>
<span class="n">tr2_sprite_texture</span> <span class="n">SpriteTextures</span><span class="p">[</span><span class="n">NumSpriteTextures</span><span class="p">];</span> <span class="c1">// sprite texture list (NumSpriteTextures * 16 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumSpriteSequences</span><span class="p">;</span> <span class="c1">// number of sprite sequences records to follow (4 bytes)</span>
<span class="n">tr2_sprite_sequence</span> <span class="n">SpriteSequences</span><span class="p">[</span><span class="n">NumSpriteSequences</span><span class="p">];</span> <span class="c1">// sprite sequence data (NumSpriteSequences * 8 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumCameras</span><span class="p">;</span> <span class="c1">// number of camera data records to follow (4 bytes)</span>
<span class="n">tr2_camera</span> <span class="n">Cameras</span><span class="p">[</span><span class="n">NumCameras</span><span class="p">];</span> <span class="c1">// camera data (NumCameras * 16 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumSoundSources</span><span class="p">;</span> <span class="c1">// number of sound source data records to follow (4 bytes)</span>
<span class="n">tr2_sound_source</span> <span class="n">SoundSources</span><span class="p">[</span><span class="n">NumSoundSources</span><span class="p">];</span> <span class="c1">// sound source data (NumSoundSources * 16 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumBoxes</span><span class="p">;</span> <span class="c1">// number of box data records to follow (4 bytes)</span>
<span class="n">tr2_box</span> <span class="n">Boxes</span><span class="p">[</span><span class="n">NumBoxes</span><span class="p">];</span> <span class="c1">// box data (NumBoxes * 8 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumOverlaps</span><span class="p">;</span> <span class="c1">// number of overlap records to follow (4 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">Overlaps</span><span class="p">[</span><span class="n">NumOverlaps</span><span class="p">];</span> <span class="c1">// overlap data (NumOverlaps * 2 bytes)</span>
<span class="kt">int16_t</span> <span class="n">Zones</span><span class="p">[</span><span class="mi">10</span><span class="o">*</span><span class="n">NumBoxes</span><span class="p">];</span> <span class="c1">// zone data (NumBoxes * 20 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumAnimatedTextures</span><span class="p">;</span> <span class="c1">// number of animated texture records to follow (4 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">AnimatedTextures</span><span class="p">[</span><span class="n">NumAnimatedTextures</span><span class="p">];</span> <span class="c1">// animated texture data (NumAnimatedTextures * 2 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumItems</span><span class="p">;</span> <span class="c1">// number of items to follow (4 bytes)</span>
<span class="n">tr2_item</span> <span class="n">Items</span><span class="p">[</span><span class="n">NumItems</span><span class="p">];</span> <span class="c1">// item list (NumItems * 24 bytes)</span>
<span class="kt">uint8_t</span> <span class="n">LightMap</span><span class="p">[</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">256</span><span class="p">];</span> <span class="c1">// light map (8192 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">NumCinematicFrames</span><span class="p">;</span> <span class="c1">// number of cinematic frame records to follow (2 bytes)</span>
<span class="n">tr2_cinematic_frame</span> <span class="n">CinematicFrames</span><span class="p">[</span><span class="n">NumCinematicFrames</span><span class="p">];</span> <span class="c1">// (NumCinematicFrames * 16 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">NumDemoData</span><span class="p">;</span> <span class="c1">// number of demo data records to follow (2 bytes)</span>
<span class="kt">uint8_t</span> <span class="n">DemoData</span><span class="p">[</span><span class="n">NumDemoData</span><span class="p">];</span> <span class="c1">// demo data (NumDemoData bytes)</span>
<span class="kt">int16_t</span> <span class="n">SoundMap</span><span class="p">[</span><span class="mi">370</span><span class="p">];</span> <span class="c1">// sound map (740 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumSoundDetails</span><span class="p">;</span> <span class="c1">// number of sound-detail records to follow (4 bytes)</span>
<span class="n">tr2_sample_info</span> <span class="n">SoundDetails</span><span class="p">[</span><span class="n">NumSoundDetails</span><span class="p">];</span> <span class="c1">// sound-detail list (NumSoundDetails * 8 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumSampleIndices</span><span class="p">;</span> <span class="c1">// number of sample indices to follow (4 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">SampleIndices</span><span class="p">[</span><span class="n">NumSampleIndices</span><span class="p">];</span> <span class="c1">// sample indices (NumSampleIndices * 4 bytes)</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_the_entire_tr3_level_format">10.3. The Entire TR3 Level Format</h3>
<div class="paragraph"><p>What follows is the physical Tomb Raider III <code>.TR2</code> file layout, byte for byte.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/caution.png" alt="Caution" />
</td>
<td class="content">This is not a &#8220;real&#8221; C/C++ structure, in that some arrays are variable-length, with the length being defined by another element of the structure.</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">uint32_t</span> <span class="n">Version</span><span class="p">;</span> <span class="c1">// version (4 bytes)</span>
<span class="n">tr_colour</span> <span class="n">Palette</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span> <span class="c1">// 8-bit palette (768 bytes)</span>
<span class="n">tr_colour4</span> <span class="n">Palette16</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span> <span class="c1">//  (1024 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumTextiles</span><span class="p">;</span> <span class="c1">// number of texture tiles (4 bytes)</span>
<span class="n">tr2_textile8</span> <span class="n">Textile8</span><span class="p">[</span><span class="n">NumTextiles</span><span class="p">];</span> <span class="c1">// 8-bit (palettized) textiles (NumTextiles * 65536 bytes)</span>
<span class="n">tr2_textile16</span> <span class="n">Textile16</span><span class="p">[</span><span class="n">NumTextiles</span><span class="p">];</span> <span class="c1">// 16-bit (ARGB) textiles (NumTextiles * 131072 bytes) (absent from TR1)</span>
<span class="kt">uint32_t</span> <span class="n">Unused</span><span class="p">;</span> <span class="c1">// 32-bit unused value (4 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">NumRooms</span><span class="p">;</span> <span class="c1">// number of rooms (2 bytes)</span>
<span class="k">virtual</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="n">tr2_room_info</span> <span class="n">RoomInfo</span><span class="p">;</span> <span class="c1">// room header (16 bytes)</span>
    <span class="kt">uint32_t</span> <span class="n">NumData</span><span class="p">;</span> <span class="c1">// number of data uint16_t&#39;s to follow (=RoomData) (4 bytes)</span>
    <span class="k">virtual</span> <span class="k">struct</span>
    <span class="p">{</span>
        <span class="kt">uint16_t</span> <span class="n">NumVertices</span><span class="p">;</span> <span class="c1">// number of vertices to follow (2 bytes)</span>
        <span class="n">tr2_vertex_room</span> <span class="n">Vertices</span><span class="p">[</span><span class="n">NumVertices</span><span class="p">];</span> <span class="c1">// vertex list (NumVertices * 12 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">NumRectangles</span><span class="p">;</span> <span class="c1">// number of rectangles to follow (2 bytes)</span>
        <span class="n">tr_face4</span> <span class="n">Rectangles</span><span class="p">[</span><span class="n">NumRectangles</span><span class="p">];</span> <span class="c1">// rectangle list (NumRectangles * 10 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">NumTriangles</span><span class="p">;</span> <span class="c1">// number of triangles to follow (2 bytes)</span>
        <span class="n">tr_face3</span> <span class="n">Triangles</span><span class="p">[</span><span class="n">NumTriangles</span><span class="p">];</span> <span class="c1">// triangle list (NumTriangles * 8 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">NumSprites</span><span class="p">;</span> <span class="c1">// number of sprites to follow (2 bytes)</span>
        <span class="n">tr2_room_sprite</span> <span class="n">Sprites</span><span class="p">[</span><span class="n">NumSprites</span><span class="p">];</span> <span class="c1">// room sprite list (NumSprites * 4 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">NumDoors</span><span class="p">;</span> <span class="c1">// number of doors to follow (2 bytes)</span>
        <span class="n">tr2_room_door</span> <span class="n">Doors</span><span class="p">[</span><span class="n">NumDoors</span><span class="p">];</span> <span class="c1">// door list (NumDoors * 32 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">NumZsector</span><span class="p">;</span> <span class="c1">// sector table width (2 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">NumXsector</span><span class="p">;</span> <span class="c1">// sector table height (2 bytes)</span>
        <span class="n">tr2_room_sector</span> <span class="n">SectorData</span><span class="p">[</span><span class="n">NumZsector</span> <span class="o">*</span> <span class="n">NumXsector</span><span class="p">];</span> <span class="c1">// sector table (NumZsector * NumXsector * 8 bytes)</span>
        <span class="kt">int16_t</span> <span class="n">Intensity1</span><span class="p">;</span>
        <span class="kt">int16_t</span> <span class="n">Intensity2</span><span class="p">;</span>
        <span class="kt">uint16_t</span> <span class="n">NumLights</span><span class="p">;</span> <span class="c1">// number of lights to follow (2 bytes)</span>
        <span class="n">tr2_room_light</span> <span class="n">Lights</span><span class="p">[</span><span class="n">NumLights</span><span class="p">];</span> <span class="c1">// light list (NumLights * 24 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">NumStaticMeshes</span><span class="p">;</span> <span class="c1">// number of static mesh records to follow (2 bytes)</span>
        <span class="n">tr2_room_staticmesh</span> <span class="n">StaticMeshes</span><span class="p">[</span><span class="n">NumStaticMeshes</span><span class="p">];</span> <span class="c1">// static mesh data (NumStaticMeshes * 20 bytes)</span>
        <span class="kt">int16_t</span> <span class="n">AlternateRoom</span><span class="p">;</span> <span class="c1">// (2 bytes)</span>
        <span class="kt">uint16_t</span> <span class="n">Flags</span><span class="p">;</span> <span class="c1">// (2 bytes)</span>
        <span class="n">tr_colour</span> <span class="n">RoomLightColour</span> <span class="c1">// 3 bytes</span>
    <span class="p">}</span> <span class="n">RoomData</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Rooms</span><span class="p">[</span><span class="n">NumRooms</span><span class="p">];</span>
<span class="kt">uint32_t</span> <span class="n">NumFloorData</span><span class="p">;</span> <span class="c1">// number of floor data uint16_t&#39;s to follow (4 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">FloorData</span><span class="p">[</span><span class="n">NumFloorData</span><span class="p">];</span> <span class="c1">// floor data (NumFloorData * 2 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumMeshData</span><span class="p">;</span> <span class="c1">// number of uint16_t&#39;s of mesh data to follow (=Meshes[]) (4 bytes)</span>
<span class="k">virtual</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="n">tr2_vertex</span> <span class="n">Centre</span><span class="p">;</span> <span class="c1">// relative coordinates of mesh centre (6 bytes)</span>
    <span class="kt">uint8_t</span> <span class="n">Unknown1</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// unknown (4 bytes)</span>
    <span class="kt">int16_t</span> <span class="n">NumVertices</span><span class="p">;</span> <span class="c1">// number of vertices to follow (2 bytes)</span>
    <span class="n">tr2_vertex</span> <span class="n">Vertices</span><span class="p">[</span><span class="n">NumVertices</span><span class="p">];</span> <span class="c1">// list of vertices (NumVertices * 6 bytes)</span>
    <span class="kt">int16_t</span> <span class="n">NumNormals</span><span class="p">;</span> <span class="c1">// number of normals to follow (2 bytes)</span>
    <span class="n">tr2_vertex</span> <span class="n">Normals</span><span class="p">[</span><span class="n">NumNormals</span><span class="p">];</span> <span class="c1">// list of normals (NumNormals * 6 bytes) (becomes Lights if NumNormals &lt; 0; 2 bytes)</span>
    <span class="kt">int16_t</span> <span class="n">NumTexturedRectangles</span><span class="p">;</span> <span class="c1">// number of textured rectangles to follow (2 bytes)</span>
    <span class="n">tr_face4</span> <span class="n">TexturedRectangles</span><span class="p">[</span><span class="n">NumTexturedRectangles</span><span class="p">];</span> <span class="c1">// list of textured rectangles (NumTexturedRectangles * 10 bytes)</span>
    <span class="kt">int16_t</span> <span class="n">NumTexturedTriangles</span><span class="p">;</span> <span class="c1">// number of textured triangles to follow (2 bytes)</span>
    <span class="n">tr_face3</span> <span class="n">TexturedTriangles</span><span class="p">[</span><span class="n">NumTexturedTriangles</span><span class="p">];</span> <span class="c1">// list of textured triangles (NumTexturedTriangles * 8 bytes)</span>
    <span class="kt">int16_t</span> <span class="n">NumColouredRectangles</span><span class="p">;</span> <span class="c1">// number of coloured rectangles to follow (2 bytes)</span>
    <span class="n">tr_face4</span> <span class="n">ColouredRectangles</span><span class="p">[</span><span class="n">NumColouredRectangles</span><span class="p">];</span> <span class="c1">// list of coloured rectangles (NumColouredRectangles * 10 bytes)</span>
    <span class="kt">int16_t</span> <span class="n">NumColouredTriangles</span><span class="p">;</span> <span class="c1">// number of coloured triangles to follow (2 bytes)</span>
    <span class="n">tr_face3</span> <span class="n">ColouredTriangles</span><span class="p">[</span><span class="n">NumColouredTriangles</span><span class="p">];</span> <span class="c1">// list of coloured triangles (NumColouredTriangles * 8 bytes)</span>
<span class="p">}</span> <span class="n">Meshes</span><span class="p">[</span><span class="n">NumMeshPointers</span><span class="p">];</span> <span class="c1">// note that NumMeshPointers comes AFTER Meshes[]</span>
<span class="kt">uint32_t</span> <span class="n">NumMeshPointers</span><span class="p">;</span> <span class="c1">// number of mesh pointers to follow (4 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">MeshPointers</span><span class="p">[</span><span class="n">NumMeshPointers</span><span class="p">];</span> <span class="c1">// mesh pointer list (NumMeshPointers * 4 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumAnimations</span><span class="p">;</span> <span class="c1">// number of animations to follow (4 bytes)</span>
<span class="n">tr2_animation</span> <span class="n">Animations</span><span class="p">[</span><span class="n">NumAnimations</span><span class="p">];</span> <span class="c1">// animation list (NumAnimations * 32 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumStateChanges</span><span class="p">;</span> <span class="c1">// number of state changes to follow (4 bytes)</span>
<span class="n">tr2_state_change</span> <span class="n">StateChanges</span><span class="p">[</span><span class="n">NumStateChanges</span><span class="p">];</span> <span class="c1">// state-change list (NumStructures * 6 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumAnimDispatches</span><span class="p">;</span> <span class="c1">// number of animation dispatches to follow (4 bytes)</span>
<span class="n">tr2_anim_dispatch</span> <span class="n">AnimDispatches</span><span class="p">[</span><span class="n">NumAnimDispatches</span><span class="p">];</span> <span class="c1">// animation-dispatch list list (NumAnimDispatches * 8 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumAnimCommands</span><span class="p">;</span> <span class="c1">// number of animation commands to follow (4 bytes)</span>
<span class="n">tr2_anim_command</span> <span class="n">AnimCommands</span><span class="p">[</span><span class="n">NumAnimCommands</span><span class="p">];</span> <span class="c1">// animation-command list (NumAnimCommands * 2 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumMeshTrees</span><span class="p">;</span> <span class="c1">// number of MeshTrees to follow (4 bytes)</span>
<span class="n">tr2_meshtree</span> <span class="n">MeshTrees</span><span class="p">[</span><span class="n">NumMeshTrees</span><span class="p">];</span> <span class="c1">// MeshTree list (NumMeshTrees * 4 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumFrames</span><span class="p">;</span> <span class="c1">// number of words of frame data to follow (4 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">Frames</span><span class="p">[</span><span class="n">NumFrames</span><span class="p">];</span> <span class="c1">// frame data (NumFrames * 2 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumMoveables</span><span class="p">;</span> <span class="c1">// number of moveables to follow (4 bytes)</span>
<span class="n">tr2_moveable</span> <span class="n">Moveables</span><span class="p">[</span><span class="n">NumMoveables</span><span class="p">];</span> <span class="c1">// moveable list (NumMoveables * 18 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumStaticMeshes</span><span class="p">;</span> <span class="c1">// number of StaticMesh data records to follow (4 bytes)</span>
<span class="n">tr2_staticmesh</span> <span class="n">StaticMeshes</span><span class="p">[</span><span class="n">NumStaticMeshes</span><span class="p">];</span> <span class="c1">// StaticMesh data (NumStaticMesh * 32 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumSpriteTextures</span><span class="p">;</span> <span class="c1">// number of sprite textures to follow (4 bytes)</span>
<span class="n">tr2_sprite_texture</span> <span class="n">SpriteTextures</span><span class="p">[</span><span class="n">NumSpriteTextures</span><span class="p">];</span> <span class="c1">// sprite texture list (NumSpriteTextures * 16 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumSpriteSequences</span><span class="p">;</span> <span class="c1">// number of sprite sequences records to follow (4 bytes)</span>
<span class="n">tr2_sprite_sequence</span> <span class="n">SpriteSequences</span><span class="p">[</span><span class="n">NumSpriteSequences</span><span class="p">];</span> <span class="c1">// sprite sequence data (NumSpriteSequences * 8 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumCameras</span><span class="p">;</span> <span class="c1">// number of camera data records to follow (4 bytes)</span>
<span class="n">tr2_camera</span> <span class="n">Cameras</span><span class="p">[</span><span class="n">NumCameras</span><span class="p">];</span> <span class="c1">// camera data (NumCameras * 16 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumSoundSources</span><span class="p">;</span> <span class="c1">// number of sound source data records to follow (4 bytes)</span>
<span class="n">tr2_sound_source</span> <span class="n">SoundSources</span><span class="p">[</span><span class="n">NumSoundSources</span><span class="p">];</span> <span class="c1">// sound source data (NumSoundSources * 16 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumBoxes</span><span class="p">;</span> <span class="c1">// number of box data records to follow (4 bytes)</span>
<span class="n">tr2_box</span> <span class="n">Boxes</span><span class="p">[</span><span class="n">NumBoxes</span><span class="p">];</span> <span class="c1">// box data (NumBoxes * 8 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumOverlaps</span><span class="p">;</span> <span class="c1">// number of overlap records to follow (4 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">Overlaps</span><span class="p">[</span><span class="n">NumOverlaps</span><span class="p">];</span> <span class="c1">// overlap data (NumOverlaps * 2 bytes)</span>
<span class="kt">int16_t</span> <span class="n">Zones</span><span class="p">[</span><span class="mi">10</span><span class="o">*</span><span class="n">NumBoxes</span><span class="p">];</span> <span class="c1">// zone data (NumBoxes * 20 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumAnimatedTextures</span><span class="p">;</span> <span class="c1">// number of animated texture records to follow (4 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">AnimatedTextures</span><span class="p">[</span><span class="n">NumAnimatedTextures</span><span class="p">];</span> <span class="c1">// animated texture data (NumAnimatedTextures * 2 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumObjectTextures</span><span class="p">;</span> <span class="c1">// number of object textures to follow (4 bytes) (after AnimatedTextures in TR3)</span>
<span class="n">tr2_object_texture</span> <span class="n">ObjectTextures</span><span class="p">[</span><span class="n">NumObjectTextures</span><span class="p">];</span> <span class="c1">// object texture list (NumObjectTextures * 20 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumItems</span><span class="p">;</span> <span class="c1">// number of items to follow (4 bytes)</span>
<span class="n">tr2_item</span> <span class="n">Items</span><span class="p">[</span><span class="n">NumItems</span><span class="p">];</span> <span class="c1">// item list (NumItems * 24 bytes)</span>
<span class="kt">uint8_t</span> <span class="n">LightMap</span><span class="p">[</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">256</span><span class="p">];</span> <span class="c1">// light map (8192 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">NumCinematicFrames</span><span class="p">;</span> <span class="c1">// number of cinematic frame records to follow (2 bytes)</span>
<span class="n">tr2_cinematic_frame</span> <span class="n">CinematicFrames</span><span class="p">[</span><span class="n">NumCinematicFrames</span><span class="p">];</span> <span class="c1">// (NumCinematicFrames * 16 bytes)</span>
<span class="kt">uint16_t</span> <span class="n">NumDemoData</span><span class="p">;</span> <span class="c1">// number of demo data records to follow (2 bytes)</span>
<span class="kt">uint8_t</span> <span class="n">DemoData</span><span class="p">[</span><span class="n">NumDemoData</span><span class="p">];</span> <span class="c1">// demo data (NumDemoData bytes)</span>
<span class="kt">int16_t</span> <span class="n">SoundMap</span><span class="p">[</span><span class="mi">370</span><span class="p">];</span> <span class="c1">// sound map (740 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumSoundDetails</span><span class="p">;</span> <span class="c1">// number of sound-detail records to follow (4 bytes)</span>
<span class="n">tr2_sample_info</span> <span class="n">SoundDetails</span><span class="p">[</span><span class="n">NumSoundDetails</span><span class="p">];</span> <span class="c1">// sound-detail list (NumSoundDetails * 8 bytes)</span>
<span class="kt">uint32_t</span> <span class="n">NumSampleIndices</span><span class="p">;</span> <span class="c1">// number of sample indices to follow (4 bytes)  +</span>
<span class="kt">uint32_t</span> <span class="n">SampleIndices</span><span class="p">[</span><span class="n">NumSampleIndices</span><span class="p">];</span> <span class="c1">// sample indices (NumSampleIndices * 4 bytes)</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_the_entire_tr4_level_format">10.4. The Entire TR4 Level Format</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">Needs to be written.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_the_entire_tr5_level_format">10.5. The Entire TR5 Level Format</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">Needs to be written.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_itemized_differences_between_tr1_and_tr2">10.6. Itemized Differences between TR1 and TR2</h3>
<div class="ulist"><ul>
<li>
<p>
TR1 has no colour table or 16-bit palette before the start of the textures; it also lacks 16-bit textures.
</p>
</li>
<li>
<p>
In TR1, <code>tr2_room_vertex</code> has after its <code>tr_vertex</code> struct only the first light intensity, and not the attributes or the second intensity.
</p>
</li>
<li>
<p>
In TR1, after SectorData, there is only the first light intensity, and not the second one or the lighting mode.
</p>
</li>
<li>
<p>
In TR1, tr2_room_light_struct has only one of:
</p>
<div class="ulist"><ul>
<li>
<p>
uint16_t Diffuse1/2
</p>
</li>
<li>
<p>
uint32_t Unknown1/2
</p>
</li>
</ul></div>
</li>
<li>
<p>
In TR1, tr2_room_static does not have two light intensities, but only one.
</p>
</li>
<li>
<p>
&#8220;Boxes&#8221; objects are rectangles whose four horizontal-coordinate values are <code>uint8_t</code>s in TR2 and <code>int32_t</code>'s in TR1.
</p>
</li>
<li>
<p>
&#8220;Zones&#8221; objects have 10 <code>int16_t</code>s in TR2, but 6 <code>int16_t</code>s in TR1
</p>
</li>
<li>
<p>
In TR1, <code>tr2_item_struct</code> is like the TR2 version, but with only one light intensity.
</p>
</li>
<li>
<p>
The TR1 colour table has the same format as the TR2 colour table, but it is located between the LightMap and the cinematic frames.
</p>
</li>
<li>
<p>
SoundMap is 370 <code>int16_t</code>s in TR2, but 256 <code>int16_t</code>s in TR1.
</p>
</li>
<li>
<p>
Between SoundDetails and SampleIndices, TR1 has all the level&#8217;s sound samples, in the form of embedded Microsoft WAVE files. Just before these samples is the
  total number of bytes in those sound samples, which is a int32_t.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_itemized_differences_between_tr2_and_tr3">10.7. Itemized Differences between TR2 and TR3</h3>
<div class="ulist"><ul>
<li>
<p>
After the two room-light intensities, TR2 has a lighting-mode value, which TR3 lacks.
</p>
</li>
<li>
<p>
Also in <code>tr3_room</code>, TR3 has 3 extra bytes at the end, which are <code>WaterScheme</code>, <code>ReverbInfo</code> and null filler.
</p>
</li>
<li>
<p>
Finally, in TR2, the <code>tr_object_texture</code> data is before the <code>tr_sprite_texture</code> data. In TR3, it is before the <code>tr2_item</code> data.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_itemized_differences_between_tr3_and_tr4">10.8. Itemized Differences between TR3 and TR4</h3>
<div class="ulist"><ul>
<li>
<p>
There are no more 8-bit and 16-bit palettes.
</p>
</li>
<li>
<p>
There are no more 8-bit textures.
</p>
</li>
<li>
<p>
There are now 32-bit textures.
</p>
</li>
<li>
<p>
Texture tiles are now divided into three parts: <em>non-bumped room texture tiles</em>, <em>model texture tiles</em> and <em>bumped room texture tiles</em>.
</p>
</li>
<li>
<p>
Level file divided in several chunks, with each chunk compressed using <em>zlib</em>:
</p>
<div class="ulist"><ul>
<li>
<p>
Chunk 1: 32-bit texture tiles.
</p>
</li>
<li>
<p>
Chunk 2: 16-bit texture tiles.
</p>
</li>
<li>
<p>
Chunk 3: 32-bit <em>sky and font graphics</em>.
</p>
</li>
<li>
<p>
Chunk 4: Level data.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Each compressed chunk is preceded by its <em>uncompressed size</em> and <em>compressed size</em> <code>uint32_t</code>s.
</p>
</li>
<li>
<p>
After last compressed chunk, there are now all audio samples, sequentially stored in this manner:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr4_sample</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span>  <span class="n">UncompressedSize</span><span class="p">;</span>
    <span class="kt">uint32_t</span>  <span class="n">CompressedSize</span><span class="p">;</span>
        <span class="kt">char</span>  <span class="n">WaveFile</span><span class="p">[];</span>       <span class="c1">// Embedded sample in MS-ADPCM or PCM WAV format.</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="ulist"><ul>
<li>
<p>
Room Light structure has completely changed:
</p>
<div class="ulist"><ul>
<li>
<p>
Colour is no longer stored in <a href="#tr_colour4">[tr_colour4]</a> format, rather <a href="#tr_colour">[tr_colour]</a>.
</p>
</li>
<li>
<p>
There is new field <code>LightType</code>, which specifies light mode or fog bulb mode.
</p>
</li>
<li>
<p>
After <code>LightType</code>, there is a <code>uint8_t Filler</code> value of <code>0xFF</code>.
</p>
</li>
<li>
<p>
<code>Intensity</code> is now <code>uint8_t</code>.
</p>
</li>
<li>
<p>
Instead of <code>Fade</code>, there is a set of 4 float values: <code>In</code>, <code>Out</code>, <code>Length</code> and <code>CutOff</code>.
</p>
</li>
<li>
<p>
There are also three float values defining <em>light direction</em>.
</p>
</li>
</ul></div>
</li>
<li>
<p>
There are now two dedicated structures for <em>mesh faces</em>, bearing extra field <code>Lighting</code>.
</p>
</li>
<li>
<p>
There is now <em>FlybyCameras</em> block before <em>SoundSources</em> block.
</p>
</li>
<li>
<p>
<em>Cinematic Frames</em> are replaced with <em>AI Data</em> block.
</p>
</li>
<li>
<p>
Meaning of fields in <a href="#tr_sprite_texture">[tr_sprite_texture]</a> has changed.
</p>
</li>
<li>
<p>
In addition, the <code>NumSpriteTextures</code> field is preceeded by the 3 ASCII bytes <code>SPR</code>.
</p>
</li>
<li>
<p>
Meshes have no longer colored tris / quads. So, <code>NumColoredRectangles</code>, <code>ColoredRectangles[]</code>, <code>NumColoredTriangles</code>, <code>ColoredTriangles[]</code> no longer exist in the tr4_mesh structure.
</p>
</li>
<li>
<p>
The <code>NumObjectTextures</code> field is now preceeded by 4 ASCII bytes <code>\0TEX</code>
</p>
</li>
<li>
<p>
<a href="#tr4_object_texture">[tr4_object_texture]</a> struct is used instead of <a href="#tr_object_texture">[tr_object_texture]</a>.
</p>
</li>
<li>
<p>
<a href="#tr4_animation">[tr4_animation]</a> struct is used instead of <a href="#tr_animation">[tr_animation]</a>.
</p>
</li>
<li>
<p>
There is no lightmap.
</p>
</li>
<li>
<p>
TR4 levels have an additional 6 bytes at the end of the uncompressed <em>Level data</em> that seem to be always 0.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_itemized_differences_between_tr4_and_tr5">10.9. Itemized Differences between TR4 and TR5</h3>
<div class="ulist"><ul>
<li>
<p>
There is no more <em>bumped room texture tiles</em> block.
</p>
</li>
<li>
<p>
There are now two extra <code>uint16_t</code> values after last texture block specifying <em>Lara type</em> and <em>weather type</em>. Weather type may be either <em>0</em> (no weather), <em>1</em> (raining) or <em>2</em> (snowing).
</p>
</li>
<li>
<p>
Also, it is followed by 28 bytes zero padding.
</p>
</li>
<li>
<p>
<em>uncompressed size</em> and <em>compressed size</em> <code>uint32_t</code> values for <em>Level data</em> block are equal (reason below).
</p>
</li>
<li>
<p>
<em>Level data</em> block is not compressed.
</p>
</li>
<li>
<p>
<a href="#tr5_room">[tr5_room]</a> struct is used instead of <a href="#tr4_room">[tr4_room]</a>.
</p>
</li>
<li>
<p>
<a href="#tr5_room_info">[tr5_room_info]</a> struct is used instead of <a href="#tr_room_info">[tr_room_info]</a>.
</p>
</li>
<li>
<p>
<a href="#tr5_room_vertex">[tr5_room_vertex]</a> struct is used instead of <a href="#tr4_room_vertex">[tr4_room_vertex]</a>.
</p>
</li>
<li>
<p>
<a href="#tr5_room_light">[tr5_room_light]</a> struct is used instead of <a href="#tr4_room_light">[tr4_room_light]</a>.
</p>
</li>
<li>
<p>
Each <a id="tr4_object_texture"></a> ends with extra null <code>uint16_t</code> value.
</p>
</li>
<li>
<p>
SoundMap is 450 <code>int16_t</code>s in TR5, but 370 <code>int16_t</code>s in TR4.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_itemized_differences_between_8220_normal_8221_trs_and_demos">10.10. Itemized Differences between &#8220;normal&#8221; TRs and Demos</h3>
<div class="ulist"><ul>
<li>
<p>
Presumably as a form of copy protection, the demo versions of some of the TR games use levels that are slightly different from those in the retail versions.
  However, those that have been found are all data rearrangements, as explained below.
</p>
</li>
<li>
<p>
The TR1 and Unfinished Business (<code>.TUB</code>) demos have their palettes moved to between the SpriteSequences and the Cameras.
</p>
</li>
<li>
<p>
The TR2 &#8220;Wall&#8221; demo, and maybe also its &#8220;Venice&#8221; demo, has its LightMap (8K) moved to between the SpriteSequences and the Cameras. It also has its
  SampleIndices content replaced by the soundfiles, though the associated number of them remains unchanged (the number of indices becomes the number of samples).
</p>
</li>
<li>
<p>
That demo also has its own version of <code>TOMBPC.DAT</code>, called <code>DEMOPC.DAT</code>, which appears to have the exact same format as <code>TOMBPC.DAT</code>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>No rearrangements are known for the TR3 demos.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scripting_in_tr2_tr3_for_pc_psx">11. Scripting in TR2/TR3 for PC/PSX</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_overview_6">11.1. Overview</h3>
<div class="paragraph"><p>The internal gameflow, which levels come in what order, what item(s) Lara has at the beginning of each level, the filenames of the level and cut-scene files,
all the visible text (e.g. &#8220;Save Game,&#8221; &#8220;Rusty Key,&#8221; etc.), and various other options are controlled by a script file called <code>TOMBPC.DAT</code>/<code>TOMBPSX.DAT</code>. The
scripts were compiled using a utility known as <code>GAMEFLOW.EXE</code> which was distributed by Eidos in the German release of Tomb Raider II Gold. Both TR2 and TR3 use
these script files. From both games the format remained unchanged. TR1&#8217;s gameflow is hardcoded thus there is no external file controlling this resulting in loss
of flexibility.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">uint32_t</span> <span class="n">Version</span><span class="p">;</span>             <span class="c1">// The Script Version (Always 3 for TR2/3)</span>
<span class="kt">uint8_t</span> <span class="n">Description</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>     <span class="c1">// Null-terminated string describing the script copyright info etc. Not encrypted.</span>
<span class="kt">uint16_t</span> <span class="n">Unknown1</span><span class="p">;</span>            <span class="c1">// ?</span>
<span class="kt">int32_t</span> <span class="n">FirstOption</span><span class="p">;</span>          <span class="c1">// Level to go to when WHAT happens?</span>
<span class="kt">int32_t</span> <span class="n">TitleReplace</span><span class="p">;</span>         <span class="c1">// Level to go to when WHAT happens?</span>
<span class="kt">int32_t</span> <span class="n">OnDeathDemoMode</span><span class="p">;</span>      <span class="c1">// Level to go to when Lara dies during demo mode</span>
<span class="kt">int32_t</span> <span class="n">OnDeathInGame</span><span class="p">;</span>        <span class="c1">// Level to go to when Lara dies during the game</span>
<span class="kt">int32_t</span> <span class="n">DemoTime</span><span class="p">;</span>             <span class="c1">// Time in game ticks (1/30th of a second?) to wait before starting a demo</span>
<span class="kt">int32_t</span> <span class="n">OnDemoInterrupt</span><span class="p">;</span>      <span class="c1">// Level to go to when demo mode is interrupted</span>
<span class="kt">int32_t</span> <span class="n">OnDemoEnd</span><span class="p">;</span>            <span class="c1">// Level to go to when the demo ends</span>
<span class="kt">uint8_t</span> <span class="n">Unknown2</span><span class="p">[</span><span class="mi">36</span><span class="p">];</span>         <span class="c1">// Filler</span>
<span class="kt">int16_t</span> <span class="n">NumLevels</span><span class="p">;</span>            <span class="c1">// Number of levels in the game.</span>
<span class="kt">int16_t</span> <span class="n">NumChapterScreens</span><span class="p">;</span>    <span class="c1">// Chapter screens (Present in TR2, first used in TR3)</span>
<span class="kt">int16_t</span> <span class="n">NumTitles</span><span class="p">;</span>            <span class="c1">// Only one, TITLE.TR2</span>
<span class="kt">int16_t</span> <span class="n">NumFMVs</span><span class="p">;</span>              <span class="c1">// Number of FMV cutscenes PC - (*.RPL), PSX - (*STR)</span>
<span class="kt">int16_t</span> <span class="n">NumCutscenes</span><span class="p">;</span>         <span class="c1">// Number of in-game (engine-rendered) cutscenes (CUT*.TR2)</span>
<span class="kt">int16_t</span> <span class="n">NumDemoLevels</span><span class="p">;</span>        <span class="c1">// Number of demo levels</span>
<span class="kt">int16_t</span> <span class="n">TitleSoundID</span><span class="p">;</span>         <span class="c1">// ID of title soundtrack</span>
<span class="kt">int16_t</span> <span class="n">SingleLevel</span><span class="p">;</span>          <span class="c1">// If doing only a single level</span>
<span class="kt">uint8_t</span> <span class="n">Unknown3</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>         <span class="c1">// Filler</span>
<span class="kt">uint16_t</span> <span class="n">Flags</span><span class="p">;</span>               <span class="c1">// Various flags see below</span>
<span class="kt">uint8_t</span> <span class="n">Unknown4</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>          <span class="c1">// Filler</span>
<span class="kt">uint8_t</span> <span class="n">XORKey</span><span class="p">;</span>               <span class="c1">// Key used to encrypt/decrypt strings</span>
<span class="kt">uint8_t</span> <span class="n">LanguageID</span><span class="p">;</span>           <span class="c1">// Script Language ID see below</span>
<span class="kt">int16_t</span> <span class="n">SecretSoundID</span><span class="p">;</span>        <span class="c1">// ID of soundtrack to play when a secret is found</span>
<span class="kt">uint8_t</span> <span class="n">Unknown5</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>          <span class="c1">// Filler</span>

<span class="c1">// 1. Offset to each string is end offset of *StringOffsets&#39; + *StringOffsets[i]</span>
<span class="c1">// 2. String length is calculated by (*StringOffsets[i+1]-*StringOffsets[i])</span>
<span class="c1">// 3. If Flags &amp; UseXor true each character must be ^ XorKey to decrypt the string.</span>

<span class="kt">uint16_t</span> <span class="n">LevelStringOffsets</span><span class="p">[</span><span class="n">NumLevels</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>                 <span class="c1">//Relative offset to level name strings</span>
<span class="n">StringArray</span> <span class="n">LevelStrings</span><span class="p">[</span><span class="n">NumLevels</span><span class="p">];</span>                      <span class="c1">//Usually Encrypted</span>
<span class="kt">uint16_t</span> <span class="n">ChapterScreenStringOffsets</span><span class="p">[</span><span class="n">NumChapterScreens</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span> <span class="c1">//Relative offset to chapter screen strings</span>
<span class="n">StringArray</span> <span class="n">ChapterScreenStrings</span><span class="p">[</span><span class="n">NumChapterScreens</span><span class="p">];</span>      <span class="c1">//Usually Encrypted</span>
<span class="kt">uint16_t</span> <span class="n">TitleStringOffsets</span><span class="p">[</span><span class="n">NumTitles</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>                 <span class="c1">//Relative offset to title strings</span>
<span class="n">StringArray</span> <span class="n">TitleStrings</span><span class="p">[</span><span class="n">NumTitles</span><span class="p">];</span>                      <span class="c1">//Usually Encrypted</span>
<span class="kt">uint16_t</span> <span class="n">FMVStringOffsets</span><span class="p">[</span><span class="n">NumFMVs</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>                     <span class="c1">//Relative offset to fmv path strings</span>
<span class="n">StringArray</span> <span class="n">FMVStrings</span><span class="p">[</span><span class="n">NumFMVs</span><span class="p">];</span>                          <span class="c1">//Usually Encrypted</span>
<span class="kt">uint16_t</span> <span class="n">LevelPathStringOffsets</span><span class="p">[</span><span class="n">NumLevels</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>             <span class="c1">//Relative offset to level path strings</span>
<span class="n">StringArray</span> <span class="n">LevelPathStrings</span><span class="p">[</span><span class="n">NumLevels</span><span class="p">];</span>                  <span class="c1">//Usually Encrypted</span>
<span class="kt">uint16_t</span> <span class="n">CutscenePathStringOffsets</span><span class="p">[</span><span class="n">NumCutscenes</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>       <span class="c1">//Relative offset to cutscene path strings</span>
<span class="n">StringArray</span> <span class="n">CutscenePathStrings</span><span class="p">[</span><span class="n">NumCutscenes</span><span class="p">];</span>            <span class="c1">//Usually Encrypted</span>

<span class="kt">uint16_t</span> <span class="n">SequenceOffsets</span><span class="p">[</span><span class="n">NumLevels</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span> <span class="c1">//Relative offset to sequence info (maybe+2 because title needs sequence +numtitles?)</span>
<span class="n">SequenceInfo</span> <span class="n">Sequences</span><span class="p">[</span><span class="n">NumLevels</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>   <span class="c1">//Sequence info see explanation below (SIZE is dependant on first opcode)</span>

<span class="kt">uint16_t</span> <span class="n">DemoLevelIDs</span><span class="p">[</span><span class="n">NumDemoLevels</span><span class="p">];</span>

<span class="cp">#if PSX </span><span class="c1">//PSX Only</span>
    <span class="n">PSXFMVInfo</span><span class="p">[</span><span class="n">NumFMVs</span><span class="p">];</span><span class="c1">// Two uint32_t, flag? then length/lba related?</span>
<span class="cp">#endif</span>

<span class="kt">int16_t</span> <span class="n">NumGameStrings</span><span class="p">;</span>
<span class="kt">uint16_t</span> <span class="n">GameStringOffsets</span><span class="p">[</span><span class="n">NumGameStrings</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>   <span class="c1">//Relative offset to game strings</span>
<span class="n">StringArray</span> <span class="n">GameStrings</span><span class="p">[</span><span class="n">NumGameStrings</span><span class="p">];</span>        <span class="c1">//Usually Encrypted</span>

<span class="cp">#if PSX </span><span class="c1">// If PSX</span>
    <span class="kt">uint16_t</span> <span class="n">PSXStringOffsets</span><span class="p">[</span><span class="mi">80</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span><span class="c1">//Fixed at 80?</span>
    <span class="n">StringArray</span> <span class="n">PSXStrings</span><span class="p">[</span><span class="mi">80</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span><span class="c1">//Fixed at 80? Usually Encrypted</span>
<span class="cp">#else </span><span class="c1">// PC</span>
    <span class="kt">uint16_t</span> <span class="n">PCStringOffsets</span><span class="p">[</span><span class="mi">80</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span><span class="c1">//Fixed at 80?</span>
    <span class="n">StringArray</span> <span class="n">PCStrings</span><span class="p">[</span><span class="mi">80</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span><span class="c1">//Fixed at 80? Usually Encrypted</span>
<span class="cp">#endif</span>

<span class="kt">uint16_t</span> <span class="n">Puzzle1StringOffsets</span><span class="p">[</span><span class="n">NumLevels</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span> <span class="c1">//Relative offset to puzzle1 strings</span>
<span class="n">StringArray</span> <span class="n">Puzzle1Strings</span><span class="p">[</span><span class="n">NumLevels</span><span class="p">];</span>      <span class="c1">//Usually Encrypted</span>

<span class="kt">uint16_t</span> <span class="n">Puzzle2StringOffsets</span><span class="p">[</span><span class="n">NumLevels</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span> <span class="c1">//Relative offset to puzzle2 strings</span>
<span class="n">StringArray</span> <span class="n">Puzzle2Strings</span><span class="p">[</span><span class="n">NumLevels</span><span class="p">];</span>      <span class="c1">//Usually Encrypted</span>

<span class="kt">uint16_t</span> <span class="n">Puzzle3StringOffsets</span><span class="p">[</span><span class="n">NumLevels</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span> <span class="c1">//Relative offset to puzzle3 strings</span>
<span class="n">StringArray</span> <span class="n">Puzzle3Strings</span><span class="p">[</span><span class="n">NumLevels</span><span class="p">];</span>      <span class="c1">//Usually Encrypted</span>

<span class="kt">uint16_t</span> <span class="n">Puzzle4StringOffsets</span><span class="p">[</span><span class="n">NumLevels</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span> <span class="c1">//Relative offset to puzzle4 strings</span>
<span class="n">StringArray</span> <span class="n">Puzzle4Strings</span><span class="p">[</span><span class="n">NumLevels</span><span class="p">];</span>      <span class="c1">//Usually Encrypted</span>

<span class="kt">uint16_t</span> <span class="n">Pickup1StringOffsets</span><span class="p">[</span><span class="n">NumLevels</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span> <span class="c1">//Relative offset to pickup1 strings</span>
<span class="n">StringArray</span> <span class="n">Pickup1Strings</span><span class="p">[</span><span class="n">NumLevels</span><span class="p">];</span>      <span class="c1">//Usually Encrypted</span>

<span class="kt">uint16_t</span> <span class="n">Pickup2StringOffsets</span><span class="p">[</span><span class="n">NumLevels</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span> <span class="c1">//Relative offset to pickup2 strings</span>
<span class="n">StringArray</span> <span class="n">Pickup2Strings</span><span class="p">[</span><span class="n">NumLevels</span><span class="p">];</span>      <span class="c1">//Usually Encrypted</span>

<span class="kt">uint16_t</span> <span class="n">Key1StringOffsets</span><span class="p">[</span><span class="n">NumLevels</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>    <span class="c1">//Relative offset to key1 strings</span>
<span class="n">StringArray</span> <span class="n">Key1Strings</span><span class="p">[</span><span class="n">NumLevels</span><span class="p">];</span>         <span class="c1">//Usually Encrypted</span>

<span class="kt">uint16_t</span> <span class="n">Key2StringOffsets</span><span class="p">[</span><span class="n">NumLevels</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>    <span class="c1">//Relative offset to key2 strings</span>
<span class="n">StringArray</span> <span class="n">Key2Strings</span><span class="p">[</span><span class="n">NumLevels</span><span class="p">];</span>         <span class="c1">//Usually Encrypted</span>

<span class="kt">uint16_t</span> <span class="n">Key3StringOffsets</span><span class="p">[</span><span class="n">NumLevels</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>    <span class="c1">//Relative offset to key3 strings</span>
<span class="n">StringArray</span> <span class="n">Key3Strings</span><span class="p">[</span><span class="n">NumLevels</span><span class="p">];</span>         <span class="c1">//Usually Encrypted</span>

<span class="kt">uint16_t</span> <span class="n">Key4StringOffsets</span><span class="p">[</span><span class="n">NumLevels</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>    <span class="c1">//Relative offset to key4 strings</span>
<span class="n">StringArray</span> <span class="n">Key4Strings</span><span class="p">[</span><span class="n">NumLevels</span><span class="p">];</span>         <span class="c1">//Usually Encrypted</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_psx_fmv_info">11.2. PSX FMV Info</h3>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">PSXFMVInfo</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">flags</span><span class="p">;</span>   <span class="c1">//? First FMV usually has this set as 1</span>
    <span class="kt">uint32_t</span> <span class="n">unknown</span><span class="p">;</span> <span class="c1">//Possibly: size, lba or length can&#39;t remember which</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>This specific info is exclusive to <code>TOMBPSX.DAT</code>.</p></div>
</div>
<div class="sect2">
<h3 id="_script_flags">11.3. Script Flags</h3>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">enum</span> <span class="n">ScriptFlags</span>
<span class="p">{</span>
    <span class="n">DemoVersion</span> <span class="o">=</span>              <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="c1">//(=1) Is this a demo version of the game</span>
    <span class="n">TitleDisabled</span> <span class="o">=</span>            <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span> <span class="c1">//(=1) Disables Title Screen</span>
    <span class="n">CheatModeCheckDisabled</span> <span class="o">=</span>   <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="c1">//(=1) Related to in-game cheats?</span>
    <span class="n">NoInputTimeout</span> <span class="o">=</span>           <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="c1">//(=1) Disables input timeout for demo mode</span>
    <span class="n">LoadSaveDisabled</span> <span class="o">=</span>         <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="c1">//(=1) Disables loading/saving</span>
    <span class="n">ScreenSizingDisabled</span> <span class="o">=</span>     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span> <span class="c1">//(=1) Disables screen resizing PC only?</span>
    <span class="n">LockoutOptionRing</span> <span class="o">=</span>        <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span> <span class="c1">//(=1) Stops options ring from being selected</span>
    <span class="n">DozyCheatEnabled</span> <span class="o">=</span>         <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span> <span class="c1">//(=1) Enable DOZY (sometimes they removed the internal code)</span>
    <span class="n">UseXor</span> <span class="o">=</span>                   <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span> <span class="c1">//(=1) If true all string chars (except null termination) must be xor-ed by XorKey.</span>
    <span class="n">GymEnabled</span> <span class="o">=</span>               <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">),</span> <span class="c1">//(=1) Is Gym available on title screen.</span>
    <span class="n">SelectAnyLevel</span> <span class="o">=</span>           <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">),</span><span class="c1">//(=1) Unlocks all levels</span>
    <span class="n">EnableCheatCode</span> <span class="o">=</span>          <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="c1">//(=1) Related to in-game cheats?</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>These flags enable various in-game features if set.</p></div>
</div>
<div class="sect2">
<h3 id="_script_language">11.4. Script Language</h3>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">enum</span> <span class="n">ScriptLanguage</span>
<span class="p">{</span>
    <span class="n">LANG_ENGLISH</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">LANG_FRENCH</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">LANG_GERMAN</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">LANG_AMERICAN</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">LANG_JAPANESE</span> <span class="o">=</span> <span class="mi">4</span>
<span class="p">};</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_script_sequencing_amp_opcodes_operands">11.5. Script Sequencing &amp; Opcodes/Operands</h3>
<div class="paragraph"><p>Each script has &#8220;sequence information&#8221;, Opcodes and Operands are all stored as <code>uint16_t</code>. Sequences contain a set of commands to execute where an additional
value (operand) is usually passed as a parameter to the function the command needs to call. Note: that if a level is a demo level, its level ID will be 1024
higher than a <em>normal</em> level ID.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">SequenceInfo</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">Opcode</span><span class="p">;</span>   <span class="c1">//Command</span>
    <span class="kt">uint16_t</span> <span class="n">Operand</span><span class="p">;</span>  <span class="c1">//Not always used, depends on the opcode</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ScriptOpcodes</span>
<span class="p">{</span>
    <span class="n">OP_PICTURE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>            <span class="c1">// ?</span>
    <span class="n">OP_LISTSTART</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>          <span class="c1">// ?</span>
    <span class="n">OP_LISTEND</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>            <span class="c1">// ?</span>
    <span class="n">OP_STARTFMV</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>           <span class="c1">// Play FMV, operand is FMV ID</span>
    <span class="n">OP_STARTLEVEL</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>         <span class="c1">// Play (interactive) level, operand is level ID</span>
    <span class="n">OP_STARTCINE</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>          <span class="c1">// Play Cutscene, operand is cutscene ID</span>
    <span class="n">OP_LEVELCOMPLETE</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>      <span class="c1">// Do level-completion display (no operands)</span>
    <span class="n">OP_STARTDEMO</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>          <span class="c1">// Play demo level: operand is level ID</span>
    <span class="n">OP_JUMPTOSEQUENCE</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>     <span class="c1">// Jumps to specified sequence?</span>
    <span class="n">OP_ENDSEQUENCE</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>        <span class="c1">// End of sequence (no operands)</span>
    <span class="n">OP_SETTRACK</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>          <span class="c1">// Play soundtrack: operand is soundtrack ID (it precedes opcodes of associated levels)</span>
    <span class="n">OP_SUNSETENABLED</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>     <span class="c1">// Bartoli&#39;s Hideous</span>
    <span class="n">OP_LOADINGPIC</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>        <span class="c1">// Chapter screen: operand is chapter ID</span>
    <span class="n">OP_DEADLYWATER</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>       <span class="c1">// Temple of Xian? Kills Lara when she touches water?</span>
    <span class="n">OP_REMOVEWEAPONS</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>     <span class="c1">// Lose your weapons (no operands)</span>
    <span class="n">OP_GAMECOMPLETE</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>      <span class="c1">// End of game (no operands)</span>
    <span class="n">OP_CUTANGLE</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>          <span class="c1">// Associated with cutscenes; a viewpoint control? (one operand?)</span>
    <span class="n">OP_NOFLOOR</span> <span class="o">=</span> <span class="mi">17</span><span class="p">,</span>           <span class="c1">// For Floating Islands/Thames Wharf? (one operand?)</span>
    <span class="n">OP_ADDTOINVENTORY</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span>    <span class="c1">// Give item; operand is item type (see below)</span>
    <span class="n">OP_LARASTARTANIMATION</span> <span class="o">=</span> <span class="mi">19</span><span class="p">,</span><span class="c1">// Item-type 12 state to start level in: operand is state number</span>
    <span class="n">OP_NUMSECRETS</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>        <span class="c1">// Number of secrets (overrides engine&#39;s hardcoded count of them?): operand is that number</span>
    <span class="n">OP_KILLTOCOMPLETE</span> <span class="o">=</span> <span class="mi">21</span><span class="p">,</span>    <span class="c1">// Probably for Ice Palace boss (no operands)</span>
    <span class="n">OP_REMOVEAMMO</span> <span class="o">=</span> <span class="mi">22</span>         <span class="c1">// Lose your ammo and medipacks? (no operands?)</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>The correct way to parse Sequence Info is to first read a <code>uint16_t</code> opcode specifying what this command within the sequence does. In reference to the list
above, certain commands MUST have an additional <code>uint16_t</code> read from the sequence data directly after the opcode that&#8217;s the pairing operand to this opcode. Not
all opcodes have an operand so this must be done correctly. The original games execute each sequence command 1 by 1 until it reaches <code>OP_ENDSEQUENCE</code>, where it
then runs the next sequence.</p></div>
<div class="sect3">
<h4 id="_opcode_18_code_op_addtoinventory_code">11.5.1. Opcode-18 <code>OP_ADDTOINVENTORY</code></h4>
<div class="paragraph"><p>(repeat means give another)</p></div>
<div class="ulist"><div class="title">After finding all the secrets in a level (Tomb Raider 2)</div><ul>
<li>
<p>
0&#8201;&#8212;&#8201;Pistols
</p>
</li>
<li>
<p>
1&#8201;&#8212;&#8201;Shotgun
</p>
</li>
<li>
<p>
2&#8201;&#8212;&#8201;Automatic pistols
</p>
</li>
<li>
<p>
3&#8201;&#8212;&#8201;Uzis
</p>
</li>
<li>
<p>
4&#8201;&#8212;&#8201;Harpoon gun
</p>
</li>
<li>
<p>
5&#8201;&#8212;&#8201;M-16
</p>
</li>
<li>
<p>
6&#8201;&#8212;&#8201;Grenade launcher
</p>
</li>
<li>
<p>
7&#8201;&#8212;&#8201;Pistol clip
</p>
</li>
<li>
<p>
8&#8201;&#8212;&#8201;Shotgun-shell box
</p>
</li>
<li>
<p>
9&#8201;&#8212;&#8201;Automatic-pistol clip
</p>
</li>
<li>
<p>
10&#8201;&#8212;&#8201;Uzi clip
</p>
</li>
<li>
<p>
11&#8201;&#8212;&#8201;Harpoon bundle
</p>
</li>
<li>
<p>
12&#8201;&#8212;&#8201;M-16 clip
</p>
</li>
<li>
<p>
13&#8201;&#8212;&#8201;Grenade pack
</p>
</li>
<li>
<p>
14&#8201;&#8212;&#8201;Flare box
</p>
</li>
<li>
<p>
15&#8201;&#8212;&#8201;Small medipack
</p>
</li>
<li>
<p>
16&#8201;&#8212;&#8201;Big medipack
</p>
</li>
<li>
<p>
17&#8201;&#8212;&#8201;Pickup 1
</p>
</li>
<li>
<p>
18&#8201;&#8212;&#8201;Pickup 2
</p>
</li>
<li>
<p>
19&#8201;&#8212;&#8201;Puzzle 1
</p>
</li>
<li>
<p>
20&#8201;&#8212;&#8201;Puzzle 2
</p>
</li>
<li>
<p>
21&#8201;&#8212;&#8201;Puzzle 3
</p>
</li>
<li>
<p>
22&#8201;&#8212;&#8201;Puzzle 4
</p>
</li>
<li>
<p>
23&#8201;&#8212;&#8201;Key 1
</p>
</li>
<li>
<p>
24&#8201;&#8212;&#8201;Key 2
</p>
</li>
<li>
<p>
25&#8201;&#8212;&#8201;Key 3
</p>
</li>
<li>
<p>
26&#8201;&#8212;&#8201;Key 4
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">When a level starts (Tomb Raider 2)</div><ul>
<li>
<p>
1000&#8201;&#8212;&#8201;Pistols
</p>
</li>
<li>
<p>
1001&#8201;&#8212;&#8201;Shotgun
</p>
</li>
<li>
<p>
1002&#8201;&#8212;&#8201;Automatic pistols
</p>
</li>
<li>
<p>
1003&#8201;&#8212;&#8201;Uzis
</p>
</li>
<li>
<p>
1004&#8201;&#8212;&#8201;Harpoon gun
</p>
</li>
<li>
<p>
1005&#8201;&#8212;&#8201;M16
</p>
</li>
<li>
<p>
1006&#8201;&#8212;&#8201;Grenade launcher
</p>
</li>
<li>
<p>
1007&#8201;&#8212;&#8201;Pistol clip
</p>
</li>
<li>
<p>
1008&#8201;&#8212;&#8201;Shotgun-shell box
</p>
</li>
<li>
<p>
1009&#8201;&#8212;&#8201;Automatic-pistol clip
</p>
</li>
<li>
<p>
1010&#8201;&#8212;&#8201;Uzi clip
</p>
</li>
<li>
<p>
1011&#8201;&#8212;&#8201;Harpoon bundle
</p>
</li>
<li>
<p>
1012&#8201;&#8212;&#8201;M16 clip
</p>
</li>
<li>
<p>
1013&#8201;&#8212;&#8201;Grenade pack
</p>
</li>
<li>
<p>
1014&#8201;&#8212;&#8201;Flare box
</p>
</li>
<li>
<p>
1015&#8201;&#8212;&#8201;Small medipack
</p>
</li>
<li>
<p>
1016&#8201;&#8212;&#8201;Big medipack
</p>
</li>
<li>
<p>
1017&#8201;&#8212;&#8201;Pickup 1
</p>
</li>
<li>
<p>
1018&#8201;&#8212;&#8201;Pickup 2
</p>
</li>
<li>
<p>
1019&#8201;&#8212;&#8201;Puzzle 1
</p>
</li>
<li>
<p>
1020&#8201;&#8212;&#8201;Puzzle 2
</p>
</li>
<li>
<p>
1021&#8201;&#8212;&#8201;Puzzle 3
</p>
</li>
<li>
<p>
1022&#8201;&#8212;&#8201;Puzzle 4
</p>
</li>
<li>
<p>
1023&#8201;&#8212;&#8201;Key 1
</p>
</li>
<li>
<p>
1024&#8201;&#8212;&#8201;Key 2
</p>
</li>
<li>
<p>
1025&#8201;&#8212;&#8201;Key 3
</p>
</li>
<li>
<p>
1026&#8201;&#8212;&#8201;Key 4
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_tomb_raider_2_identifications">11.5.2. Tomb Raider 2 Identifications</h4>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content"><span class="blue">TR2 only information here. These lists are virtually colored blue.</span></td>
</tr></table>
</div>
<div class="ulist"><div class="title">FMV IDs</div><ul>
<li>
<p>
0&#8201;&#8212;&#8201;LOGO (everybody&#8217;s corporate logos)
</p>
</li>
<li>
<p>
1&#8201;&#8212;&#8201;ANCIENT (monks vs. dragon)
</p>
</li>
<li>
<p>
2&#8201;&#8212;&#8201;MODERN (Lara drops in from helicopter)
</p>
</li>
<li>
<p>
3&#8201;&#8212;&#8201;LANDING (Seaplane lands at rig)
</p>
</li>
<li>
<p>
4&#8201;&#8212;&#8201;MS (Lara hitchhikes on a minisub)
</p>
</li>
<li>
<p>
5&#8201;&#8212;&#8201;CRASH (Lara goes to Tibet and has a rough landing there)
</p>
</li>
<li>
<p>
6&#8201;&#8212;&#8201;JEEP (Lara steals it and outruns Bartoli&#8217;s goons)
</p>
</li>
<li>
<p>
7&#8201;&#8212;&#8201;END (Lara escaping the collapsing lair)
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">Cutscene IDs</div><ul>
<li>
<p>
0&#8201;&#8212;&#8201;CUT1 (At the end of the Great Wall)
</p>
</li>
<li>
<p>
1&#8201;&#8212;&#8201;CUT2 (Lara the stowaway)
</p>
</li>
<li>
<p>
2&#8201;&#8212;&#8201;CUT3 (Bartoli vs. goon)
</p>
</li>
<li>
<p>
3&#8201;&#8212;&#8201;CUT4 (Bartoli stabs himself)
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">Soundtrack IDs</div><ul>
<li>
<p>
0&#8201;&#8212;&#8201;BLANK (no sound)
</p>
</li>
<li>
<p>
3&#8201;&#8212;&#8201;CUT1 (&#8220;at the fancy door&#8221; soundtrack)
</p>
</li>
<li>
<p>
4&#8201;&#8212;&#8201;CUT2 (&#8220;Lara the stowaway&#8221; soundtrack)
</p>
</li>
<li>
<p>
5&#8201;&#8212;&#8201;CUT3 (&#8220;Bartoli vs. goon&#8221; soundtrack)
</p>
</li>
<li>
<p>
30&#8201;&#8212;&#8201;CUT4 (&#8220;Bartoli stabs himself&#8221; soundtrack)
</p>
</li>
<li>
<p>
31&#8201;&#8212;&#8201;DERELICT (eerie choppy/echo-y synths)
</p>
</li>
<li>
<p>
32&#8201;&#8212;&#8201;WATER (dripping/pouring water sounds)
</p>
</li>
<li>
<p>
33&#8201;&#8212;&#8201;WIND (Blowing wind)
</p>
</li>
<li>
<p>
34&#8201;&#8212;&#8201;HEARTBT (musical embellishment of one)
</p>
</li>
<li>
<p>
52&#8201;&#8212;&#8201;SHOWER (that infamous shower scene)
</p>
</li>
<li>
<p>
58&#8201;&#8212;&#8201;MACHINES (in the offshore rig)
</p>
</li>
<li>
<p>
59&#8201;&#8212;&#8201;FLOATING (wispy synths)
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_other_script_commands">11.6. Other Script Commands</h3>
<div class="paragraph"><p>` FirstOption`, <code>TitleReplace</code>, <code>OnDeathDemoMode</code>, and <code>OnDeathInGame</code> can also be setup to perform specific actions. For example,  <code>OnDeathInGame</code> will be set
to "0x500" which loads the title screen when Lara dies in-game. Some other commands are as follows:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>ExitGame</strong> - <code>0x700</code> - Exit entire game?
</p>
</li>
<li>
<p>
<strong>ExitToTitle</strong> - <code>0x500</code> - Exit to Title Screen
</p>
</li>
<li>
<p>
<strong>Demo</strong> - <code>0x400</code> - Load Demo level
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scripting_in_tr4">12. Scripting in TR4</h2>
<div class="sectionbody">
<div class="paragraph"><p>In this chapter we will describe full gameflow script specification for TR4 <em>script file</em> (usually called <code>SCRIPT.DAT</code>) and <em>language file</em>, which contains all
the strings used in game for specific language (e.g., <code>ENGLISH.DAT</code>, <code>FRENCH.DAT</code>, and so on).</p></div>
<div class="sect2">
<h3 id="_the_script_file">12.1. The Script File</h3>
<div class="paragraph"><p>The script is divided into several blocks (or <em>headers</em>), some of them are global (applicable to whole game instance), and some are per-level only.</p></div>
<div class="sect3">
<h4 id="_global_header">12.1.1. Global Header</h4>
<div class="paragraph"><p>This header contains general information not specific to particular level.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr4_script_header</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span>  <span class="n">Options</span><span class="p">;</span>
    <span class="kt">uint8_t</span>  <span class="n">Filler</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>     <span class="c1">// Unused</span>
    <span class="kt">uint32_t</span> <span class="n">InputTimeout</span><span class="p">;</span>
    <span class="kt">uint8_t</span>  <span class="n">Security</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p><code>Options</code> is a set of bit flags with several global game settings (name of the settings directly borrowed from original text scripts distributed with TRLE):</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Bit 0</em> (<code>0x01</code>)&#8201;&#8212;&#8201;FlyCheat. Enables debug fly mode activated by typing <code>DOZY</code> ingame.
</p>
</li>
<li>
<p>
<em>Bit 1</em> (<code>0x02</code>)&#8201;&#8212;&#8201;LoadSave. When this bit is not set, load and save features are disabled. This option was used for demo versions.
</p>
</li>
<li>
<p>
<em>Bit 2</em> (<code>0x04</code>)&#8201;&#8212;&#8201;Title. Specifies if title screen should be displayed or not. If not set, game will start right away after user has launched an application.
</p>
</li>
<li>
<p>
<em>Bit 3</em> (<code>0x08</code>)&#8201;&#8212;&#8201;PlayAnyLevel. Gives an access to any level from the title screen.
</p>
</li>
<li>
<p>
<em>Bit 7</em> (<code>0x80</code>)&#8201;&#8212;&#8201;DemoDisc. Unknown feature, probably related to game versions deployed on promotional CDs.
</p>
</li>
</ul></div>
<div class="paragraph"><p><code>InputTimeout</code>: in early TR4 demos (for example, version dated September 15, 1999) this parameter specified time interval, after which game will engage
pre-recorded rolling demo, in case there was no user input. This feature became useless in final version.</p></div>
<div class="paragraph"><p><code>Security</code> parameter meant to be a special &#8220;key&#8221; value used to encrypt script data. Encryption is done with simple XOR operation against the data. However,
this value was never used, and instead, hardcoded one was specified. This matter will be discussed later.</p></div>
</div>
<div class="sect3">
<h4 id="_level_header">12.1.2. Level Header</h4>
<div class="paragraph"><p>This section defines platform-specific information, such as <em>file extensions</em> used in PC an PlayStation versions of the game. All the mentioned strings are
null-terminated.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr4_script_levelheader</span>
<span class="p">{</span>
     <span class="kt">uint8_t</span> <span class="n">NumTotalLevels</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">NumUniqueLevelPaths</span><span class="p">;</span>

    <span class="kt">uint16_t</span> <span class="n">LevelpathStringLen</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">LevelBlockLen</span><span class="p">;</span>

    <span class="kt">uint8_t</span>  <span class="n">PSXLevelString</span> <span class="p">[</span><span class="mi">5</span><span class="p">];</span>    <span class="c1">//  typically &quot;.PSX&quot;</span>
    <span class="kt">uint8_t</span>  <span class="n">PSXFMVString</span>   <span class="p">[</span><span class="mi">5</span><span class="p">];</span>    <span class="c1">//  typically &quot;.FMV&quot;</span>
    <span class="kt">uint8_t</span>  <span class="n">PSXCutString</span> <span class="p">[</span><span class="mi">5</span><span class="p">];</span>    <span class="c1">//  typically &quot;.CUT&quot;</span>
    <span class="kt">uint8_t</span>  <span class="n">Filler</span> <span class="p">[</span><span class="mi">5</span><span class="p">];</span>            <span class="c1">//  Possibly for some additional extension type?</span>

    <span class="kt">uint8_t</span>  <span class="n">PCLevelString</span>  <span class="p">[</span><span class="mi">5</span><span class="p">];</span>    <span class="c1">//  typically &quot;.TR4&quot;</span>
    <span class="kt">uint8_t</span>  <span class="n">PCFMVString</span>    <span class="p">[</span><span class="mi">5</span><span class="p">];</span>    <span class="c1">//  typically &quot;.BIK&quot;</span>
    <span class="kt">uint8_t</span>  <span class="n">PCCutString</span>    <span class="p">[</span><span class="mi">5</span><span class="p">];</span>    <span class="c1">//  typically &quot;.TR4&quot;</span>
    <span class="kt">uint8_t</span>  <span class="n">Unused</span> <span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p><code>NumTotalLevels</code> is an amount of levels included in script. Title flyby is also counted.</p></div>
<div class="paragraph"><p><code>LevelpathStringLen</code> is a sum of lengths of all <em>level path strings</em>, including <code>0x00</code>s (empty ones).</p></div>
<div class="paragraph"><p><code>LevelBlockLen</code> is a sum of lengths of each level script data length.</p></div>
</div>
<div class="sect3">
<h4 id="_level_listing_block">12.1.3. Level Listing Block</h4>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr4_script_levellisting</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">OffsetsToLevelpathString</span><span class="p">[</span><span class="n">NumTotalLevels</span><span class="p">];</span>
     <span class="kt">uint8_t</span> <span class="n">LevelpathStringBlock</span> <span class="p">[</span><span class="n">LevelpathStringLen</span><span class="p">];</span>

    <span class="kt">uint16_t</span> <span class="n">OffsetsToLevelData</span> <span class="p">[</span><span class="n">NumTotalLevels</span><span class="p">];</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Note that the offsets in the offset table themselves <strong>are not</strong> relative to the file address <code>0</code>. The level-path offsets are relative to the first path string&#8217;s
starting byte address <code>(56 + NumTotalLevels * 2)</code>, while the level-data offsets are relative to the first level data&#8217;s starting byte address <code>(56 +
NumTotalLevels * 2 + LevelpathStringLen + NumTotalLevels * 2)</code>.</p></div>
<div class="paragraph"><p>It is also worth noting that the level-path strings in <code>SCRIPT.DAT</code> are ordered the same way they were ordered in corresponding <code>[Level]</code> blocks in uncompiled
<em>SCRIPT.TXT</em>. For example, if the first <em>[Level]</em> in <code>SCRIPT.TXT</code> defines <code>Level=DATA\TEST1,101</code> and the second <code>Level=DATA\TEST2,101</code>&#8201;&#8212;&#8201;then there will be 2
level-paths in <code>SCRIPT.DAT</code>, in the order such as this: <code>DATA\\TEST1.DATA\\TEST2;</code> where <code>.</code> is the null-terminator (<code>0x00</code>) byte.</p></div>
<div class="paragraph"><p>To get to a certain level&#8217;s path within <code>SCRIPT.DAT</code> knowing only its number, just look-up at <code>OffsetsToLevelpathString[LevelNum]</code> and go to that offset
(remember, it is <em>not relative</em> to file address <code>0</code>!).</p></div>
</div>
<div class="sect3">
<h4 id="_level_block">12.1.4. Level Block</h4>
<div class="paragraph"><p>Inside the level block, each level stores its own data describing certain parameters, such as level name, puzzle item names, load camera position, default
background ambience soundtrack, and so on (the title level is no exception!).</p></div>
<div class="paragraph"><p>While in <code>SCRIPT.TXT</code> each parameter was given its own line and position within the file itself, in <code>SCRIPT.DAT</code> this is not the case. Rather, bitfields are
used for bool options (enabled/disabled; such as <em>Lightning</em> option) and the rest of the usually multi-byte data uses an <em>opcode data structure</em>.</p></div>
<div class="paragraph"><p>That is, preceding a certain type of data you usually find a byte. That is the <em>opcode byte</em>&#8201;&#8212;&#8201;depending on its value, it can be determined what kind and how
many arguments follow that need parsing. For example, chunk <code>0x81</code> indicates the level description opcode; with that info, the parser knows that 4 arguments
follows: the string index, etc. This structure is somewhat akin to the <em>AnimCommands</em> structure of level files (see description above). The chunk order <em>does</em>
matter; the original <code>tomb4.exe</code> binary seems to crash if something is not ordered the way it should be.</p></div>
<div class="paragraph"><p>The title screen is special in that it uses the <code>0x82</code> opcode the indicate the level-name and audio track information and it, naturally, lacks the string index
integer as the title level has no name associated with it.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr4_script_leveldata</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">LevelData</span> <span class="p">[</span><span class="n">LevelDataLen</span><span class="p">];</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p><code>LevelData</code> is all of the level&#8217;s data continuously stored in memory. Number of level data sections is equal to overall amount of levels in game, and overall
size of all level data sections comprise <em>Level Block</em>.</p></div>
<div class="paragraph"><p>To get to a certain level&#8217;s data section, follow that particular level&#8217;s offset from inside the offset table you loaded (described above). The data sections
themselves are ordered the very same way levels were ordered in <code>SCRIPT.TXT</code>. For more info on the types of all available TR4 chunks and how to parse them, see
the <a href="#Script Opcodes">[Script Opcodes]</a> section.</p></div>
</div>
<div class="sect3">
<h4 id="_language_file_listing_block">12.1.5. Language File Listing Block</h4>
<div class="paragraph"><p>After the level block follows a simple array of ASCII strings which define <em>all the language files the game can choose from</em>. There are, however, no offset
tables for this one, so one must simply read until a null-byte is reached, and then take that as the string and repeat onwards until EOF. Therefore, the last
byte of <code>SCRIPT.DAT</code> must always be the null-terminator (<code>0x00</code>).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">This setup is valid only for standard TR4 scripts generated by original TRLE script utility. <em>TRNG</em> scripts have their own special footer and data block
appended to the bottom of the file, which contain all the extra information it needs.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_script_opcodes">12.1.6. Script Opcodes</h4>
<div class="paragraph"><p>Here is a list of all available TR4 opcodes, their meaning and their corresponding arguments (order of arguments matters!):</p></div>
<div class="listingblock">
<div class="content">
<pre><code>0x81  Level           bitu8 stringIndex, uint16_t levelOptions, bitu8 pathIndex, bitu8 audio
0x82  [Title] Level   bitu8 pathIndex, uint16_t titleOptions, bitu8 audio
0x8C  Legend          bitu8 stringIndex
0x91  LoadCamera      bit32 srcX, bit32 srcY, bit32 srcZ, bit32 targX, bit32 targY, bit32 targZ, bitu8 room
0x89  Layer1          bitu8 red, bitu8 green, bitu8 blue, bit8 speed
0x8A  Layer2          bitu8 red, bitu8 green, bitu8 blue, bit8 speed
0x8E  Mirror          bitu8 room, bit32 xAxis
0x8F  Fog             bitu8 red, bitu8 green, bitu8 blue
0x84  Cut             bitu8 cutIndex
0x8B  UVrotate        bit8 speed
0x85  ResidentCut1    bitu8 cutIndex
0x86  ResidentCut2    bitu8 cutIndex
0x87  ResidentCut3    bitu8 cutIndex
0x88  ResidentCut4    bitu8 cutIndex
0x80  FMV             bitu8: 4 least significant bits represent the FMV index; 4 most significant bits (y) represent the FMV trigger bitfield as in y=1&lt;-&gt;bit 8 set
0x92  ResetHUB        bitu8 levelIndex
0x90  AnimatingMIP    bitu8: 4 least significant bits represent animatingObjectIndex - 1; 4 most significant bits represent the distance
0x8D  LensFlare       uint16_t yClicks, bit16 zClicks, uint16_t xClicks, bitu8 red, bitu8 green, bitu8 blue
0x93  KEY_ITEM1       uint16_t stringIndex, uint16_t height, uint16_t size, uint16_t yAngle, uint16_t zAngle, uint16_t xAngle, uint16_t unknown
0x94  KEY_ITEM2   -=-  (All the same)
0x95  KEY_ITEM3   -=-
0x96  KEY_ITEM4   -=-
0x97  KEY_ITEM5   -=-
0x98  KEY_ITEM6   -=-
0x99  KEY_ITEM7   -=-
0x9A  KEY_ITEM8   -=-
0x9B  KEY_ITEM9   -=-
0x9C  KEY_ITEM10  -=-
0x9D  KEY_ITEM11  -=-
0x9E  KEY_ITEM12  -=-
0x9F  PUZZLE_ITEM1  -=-
0xA0  PUZZLE_ITEM2  -=-
0xA1  PUZZLE_ITEM3  -=-
0xA2  PUZZLE_ITEM4  -=-
0xA3  PUZZLE_ITEM5  -=-
0xA4  PUZZLE_ITEM6  -=-
0xA5  PUZZLE_ITEM7  -=-
0xA6  PUZZLE_ITEM8  -=-
0xA7  PUZZLE_ITEM9  -=-
0xA8  PUZZLE_ITEM10  -=-
0xA9  PUZZLE_ITEM11  -=-
0xAA  PUZZLE_ITEM12  -=-

0xAB  PICKUP_ITEM1  -=-
0xAC  PICKUP_ITEM2  -=-
0xAD  PICKUP_ITEM3  -=-
0xAE  PICKUP_ITEM4  -=-

0xAF  EXAMINE1 -=-
0xB0  EXAMINE2 -=-
0xB1  EXAMINE3 -=-

0xB2  KEY_ITEM1_COMBO1 -=-
0xB3  KEY_ITEM1_COMBO2 -=-
0xB4  KEY_ITEM2_COMBO1 -=-
0xB5  KEY_ITEM2_COMBO2 -=-
0xB6  KEY_ITEM3_COMBO1 -=-
0xB7  KEY_ITEM3_COMBO2 -=-
0xB8  KEY_ITEM4_COMBO1 -=-
0xB9  KEY_ITEM4_COMBO2 -=-
0xBA  KEY_ITEM5_COMBO1 -=-
0xBB  KEY_ITEM5_COMBO2 -=-
0xBC  KEY_ITEM6_COMBO1 -=-
0xBD  KEY_ITEM6_COMBO2 -=-
0xBE  KEY_ITEM7_COMBO1 -=-
0xBF  KEY_ITEM7_COMBO2 -=-
0xC0  KEY_ITEM8_COMBO1 -=-
0xC1  KEY_ITEM8_COMBO2 -=-

0xC2  PUZZLE_ITEM1_COMBO1 -=-
0xC3  PUZZLE_ITEM1_COMBO2  -=-
0xC4  PUZZLE_ITEM2_COMBO1  -=-
0xC5  PUZZLE_ITEM2_COMBO2  -=-
0xC6  PUZZLE_ITEM3_COMBO1  -=-
0xC7  PUZZLE_ITEM3_COMBO2  -=-
0xC8  PUZZLE_ITEM4_COMBO1  -=-
0xC9  PUZZLE_ITEM4_COMBO2  -=-
0xCA  PUZZLE_ITEM5_COMBO1  -=-
0xCB  PUZZLE_ITEM5_COMBO2  -=-
0xCC  PUZZLE_ITEM6_COMBO1  -=-
0xCD  PUZZLE_ITEM6_COMBO2 -=-
0xCE  PUZZLE_ITEM7_COMBO1 -=-
0xCF  PUZZLE_ITEM7_COMBO2 -=-
0xD0  PUZZLE_ITEM8_COMBO1 -=-
0xD1  PUZZLE_ITEM8_COMBO2 -=-

0xD2  PICKUP_ITEM1_COMBO1 -=-
0xD3  PICKUP_ITEM1_COMBO2 -=-
0xD4  PICKUP_ITEM2_COMBO1 -=-
0xD5  PICKUP_ITEM2_COMBO2 -=-
0xD6  PICKUP_ITEM3_COMBO1 -=-
0xD7  PICKUP_ITEM3_COMBO2 -=-
0xD8  PICKUP_ITEM4_COMBO1 -=-
0xD9  PICKUP_ITEM4_COMBO2 -=-

0x83  level-data-end  no arguments - this opcode appears at the end of every level (incl. title) block</code></pre>
</div></div>
<div class="paragraph"><p>The <code>uint16_t</code> values <code>levelOptions</code> and <code>titleOptions</code> are actually <em>bit fields</em> containing several boolean options, and are laid out as follows (per-bit
description):</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Bit 0</em> (<code>0x0001</code>)&#8201;&#8212;&#8201;YoungLara
</p>
</li>
<li>
<p>
<em>Bit 1</em> (<code>0x0002</code>)&#8201;&#8212;&#8201;Weather
</p>
</li>
<li>
<p>
<em>Bit 2</em> (<code>0x0004</code>)&#8201;&#8212;&#8201;Horizon
</p>
</li>
<li>
<p>
<em>Bit 4</em> (<code>0x0010</code>)&#8201;&#8212;&#8201;Layer2 used (?)
</p>
</li>
<li>
<p>
<em>Bit 3</em> (<code>0x0008</code>)&#8201;&#8212;&#8201;Horizon (has to be paired with 3)
</p>
</li>
<li>
<p>
<em>Bit 5</em> (<code>0x0020</code>)&#8201;&#8212;&#8201;Starfield
</p>
</li>
<li>
<p>
<em>Bit 6</em> (<code>0x0040</code>)&#8201;&#8212;&#8201;Lightning
</p>
</li>
<li>
<p>
<em>Bit 7</em> (<code>0x0080</code>)&#8201;&#8212;&#8201;Train
</p>
</li>
<li>
<p>
<em>Bit 8</em> (<code>0x0100</code>)&#8201;&#8212;&#8201;Pulse
</p>
</li>
<li>
<p>
<em>Bit 9</em> (<code>0x0200</code>)&#8201;&#8212;&#8201;ColAddHorizon
</p>
</li>
<li>
<p>
<em>Bit 10</em> (<code>0x0400</code>)&#8201;&#8212;&#8201;ResetHUB used
</p>
</li>
<li>
<p>
<em>Bit 11</em> (<code>0x0800</code>)&#8201;&#8212;&#8201;ColAddHorizon (has to be paired with 10)
</p>
</li>
<li>
<p>
<em>Bit 12</em> (<code>0x1000</code>)&#8201;&#8212;&#8201;Timer
</p>
</li>
<li>
<p>
<em>Bit 13</em> (<code>0x2000</code>)&#8201;&#8212;&#8201;Mirror used
</p>
</li>
<li>
<p>
<em>Bit 14</em> (<code>0x4000</code>)&#8201;&#8212;&#8201;RemoveAmulet
</p>
</li>
<li>
<p>
<em>Bit 15</em> (<code>0x8000</code>)&#8201;&#8212;&#8201;NoLevel
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_the_language_file">12.2. The Language File</h3>
<div class="paragraph"><p>In contrary to TR2 and TR3, TR4 uses a more sophisticated language-handling scheme. Instead of storing the strings in <code>SCRIPT.DAT</code> for every different language,
TR4 splits the string definition (<code>{LANGUAGE}.DAT</code>) and script definition (<code>SCRIPT.DAT</code>) data into the two mentioned files. This allows for smaller files, finer
grain of selectivity and easy localization.</p></div>
<div class="paragraph"><p>This means that, within <code>SCRIPT.DAT</code>, strings are always given as string indices, i.e. numbers that correspond to the array positions of the corresponding
strings within <code>{LANGUAGE}.DAT</code>, where <code>{LANGUAGE}</code> can be any supported language filename.</p></div>
<div class="paragraph"><p>From these files, the game will choose the first one that is available and use that as the <em>string resource</em>. See below for details on string selection.</p></div>
<div class="sect3">
<h4 id="_language_file_priority">12.2.1. Language File Priority</h4>
<div class="paragraph"><p>The number of supported language files depends on what was defined in <code>SCRIPT.TXT</code>, in the <em>[Language]</em> section. Also, the priority of loading is specified
there (the first number before the comma). For example, if we have defined:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>[Language]
File= 0,ENGLISH.TXT
File= 1,FRENCH.TXT
File= 2,GERMAN.TXT
File= 3,ITALIAN.TXT
File= 4,SPANISH.TXT
File= 5,US.TXT</code></pre>
</div></div>
<div class="paragraph"><p>&#8230;that would mean that the game will first look for <code>ENGLISH.DAT</code> for loading. If that&#8217;s not present, it will look for <code>FRENCH.DAT</code>. If not, it&#8217;ll look for
<code>GERMAN.DAT</code>, and so on. If none of the files are present, the game will crash. In <code>SCRIPT.DAT</code>, these numbers reflect on the order of file name strings: in the
above situation, the <em>language file listing block</em> at the end of <code>SCRIPT.DAT</code> would look like this (highest&#8594;lowest priority):</p></div>
<div class="listingblock">
<div class="content">
<pre><code>ENGLISH.DAT FRENCH.DAT GERMAN.DAT ITALIAN DAT SPANISH.DAT US.DAT.</code></pre>
</div></div>
<div class="paragraph"><p>&#8230;where the splitting space between filenames specifies the null-terminator (0x00) byte.</p></div>
</div>
<div class="sect3">
<h4 id="_language_file_structure">12.2.2. Language File Structure</h4>
<div class="sect4">
<h5 id="_the_header">The Header</h5>
<div class="paragraph"><p>The header of the language file follows this structure:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr4_lang_header</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">NumGenericStrings</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">NumPSXStrings</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">NumPCStrings</span><span class="p">;</span>

    <span class="kt">uint16_t</span> <span class="n">GenericStringsLen</span><span class="p">;</span> <span class="c1">//  including the null-terminator bytes</span>
    <span class="kt">uint16_t</span> <span class="n">PSXStringsLen</span><span class="p">;</span>     <span class="c1">//  including the null-terminator bytes</span>
    <span class="kt">uint16_t</span> <span class="n">PCStringsLen</span><span class="p">;</span>      <span class="c1">//  including the null-terminator bytes</span>

    <span class="kt">uint16_t</span> <span class="n">StringOffsetTable</span><span class="p">[];</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p><code>StringOffsetTable</code> is a table holding offsets which point to corresponding strings. Therefore, its size is <code>NumGenericStrings + NumPSXStrings + NumPCStrings</code>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">Offsets in the offset table themselves <em>are not</em> relative to the file address 0! They are actually relative to the first string&#8217;s starting byte address!</td>
</tr></table>
</div>
<div class="paragraph"><p>In order to get an absolute offset of a string whose relative offset you retrieved from the offset table, do the following:</p></div>
<div class="paragraph"><p><code>absoluteOffset = relativeOffset + sizeof(tr4_lang_header)</code></p></div>
<div class="paragraph"><p><code>sizeof(tr4_lang_header)</code> depends, of course, on the number of strings in each group. Therefore, the header size is <code>sizeof(uint16_t) * 6 + sizeof(OffsetTable)</code>.</p></div>
</div>
<div class="sect4">
<h5 id="_string_data">String Data</h5>
<div class="paragraph"><p>In the usual TR4 situation, there are typically <em>359 strings</em> (that is, usually <em>NumTotalStrings = NumGenericStrings + NumPSXStrings + NumPCStrings = 359</em>)
defined. This, however, is <em>not</em> a limit nor rule of any kind.</p></div>
<div class="paragraph"><p>All the strings defined within <code>{LANGUAGE}.DAT</code> files are ASCII null-terminated strings. Every character (byte) contained in such a string is XOR-ed with byte
<code>0xA5</code> (as mentioned above, it is done regardless of what byte was specified in <code>SCRIPT.TXT</code> under the <em>Security</em> option).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="/usr/share/asciidoc/icons/note.png" alt="Note" />
</td>
<td class="content">The null-termination byte is <em>not</em> being XOR-ed!</td>
</tr></table>
</div>
<div class="paragraph"><p>After the above defined header section goes an array of strings, in a predefined order: <em>Generic &#8594; PSX &#8594; PC</em>.</p></div>
<div class="paragraph"><p>The length of this array of total <em>(NumTotalStrings)</em> strings is therefore <em>TotalStringsLen = GenericStringsLen + PSXStringsLen + PCStringsLen</em>.</p></div>
<div class="paragraph"><p>Hence the string array has the following format:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tr4_lang_stringdata</span>
<span class="p">{</span>
    <span class="n">string_entry</span> <span class="n">Strings</span><span class="p">[</span><span class="n">NumTotalStrings</span><span class="p">];</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>where <code>string_entry</code> is simply a <code>char</code> array, whose length depends on the corresponding string&#8217;s length. That can be calculated by subtracting the next
string&#8217;s by the current string&#8217;s offset.</p></div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cutseq_file_format_tr4_tr5">13. CUTSEQ file format (TR4-TR5)</h2>
<div class="sectionbody">
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2015-08-17 17:34:41 YEKT
</div>
</div>
</body>
</html>
